<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Clientes</title>
    <!-- Usando Tailwind CSS para um design bonito e rápido -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 font-sans">

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Cabeçalho -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">
                <i class="fas fa-users-cog mr-2"></i>Organizador de Clientes
            </h1>
            <p class="text-gray-600">Selecione seus arquivos .js de clientes para visualizar e exportar a lista limpa.</p>
        </header>

        <!-- Área de Upload -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <label class="block mb-2 text-sm font-medium text-gray-900">Carregar Arquivos (.js)</label>
            <div class="flex gap-2">
                <input type="file" id="fileInput" multiple accept=".js,.txt" 
                    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2.5">
                <button onclick="processarArquivos()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 flex items-center">
                    <i class="fas fa-play mr-2"></i> Processar
                </button>
            </div>
            <p class="mt-2 text-xs text-gray-500">Suporta múltiplos arquivos simultaneamente (clientes.js, clientes2.js, etc).</p>
        </div>

        <!-- Botões de Ação (Aparecem após processar) -->
        <div id="actionArea" class="hidden flex justify-between items-center mb-4">
            <span id="totalCounter" class="font-semibold text-gray-700 bg-gray-200 px-3 py-1 rounded-full text-sm">
                0 Contatos encontrados
            </span>
            <button onclick="baixarListaTxt()" 
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 flex items-center">
                <i class="fas fa-download mr-2"></i> Baixar Lista (.txt)
            </button>
        </div>

        <!-- Tabela de Resultados -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th class="py-3 px-6 text-left">Nome</th>
                        <th class="py-3 px-6 text-left">Cidade</th>
                        <th class="py-3 px-6 text-left">Bairro / Detalhes</th>
                    </tr>
                </thead>
                <tbody id="listaClientes" class="text-gray-600 text-sm font-light">
                    <!-- Linhas serão inseridas aqui via JavaScript -->
                    <tr>
                        <td colspan="3" class="py-8 text-center text-gray-400 italic">
                            Nenhum arquivo processado ainda.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variável global para armazenar todos os clientes processados
        let todosClientes = [];

        async function processarArquivos() {
            const input = document.getElementById('fileInput');
            const tbody = document.getElementById('listaClientes');
            const actionArea = document.getElementById('actionArea');
            const totalCounter = document.getElementById('totalCounter');

            if (input.files.length === 0) {
                alert("Por favor, selecione pelo menos um arquivo.");
                return;
            }

            // Limpa dados anteriores
            todosClientes = [];
            tbody.innerHTML = '<tr><td colspan="3" class="py-8 text-center"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i><br>Lendo arquivos...</td></tr>';

            // Processa cada arquivo
            for (let i = 0; i < input.files.length; i++) {
                const arquivo = input.files[i];
                try {
                    const texto = await lerArquivo(arquivo);
                    const clientesDoArquivo = extrairDadosDoTexto(texto);
                    todosClientes = [...todosClientes, ...clientesDoArquivo];
                } catch (erro) {
                    console.error(`Erro ao ler arquivo ${arquivo.name}:`, erro);
                }
            }

            // Ordenar alfabeticamente por Nome
            todosClientes.sort((a, b) => {
                const nomeA = (a.nome || "").toLowerCase();
                const nomeB = (b.nome || "").toLowerCase();
                if (nomeA < nomeB) return -1;
                if (nomeA > nomeB) return 1;
                return 0;
            });

            // Atualizar UI
            renderizarTabela();
            actionArea.classList.remove('hidden');
            totalCounter.textContent = `${todosClientes.length} Contatos encontrados`;
        }

        // Função auxiliar para ler arquivo como promessa
        function lerArquivo(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // O Coração da Lógica: Extrai o array do arquivo JS
        function extrairDadosDoTexto(conteudo) {
            try {
                // 1. Encontra onde começa o array '[' e onde termina ']'
                const inicio = conteudo.indexOf('[');
                const fim = conteudo.lastIndexOf(']');

                if (inicio === -1 || fim === -1) return [];

                // 2. Pega apenas o texto que representa o array
                let jsonTexto = conteudo.substring(inicio, fim + 1);

                // 3. Tenta converter para Objeto Javascript de forma segura
                const pegarArray = new Function(`return ${jsonTexto};`);
                return pegarArray();

            } catch (e) {
                console.error("Erro ao converter texto em dados:", e);
                return [];
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('listaClientes');
            tbody.innerHTML = '';

            if (todosClientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-red-500">Nenhum cliente válido encontrado nos arquivos.</td></tr>';
                return;
            }

            todosClientes.forEach(cliente => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 hover:bg-gray-50";

                // Tratamento de dados nulos e busca de campos alternativos (fallback)
                const nome = cliente.nome || "Sem Nome";
                const cidade = cliente.cidade || "-";
                // Procura bairro, se não tiver, procura complemento (comum nos arquivos tipo 4 e 5)
                let bairro = cliente.bairro || cliente.complemento || "-";
                
                // Limpa quebras de linha que possam vir no complemento
                bairro = bairro.replace(/(\r\n|\n|\r)/gm, " ");

                tr.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${nome}</td>
                    <td class="py-3 px-6 text-left">${cidade}</td>
                    <td class="py-3 px-6 text-left text-xs">${bairro}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function baixarListaTxt() {
            if (todosClientes.length === 0) {
                alert("Não há dados para baixar.");
                return;
            }

            // Cabeçalho do arquivo TXT
            let conteudoTxt = "=== LISTA DE CLIENTES ===\n";
            conteudoTxt += "NOME | CIDADE | BAIRRO / DETALHES\n";
            conteudoTxt += "------------------------------------------------------------\n";

            todosClientes.forEach(cliente => {
                const nome = cliente.nome || "Sem Nome";
                
                // Normalização: Se não tem cidade, deixa vazio. Se não tem bairro, tenta pegar o complemento.
                let cidade = cliente.cidade ? cliente.cidade : " - ";
                let bairro = cliente.bairro || cliente.complemento || " - ";

                // Remove quebras de linha para manter o arquivo txt organizado (uma linha por cliente)
                bairro = bairro.replace(/(\r\n|\n|\r)/gm, " ");
                
                conteudoTxt += `${nome} | ${cidade} | ${bairro}\n`;
            });

            // Cria o blob e o link de download
            const blob = new Blob([conteudoTxt], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lista_clientes_organizada.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
