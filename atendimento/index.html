<!DOCTYPE html>
<html lang="pt-BR" itemscope itemtype="https://schema.org/LocalBusiness">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cesta Econ√¥mica | Dona Ant√¥nia Alimentos - Cuiab√° e VG</title>
    <meta name="description" content="Encomende cestas b√°sicas em Cuiab√° e V√°rzea Grande. Qualidade, pre√ßo justo e entrega r√°pida. Fale com o Osvaldo!">
    <meta name="theme-color" content="#008069">
    
    <!-- PILLAR 1: SCHEMA MARKUP (SEO LOCAL) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "GroceryStore",
      "name": "Dona Ant√¥nia Alimentos",
      "image": "https://donaantonia.com.br/img/logo.png",
      "telephone": "+5565998150975",
      "url": "https://donaantonia.com.br",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Cuiab√°",
        "addressRegion": "MT",
        "addressCountry": "BR"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": -15.6014, 
        "longitude": -56.0979
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        "opens": "08:00",
        "closes": "18:00"
      },
      "priceRange": "$$"
    }
    </script>

    <!-- OTIMIZA√á√ÉO: Preload e DNS Prefetch -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PILLAR 3: SEGURAN√áA (CSP & Headers Simulados) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">
    <meta http-equiv="X-Frame-Options" content="DENY">

    <style>
        /* === ESTILOS GERAIS DO WHATSAPP === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #E5DDD5; }
        
        .wa-header { background-color: #008069; }
        
        /* Otimiza√ß√£o de renderiza√ß√£o do padr√£o de fundo */
        .wa-bg { 
            background-color: #E5DDD5;
            background-image: url("data:image/svg+xml,%3Csvg width='320' height='180' viewBox='0 0 320 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239CAFA3' fill-opacity='0.20' fill-rule='evenodd'%3E%3Ctext x='20' y='70' font-family='Arial, sans-serif' font-size='24' font-weight='bold' transform='rotate(-8 20 70)'%3Ewww.donaantonia.com.br%3C/text%3E%3Ctext x='80' y='150' font-family='Arial, sans-serif' font-size='24' font-weight='bold' transform='rotate(-8 80 150)'%3E65 99815-0975%3C/text%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        
        .msg-in { background-color: #FFFFFF; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg-out { background-color: #E7FFDB; border-radius: 8px 0 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        
        /* === PILLAR 3: Prote√ß√£o de Marca (CSS) === */
        .protected-img, .protected-msg, .card-cesta-new { 
            user-select: none; 
            -webkit-user-select: none; 
            -webkit-touch-callout: none;
            pointer-events: auto; /* Permite scroll */
        }
        img { pointer-events: none; } /* Bloqueia arrastar imagens */

        /* === BOT√ïES INTERATIVOS === */
        .msg-options { background-color: transparent; padding: 0; box-shadow: none; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; width: 85%; }
        .wa-btn {
            background-color: white; color: #008069; padding: 12px 16px; border-radius: 8px; width: 100%;
            text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.2s; border: 1px solid #f0f0f0;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .wa-btn:active { background-color: #f0f2f5; transform: scale(0.98); }
        .wa-btn-title { font-weight: 600; font-size: 15px; line-height: 1.2; }
        .wa-btn-subtitle { font-weight: 400; font-size: 11px; color: #667781; margin-top: 4px; line-height: 1.2; }

        /* === ANIMA√á√ïES === */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        @keyframes bounceRight { 0%, 100% { transform: translate(0, -50%); } 50% { transform: translate(6px, -50%); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === UTILIT√ÅRIOS === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* === ESTILOS DOS CARDS === */
        :root {
            --cor-destaque-dourado: #ffb300;
            --cor-texto-destaque: #0F2546;
            --cor-whatsapp: #25D366;
            --cor-destaque-vermelho: #ff5252;
        }

        .card-msg-container { width: 100%; max-width: 340px; margin-bottom: 5px; }

        .card-cesta-new {
            background: #fff; border-radius: 12px; border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column;
            position: relative;
        }

        /* NAVEGA√á√ÉO DO CARD UNIFICADO */
        .card-nav-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #fdfdfd; padding: 10px; border-bottom: 1px solid #eee;
        }
        .nav-arrow-btn {
            width: 40px; height: 40px; border-radius: 50%; background: #f0f2f5;
            display: flex; align-items: center; justify-content: center;
            color: #008069; cursor: pointer; border: 1px solid #ddd;
            transition: all 0.2s; font-size: 1.2rem;
        }
        .nav-arrow-btn:active { background: #e0e0e0; transform: scale(0.95); }
        .nav-title-display {
            font-weight: 800; color: #0F2546; font-size: 1.1rem; text-transform: uppercase;
            text-align: center; flex: 1;
        }

        .card-header-visual {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: #fff; padding: 0; border-bottom: 1px solid #f0f0f0; position: relative;
        }
        
        .card-img-container { width: 100%; padding: 15px; display: flex; justify-content: center; transition: opacity 0.3s; }
        .card-img-large {
            width: 180px; height: 180px; object-fit: cover; border-radius: 8px; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
        }

        .selo-destaque {
            position: absolute; top: 15px; right: 10px;
            background: linear-gradient(135deg, #ffb300, #FFB300);
            color: #0F2546; padding: 4px 10px; border-radius: 20px;
            font-weight: 800; font-size: 0.7rem; text-transform: uppercase; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Slider de Produtos */
        .product-slider-container { background: #f9fafb; padding: 15px 0; position: relative; transition: opacity 0.3s; }
        .product-slider {
            display: flex; overflow-x: auto; gap: 10px; padding: 0 15px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .product-slider::-webkit-scrollbar { height: 4px; }
        .product-slider::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        .product-slide {
            flex: 0 0 120px; min-height: 160px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 5px;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .product-slide img { width: 85px; height: 85px; object-fit: contain; margin-bottom: 8px; }
        .product-info { display: flex; flex-direction: column; line-height: 1.1; }
        .product-qty { font-size: 0.85rem; font-weight: 800; color: #0d5f46; margin-bottom: 3px; }
        .product-name { font-size: 0.75rem; color: #444; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .slider-arrow-indicator {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9); border: 2px solid #25D366; border-radius: 50%;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 20; animation: bounceRight 1.2s infinite;
            pointer-events: none; transition: opacity 0.3s;
        }

        /* Pre√ßos */
        .card-price-display-only { padding: 10px 15px; background: #fff; border-top: 1px solid #eee; transition: opacity 0.3s; }
        .price-item-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #555; }
        .price-item-row strong { color: #ff5252; }

        /* Discount Widget */
        .discount-container { background: #fff; border-radius: 8px; padding: 12px; border: 1px solid #e0e0e0; }
        .discount-table { width: 100%; font-size: 0.9rem; margin-bottom: 12px; }
        .discount-table td { padding: 4px 0; border-bottom: 1px dashed #eee; }
        .discount-table td:last-child { text-align: right; font-weight: bold; color: #166534; }
        
        .radio-discount { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .radio-discount.selected { background: #f0fdf4; border-color: #166534; }
        .radio-circle { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #ccc; position: relative; }
        .radio-discount.selected .radio-circle { border-color: #166534; }
        .radio-discount.selected .radio-circle::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; background: #166534; border-radius: 50%; }

        /* Card Empresa */
        .company-social-row { display: flex; justify-content: center; gap: 15px; padding: 10px; background: #f9f9f9; border-top: 1px solid #eee; }
        .company-social-btn { color: #555; font-size: 1.5rem; transition: color 0.2s; }
        .company-social-btn:hover { color: #008069; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" oncontextmenu="return false;">

    <!-- HEADER -->
    <header class="wa-header text-white p-3 flex items-center shadow-md z-30 shrink-0">
        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden mr-3 border border-white/30 relative shrink-0">
            <img src="img/logo.png" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo&backgroundColor=c0aede'" alt="Osvaldo" class="w-full h-full object-cover protected-img">
            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
        </div>
        <div class="flex-1 min-w-0">
            <h1 class="font-bold text-lg leading-tight truncate">Osvaldo - Cestas</h1>
            <p id="status-text" class="text-xs text-green-100/80 truncate">Online</p>
        </div>
        <div class="flex gap-4 text-xl shrink-0">
            <a href="https://instagram.com" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-instagram-logo"></i></a>
            <a href="#" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-globe"></i></a>
            <a href="https://wa.me/5565998150975" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-whatsapp-logo"></i></a>
        </div>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="wa-bg flex-1 overflow-y-auto p-4 space-y-3 relative scrolling-touch">
        <!-- Messages will appear here -->
    </main>

    <!-- INPUT AREA -->
    <footer id="input-footer" class="bg-[#F0F2F5] p-2 flex items-center gap-2 shrink-0 z-30 pb-safe">
        <div class="flex-1 bg-white rounded-full px-4 py-2 shadow-sm flex items-center">
            <input type="text" id="user-input" placeholder="Digite seu nome..." class="w-full outline-none text-base bg-transparent text-gray-800" autocomplete="off" inputmode="text">
        </div>
        <div id="send-btn" class="bg-[#008069] text-white rounded-full p-3 shadow-md cursor-pointer transition active:scale-95 flex items-center justify-center">
            <i class="ph-fill ph-paper-plane-right text-xl"></i>
        </div>
    </footer>

    <script>
        // PILLAR 3: DOMAIN CHECK & SECURITY
        (function() {
            const allowedDomains = ['donaantonia.com.br', 'www.donaantonia.com.br', 'localhost', '127.0.0.1', 'generativelanguage.net'];
            if (!allowedDomains.some(domain => window.location.hostname.endsWith(domain))) {
                console.warn('Security Alert: Domain mismatch');
            }
        })();

        // PILLAR 2: DATA LAYER SETUP
        window.dataLayer = window.dataLayer || [];
        function trackEvent(eventName, params = {}) {
            const eventData = {
                'event': eventName,
                'timestamp': new Date().toISOString(),
                ...params
            };
            window.dataLayer.push(eventData);
            console.log(`[Meta Pixel/API] ${eventName}:`, params);
        }

        // CONFIGURA√á√ÉO GERAL
        const CONFIG = {
            ownerName: "Osvaldo",
            whatsAppGroupLink: "https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1",
            whatsAppNumber: "5565998150975",
            instagramLink: "https://instagram.com/cestas.dona.antonia.cuiaba.vg"
        };

        // BASE DE DADOS ATUALIZADA COM DESCONTOS
        const CESTAS = [
            {
                id: 'grande', nome: 'Cesta Grande', desconto: 25, arrozQtd: 4, brindeNome: '1 OMO 800g',
                brindeImg: 'img/limpezaehigiente/sab√£o em p√≥ omo 800g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-grande.avif',
                items: ['4 Arroz Koblenz 5kg', '3 A√ß√∫car Doce Dia 2kg', '4 √ìleo de Soja Liza 900ml', '4 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '3 Espaguete QDelicia 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '4 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '4 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '380,00', valor_num: 380.00 }, { arroz: 'Koblenz', preco: '390,00', valor_num: 390.00 }]
            },
            {
                id: 'media', nome: 'Cesta M√©dia', desconto: 20, arrozQtd: 3, brindeNome: '1 Caf√© 250g',
                brindeImg: 'img/alimento/cafe caboclo 250g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-media.avif',
                items: ['3 Arroz Koblenz 5kg', '2 A√ß√∫car Doce Dia 2kg', '3 √ìleo de Soja Liza 900ml', '3 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '2 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '3 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '3 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '320,00', valor_num: 320.00 }, { arroz: 'Koblenz', preco: '325,00', valor_num: 325.00 }]
            },
            {
                id: 'pequena', nome: 'Cesta Pequena', desconto: 15, arrozQtd: 2, brindeNome: '1 Amaciante 2L',
                brindeImg: 'img/limpezaehigiente/amaciante ype 2L.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-pequena.avif',
                items: ['2 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '215,00', valor_num: 215.00 }, { arroz: 'Koblenz', preco: '220,00', valor_num: 220.00 }]
            },
            {
                id: 'mini', nome: 'Cesta Mini', desconto: 10, arrozQtd: 1, brindeNome: '1 Feij√£o 1kg',
                brindeImg: 'img/alimento/feij√£o da casa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-mini.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '1 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '165,00', valor_num: 165.00 }, { arroz: 'Koblenz', preco: '170,00', valor_num: 170.00 }]
            },
            {
                id: 'economica', nome: 'Cesta Econ√¥mica', destaque: 'Mais Vendida', desconto: 5, arrozQtd: 1, brindeNome: '1 Trigo 1kg',
                brindeImg: 'img/alimento/trigo vitoriosa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-economica.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '1 √ìleo de Soja Liza 900ml', '1 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Farinha Mandioca', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '1 Suco Frisco'],
                opcoes: [{ arroz: 'Valor √önico', preco: '85,00', valor_num: 85.00 }]
            }
        ];

        // --- SISTEMA DE CHAT ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const inputFooter = document.getElementById('input-footer');

        let state = { 
            step: 0, 
            userName: '', 
            clientDisplayName: '', 
            viewedBaskets: [],
            timerRef: null,
            currentBasketIndex: 0,
            selectedDiscountId: null
        };

        const getGreeting = () => {
            const h = new Date().getHours();
            return h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        };

        const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function calculateTypingTime(text) {
            const baseDelay = 800; 
            const charDelay = 20;
            return Math.min(baseDelay + (text.length * charDelay), 3000);
        }

        function addMessage(text, sender = 'bot', forceDelay = null) {
            return new Promise(resolve => {
                const typingTime = forceDelay !== null ? forceDelay : calculateTypingTime(text);
                const preTypingDelay = sender === 'bot' ? 500 : 0;

                setTimeout(() => {
                    if (sender === 'bot') {
                        statusText.innerText = 'Digitando...';
                        scrollToBottom();

                        const typingId = `typing-${Date.now()}`;
                        const typingHTML = `
                            <div id="${typingId}" class="flex justify-start w-full mb-2">
                                <div class="msg-in p-3 px-4 rounded-lg relative">
                                    <div class="flex gap-1 text-gray-400">
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', typingHTML);
                        scrollToBottom();

                        setTimeout(() => {
                            const typingEl = document.getElementById(typingId);
                            if(typingEl) typingEl.remove();
                            
                            const isCard = text.includes('card-cesta-new') || text.includes('discount-container') || text.includes('product-slider-container');
                            const bubbleClass = isCard ? 'p-1 bg-transparent shadow-none' : 'p-2 px-3 bg-white shadow-sm';
                            
                            const html = `
                                <div class="flex justify-start w-full mb-2 fade-in">
                                    <div class="msg-in ${bubbleClass} rounded-lg relative max-w-[95%] text-gray-800 text-[15px] leading-snug protected-msg">
                                        ${text}
                                        ${!isCard ? `<span class="block text-[10px] text-gray-400 text-right mt-1 -mr-1">${getCurrentTime()}</span>` : ''}
                                    </div>
                                </div>`;
                            chatContainer.insertAdjacentHTML('beforeend', html);
                            statusText.innerText = 'Online';
                            scrollToBottom();
                            resolve();
                        }, typingTime);
                    } else {
                        const html = `
                            <div class="flex justify-end w-full mb-2">
                                <div class="msg-out p-2 px-3 rounded-lg relative max-w-[85%] text-gray-800 text-[15px] leading-snug shadow-sm protected-msg">
                                    ${text}
                                    <span class="block text-[10px] text-[#97a892] text-right mt-1 -mr-1">
                                        ${getCurrentTime()} <i class="ph-bold ph-checks text-blue-500 ml-1"></i>
                                    </span>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', html);
                        scrollToBottom();
                        resolve();
                    }
                }, preTypingDelay);
            });
        }

        function showOptions(options) {
            setTimeout(() => {
                const optionsId = `opts-${Date.now()}`;
                let buttonsHTML = options.map(opt => `
                    <button onclick="handleOptionClick('${opt.text}', '${opt.value}', ${opt.nextStep}, '${optionsId}')" 
                            class="wa-btn text-left">
                        <span class="wa-btn-title">${opt.text}</span>
                        ${opt.subtext ? `<span class="wa-btn-subtitle">${opt.subtext}</span>` : ''}
                    </button>
                `).join('');

                const html = `
                    <div id="${optionsId}" class="flex justify-start w-full mb-2">
                        <div class="msg-options">
                            ${buttonsHTML}
                        </div>
                    </div>`;
                chatContainer.insertAdjacentHTML('beforeend', html);
                scrollToBottom();
            }, 800);
        }

        // --- SISTEMA DE NAVEGA√á√ÉO DO CARD UNIFICADO ---
        window.switchBasketCard = function(direction) {
            const container = document.getElementById('unified-card-content');
            if(!container) return;

            // Fade out
            const elementsToFade = container.querySelectorAll('.card-img-container, .product-slider-container, .card-price-display-only, .selo-destaque');
            elementsToFade.forEach(el => el.style.opacity = '0');

            setTimeout(() => {
                let newIndex = state.currentBasketIndex + direction;
                if(newIndex < 0) newIndex = CESTAS.length - 1;
                if(newIndex >= CESTAS.length) newIndex = 0;
                
                state.currentBasketIndex = newIndex;
                const cesta = CESTAS[newIndex];
                
                // Track interaction
                trackEvent('ViewContent', { content_name: cesta.nome });

                // Update DOM
                const titleEl = document.getElementById('card-nav-title');
                if(titleEl) titleEl.innerText = cesta.nome;

                // Regenerate content
                container.innerHTML = generateUnifiedInnerContent(cesta);
                
                // Fade in
                setTimeout(() => {
                    const newElements = container.querySelectorAll('.card-img-container, .product-slider-container, .card-price-display-only, .selo-destaque');
                    newElements.forEach(el => el.style.opacity = '1');
                }, 50);

            }, 250);
        };

        function getProductImage(text) {
            const lowerText = text.toLowerCase();
            let imgName = 'outros.png';
            let folder = 'img/alimento/';
            if(lowerText.includes('arroz')) imgName = 'Arroz Koblenz 5kg.webp';
            else if(lowerText.includes('a√ß√∫car')) imgName = 'a√ßucar doce dia 2 kg.webp';
            return `${folder}${imgName}`;
        }

        function parseProductItem(text) {
            const match = text.match(/^(\d+)\s+(.*)$/);
            const defaultImg = "https://placehold.co/80x80/eee/999?text=IMG";
            if(match) {
                const qty = parseInt(match[1]);
                const qtyText = qty > 1 ? `${qty} unidades` : `${qty} unidade`;
                return { qty: qtyText, name: match[2], img: getProductImage(match[2]), fallback: defaultImg }; 
            }
            return { qty: '1 unidade', name: text, img: getProductImage(text), fallback: defaultImg };
        }

        function generateUnifiedInnerContent(cesta) {
            const slidesHTML = cesta.items.map(item => {
                const parsed = parseProductItem(item);
                const fallbackImg = `https://placehold.co/80x80/eee/999?text=${parsed.name.substring(0,3).toUpperCase()}`;
                return `
                <div class="product-slide">
                    <img src="${parsed.img}" onerror="this.src='${fallbackImg}'" alt="${parsed.name}" loading="lazy">
                    <div class="product-info">
                        <span class="product-qty">${parsed.qty}</span>
                        <span class="product-name">${parsed.name}</span>
                    </div>
                </div>`;
            }).join('');
            
            const pricesHTML = cesta.opcoes.map(opt => `
                <div class="price-item-row">
                    <span>${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                    <strong>R$ ${opt.preco}</strong>
                </div>
            `).join('');

            return `
                <div class="card-header-visual">
                    ${cesta.destaque ? `<div class="selo-destaque fade-in">${cesta.destaque}</div>` : ''}
                    <div class="card-img-container fade-in">
                        <img src="${cesta.img}" class="card-img-large" alt="${cesta.nome}" loading="lazy">
                    </div>
                </div>
                
                <div class="product-slider-container fade-in">
                    <div class="slider-wrapper">
                        <div class="product-slider" onscroll="handleSlideScroll(this)">
                            ${slidesHTML}
                            <div style="min-width: 15px;"></div>
                        </div>
                        <div class="slider-arrow-indicator">
                            <i class="ph-bold ph-caret-right text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card-price-display-only fade-in">
                    ${pricesHTML}
                </div>
            `;
        }

        function generateUnifiedCardFrame(initialCesta) {
            return `
            <div class="card-msg-container">
                <div class="card-cesta-new">
                    <div class="card-nav-header">
                        <div class="nav-arrow-btn" onclick="switchBasketCard(-1)"><i class="ph-bold ph-caret-left"></i></div>
                        <div id="card-nav-title" class="nav-title-display">${initialCesta.nome}</div>
                        <div class="nav-arrow-btn" onclick="switchBasketCard(1)"><i class="ph-bold ph-caret-right"></i></div>
                    </div>
                    <div id="unified-card-content">
                        ${generateUnifiedInnerContent(initialCesta)}
                    </div>
                </div>
            </div>`;
        }

        // --- DISCOUNT WIDGET ---
        window.selectDiscount = function(id) {
            state.selectedDiscountId = id;
            document.querySelectorAll('.radio-discount').forEach(el => el.classList.remove('selected'));
            document.getElementById(`disc-${id}`).classList.add('selected');
        };

        window.submitDiscount = function() {
            if(!state.selectedDiscountId) return;
            const cesta = CESTAS.find(c => c.id === state.selectedDiscountId);
            const msg = `Ol√°! Sou ${state.clientDisplayName}. Escolhi a *${cesta.nome}* e quero garantir meu desconto de *R$ ${cesta.desconto},00* na primeira compra (V√°lido por 15 dias).`;
            
            trackEvent('Lead', { value: cesta.desconto, currency: 'BRL', content_name: 'Discount Claim' });
            window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            
            setTimeout(() => {
                state.step = 100;
                nextStepFlow();
            }, 1500);
        };

        function generateDiscountWidget() {
            const rows = CESTAS.map(c => `<tr><td>${c.nome}</td><td>- R$ ${c.desconto},00</td></tr>`).join('');
            const options = CESTAS.map(c => `
                <div id="disc-${c.id}" class="radio-discount" onclick="selectDiscount('${c.id}')">
                    <div class="radio-circle"></div>
                    <div class="flex-1 font-semibold text-gray-700">${c.nome}</div>
                    <div class="text-green-600 font-bold">-R$${c.desconto}</div>
                </div>
            `).join('');

            return `
            <div class="card-msg-container">
                <div class="discount-container">
                    <h3 class="text-center font-bold text-lg text-[#0F2546] mb-2"><i class="ph-fill ph-tag text-green-500"></i> TABELA DE DESCONTOS</h3>
                    <p class="text-xs text-center text-gray-500 mb-3">Exclusivo para primeira compra (Validade 15 dias)</p>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mb-4">
                        <table class="discount-table">
                            ${rows}
                        </table>
                    </div>

                    <p class="font-bold text-sm mb-2 text-gray-700">Qual cesta voc√™ quer?</p>
                    ${options}

                    <button onclick="submitDiscount()" class="w-full bg-[#008069] text-white font-bold py-3 rounded-lg mt-2 shadow-md hover:bg-[#006d59] active:scale-95 transition">
                        GARANTIR MEU DESCONTO <i class="ph-bold ph-whatsapp-logo ml-1"></i>
                    </button>
                </div>
            </div>`;
        }

        function generateCompanyCardHTML() {
            const slidesHTML = ['fachada.jpg', 'equipe.jpg', 'estoque.jpg'].map((foto, index) => {
                const imgPath = `img/empresa/${foto}`;
                const fallbackImg = `https://placehold.co/400x250/eee/999?text=Dona+Antonia+${index+1}`;
                return `
                <div class="product-slide" style="flex: 0 0 240px; border:none; box-shadow:none; min-height:auto;">
                    <img src="${imgPath}" onerror="this.src='${fallbackImg}'" style="width:100%; height:160px; object-fit:cover; border-radius:8px;" alt="Empresa" loading="lazy">
                </div>`;
            }).join('');

            return `
            <div class="card-msg-container">
                <div class="card-cesta-new">
                    <div class="card-header-visual" style="flex-direction:row;">
                        <img src="img/logo.png" style="width:70px; height:70px; border-radius:50%;" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo'">
                        <div class="card-title-right">
                            <h2 style="font-size:1.1rem">Dona Ant√¥nia Alimentos</h2>
                            <p style="font-size:0.8rem; color:#666;">Desde 2016 em Cuiab√° & VG</p>
                        </div>
                    </div>
                    <div class="product-slider-container" style="padding: 10px 0;">
                        <div class="slider-wrapper">
                            <div class="product-slider">
                                ${slidesHTML}
                                <div style="min-width: 15px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="company-social-row">
                        <a href="https://instagram.com" target="_blank" class="company-social-btn"><i class="ph ph-instagram-logo text-pink-600"></i></a>
                        <a href="https://facebook.com" target="_blank" class="company-social-btn"><i class="ph ph-facebook-logo text-blue-600"></i></a>
                        <a href="https://wa.me/${CONFIG.whatsAppNumber}" target="_blank" class="company-social-btn"><i class="ph ph-whatsapp-logo text-green-500"></i></a>
                    </div>
                </div>
            </div>`;
        }

        window.handleSlideScroll = function(element) {
            const wrapper = element.parentElement;
            const arrow = wrapper.querySelector('.slider-arrow-indicator');
            if (element.scrollLeft > 20) { if(arrow) arrow.style.opacity = '0'; } else { if(arrow) arrow.style.opacity = '1'; }
        };

        function handlePostClick() {
            setTimeout(() => {
                state.step = 100;
                nextStepFlow();
            }, 1500);
        }

        // --- L√ìGICA DO ROTEIRO (MAQUINA DE ESTADOS) ---
        window.onload = async () => {
            trackEvent('PageView');
            setTimeout(async () => {
                await addMessage(`${getGreeting()}! Tudo bem? üëã`, 'bot', 1000);
                await addMessage(`Aqui √© o <b>${CONFIG.ownerName}</b>, da Cesta B√°sica Econ√¥mica.`, 'bot', 1500);
                await addMessage(`Qual √© o seu primeiro nome?`, 'bot', 1200);
                userInput.focus();
            }, 500);
        };

        async function handleInput() {
            const text = userInput.value.trim();
            if (!text) return;

            if (state.step === 0) {
                const parts = text.split(/\s+/);
                state.userName = parts[0]; 
                state.clientDisplayName = parts.slice(0, 2).join(' ');

                trackEvent('Identify', { user_name: state.userName });

                state.step = 1;
                userInput.value = '';
                await addMessage(text, 'user');
                inputFooter.style.display = 'none';
                
                nextStepFlow();
            }
        }

        async function handleOptionClick(text, value, nextStep, containerId) {
            const container = document.getElementById(containerId);
            if(container) container.remove();

            await addMessage(text, 'user');
            state.step = nextStep;
            
            // Timer Reset logic se necess√°rio
            if(state.timerRef) clearTimeout(state.timerRef);

            nextStepFlow(value);
        }

        async function nextStepFlow(triggerValue) {
            const name = state.userName;
            if(state.timerRef) clearTimeout(state.timerRef);

            switch (state.step) {
                case 1: 
                    await addMessage(`Prazer, ${name}! üòÄ`);
                    await addMessage(`Voc√™ j√° conhece a Dona Ant√¥nia Alimentos?`);
                    showOptions([
                        { text: "Sim, j√° conhe√ßo üëç", value: "sim", nextStep: 3 },
                        { text: "N√£o conhe√ßo ü§î", value: "nao", nextStep: 2 }
                    ]);
                    break;

                case 2: // Mostra Empresa
                    await addMessage(generateCompanyCardHTML());
                    await addMessage(`Somos de Cuiab√°, com 8 anos de tradi√ß√£o entregando qualidade na sua mesa.`);
                    setTimeout(() => { state.step = 3; nextStepFlow(); }, 4000);
                    break;

                case 3: // Intro Showcase
                    await addMessage(`Vou te mostrar as nossas cestas. Voc√™ pode navegar entre elas aqui mesmo üëá`);
                    // Chama direto o Card Unificado
                    setTimeout(() => { state.step = 5; nextStepFlow(); }, 1500);
                    break;

                case 5: // Exibe Card UNIFICADO
                    state.currentBasketIndex = 0; // Come√ßa na Grande
                    await addMessage(generateUnifiedCardFrame(CESTAS[0]));
                    
                    trackEvent('ViewContent', { content_name: CESTAS[0].nome });

                    // TIMER DE RETEN√á√ÉO (30s)
                    // Se o usu√°rio n√£o fizer nada em 30s, o bot puxa assunto sobre pagamento
                    state.timerRef = setTimeout(() => {
                        state.step = 6;
                        nextStepFlow('timer_trigger');
                    }, 30000); 
                    break;

                case 6: // Pergunta Pagamento (Recupera√ß√£o)
                    if (triggerValue === 'timer_trigger') {
                        await addMessage(`Ei ${name}, ainda est√° por a√≠? üëÄ`);
                    }
                    await addMessage(`Posso te mostrar as formas de pagamento facilitadas?`);
                    showOptions([
                        { text: "Pode mostrar ‚úÖ", value: "show_payment", nextStep: 7 }
                    ]);
                    break;

                case 7: // Mostra Pagamento e PITCH DE DESCONTO
                    await addMessage(`Aceitamos praticamente tudo:`);
                    const listaPagamento = `
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Cart√£o de Cr√©dito e D√©bito</li>
                            <li>PIX ou Dinheiro na entrega</li>
                            <li>Vale Alimenta√ß√£o (Alelo, Sodexo, Pluxee, Caju, etc)</li>
                        </ul>`;
                    await addMessage(listaPagamento);
                    
                    // Pitch Final
                    setTimeout(async () => {
                        await addMessage(`üéÅ <b>PROMO√á√ÉO REL√ÇMPAGO</b>`);
                        await addMessage(`Para voc√™ fechar agora, liberei um cupom de desconto na sua primeira compra:`);
                        
                        await addMessage(generateDiscountWidget()); // Widget de Fechamento
                    }, 2000);
                    break;

                case 100: // Passo Final
                    await addMessage(`Perfeito! Aguarde que j√° vamos confirmar seu pedido no WhatsApp. üü¢`);
                    await addMessage(`Siga a gente no Instagram:`);
                    
                    const instaBtn = `
                        <div class="flex justify-center w-full mt-2 mb-4">
                            <a href="${CONFIG.instagramLink}" target="_blank" onclick="trackEvent('SocialClick')"
                               class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 hover:opacity-90 transition transform hover:scale-105 no-underline">
                                <i class="ph-bold ph-instagram-logo text-2xl"></i>
                                Seguir no Instagram
                            </a>
                        </div>`;
                    chatContainer.insertAdjacentHTML('beforeend', instaBtn);
                    scrollToBottom();
                    break;
            }
        }

        sendBtn.addEventListener('click', handleInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleInput();
        });
    </script>
</body>
</html>
