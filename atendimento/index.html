<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cesta Econ√¥mica | Fale com o Osvaldo</title>
    <meta name="theme-color" content="#008069">

    <!-- OTIMIZA√á√ÉO: Preload de recursos cr√≠ticos -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SEGURAN√áA -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https: data:;">
    <meta http-equiv="X-Frame-Options" content="DENY">

    <style>
        /* === ESTILOS GERAIS DO WHATSAPP === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #E5DDD5; }
        
        .wa-header { background-color: #008069; }
        
        /* Background Pattern SVG Otimizado */
        .wa-bg { 
            background-color: #E5DDD5;
            background-image: url("data:image/svg+xml,%3Csvg width='320' height='180' viewBox='0 0 320 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239CAFA3' fill-opacity='0.20' fill-rule='evenodd'%3E%3Ctext x='20' y='70' font-family='Arial, sans-serif' font-size='24' font-weight='bold' transform='rotate(-8 20 70)'%3Ewww.donaantonia.com.br%3C/text%3E%3Ctext x='80' y='150' font-family='Arial, sans-serif' font-size='24' font-weight='bold' transform='rotate(-8 80 150)'%3E65 99815-0975%3C/text%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        
        .msg-in { background-color: #FFFFFF; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg-out { background-color: #E7FFDB; border-radius: 8px 0 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        
        /* === BOT√ïES INTERATIVOS === */
        .msg-options { background-color: transparent; padding: 0; box-shadow: none; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; width: 85%; }
        .wa-btn {
            background-color: white; color: #008069; padding: 12px 16px; border-radius: 8px; width: 100%;
            text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.2s; border: 1px solid #f0f0f0;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .wa-btn:active { background-color: #f0f2f5; transform: scale(0.98); }
        .wa-btn-title { font-weight: 600; font-size: 15px; line-height: 1.2; }
        .wa-btn-subtitle { font-weight: 400; font-size: 11px; color: #667781; margin-top: 4px; line-height: 1.2; }

        /* === ANIMA√á√ïES === */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        @keyframes pulseHint { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes bounceRight { 0%, 100% { transform: translate(0, -50%); } 50% { transform: translate(6px, -50%); } }

        /* === UTILIT√ÅRIOS === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .protected-img, .protected-msg { user-select: none; -webkit-user-select: none; }

        /* === ESTILOS DOS CARDS DE PRODUTO === */
        :root {
            --cor-destaque-dourado: #ffb300;
            --cor-texto-destaque: #0F2546;
            --cor-whatsapp: #25D366;
            --cor-destaque-vermelho: #ff5252;
        }

        .card-msg-container { width: 100%; max-width: 340px; margin-bottom: 5px; }

        .card-cesta-new {
            background: #fff; border-radius: 12px; border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column;
        }

        /* Header do Card (Foto + T√≠tulo) */
        .card-header-visual {
            display: flex; flex-direction: row; align-items: center;
            background: #fff; padding: 10px; border-bottom: 1px solid #f0f0f0; position: relative;
        }
        .card-img-left {
            width: 135px; height: 135px; object-fit: cover; border-radius: 8px; flex-shrink: 0; border: 1px solid #eee;
        }
        .card-title-right {
            flex-grow: 1; padding-left: 15px; display: flex; flex-direction: column; justify-content: center;
        }
        .card-title-right h2 {
            font-size: 1.2rem; margin: 0; color: #0F2546; font-weight: 800; text-transform: uppercase; letter-spacing: -0.5px; line-height: 1.2;
        }
        .selo-destaque {
            position: absolute; top: -5px; right: 10px;
            background: linear-gradient(135deg, #ffb300, #FFB300);
            color: #0F2546; padding: 4px 10px; border-radius: 0 0 10px 10px;
            font-weight: 800; font-size: 0.65rem; text-transform: uppercase; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Slider de Produtos */
        .product-slider-container { background: #f9fafb; padding: 15px 0; position: relative; }
        .product-slider {
            display: flex; overflow-x: auto; gap: 12px; padding: 0 15px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .product-slider::-webkit-scrollbar { height: 4px; }
        .product-slider::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        .product-slide {
            flex: 0 0 110px; display: flex; flex-direction: column; align-items: center;
            background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 5px;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .product-slide img { width: 65px; height: 65px; object-fit: contain; margin-bottom: 8px; }
        .product-info { display: flex; flex-direction: column; line-height: 1.1; }
        .product-qty { font-size: 0.85rem; font-weight: 800; color: #25D366; margin-bottom: 3px; }
        .product-name { font-size: 0.75rem; color: #444; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Indicadores de Scroll */
        .scroll-hint {
            background-color: #fff8dc; color: #b45309; font-size: 0.75rem; font-weight: 800;
            text-align: center; padding: 8px; margin: 0 10px 8px 10px; border-radius: 6px;
            border: 1px dashed #fcd34d; display: flex; align-items: center; justify-content: center;
            gap: 6px; animation: pulseHint 2s infinite;
        }
        .slider-arrow-indicator {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9); border: 2px solid #25D366; border-radius: 50%;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 20; animation: bounceRight 1.2s infinite;
            pointer-events: none; transition: opacity 0.3s;
        }

        /* Lista de Pre√ßos (Visualiza√ß√£o) */
        .card-price-display-only { padding: 10px 15px; background: #fff; border-top: 1px solid #eee; }
        .price-item-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #555; }
        .price-item-row strong { color: #ff5252; }

        /* Widget de Encomenda (Op√ß√µes de Arroz) */
        .order-widget {
            background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #25D366; margin-top: 5px;
        }
        .order-widget h3 { font-size: 1rem; font-weight: 700; color: #0F2546; margin-bottom: 10px; text-align: center; }

        .radio-arroz-option {
            display: flex; flex-direction: row; align-items: center; justify-content: space-between;
            padding: 12px 15px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; background: white; transition: all 0.2s;
        }
        .radio-arroz-option:active { transform: scale(0.98); }
        .radio-arroz-option.selected { border-color: #25D366; background: #f0fff4; }
        
        .radio-arroz-info { display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%; padding-right: 15px; }
        .radio-arroz-name { font-weight: 600; font-size: 0.9rem; color: #333; }
        .radio-arroz-price { color: #ff5252; font-weight: 800; font-size: 1rem; }
        
        .btn-encomendar-card {
            width: 100%; background-color: #25D366; color: white; border: none; padding: 14px;
            border-radius: 8px; font-size: 1rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 10px; box-shadow: 0 3px 0 #189d4b; transition: transform 0.1s;
        }
        .btn-encomendar-card:active { transform: translateY(3px); box-shadow: none; }

        /* Card Empresa */
        .company-social-row { display: flex; justify-content: center; gap: 15px; padding: 10px; background: #f9f9f9; border-top: 1px solid #eee; }
        .company-social-btn { color: #555; font-size: 1.5rem; transition: color 0.2s; }
        .company-social-btn:hover { color: #008069; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" oncontextmenu="return false;">

    <!-- HEADER -->
    <header class="wa-header text-white p-3 flex items-center shadow-md z-30 shrink-0">
        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden mr-3 border border-white/30 relative shrink-0">
            <img src="img/logo.png" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo&backgroundColor=c0aede'" alt="Osvaldo" class="w-full h-full object-cover protected-img">
            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
        </div>
        <div class="flex-1 min-w-0">
            <h1 class="font-bold text-lg leading-tight truncate">Osvaldo - Cestas</h1>
            <p id="status-text" class="text-xs text-green-100/80 truncate">Online</p>
        </div>
        <div class="flex gap-4 text-xl shrink-0">
            <a href="https://instagram.com" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-instagram-logo"></i></a>
            <a href="#" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-globe"></i></a>
            <a href="https://wa.me/5565998150975" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-whatsapp-logo"></i></a>
        </div>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="wa-bg flex-1 overflow-y-auto p-4 space-y-3 relative scrolling-touch">
        <!-- Messages area -->
    </main>

    <!-- INPUT AREA -->
    <footer id="input-footer" class="bg-[#F0F2F5] p-2 flex items-center gap-2 shrink-0 z-30 pb-safe">
        <div class="flex-1 bg-white rounded-full px-4 py-2 shadow-sm flex items-center">
            <input type="text" id="user-input" placeholder="Digite seu nome..." class="w-full outline-none text-base bg-transparent text-gray-800" autocomplete="off">
        </div>
        <div id="send-btn" class="bg-[#008069] text-white rounded-full p-3 shadow-md cursor-pointer transition active:scale-95 flex items-center justify-center">
            <i class="ph-fill ph-paper-plane-right text-xl"></i>
        </div>
    </footer>

    <script>
        // CONFIGURA√á√ÉO GERAL
        const CONFIG = {
            ownerName: "Osvaldo",
            whatsAppGroupLink: "https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1",
            whatsAppNumber: "5565998150975"
        };

        if (window.self !== window.top) window.top.location.href = window.self.location.href;

        // BASE DE DADOS
        const CESTAS = [
            {
                id: 'grande', nome: 'Cesta Grande', arrozQtd: 4, brindeNome: '1 OMO 800g',
                brindeImg: 'img/limpeza/sab√£o em p√≥ omo 800g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-grande.avif',
                items: ['4 Arroz Koblenz 5kg', '3 A√ß√∫car Doce Dia 2kg', '4 √ìleo de Soja Liza 900ml', '4 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '3 Espaguete QDelicia 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '4 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '4 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '380,00' }, { arroz: 'Koblenz', preco: '390,00' }]
            },
            {
                id: 'media', nome: 'Cesta M√©dia', arrozQtd: 3, brindeNome: '1 Caf√© 250g',
                brindeImg: 'img/alimento/cafe caboclo 250g.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-media.avif',
                items: ['3 Arroz Koblenz 5kg', '2 A√ß√∫car Doce Dia 2kg', '3 √ìleo de Soja Liza 900ml', '3 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 500g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '2 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '2 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '3 Suco Frisco', '1 Sab√£o Barra Ype 900g', '2 Creme Dental Sorriso 70g', '2 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '3 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '320,00' }, { arroz: 'Koblenz', preco: '325,00' }]
            },
            {
                id: 'pequena', nome: 'Cesta Pequena', arrozQtd: 2, brindeNome: '1 Amaciante 2L',
                brindeImg: 'img/limpeza/amaciante ype 2L.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-pequena.avif',
                items: ['2 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '12 Ovos', '1 Bolo Apti Chocolate 400g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Tempero Tio Jonas', '2 Bolacha MyBit Recheada', '2 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '2 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '215,00' }, { arroz: 'Koblenz', preco: '220,00' }]
            },
            {
                id: 'mini', nome: 'Cesta Mini', arrozQtd: 1, brindeNome: '1 Feij√£o 1kg',
                brindeImg: 'img/alimento/feij√£o da casa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-mini.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '2 √ìleo de Soja Liza 900ml', '2 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '2 Suco Frisco', '1 Sab√£o Barra Ype 900g', '1 Creme Dental Sorriso 70g', '1 Papel Higi√™nico', '1 Amaciante Ype 2L', '1 Desinfetante Remmus 2L', '1 Sab√£o em P√≥ OMO 800g', '1 Detergente Ype 500ml', '1 Qboa 1 Litro', '2 Sabonete Palmolive 85g', '1 L√£ de A√ßo Assolan', '1 Esponja de Lavar Lou√ßa'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '165,00' }, { arroz: 'Koblenz', preco: '170,00' }]
            },
            {
                id: 'economica', nome: 'Cesta Econ√¥mica', destaque: 'Mais Vendida', arrozQtd: 1, brindeNome: '1 Trigo 1kg',
                brindeImg: 'img/alimento/trigo vitoriosa.webp',
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-economica.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '1 √ìleo de Soja Liza 900ml', '1 Feij√£o Da Casa 1kg', '1 Caf√© Caboclo 250g', '1 Espaguete QDelicia 500g', '1 Trigo Vitoriosa 1kg', '1 Farinha Mandioca', '1 Sal 1kg', '1 Molho Fugini 340g', '1 Milho Verde Predileta', '1 Bolacha MyBit Recheada', '1 Miojo Apti', '1 Suco Frisco'],
                opcoes: [{ arroz: 'Valor √önico', preco: '85,00' }]
            }
        ];

        // --- SISTEMA DE CHAT ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const inputFooter = document.getElementById('input-footer');

        let state = { 
            step: 0, 
            userName: '', 
            clientDisplayName: '', 
            viewedBaskets: [],
            timerRef: null,
            currentBasketId: null,
            giftShown: false
        };

        const getGreeting = () => {
            const h = new Date().getHours();
            return h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        };

        const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function calculateTypingTime(text) {
            const baseDelay = 1000;
            const charDelay = 30;
            return Math.min(baseDelay + (text.length * charDelay), 4000);
        }

        // Adiciona mensagens ao chat
        function addMessage(text, sender = 'bot', forceDelay = null) {
            return new Promise(resolve => {
                const typingTime = forceDelay !== null ? forceDelay : calculateTypingTime(text);
                const preTypingDelay = sender === 'bot' ? 600 : 0;

                setTimeout(() => {
                    if (sender === 'bot') {
                        statusText.innerText = 'Digitando...';
                        scrollToBottom();

                        const typingId = `typing-${Date.now()}`;
                        const typingHTML = `
                            <div id="${typingId}" class="flex justify-start w-full mb-2">
                                <div class="msg-in p-3 px-4 rounded-lg relative">
                                    <div class="flex gap-1 text-gray-400">
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', typingHTML);
                        scrollToBottom();

                        setTimeout(() => {
                            const typingEl = document.getElementById(typingId);
                            if(typingEl) typingEl.remove();
                            
                            const isCard = text.includes('card-cesta-new') || text.includes('order-widget') || text.includes('product-slider-container');
                            const bubbleClass = isCard ? 'p-1 bg-transparent shadow-none' : 'p-2 px-3 bg-white shadow-sm';
                            
                            const html = `
                                <div class="flex justify-start w-full mb-2 fade-in">
                                    <div class="msg-in ${bubbleClass} rounded-lg relative max-w-[95%] text-gray-800 text-[15px] leading-snug protected-msg">
                                        ${text}
                                        ${!isCard ? `<span class="block text-[10px] text-gray-400 text-right mt-1 -mr-1">${getCurrentTime()}</span>` : ''}
                                    </div>
                                </div>`;
                            chatContainer.insertAdjacentHTML('beforeend', html);
                            statusText.innerText = 'Online';
                            scrollToBottom();
                            resolve();
                        }, typingTime);
                    } else {
                        const html = `
                            <div class="flex justify-end w-full mb-2">
                                <div class="msg-out p-2 px-3 rounded-lg relative max-w-[85%] text-gray-800 text-[15px] leading-snug shadow-sm protected-msg">
                                    ${text}
                                    <span class="block text-[10px] text-[#97a892] text-right mt-1 -mr-1">
                                        ${getCurrentTime()} <i class="ph-bold ph-checks text-blue-500 ml-1"></i>
                                    </span>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', html);
                        scrollToBottom();
                        resolve();
                    }
                }, preTypingDelay);
            });
        }

        function showOptions(options) {
            setTimeout(() => {
                const optionsId = `opts-${Date.now()}`;
                let buttonsHTML = options.map(opt => `
                    <button onclick="handleOptionClick('${opt.text}', '${opt.value}', ${opt.nextStep}, '${optionsId}')" 
                            class="wa-btn text-left">
                        <span class="wa-btn-title">${opt.text}</span>
                        ${opt.subtext ? `<span class="wa-btn-subtitle">${opt.subtext}</span>` : ''}
                    </button>
                `).join('');

                const html = `
                    <div id="${optionsId}" class="flex justify-start w-full mb-2">
                        <div class="msg-options">
                            ${buttonsHTML}
                        </div>
                    </div>`;
                chatContainer.insertAdjacentHTML('beforeend', html);
                scrollToBottom();
            }, 800);
        }

        // Fun√ß√µes para manipula√ß√£o dos Cards
        window.selectRice = function(id, nome, preco) {
            const btn = document.getElementById(`btn-pedir-${id}`);
            const allOpts = document.querySelectorAll(`#widget-${id} .radio-arroz-option`);
            allOpts.forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            btn.innerHTML = `<i class="fa-brands fa-whatsapp"></i> Pedir Agora`;
            btn.onclick = () => {
                const msg = `Ol√°! Aqui √© o ${state.clientDisplayName}. Quero encomendar a *Cesta ${id.toUpperCase()}* com *Arroz ${nome}* por *R$ ${preco}*.`;
                window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        };

        window.handleSlideScroll = function(element) {
            const wrapper = element.parentElement;
            const arrow = wrapper.querySelector('.slider-arrow-indicator');
            if (element.scrollLeft > 20) { if(arrow) arrow.style.opacity = '0'; } else { if(arrow) arrow.style.opacity = '1'; }
            
            if (state.cardHasInteracted) return; 
            if (element.scrollLeft + element.clientWidth >= element.scrollWidth - 30) {
                triggerPostCardFlow();
            }
        };

        function triggerPostCardFlow() {
            if (state.cardHasInteracted) return;
            state.cardHasInteracted = true;
            clearTimeout(state.cardInteractionTimer);
            showPostCardMessages();
        }

        async function showPostCardMessages() {
            const cestaAtual = CESTAS.find(c => c.id === state.currentBasketId);
            const nomeCesta = cestaAtual ? cestaAtual.nome : 'esta cesta';

            await addMessage(`O que quer fazer agora?`, 'bot');

            const opcoes = [
                { text: `Encomendar a ${nomeCesta} ‚úÖ`, value: "encomendar_atual", nextStep: 6 },
                { text: "Ver outras cestas üîÑ", value: "ver_outra", nextStep: 4 }, // Volta para o menu (lista)
                { text: "Quem somos n√≥s? üè¢", value: "quem_somos", nextStep: 7 },
                { text: "Ver formas de pagamento üí≥", value: "pagamento", nextStep: 6 }
            ];

            showOptions(opcoes);
        }

        // L√≥gica de mapeamento de imagens
        function getProductImage(text) {
            const lowerText = text.toLowerCase();
            let imgName = 'outros.png';
            let folder = 'img/alimento/';

            if(lowerText.includes('arroz')) imgName = 'Arroz Koblenz 5kg.webp';
            else if(lowerText.includes('a√ß√∫car') || lowerText.includes('acucar')) imgName = 'a√ßucar doce dia 2 kg.webp';
            else if(lowerText.includes('bolacha')) imgName = 'bolacha mybit.webp';
            else if(lowerText.includes('bolo') || lowerText.includes('mistura')) imgName = 'bolo apti chocolate.webp';
            else if(lowerText.includes('caf√©') || lowerText.includes('cafe') || lowerText.includes('caboclo')) {
                if(lowerText.includes('500g')) imgName = 'cafe caboclo 500g.webp';
                else imgName = 'cafe caboclo 250g.webp';
            }
            else if(lowerText.includes('espaguete')) imgName = 'espaguete qdelicia.webp';
            else if(lowerText.includes('esponja de a√ßo') || lowerText.includes('l√£ de a√ßo') || lowerText.includes('assolan')) {
                imgName = 'l√£ de a√ßo assolan.webp';
                folder = 'img/limpeza/';
            }
            else if(lowerText.includes('esponja')) { imgName = 'esponja de lavar lou√ßa.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('feij√£o') || lowerText.includes('feijao')) imgName = 'feij√£o da casa.webp';
            else if(lowerText.includes('milho')) imgName = 'milho verde predileta.webp';
            else if(lowerText.includes('miojo')) imgName = 'miojo apti.webp';
            else if(lowerText.includes('molho')) imgName = 'molho fugini.webp';
            else if(lowerText.includes('oleo') || lowerText.includes('√≥leo')) imgName = 'oleo de soja liza.webp';
            else if(lowerText.includes('ovo')) imgName = 'ovo duzia.jpg';
            else if(lowerText.includes('sal')) imgName = 'sal.webp';
            else if(lowerText.includes('suco')) imgName = 'suco frisco.webp';
            else if(lowerText.includes('tempero')) imgName = 'tempero tio jonas.jpg';
            else if(lowerText.includes('trigo')) imgName = 'trigo vitoriosa.webp';
            
            else if(lowerText.includes('creme dental')) { imgName = 'Creme Dental Sorriso 70g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('desinfetante')) { imgName = 'Desinfetante Remmus 2L.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('detergente')) { imgName = 'Detergente Ype 500ml.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('qboa')) { imgName = 'Qboa 1 Litro.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('amaciante')) { imgName = 'amaciante ype 2L.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sabonete')) { imgName = 'sabonete palmolive 85g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sab√£o barra') || lowerText.includes('sabao barra')) { imgName = 'sab√£o barra ype 900g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sab√£o p√≥') || lowerText.includes('sab√£o em p√≥') || lowerText.includes('omo')) { imgName = 'sab√£o em p√≥ omo 800g.webp'; folder = 'img/limpeza/'; }

            return `${folder}${imgName}`;
        }

        function parseProductItem(text) {
            const match = text.match(/^(\d+)\s+(.*)$/);
            if(match) {
                const qty = parseInt(match[1]);
                const qtyText = qty > 1 ? `${qty} unidades` : `${qty} unidade`;
                return { qty: qtyText, name: match[2], img: getProductImage(match[2] + (text.includes('500g') ? ' 500g' : '')) }; 
            }
            return { qty: '1 unidade', name: text, img: getProductImage(text) };
        }

        function generateCardHTML(cesta) {
            const slidesHTML = cesta.items.map(item => {
                const parsed = parseProductItem(item);
                const fallbackImg = `https://placehold.co/80x80/eee/999?text=${parsed.name.substring(0,3).toUpperCase()}`;
                return `
                <div class="product-slide">
                    <img src="${parsed.img}" onerror="this.src='${fallbackImg}'" alt="${parsed.name}">
                    <div class="product-info">
                        <span class="product-qty">${parsed.qty}</span>
                        <span class="product-name">${parsed.name}</span>
                    </div>
                </div>`;
            }).join('');
            
            const pricesHTML = cesta.opcoes.map(opt => `
                <div class="price-item-row">
                    <span>${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                    <strong>R$ ${opt.preco}</strong>
                </div>
            `).join('');

            return `
            <div class="card-msg-container">
                <div class="card-cesta-new">
                    <div class="card-header-visual">
                        ${cesta.destaque ? `<div class="selo-destaque">${cesta.destaque}</div>` : ''}
                        <img src="${cesta.img}" class="card-img-left" alt="${cesta.nome}">
                        <div class="card-title-right">
                            <h2>${cesta.nome}</h2>
                        </div>
                    </div>
                    <div class="product-slider-container">
                        <div class="scroll-hint">
                            <i class="ph-bold ph-hand-swipe-left text-lg"></i> 
                            ARRASTE PARA O LADO <i class="ph-bold ph-arrow-right"></i>
                        </div>
                        <div class="slider-wrapper">
                            <div class="product-slider" onscroll="handleSlideScroll(this)">
                                ${slidesHTML}
                                <div style="min-width: 15px;"></div>
                            </div>
                            <div class="slider-arrow-indicator">
                                <i class="ph-bold ph-caret-right text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-price-display-only">
                        ${pricesHTML}
                    </div>
                </div>
            </div>`;
        }

        function generateCompanyCardHTML() {
            const fotosEmpresa = ['fachada.jpg', 'equipe.jpg', 'estoque.jpg']; 
            const slidesHTML = fotosEmpresa.map((foto, index) => {
                const imgPath = `img/empresa/${foto}`;
                const fallbackImg = `https://placehold.co/400x250/eee/999?text=Dona+Antonia+${index+1}`;
                return `
                <div class="product-slide" style="flex: 0 0 240px; border:none; box-shadow:none;">
                    <img src="${imgPath}" onerror="this.src='${fallbackImg}'" style="width:100%; height:160px; object-fit:cover; border-radius:8px;" alt="Empresa">
                </div>`;
            }).join('');

            return `
            <div class="card-msg-container">
                <div class="card-cesta-new">
                    <div class="card-header-visual">
                        <img src="img/logo.png" class="card-img-left" style="width:70px; height:70px;" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo'">
                        <div class="card-title-right">
                            <h2 style="font-size:1.1rem">Dona Ant√¥nia Alimentos</h2>
                            <p style="font-size:0.8rem; color:#666;">Desde 2016 em Cuiab√° & VG</p>
                        </div>
                    </div>
                    <div class="product-slider-container" style="padding: 10px 0;">
                        <div class="slider-wrapper">
                            <div class="product-slider">
                                ${slidesHTML}
                                <div style="min-width: 15px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="company-social-row">
                        <a href="https://instagram.com" target="_blank" class="company-social-btn"><i class="ph ph-instagram-logo text-pink-600"></i></a>
                        <a href="https://facebook.com" target="_blank" class="company-social-btn"><i class="ph ph-facebook-logo text-blue-600"></i></a>
                        <a href="https://wa.me/${CONFIG.whatsAppNumber}" target="_blank" class="company-social-btn"><i class="ph ph-whatsapp-logo text-green-500"></i></a>
                    </div>
                </div>
            </div>`;
        }

        // Carrossel de Brindes
        function generateGiftCarouselHTML() {
            const gifts = CESTAS.map(c => ({ cesta: c.nome, nome: c.brindeNome, img: c.brindeImg }));
            const slidesHTML = gifts.map(gift => {
                const fallbackImg = `https://placehold.co/120x120/eee/999?text=${gift.nome.split(' ')[1]}`;
                return `
                <div class="product-slide" style="flex: 0 0 140px; border-color: #fcd34d;">
                    <img src="${gift.img}" onerror="this.src='${fallbackImg}'" style="width:70px; height:70px; margin-bottom:5px;">
                    <div class="product-info">
                        <span style="font-size:0.7rem; color:#666; margin-bottom:2px;">${gift.cesta}</span>
                        <span style="font-size:0.85rem; font-weight:800; color:#008069; line-height:1.1;">${gift.nome}</span>
                    </div>
                </div>`;
            }).join('');

            return `
            <div class="card-msg-container" style="margin-top:5px;">
                <div class="card-cesta-new" style="border: 2px solid #fcd34d;">
                    <div style="background:#fffbeb; padding:10px; text-align:center; border-bottom:1px solid #fcd34d;">
                        <h3 style="font-size:0.95rem; font-weight:800; color:#b45309; margin:0;"><i class="ph-fill ph-gift"></i> BRINDES NA 1¬™ COMPRA</h3>
                    </div>
                    <div class="product-slider-container" style="background:#fff; padding:15px 0;">
                        <div class="slider-wrapper">
                            <div class="product-slider">
                                ${slidesHTML}
                                <div style="min-width: 15px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function generateOrderWidget(cesta) {
            const riceOptionsHTML = cesta.opcoes.map(opt => `
                <div class="radio-arroz-option" onclick="selectRice('${cesta.id}', '${opt.arroz}', '${opt.preco}')">
                    <div class="radio-arroz-info">
                        <span class="radio-arroz-name">${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                        <span class="radio-arroz-price">R$ ${opt.preco}</span>
                    </div>
                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                         <div class="w-3 h-3 bg-green-500 rounded-full hidden selection-dot"></div>
                    </div>
                </div>
            `).join('');

            return `
            <div class="card-msg-container">
                <div id="widget-${cesta.id}" class="order-widget">
                    <h3>Finalize seu pedido da ${cesta.nome}:</h3>
                    <p style="margin-bottom: 10px; font-size: 0.85rem; color:#666; text-align: center;">Escolha o arroz abaixo:</p>
                    ${riceOptionsHTML}
                    <button id="btn-pedir-${cesta.id}" class="btn-encomendar-card">
                        <i class="fa-brands fa-whatsapp"></i> Escolha o Arroz
                    </button>
                </div>
            </div>`;
        }

        // --- L√ìGICA DO ROTEIRO (MAQUINA DE ESTADOS) ---
        window.onload = async () => {
            setTimeout(async () => {
                await addMessage(`${getGreeting()}! Tudo bem? üëã`, 'bot', 1000);
                await addMessage(`Aqui √© o <b>${CONFIG.ownerName}</b>, da Cesta B√°sica Econ√¥mica.`, 'bot', 1500);
                await addMessage(`Qual √© o seu primeiro nome?`, 'bot', 1200);
                userInput.focus();
            }, 500);
        };

        async function handleInput() {
            const text = userInput.value.trim();
            if (!text) return;

            if (state.step === 0) {
                const parts = text.split(/\s+/);
                state.userName = parts[0]; 
                state.clientDisplayName = parts.slice(0, 2).join(' ');

                state.step = 1;
                userInput.value = '';
                await addMessage(text, 'user');
                inputFooter.style.display = 'none';
                
                nextStepFlow();
            }
        }

        async function handleOptionClick(text, value, nextStep, containerId) {
            const container = document.getElementById(containerId);
            if(container) container.remove();

            await addMessage(text, 'user');
            state.step = nextStep;

            // Se for sele√ß√£o de cesta da lista
            if (state.step === 5 && value.startsWith('select_cesta_')) {
                const index = parseInt(value.split('_')[2]);
                // Armazena ID para l√≥gica futura
                state.suggestedIndex = index; // Usa variavel generica para guardar indice
            }

            // Se for bot√£o "Ver Cestas" do menu final ou intermediario
            if (value === 'menu_cestas' || value === 'ver_outra') {
                state.step = 4; // For√ßa ida para a Lista (Step 4)
                nextStepFlow('loop_cestas'); // Trigger para mensagem customizada
                return; 
            }

            // Se for decis√£o de brinde
            if (value === 'salvar_brinde') {
                window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=Ol√°! Salvei seu contato e quero garantir meu brinde!`, '_blank');
                // Assume inten√ß√£o de compra futura ou imediata
                state.step = 99; // Finaliza ou mantem
            }

            nextStepFlow(value);
        }

        async function nextStepFlow(triggerValue) {
            const name = state.userName;
            if(state.timerRef) clearTimeout(state.timerRef);

            switch (state.step) {
                case 1: 
                    await addMessage(`Prazer, ${name}! üòÄ`);
                    await addMessage(`Voc√™ j√° conhece a Dona Ant√¥nia Alimentos?`);
                    showOptions([
                        { text: "Sim, j√° conhe√ßo üëç", value: "sim", nextStep: 3 },
                        { text: "N√£o conhe√ßo ü§î", value: "nao", nextStep: 2 }
                    ]);
                    break;

                case 2: // Mostra Empresa
                    await addMessage(generateCompanyCardHTML());
                    await addMessage(`Somos de Cuiab√°, com 8 anos de tradi√ß√£o entregando qualidade na sua mesa.`);
                    setTimeout(() => { state.step = 3; nextStepFlow(); }, 4000);
                    break;

                case 3: // Intro Showcase
                    await addMessage(`Vou te mostrar as nossas cestas pra voc√™ conhecer.`);
                    showOptions([{ text: "OK, mostrar cestas", value: "ok", nextStep: 4 }]);
                    break;

                case 4: // Menu de Cestas (Lista)
                    if (triggerValue === 'loop_cestas') await addMessage(`D√° uma olhada nas outras op√ß√µes üëá`);
                    
                    let opcoesCestas = [];
                    CESTAS.forEach((c, i) => {
                        // Filtra se j√° viu, mas se viu todas reseta a l√≥gica visual apenas se necess√°rio
                        // Requisito: "manda novamente a lista menos a que ja foi vista"
                        if (!state.viewedBaskets.includes(c.id)) {
                            opcoesCestas.push({
                                text: c.nome,
                                subtext: `(${c.arrozQtd} pacote${c.arrozQtd > 1 ? 's' : ''} de arroz)`,
                                value: `select_cesta_${i}`,
                                nextStep: 5 
                            });
                        }
                    });

                    // Se j√° viu todas, mostra todas novamente
                    if (opcoesCestas.length === 0) {
                        state.viewedBaskets = []; 
                        CESTAS.forEach((c, i) => {
                            opcoesCestas.push({
                                text: c.nome,
                                subtext: `(${c.arrozQtd} pacote${c.arrozQtd > 1 ? 's' : ''} de arroz)`,
                                value: `select_cesta_${i}`,
                                nextStep: 5
                            });
                        });
                    }

                    opcoesCestas.push({ text: "Formas de Pagamento üí≥", subtext: "Ver como pagar e brindes", value: "pagamento", nextStep: 6 });
                    showOptions(opcoesCestas);
                    break;

                case 5: // Exibe Card da Cesta
                    // Indice veio do handleOptionClick via state.suggestedIndex
                    const index = state.suggestedIndex !== null ? state.suggestedIndex : 0; 
                    const cesta = CESTAS[index];
                    
                    state.currentBasketId = cesta.id;
                    if(!state.viewedBaskets.includes(cesta.id)) state.viewedBaskets.push(cesta.id);

                    await addMessage(`Essa √© a <b>${cesta.nome}</b>:`);
                    await addMessage(generateCardHTML(cesta));

                    // Timer de 15 segundos
                    state.timerRef = setTimeout(() => {
                        state.step = 4;
                        nextStepFlow('loop_cestas');
                    }, 15000); 
                    break;

                case 6: // Pagamento e Brinde
                    if (state.giftShown) {
                        if (triggerValue === 'encomendar_atual') { state.step = 3; nextStepFlow(); return; }
                        if (triggerValue === 'pagamento') { state.step = 6; /* Fica aqui */ }
                    }
                    state.giftShown = true;

                    await addMessage(`Facilitamos o pagamento pra voc√™:`);
                    const listaPagamento = `
                        <ul class="list-disc pl-5 space-y-1">
                            <li><b>Cart√£o de Cr√©dito</b> em at√© 3x</li>
                            <li><b>Cart√£o de D√©bito</b></li>
                            <li><b>PIX</b> ou <b>Dinheiro</b> na entrega</li>
                            <li><b>Vale Alimenta√ß√£o/Refei√ß√£o:</b> Alelo, Sodexo, Pluxee, Caju, Flash, iFood...</li>
                            <li class="text-red-500 font-bold">N√£o vendemos pra 30 dias</li>
                        </ul>`;
                    await addMessage(listaPagamento);
                    
                    const alertMsg = `<div style="background-color:#fef9c3; color:#854d0e; padding:10px; border-radius:8px; text-align:center; font-weight:600; border:1px solid #fde047;">Aqui voc√™ s√≥ paga quando recebe a cesta na sua casa.</div>`;
                    await addMessage(alertMsg);

                    setTimeout(async () => {
                        await addMessage(`${name}, eu vou garantir um brinde pra quando voc√™ fizer a sua primeira compra.`);
                        await addMessage(generateGiftCarouselHTML());

                        showOptions([
                            { text: "Salvar contato e garantir brinde üéÅ", subtext: "Clique para confirmar no WhatsApp", value: "salvar_brinde", nextStep: 6 }, 
                            { text: "Ver as Cestas üõí", subtext: "Escolher outra op√ß√£o", value: "menu_cestas", nextStep: 4 }, // Vai pro menu
                            { text: "Entrar no Grupo VIP üöÄ", subtext: "Ofertas rel√¢mpago", value: "vip", nextStep: 99 }
                        ]);
                    }, 2000);
                    break;

                case 7: // Quem Somos (Menu Extra se necess√°rio)
                    await addMessage(`Que bom que voc√™ quer saber mais sobre a gente! ü§ù`);
                    await addMessage(generateCompanyCardHTML());
                    await addMessage(`Somos de Cuiab√°, com 8 anos de tradi√ß√£o entregando qualidade na sua mesa.`);
                    await addMessage(`E a√≠, vamos aproveitar?`, 'bot', 2000);
                    showOptions([
                        { text: "Ganhar meu Brinde üéÅ", value: "salvar_brinde", nextStep: 6 },
                        { text: "Ver as Cestas novamente üõí", value: "menu_cestas", nextStep: 4 }
                    ]);
                    break;
                    
                case 99: // A√ß√µes Finais
                    if(triggerValue === 'salvar') window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=Ol√°! Aqui √© o ${state.clientDisplayName}. Salvei o contato!`, '_blank');
                    if(triggerValue === 'vip') window.open(CONFIG.whatsAppGroupLink, '_blank');
                    break;
            }
        }

        sendBtn.addEventListener('click', handleInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleInput();
        });
    </script>
</body>
</html>
