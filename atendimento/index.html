<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cesta Econ√¥mica | Fale com o Osvaldo</title>
    <meta name="theme-color" content="#008069">

    <!-- PILLAR 1: SEO & PERFORMANCE -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PILLAR 3: SECURITY HEADERS -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https: data:;">
    <meta http-equiv="X-Frame-Options" content="DENY">

    <style>
        /* WhatsApp Specific Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #E5DDD5; }
        
        .wa-header { background-color: #008069; }
        .wa-bg { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
            opacity: 0.9;
        }
        
        .msg-in { background-color: #FFFFFF; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg-out { background-color: #E7FFDB; border-radius: 8px 0 8px 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        
        /* Bot√µes Estilo Menu WhatsApp */
        .msg-options { background-color: transparent; padding: 0; box-shadow: none; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; width: 85%; }
        .wa-btn {
            background-color: white;
            color: #008069;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 8px;
            width: 100%;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            transition: all 0.2s;
            border: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 15px;
        }
        .wa-btn:active { background-color: #f0f2f5; transform: scale(0.98); }

        /* Animation for typing */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .protected-img, .protected-msg {
            user-select: none;
            -webkit-user-select: none;
        }

        /* === ESTILOS DOS CARDS (DESIGN OTIMIZADO) === */
        :root {
            --cor-destaque-dourado: #ffb300;
            --cor-texto-destaque: #0F2546;
            --cor-texto: #333;
            --cor-borda: #e0e0e0;
            --cor-whatsapp: #25D366;
            --cor-destaque-vermelho: #ff5252;
        }

        .card-msg-container {
            width: 100%;
            max-width: 340px;
        }

        .card-cesta-new {
            background: #fff;
            border-radius: 12px;
            margin-bottom: 5px;
            border: 1px solid var(--cor-borda);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Novo Cabe√ßalho Horizontal */
        .card-header-visual {
            display: flex;
            flex-direction: row; /* Horizontal */
            align-items: center;
            background: #fff;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        
        .card-img-left {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
            border: 1px solid #eee;
        }

        .card-title-right {
            flex-grow: 1;
            padding-left: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-title-right h2 {
            font-size: 1.2rem;
            margin: 0;
            color: var(--cor-texto-destaque);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .selo-destaque {
            position: absolute;
            top: -5px; right: 10px;
            background: linear-gradient(135deg, var(--cor-destaque-dourado), #FFB300);
            color: #0F2546;
            padding: 4px 10px;
            border-radius: 0 0 10px 10px;
            font-weight: 800;
            font-size: 0.65rem;
            text-transform: uppercase;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Slider Horizontal de Produtos */
        .product-slider-container {
            background: #f9fafb;
            padding: 15px 0;
        }
        .product-slider {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 0 15px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .product-slider::-webkit-scrollbar { height: 4px; }
        .product-slider::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        .product-slide {
            flex: 0 0 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .product-slide img {
            width: 65px;
            height: 65px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .product-info { display: flex; flex-direction: column; line-height: 1.1; }
        .product-qty { 
            font-size: 1rem; 
            font-weight: 800; 
            color: var(--cor-whatsapp);
            margin-bottom: 3px;
        }
        .product-name {
            font-size: 0.75rem;
            color: #444;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Lista de Pre√ßos (Apenas Visualiza√ß√£o) */
        .card-price-display-only {
            padding: 10px 15px;
            background: #fff;
            border-top: 1px solid #eee;
        }
        .price-item-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #555;
        }
        .price-item-row strong { color: var(--cor-destaque-vermelho); }

        /* WIDGET DE ENCOMENDA (Aparece depois) */
        .order-widget {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--cor-whatsapp);
            margin-top: 5px;
        }
        .order-widget h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--cor-texto-destaque);
            margin-bottom: 10px;
            text-align: center;
        }

        .radio-arroz-option {
            display: flex; 
            flex-direction: row; /* Horizontal */
            align-items: center; 
            justify-content: space-between;
            padding: 12px 15px;
            border: 2px solid #eee; border-radius: 8px;
            margin-bottom: 8px; cursor: pointer; background: white;
            transition: all 0.2s;
        }
        .radio-arroz-option:active { transform: scale(0.98); }
        .radio-arroz-option.selected { border-color: var(--cor-whatsapp); background: #f0fff4; }
        
        .radio-arroz-info { 
            display: flex; 
            flex-direction: row; 
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-right: 15px;
        }
        .radio-arroz-name { font-weight: 600; font-size: 0.9rem; color: #333; }
        .radio-arroz-price { color: var(--cor-destaque-vermelho); font-weight: 800; font-size: 1rem; }
        
        .btn-encomendar-card {
            width: 100%; background-color: var(--cor-whatsapp); color: white;
            border: none; padding: 14px; border-radius: 8px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 10px; box-shadow: 0 3px 0 #189d4b;
            transition: transform 0.1s;
        }
        .btn-encomendar-card:active { transform: translateY(3px); box-shadow: none; }
        
        .scroll-hint {
            font-size: 0.75rem; color: #666; text-align: center;
            padding-bottom: 8px; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" oncontextmenu="return false;">

    <!-- HEADER -->
    <header class="wa-header text-white p-3 flex items-center shadow-md z-30 shrink-0">
        <div class="mr-2">
            <i class="ph ph-arrow-left text-xl cursor-pointer"></i>
        </div>
        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden mr-3 border border-white/30 relative shrink-0">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo&backgroundColor=c0aede" alt="Osvaldo" class="w-full h-full object-cover protected-img">
            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
        </div>
        <div class="flex-1 min-w-0">
            <h1 class="font-bold text-lg leading-tight truncate">Osvaldo - Cestas</h1>
            <p id="status-text" class="text-xs text-green-100/80 truncate">Online</p>
        </div>
        <div class="flex gap-4 text-xl shrink-0">
            <!-- NOVOS √çCONES -->
            <a href="https://instagram.com" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-instagram-logo"></i></a>
            <a href="#" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-globe"></i></a>
            <a href="https://wa.me/5565998150975" target="_blank" class="text-white hover:text-gray-200"><i class="ph ph-whatsapp-logo"></i></a>
        </div>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="wa-bg flex-1 overflow-y-auto p-4 space-y-3 relative scrolling-touch">
        <div class="flex justify-center mb-6 protected-msg">
            <div class="bg-[#FFF5C4] text-gray-800 text-[10px] py-1 px-3 rounded-lg shadow-sm text-center max-w-[80%]">
                <i class="ph-fill ph-lock-key inline-block mr-1"></i> As mensagens s√£o protegidas com criptografia de ponta-a-ponta.
            </div>
        </div>
        <!-- Messages area -->
    </main>

    <!-- INPUT AREA -->
    <footer class="bg-[#F0F2F5] p-2 flex items-center gap-2 shrink-0 z-30 pb-safe">
        <div class="bg-white rounded-full p-2 text-gray-500 text-xl cursor-pointer">
            <i class="ph ph-smiley"></i>
        </div>
        
        <div class="flex-1 bg-white rounded-full px-4 py-2 shadow-sm flex items-center">
            <input type="text" id="user-input" placeholder="Digite seu nome..." class="w-full outline-none text-base bg-transparent text-gray-800" autocomplete="off">
        </div>

        <div id="send-btn" class="bg-[#008069] text-white rounded-full p-3 shadow-md cursor-pointer transition active:scale-95 flex items-center justify-center">
            <i class="ph-fill ph-paper-plane-right text-xl"></i>
        </div>
    </footer>

    <script>
        const CONFIG = {
            ownerName: "Osvaldo",
            whatsAppGroupLink: "https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1",
            whatsAppNumber: "5565998150975"
        };

        if (window.self !== window.top) window.top.location.href = window.self.location.href;

        // --- DADOS DAS CESTAS ---
        const CESTAS = [
            {
                id: 'grande',
                nome: 'Cesta Grande',
                arrozQtd: 4,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-grande.avif',
                items: [
                    '4 Arroz de 5kg', '3 A√ß√∫car Cristal 2kg', '4 √ìleo de Soja 900ml', 
                    '4 Feij√£o 1kg', '1 Caf√© 500g', '3 Espaguetes 500g', '12 Ovos',
                    '1 Mistura Bolo', '1 Trigo 1kg', '1 Sal 1kg', '2 Molho Tomate',
                    '1 Milho', '1 Tempero', '2 Bolacha Recheada', '2 Miojo', '4 Suco P√≥',
                    '1 Kit Limpeza'
                ],
                opcoes: [
                    { arroz: 'Tio Alvino', preco: '380,00' },
                    { arroz: 'Koblenz', preco: '390,00' }
                ]
            },
            {
                id: 'media',
                nome: 'Cesta M√©dia',
                arrozQtd: 3,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-media.avif',
                items: [
                    '3 Arroz de 5kg', '2 A√ß√∫car Cristal', '3 √ìleo', '3 Feij√£o', 
                    '1 Caf√© 500g', '12 Ovos', '1 Mistura Bolo', '2 Espaguetes',
                    '1 Trigo', '1 Sal', '2 Molho Tomate', '1 Milho', '1 Tempero',
                    '2 Bolacha', '2 Miojo', '3 Suco', '1 Kit Limpeza'
                ],
                opcoes: [
                    { arroz: 'Tio Alvino', preco: '320,00' },
                    { arroz: 'Koblenz', preco: '325,00' }
                ]
            },
            {
                id: 'pequena',
                nome: 'Cesta Pequena',
                arrozQtd: 2,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-pequena.avif',
                items: [
                    '2 Arroz de 5kg', '1 A√ß√∫car 2kg', '2 √ìleo', '2 Feij√£o', 
                    '1 Caf√© 250g', '12 Ovos', '1 Mistura Bolo', '1 Espaguete',
                    '1 Trigo', '1 Sal', '1 Molho Tomate', '1 Milho', '1 Tempero',
                    '2 Bolacha', '2 Miojo', '2 Suco', '1 Kit Limpeza'
                ],
                opcoes: [
                    { arroz: 'Tio Alvino', preco: '215,00' },
                    { arroz: 'Koblenz', preco: '220,00' }
                ]
            },
            {
                id: 'mini',
                nome: 'Cesta Mini',
                arrozQtd: 1,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-mini.avif',
                items: [
                    '1 Arroz de 5kg', '1 A√ß√∫car 2kg', '2 √ìleo', '2 Feij√£o', 
                    '1 Caf√© 250g', '1 Espaguete', '1 Sal', '1 Molho Tomate', '1 Milho',
                    '1 Bolacha', '1 Miojo', '2 Suco', '1 Kit Limpeza'
                ],
                opcoes: [
                    { arroz: 'Tio Alvino', preco: '165,00' },
                    { arroz: 'Koblenz', preco: '170,00' }
                ]
            },
            {
                id: 'economica',
                nome: 'Cesta Econ√¥mica',
                destaque: 'Mais Vendida',
                arrozQtd: 1,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-economica.avif',
                items: [
                    '1 Arroz de 5kg', '1 A√ß√∫car 2kg', '1 √ìleo', '1 Feij√£o', 
                    '1 Caf√© 250g', '1 Espaguete', '1 Trigo', '1 Farinha Mandioca', 
                    '1 Sal', '1 Molho Tomate', '1 Milho', '1 Bolacha', '1 Miojo', '1 Suco'
                ],
                opcoes: [
                    { arroz: 'Valor √önico', preco: '85,00' }
                ]
            }
        ];

        // --- SISTEMA DE CHAT ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');

        let state = { 
            step: 0, 
            userName: '', 
            suggestedIndex: null, 
            browsingQueue: [],
            cardInteractionTimer: null,
            cardHasInteracted: false,
            currentBasketId: null // Para saber qual cesta est√° sendo vista
        };

        const getGreeting = () => {
            const h = new Date().getHours();
            return h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        };

        const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        // --- MENSAGEM COM DELAY HUMANO ---
        function calculateTypingTime(text) {
            const baseDelay = 1000;
            const charDelay = 30;
            return Math.min(baseDelay + (text.length * charDelay), 4000);
        }

        function addMessage(text, sender = 'bot', forceDelay = null) {
            return new Promise(resolve => {
                const typingTime = forceDelay !== null ? forceDelay : calculateTypingTime(text);
                const preTypingDelay = sender === 'bot' ? 600 : 0;

                setTimeout(() => {
                    if (sender === 'bot') {
                        statusText.innerText = 'Digitando...';
                        scrollToBottom();

                        const typingId = `typing-${Date.now()}`;
                        const typingHTML = `
                            <div id="${typingId}" class="flex justify-start w-full mb-2">
                                <div class="msg-in p-3 px-4 rounded-lg relative">
                                    <div class="flex gap-1 text-gray-400">
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                        <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', typingHTML);
                        scrollToBottom();

                        setTimeout(() => {
                            const typingEl = document.getElementById(typingId);
                            if(typingEl) typingEl.remove();
                            
                            const isCard = text.includes('card-cesta-new') || text.includes('order-widget');
                            const bubbleClass = isCard ? 'p-1 bg-transparent shadow-none' : 'p-2 px-3 bg-white shadow-sm';
                            
                            const html = `
                                <div class="flex justify-start w-full mb-2 fade-in">
                                    <div class="msg-in ${bubbleClass} rounded-lg relative max-w-[95%] text-gray-800 text-[15px] leading-snug protected-msg">
                                        ${text}
                                        ${!isCard ? `<span class="block text-[10px] text-gray-400 text-right mt-1 -mr-1">${getCurrentTime()}</span>` : ''}
                                    </div>
                                </div>`;
                            chatContainer.insertAdjacentHTML('beforeend', html);
                            statusText.innerText = 'Online';
                            scrollToBottom();
                            resolve();
                        }, typingTime);
                    } else {
                        const html = `
                            <div class="flex justify-end w-full mb-2">
                                <div class="msg-out p-2 px-3 rounded-lg relative max-w-[85%] text-gray-800 text-[15px] leading-snug shadow-sm protected-msg">
                                    ${text}
                                    <span class="block text-[10px] text-[#97a892] text-right mt-1 -mr-1">
                                        ${getCurrentTime()} <i class="ph-bold ph-checks text-blue-500 ml-1"></i>
                                    </span>
                                </div>
                            </div>`;
                        chatContainer.insertAdjacentHTML('beforeend', html);
                        scrollToBottom();
                        resolve();
                    }
                }, preTypingDelay);
            });
        }

        function showOptions(options) {
            setTimeout(() => {
                const optionsId = `opts-${Date.now()}`;
                let buttonsHTML = options.map(opt => `
                    <button onclick="handleOptionClick('${opt.text}', '${opt.value}', ${opt.nextStep}, '${optionsId}')" 
                            class="wa-btn text-left">
                        ${opt.text}
                    </button>
                `).join('');

                const html = `
                    <div id="${optionsId}" class="flex justify-start w-full mb-2">
                        <div class="msg-options">
                            ${buttonsHTML}
                        </div>
                    </div>`;
                chatContainer.insertAdjacentHTML('beforeend', html);
                scrollToBottom();
                userInput.disabled = true;
                userInput.placeholder = "Selecione uma op√ß√£o acima üëÜ";
            }, 800);
        }

        // --- FUN√á√ïES GLOBAIS DE CARD ---
        window.selectRice = function(id, nome, preco) {
            const btn = document.getElementById(`btn-pedir-${id}`);
            const allOpts = document.querySelectorAll(`#widget-${id} .radio-arroz-option`);
            allOpts.forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            btn.innerHTML = `<i class="fa-brands fa-whatsapp"></i> Pedir Agora`;
            btn.onclick = () => {
                const msg = `Ol√°! Quero encomendar a *Cesta ${id.toUpperCase()}* com *Arroz ${nome}* por *R$ ${preco}*.`;
                window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        };

        // Detector de Scroll para Gatilho Inteligente
        window.handleSlideScroll = function(element) {
            if (state.cardHasInteracted) return; 
            if (element.scrollLeft + element.clientWidth >= element.scrollWidth - 20) {
                triggerPostCardFlow();
            }
        };

        function triggerPostCardFlow() {
            if (state.cardHasInteracted) return;
            state.cardHasInteracted = true;
            clearTimeout(state.cardInteractionTimer);
            showPostCardMessages();
        }

        async function showPostCardMessages() {
            const cestaAtual = CESTAS.find(c => c.id === state.currentBasketId);
            const nomeCesta = cestaAtual ? cestaAtual.nome : 'esta cesta';

            const opcoes = [
                { text: `Encomendar a ${nomeCesta} ‚úÖ`, value: "encomendar_atual", nextStep: 3 },
                { text: "Ver outras cestas üîÑ", value: "ver_outra", nextStep: 2 },
                { text: "Ver formas de pagamento üí≥", value: "pagamento", nextStep: 4 }
            ];

            showOptions(opcoes);
        }

        function getProductImage(text) {
            const lowerText = text.toLowerCase();
            let imgName = 'outros.png';
            if(lowerText.includes('arroz')) imgName = 'arroz.png';
            else if(lowerText.includes('acucar') || lowerText.includes('a√ß√∫car')) imgName = 'acucar.png';
            else if(lowerText.includes('oleo') || lowerText.includes('√≥leo')) imgName = 'oleo.png';
            else if(lowerText.includes('feijao') || lowerText.includes('feij√£o')) imgName = 'feijao.png';
            else if(lowerText.includes('cafe') || lowerText.includes('caf√©')) imgName = 'cafe.png';
            else if(lowerText.includes('macarrao') || lowerText.includes('espaguete')) imgName = 'macarrao.png';
            else if(lowerText.includes('molho')) imgName = 'molho.png';
            else if(lowerText.includes('sal')) imgName = 'sal.png';
            else if(lowerText.includes('trigo')) imgName = 'trigo.png';
            else if(lowerText.includes('ovo')) imgName = 'ovos.png';
            else if(lowerText.includes('limpeza')) imgName = 'limpeza.png';
            else if(lowerText.includes('milho')) imgName = 'milho.png';
            else if(lowerText.includes('tempero')) imgName = 'tempero.png';
            else if(lowerText.includes('bolacha')) imgName = 'bolacha.png';
            else if(lowerText.includes('miojo')) imgName = 'miojo.png';
            else if(lowerText.includes('suco')) imgName = 'suco.png';
            else if(lowerText.includes('farinha')) imgName = 'farinha.png';
            return `img/produtos/${imgName}`;
        }

        function parseProductItem(text) {
            const match = text.match(/^(\d+)\s+(.*)$/);
            if(match) return { qty: match[1] + 'x', name: match[2], img: getProductImage(match[2]) };
            return { qty: '1x', name: text, img: getProductImage(text) };
        }

        function generateCardHTML(cesta) {
            const slidesHTML = cesta.items.map(item => {
                const parsed = parseProductItem(item);
                const fallbackImg = `https://placehold.co/80x80/eee/999?text=${parsed.name.substring(0,3).toUpperCase()}`;
                
                return `
                <div class="product-slide">
                    <img src="${parsed.img}" onerror="this.src='${fallbackImg}'" alt="${parsed.name}">
                    <div class="product-info">
                        <span class="product-qty">${parsed.qty}</span>
                        <span class="product-name">${parsed.name}</span>
                    </div>
                </div>`;
            }).join('');
            
            // Lista simples de pre√ßos para o card
            const pricesHTML = cesta.opcoes.map(opt => `
                <div class="price-item-row">
                    <span>${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                    <strong>R$ ${opt.preco}</strong>
                </div>
            `).join('');

            return `
            <div class="card-msg-container">
                <div class="card-cesta-new">
                    <div class="card-header-visual">
                        ${cesta.destaque ? `<div class="selo-destaque">${cesta.destaque}</div>` : ''}
                        <img src="${cesta.img}" class="card-img-left" alt="${cesta.nome}">
                        <div class="card-title-right">
                            <h2>${cesta.nome}</h2>
                        </div>
                    </div>
                    
                    <div class="product-slider-container">
                        <div class="scroll-hint">
                            <i class="ph-bold ph-hand-swipe-left"></i> Arraste para ver os produtos
                        </div>
                        <div class="product-slider" onscroll="handleSlideScroll(this)">
                            ${slidesHTML}
                        </div>
                    </div>

                    <div class="card-price-display-only">
                        ${pricesHTML}
                    </div>
                </div>
            </div>`;
        }

        // Gera o Widget de Encomenda (Aparece ao clicar em "Encomendar")
        function generateOrderWidget(cesta) {
            const riceOptionsHTML = cesta.opcoes.map(opt => `
                <div class="radio-arroz-option" onclick="selectRice('${cesta.id}', '${opt.arroz}', '${opt.preco}')">
                    <div class="radio-arroz-info">
                        <span class="radio-arroz-name">${opt.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + opt.arroz}</span>
                        <span class="radio-arroz-price">R$ ${opt.preco}</span>
                    </div>
                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                         <div class="w-3 h-3 bg-green-500 rounded-full hidden selection-dot"></div>
                    </div>
                </div>
            `).join('');

            return `
            <div class="card-msg-container">
                <div id="widget-${cesta.id}" class="order-widget">
                    <h3>Finalize seu pedido da ${cesta.nome}:</h3>
                    <p style="margin-bottom: 10px; font-size: 0.85rem; color:#666; text-align: center;">Escolha o arroz abaixo:</p>
                    ${riceOptionsHTML}
                    <button id="btn-pedir-${cesta.id}" class="btn-encomendar-card">
                        <i class="fa-brands fa-whatsapp"></i> Escolha o Arroz
                    </button>
                </div>
            </div>`;
        }

        // --- L√ìGICA DO ROTEIRO ---
        window.onload = async () => {
            setTimeout(async () => {
                await addMessage(`${getGreeting()}! Tudo bem? üëã`, 'bot', 1000);
                await addMessage(`Aqui √© o *${CONFIG.ownerName}*, da Cesta B√°sica Econ√¥mica.`, 'bot', 1500);
                await addMessage(`Qual √© o seu primeiro nome?`, 'bot', 1200);
                userInput.focus();
            }, 500);
        };

        async function handleInput() {
            const text = userInput.value.trim();
            if (!text) return;

            if (state.step === 0) {
                state.userName = text.split(' ')[0];
                state.step = 1;
                userInput.value = '';
                await addMessage(text, 'user');
                
                userInput.disabled = true;
                userInput.placeholder = "Aguarde...";
                
                nextStepFlow();
            }
        }

        async function handleOptionClick(text, value, nextStep, containerId) {
            const container = document.getElementById(containerId);
            if(container) container.remove();

            await addMessage(text, 'user');
            state.step = nextStep;

            if (state.step === 2) {
                if (value === '1') { state.suggestedIndex = 3; state.browsingQueue = [4, 2, 1, 0]; }
                else if (value === '2') { state.suggestedIndex = 2; state.browsingQueue = [1, 3, 0, 4]; }
                else if (value === '3') { state.suggestedIndex = 1; state.browsingQueue = [0, 2, 3, 4]; }
                else { state.suggestedIndex = 0; state.browsingQueue = [1, 2, 3, 4]; }
            }

            if (value === 'ver_outra') {
                 if(state.browsingQueue.length > 0) {
                     state.suggestedIndex = state.browsingQueue.shift();
                     state.step = 2; // Loop
                 } else {
                     // Acabou as cestas, sugere a grande ou menu
                     state.suggestedIndex = 0;
                     state.step = 2;
                 }
            }

            // L√≥gica para quando seleciona uma cesta espec√≠fica na lista final
            if (value.startsWith('select_cesta_')) {
                const index = parseInt(value.split('_')[2]);
                state.suggestedIndex = index;
                state.step = 2; // Volta a mostrar o card
            }

            nextStepFlow(value);
        }

        async function nextStepFlow(triggerValue) {
            const name = state.userName;

            switch (state.step) {
                case 1:
                    await addMessage(`Prazer, ${name}! üòÄ`);
                    await addMessage(`Agora vou te mostrar as nossas op√ß√µes de cestas. Tenho certeza que uma vai te servir perfeitamente.`);
                    await addMessage(`Pra eu te indicar a certa: **Quantos pacotes de arroz (5kg) voc√™ usa na sua casa por m√™s?**`, 'bot', 2500);
                    showOptions([
                        { text: "1 Pacote", value: "1", nextStep: 2 },
                        { text: "2 Pacotes", value: "2", nextStep: 2 },
                        { text: "3 Pacotes", value: "3", nextStep: 2 },
                        { text: "4 ou mais", value: "4", nextStep: 2 }
                    ]);
                    break;

                case 2: // Mostrar Cesta Sugerida
                    state.cardHasInteracted = false; 
                    const index = state.suggestedIndex;
                    const cesta = CESTAS[index];
                    const qtdArroz = cesta.arrozQtd;
                    state.currentBasketId = cesta.id;
                    
                    if (triggerValue === 'ver_outra') {
                        await addMessage(`D√° uma olhada nessa aqui, a **${cesta.nome}**:`, 'bot', 1000);
                    } else if (triggerValue && triggerValue.startsWith('select_cesta')) {
                        await addMessage(`Aqui est√° a **${cesta.nome}**:`, 'bot', 1000);
                    } else {
                         await addMessage(`Legal! Pra essa quantidade, vou te mostrar a **${cesta.nome}**, que vem com ${qtdArroz} arroz.`);
                    }

                    await addMessage(generateCardHTML(cesta));

                    // Inicia Timer de 2 minutos (fallback)
                    state.cardInteractionTimer = setTimeout(() => {
                        triggerPostCardFlow();
                    }, 120000); // 2 minutos
                    break;

                case 3: // Clicou em "Encomendar a Cesta X"
                    const idCestaAtual = state.currentBasketId;
                    const cestaParaPedir = CESTAS.find(c => c.id === idCestaAtual);
                    
                    if(cestaParaPedir) {
                        await addMessage(generateOrderWidget(cestaParaPedir));
                    }
                    // N√£o avan√ßa automaticamente, fica esperando clique no Zap
                    break;

                case 4: // Pagamento e Fechamento
                    await addMessage(`Facilitamos o pagamento pra voc√™:`);
                    const listaPagamento = `
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Cart√£o de Cr√©dito</strong> em at√© 3x</li>
                            <li><strong>Cart√£o de D√©bito</strong></li>
                            <li><strong>PIX</strong> ou <strong>Dinheiro</strong> na entrega</li>
                            <li><strong>Vale Alimenta√ß√£o/Refei√ß√£o:</strong> Alelo, Sodexo, Pluxee, Caju, Flash, iFood...</li>
                        </ul>`;
                    await addMessage(listaPagamento);

                    // Delay de 15 segundos antes de mostrar op√ß√µes finais
                    setTimeout(async () => {
                        await addMessage(`O que deseja fazer agora?`, 'bot');
                        
                        const linkZap = `https://wa.me/${CONFIG.whatsAppNumber}?text=Ol%C3%A1%20Osvaldo%2C%20estou%20salvando%20seu%20contato%21`;
                        const linkVip = CONFIG.whatsAppGroupLink;

                        showOptions([
                            { text: "Salvar Contato üìû", value: "salvar", nextStep: 99 }, // 99 s√≥ pra segurar, onclick abre link
                            { text: "Entrar no Grupo VIP üéÅ", value: "vip", nextStep: 99 },
                            { text: "Encomendar uma cesta üõí", value: "menu_cestas", nextStep: 5 }
                        ]);

                        // Tratamento especial para abrir links nos bot√µes acima (j√° que showOptions usa onclick padr√£o)
                        // Ajuste no handleOptionClick seria ideal, mas aqui faremos um "override" visual simulado
                        // ou simplificamos: o nextStep 5 leva ao menu, os outros poderiam ser links diretos se a fun√ß√£o permitisse.
                        // Como a estrutura √© rigida, vamos adaptar o handleOptionClick para abrir link se for o caso.

                    }, 15000);
                    break;

                case 5: // Menu Lista de Cestas
                    await addMessage(`Qual cesta voc√™ quer ver novamente?`);
                    
                    const listaCestas = CESTAS.map((c, i) => ({
                        text: c.nome,
                        value: `select_cesta_${i}`,
                        nextStep: 2
                    }));
                    
                    showOptions(listaCestas);
                    break;
                    
                case 99: // Steps finais que abrem link
                    if(triggerValue === 'salvar') {
                        window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=Ol%C3%A1%20Osvaldo%2C%20estou%20salvando%20seu%20contato%21`, '_blank');
                    } else if(triggerValue === 'vip') {
                        window.open(CONFIG.whatsAppGroupLink, '_blank');
                    }
                    // Volta para menu
                    state.step = 5; 
                    nextStepFlow();
                    break;
            }
        }

        sendBtn.addEventListener('click', handleInput);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleInput();
        });
    </script>
</body>
</html>
