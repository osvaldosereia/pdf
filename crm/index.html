<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V1 - CRM & P√≥s-Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilo Consistente (Desktop Compacto) */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1400px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .compact-input { padding: 0.3rem; font-size: 0.9rem; }
        
        /* Utilit√°rios de Scroll */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .btn-zap { transition: all 0.2s; }
        .btn-zap:hover { transform: scale(1.1); }
        
        /* Tabela compacta para relat√≥rios */
        .table-report td, .table-report th { padding: 2px 4px; font-size: 0.75rem; border-bottom: 1px solid #f3f4f6; }
    </style>
</head>
<body class="text-gray-800">

    <div class="app-container p-4">
        
        <!-- Cabe√ßalho -->
        <header class="bg-white shadow-sm rounded-lg p-3 mb-3 flex justify-between items-center border border-gray-200">
            <div class="flex items-center gap-4">
                <div class="bg-purple-600 text-white p-2 rounded">
                    <i class="fa-solid fa-handshake"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-700 leading-tight">M√≥dulo 3: CRM</h1>
                    <p class="text-[10px] text-gray-500">Intelig√™ncia de Vendas e Relacionamento</p>
                </div>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="window.location.href='cadastro.html'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    1. Cadastro
                </button>
                <button onclick="window.location.href='vendas.html'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    2. Vendas
                </button>
                <button class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-medium shadow-sm">
                    3. CRM
                </button>
            </nav>

            <div class="flex gap-2">
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importarDadosExternos(this)" multiple>
                <button onclick="document.getElementById('importInput').click()" class="border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-50" title="Importar JSON">
                    <i class="fa-solid fa-upload mr-1"></i> Importar
                </button>
                <button onclick="atualizarDados()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow-sm">
                    <i class="fa-solid fa-sync mr-1"></i> Atualizar
                </button>
            </div>
        </header>

        <!-- Barra de Filtros de Per√≠odo -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-3 flex items-center gap-4">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-filter text-gray-400"></i>
                <span class="text-xs font-bold text-gray-700 uppercase">An√°lise de Per√≠odo:</span>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">De:</label>
                <input type="date" id="dataInicio" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">At√©:</label>
                <input type="date" id="dataFim" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
            </div>
            <button onclick="definirMesAtual()" class="text-xs text-blue-600 hover:underline">Este M√™s</button>
            
            <div class="ml-auto flex gap-4 text-xs">
                <div>Total Filtrado: <span id="resumoTotal" class="font-bold text-gray-800">R$ 0,00</span></div>
                <div>Vendas: <span id="resumoQtd" class="font-bold text-gray-800">0</span></div>
            </div>
        </div>

        <!-- Painel de Relat√≥rios Detalhados (Expandido) -->
        <div class="grid grid-cols-3 gap-4 mb-4 h-48">
            <!-- Relat√≥rio 1: Produtos -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="bg-indigo-50 px-3 py-2 border-b border-indigo-100 flex justify-between">
                    <h3 class="text-xs font-bold text-indigo-800 uppercase">Cestas Vendidas</h3>
                    <i class="fa-solid fa-basket-shopping text-indigo-300"></i>
                </div>
                <div class="flex-1 overflow-y-auto p-2 custom-scroll">
                    <table class="w-full text-left table-report">
                        <thead><tr><th>Produto</th><th class="text-right">Qtd</th></tr></thead>
                        <tbody id="relatorioProdutos"></tbody>
                    </table>
                </div>
            </div>

            <!-- Relat√≥rio 2: Financeiro -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="bg-green-50 px-3 py-2 border-b border-green-100 flex justify-between">
                    <h3 class="text-xs font-bold text-green-800 uppercase">Pagamentos</h3>
                    <i class="fa-solid fa-money-bill-wave text-green-300"></i>
                </div>
                <div class="flex-1 overflow-y-auto p-2 custom-scroll">
                    <table class="w-full text-left table-report">
                        <thead><tr><th>M√©todo</th><th class="text-right">Total (R$)</th></tr></thead>
                        <tbody id="relatorioPagamentos"></tbody>
                    </table>
                </div>
            </div>

            <!-- Relat√≥rio 3: Regi√£o -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="bg-orange-50 px-3 py-2 border-b border-orange-100 flex justify-between">
                    <h3 class="text-xs font-bold text-orange-800 uppercase">Cidades / Bairros</h3>
                    <i class="fa-solid fa-map-location-dot text-orange-300"></i>
                </div>
                <div class="flex-1 overflow-y-auto p-2 custom-scroll">
                    <table class="w-full text-left table-report">
                        <thead><tr><th>Local</th><th class="text-right">Vendas</th></tr></thead>
                        <tbody id="relatorioLocais"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- √Årea Principal Dividida -->
        <div class="flex flex-1 gap-4 overflow-hidden">
            
            <!-- ESQUERDA: Radar de Resgate (Logica Independente do filtro de data da venda) -->
            <div class="w-5/12 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-2 border-b border-gray-100 bg-red-50 rounded-t-lg">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="font-bold text-red-800 text-xs uppercase"><i class="fa-solid fa-heart-crack mr-2"></i>Radar Inativos</h2>
                        <input type="number" id="diasInativo" value="30" class="w-12 text-center text-xs border border-red-200 rounded text-red-700 font-bold" onchange="renderizarRadar()">
                    </div>
                    <p class="text-[10px] text-gray-500">Clientes sem comprar h√° X dias (Baseado em hoje)</p>
                </div>

                <div class="flex-1 overflow-auto p-0 bg-white custom-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-[10px] sticky top-0 shadow-sm">
                            <tr>
                                <th class="p-2">Cliente</th>
                                <th class="p-2 text-center">Dias Off</th>
                                <th class="p-2 text-center">Zap</th>
                            </tr>
                        </thead>
                        <tbody id="listaRadar" class="text-xs divide-y divide-gray-100">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                    <div id="emptyRadar" class="hidden text-center text-gray-400 p-8">
                        <p class="text-xs">Todos clientes ativos!</p>
                    </div>
                </div>
            </div>

            <!-- DIREITA: P√≥s-Venda (Lista Filtrada pelo Per√≠odo) -->
            <div class="w-7/12 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-2 border-b border-gray-100 bg-blue-50 rounded-t-lg flex justify-between items-center">
                    <h2 class="font-bold text-blue-800 text-xs uppercase"><i class="fa-solid fa-list-ul mr-2"></i>Vendas do Per√≠odo</h2>
                    <span class="text-[10px] text-blue-600 bg-blue-100 px-2 rounded-full" id="countPosVenda">0 listados</span>
                </div>

                <div class="flex-1 overflow-auto p-2 bg-gray-50 custom-scroll">
                    <div id="listaPosVenda" class="grid grid-cols-1 gap-2">
                        <!-- Cards Compactos de P√≥s Venda -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script L√≥gico -->
    <script>
        // --- 1. CONFIGURA√á√ÉO E DADOS ---
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';
        
        let clientes = [];
        let vendas = [];
        let vendasFiltradas = [];

        const TEMPLATES = {
            agradecimento: "Ol√° {nome}! Tudo bem? Passando para agradecer pela prefer√™ncia na sua compra do dia {data}. Espero que tenha gostado dos produtos! Qualquer coisa estou √† disposi√ß√£o. üõí",
            insta: "Oie {nome}! üòÉ Gostaria de te convidar para seguir nosso Instagram. Postamos promo√ß√µes rel√¢mpago por l√°! Segue o link: [SEU_INSTA_AQUI]",
            avaliacao: "Ol√° {nome}, tudo joia? Poderia nos dar uma forcinha? üôè Avalie nossa empresa no Google, ajuda muito! Segue o link: [SEU_LINK_GOOGLE_AQUI]",
            resgate: "Ol√° {nome}! Sumiu hein? üòâ Faz {dias} dias que n√£o te vemos. Temos cestas fresquinhas chegando. Que tal aproveitar um desconto especial de retorno? Me chama aqui!",
            feedback: "Oi {nome}, queria saber se deu tudo certo com a entrega da cesta no dia {data}? O arroz estava ok?"
        };

        window.onload = () => {
            atualizarDados();
            definirMesAtual(); // Define filtro inicial
        };

        function definirMesAtual() {
            const date = new Date();
            const primeiroDia = new Date(date.getFullYear(), date.getMonth(), 1);
            const ultimoDia = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            
            document.getElementById('dataInicio').valueAsDate = primeiroDia;
            document.getElementById('dataFim').valueAsDate = ultimoDia;
            aplicarFiltros();
        }

        // --- 2. IMPORTA√á√ÉO E DADOS ---
        
        function atualizarDados() {
            const cLocal = localStorage.getItem(KEY_CLIENTES);
            const vLocal = localStorage.getItem(KEY_PEDIDOS);

            if (cLocal) clientes = JSON.parse(cLocal);
            if (vLocal) vendas = JSON.parse(vLocal);

            // Ordena vendas por data (mais recente primeiro)
            vendas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            aplicarFiltros();
            renderizarRadar(); // Radar √© independente do filtro de per√≠odo
        }

        function importarDadosExternos(input) {
            const files = input.files;
            if (files.length === 0) return;

            let carregados = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.length > 0) {
                            if (json[0].hasOwnProperty('financeiro')) {
                                vendas = json;
                                localStorage.setItem(KEY_PEDIDOS, JSON.stringify(vendas));
                            } else if (json[0].hasOwnProperty('nome')) {
                                clientes = json;
                                localStorage.setItem(KEY_CLIENTES, JSON.stringify(clientes));
                            }
                        }
                        carregados++;
                        if(carregados === files.length) {
                            atualizarDados();
                            alert('Dados atualizados!');
                        }
                    } catch (error) { console.error(error); }
                };
                reader.readAsText(file);
            });
        }

        // --- 3. L√ìGICA DE FILTROS E RELAT√ìRIOS ---

        function aplicarFiltros() {
            const inicio = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;
            
            // Filtra o array principal de vendas
            if (inicio && fim) {
                // Ajuste de fuso hor√°rio simples comparando strings YYYY-MM-DD
                vendasFiltradas = vendas.filter(v => {
                    const dataVenda = v.data.split('T')[0];
                    return dataVenda >= inicio && dataVenda <= fim;
                });
            } else {
                vendasFiltradas = [...vendas];
            }

            atualizarKPIsDashboard();
            gerarRelatoriosDetalhados();
            renderizarPosVendaCompacto();
        }

        function atualizarKPIsDashboard() {
            const total = vendasFiltradas.reduce((acc, v) => acc + v.financeiro.total, 0);
            document.getElementById('resumoTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('resumoQtd').innerText = vendasFiltradas.length;
            document.getElementById('countPosVenda').innerText = vendasFiltradas.length + ' vendas';
        }

        function gerarRelatoriosDetalhados() {
            // 1. Contagem de Produtos (Cestas)
            const statsCestas = {};
            vendasFiltradas.forEach(v => {
                v.itens.forEach(item => {
                    const chave = item.tipo + (item.marca !== 'Padr√£o' ? ` (${item.marca})` : '');
                    statsCestas[chave] = (statsCestas[chave] || 0) + 1;
                });
            });
            renderizarTabelaRelatorio('relatorioProdutos', statsCestas, false);

            // 2. Financeiro por Pagamento
            const statsPagto = {};
            vendasFiltradas.forEach(v => {
                const metodo = v.pagamento.metodo.toUpperCase();
                statsPagto[metodo] = (statsPagto[metodo] || 0) + v.financeiro.total;
            });
            renderizarTabelaRelatorio('relatorioPagamentos', statsPagto, true);

            // 3. Locais (Cidade - Bairro)
            const statsLocal = {};
            vendasFiltradas.forEach(v => {
                const cidade = v.cliente.cidade || 'Indefinido';
                const bairro = v.cliente.bairro || '?';
                const chave = `${cidade} - ${bairro}`;
                statsLocal[chave] = (statsLocal[chave] || 0) + 1;
            });
            renderizarTabelaRelatorio('relatorioLocais', statsLocal, false);
        }

        function renderizarTabelaRelatorio(elementId, dados, isMoeda) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            
            // Converte objeto em array e ordena por valor decrescente
            const lista = Object.entries(dados).sort((a, b) => b[1] - a[1]);

            lista.forEach(([chave, valor]) => {
                const valFormatado = isMoeda ? valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : valor;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="truncate max-w-[120px]" title="${chave}">${chave}</td>
                    <td class="text-right font-bold text-gray-700">${valFormatado}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-400 italic py-2">Sem dados</td></tr>';
            }
        }

        // --- 4. RENDERIZA√á√ÉO P√ìS-VENDA (COMPACTO) ---

        function renderizarPosVendaCompacto() {
            const container = document.getElementById('listaPosVenda');
            container.innerHTML = '';

            // Limita a 100 itens para n√£o travar se o per√≠odo for longo
            const listaExibicao = vendasFiltradas.slice(0, 100);

            listaExibicao.forEach(v => {
                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded border border-gray-200 shadow-sm flex flex-col gap-1 hover:border-blue-300 transition";
                
                const dataObj = new Date(v.data);
                const dataStr = dataObj.toLocaleDateString('pt-BR');
                const primeiroNome = v.cliente.nome.split(' ')[0]; // S√≥ o primeiro nome pra economizar espa√ßo
                
                // Resumo itens
                const qtdItens = v.itens.length;
                const descItens = v.itens.map(i => i.tipo).join(', ');

                card.innerHTML = `
                    <div class="flex justify-between items-center border-b border-gray-50 pb-1">
                        <span class="font-bold text-xs text-gray-800 truncate w-2/3" title="${v.cliente.nome}">${v.cliente.nome}</span>
                        <span class="text-[10px] text-gray-400">${dataStr}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] text-gray-600 truncate w-2/3" title="${descItens}">
                            ${qtdItens}x ${descItens}
                        </span>
                        <span class="font-bold text-xs text-blue-600">R$ ${v.financeiro.total.toFixed(0)}</span>
                    </div>

                    <!-- Bot√µes de A√ß√£o Compactos (√çcones Apenas) -->
                    <div class="flex justify-end gap-2 mt-1 pt-1 border-t border-gray-50">
                        <button onclick="enviarZap('${v.cliente.telefone}', 'agradecimento', '${primeiroNome}', '${dataStr}')" 
                            class="text-green-500 hover:text-green-700 text-xs" title="Agradecer">
                            <i class="fa-brands fa-whatsapp"></i> Obrigado
                        </button>
                        <button onclick="enviarZap('${v.cliente.telefone}', 'feedback', '${primeiroNome}', '${dataStr}')" 
                            class="text-blue-500 hover:text-blue-700 text-xs" title="Pedir Feedback">
                            <i class="fa-regular fa-comment-dots"></i> Feedback
                        </button>
                        <button onclick="enviarZap('${v.cliente.telefone}', 'avaliacao', '${primeiroNome}')" 
                            class="text-yellow-500 hover:text-yellow-700 text-xs" title="Pedir Avalia√ß√£o">
                            <i class="fa-solid fa-star"></i> Avaliar
                        </button>
                        <button onclick="enviarZap('${v.cliente.telefone}', 'insta', '${primeiroNome}')" 
                            class="text-pink-500 hover:text-pink-700 text-xs" title="Pedir pra Seguir">
                            <i class="fa-brands fa-instagram"></i> Seguir
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            if (listaExibicao.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">Nenhuma venda neste per√≠odo.</div>';
            }
        }

        // --- 5. RENDERIZA√á√ÉO RADAR (INALTERADO PELA DATA DO FILTRO) ---

        function renderizarRadar() {
            const diasCorte = parseInt(document.getElementById('diasInativo').value) || 30;
            const tbody = document.getElementById('listaRadar');
            const empty = document.getElementById('emptyRadar');
            tbody.innerHTML = '';
            
            // Mapa da √∫ltima compra por cliente (Global, de todo o hist√≥rico)
            const mapaUltimaCompra = {};
            vendas.forEach(v => {
                const dataVenda = new Date(v.data);
                if (!mapaUltimaCompra[v.cliente.id] || dataVenda > mapaUltimaCompra[v.cliente.id]) {
                    mapaUltimaCompra[v.cliente.id] = dataVenda;
                }
            });

            const hoje = new Date();
            const listaInativos = clientes.filter(c => {
                const ultimaData = mapaUltimaCompra[c.id];
                if (!ultimaData) return false; 
                const diffTime = Math.abs(hoje - ultimaData);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                c.diasSemComprar = diffDays;
                return diffDays >= diasCorte;
            });

            listaInativos.sort((a, b) => b.diasSemComprar - a.diasSemComprar);

            if (listaInativos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                listaInativos.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-red-50 transition border-b border-gray-100 group";
                    tr.innerHTML = `
                        <td class="p-1 pl-2">
                            <div class="font-bold text-gray-800 text-xs truncate max-w-[100px]">${c.nome}</div>
                            <div class="text-[9px] text-gray-400">${c.telefone}</div>
                        </td>
                        <td class="p-1 text-center">
                            <span class="bg-red-100 text-red-700 text-[10px] font-bold px-1 rounded">${c.diasSemComprar}d</span>
                        </td>
                        <td class="p-1 text-center">
                            <button onclick="enviarZap('${c.telefone}', 'resgate', '${c.nome}', null, '${c.diasSemComprar}')" 
                                class="btn-zap text-green-500 hover:text-green-600 text-sm" title="Enviar Oferta">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- 6. UTILIT√ÅRIOS ---
        function enviarZap(telefone, tipo, nome, dataVenda = '', dias = '') {
            if (!telefone) return alert("Cliente sem telefone.");
            let phone = telefone.replace(/\D/g, '');
            if (phone.length < 10) return alert("Telefone inv√°lido");
            if (!phone.startsWith('55')) phone = '55' + phone;

            let msg = TEMPLATES[tipo];
            msg = msg.replace('{nome}', nome.split(' ')[0]);
            if (dataVenda) msg = msg.replace('{data}', dataVenda);
            if (dias) msg = msg.replace('{dias}', dias);

            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
