<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota de Entregas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6;
        }
        /* Esconder barra de rolagem mas permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- √çCONES (SVG Components) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Truck = (props) => <IconBase {...props}><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const List = (props) => <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const MessageCircle = (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>;
        const Phone = (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>;
        const Navigation = (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>;
        const Package = (props) => <IconBase {...props}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
        const ZapIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-zap">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
        );

        // Configura√ß√µes
        const ADMIN_PHONE = "5565998150975";

        function DeliveryApp() {
            const [orders, setOrders] = useState([]);
            const [activeRoutes, setActiveRoutes] = useState([]);
            const [showLoadList, setShowLoadList] = useState(false);
            
            // Refer√™ncia para o input de arquivo
            const fileInputRef = useRef(null);
            
            // Modal de Confirma√ß√£o de Entrega
            const [deliveryModal, setDeliveryModal] = useState({ open: false, orderId: null, paymentMethod: '' });
            
            // Modal de Detalhes do Pedido
            const [detailsModal, setDetailsModal] = useState({ open: false, order: null });

            // Extrair rotas √∫nicas dinamicamente com base nos pedidos carregados
            const availableRoutes = useMemo(() => {
                const routes = new Set(orders.map(o => o.rota));
                return Array.from(routes);
            }, [orders]);

            // Fun√ß√£o para importar arquivo JSON
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            // Processa os dados
                            const processedData = json.map(order => ({
                                ...order,
                                status_entrega: order.status_entrega || 'pendente'
                            }));
                            
                            setOrders(processedData);
                            
                            // Ativa todas as rotas ao carregar
                            const newRoutes = Array.from(new Set(processedData.map(o => o.rota)));
                            setActiveRoutes(newRoutes);
                            
                            alert(`${processedData.length} pedidos importados com sucesso!`);
                        } else {
                            alert('O arquivo JSON deve conter uma lista de pedidos.');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('Erro ao ler o arquivo JSON. Verifique se o formato est√° correto.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // Filtrar e Ordenar Pedidos
            const displayedOrders = useMemo(() => {
                let filtered = orders.filter(o => activeRoutes.includes(o.rota));
                
                // Ordenar: Pendentes primeiro, depois entregues/cancelados
                return filtered.sort((a, b) => {
                    const scoreA = a.status_entrega === 'pendente' ? 0 : 1;
                    const scoreB = b.status_entrega === 'pendente' ? 0 : 1;
                    return scoreA - scoreB || a.ordem - b.ordem;
                });
            }, [orders, activeRoutes]);

            // Estat√≠sticas
            const stats = useMemo(() => {
                const total = displayedOrders.length;
                const pending = displayedOrders.filter(o => o.status_entrega === 'pendente').length;
                return { total, pending, completed: total - pending };
            }, [displayedOrders]);

            // Lista de Carga (Resumo)
            const loadList = useMemo(() => {
                const list = {};
                orders.filter(o => activeRoutes.includes(o.rota) && o.status_entrega === 'pendente').forEach(order => {
                    order.itens.forEach(item => {
                        const key = `${item.tipo} - ${item.marca}`;
                        list[key] = (list[key] || 0) + 1;
                    });
                });
                return Object.entries(list);
            }, [orders, activeRoutes]);

            // --- A√á√ïES ---

            const handleWhatsApp = (phone, message) => {
                const cleanPhone = phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.startsWith('55') ? cleanPhone : `55${cleanPhone}`;
                const url = `https://wa.me/${finalPhone}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            };

            const openMap = (address, mapsLink) => {
                if (mapsLink) {
                    if(mapsLink.includes('http')) {
                        window.open(mapsLink, '_blank');
                    } else {
                        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapsLink)}`, '_blank');
                    }
                } else {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
                }
            };

            const handleCancel = (order) => {
                if (!window.confirm("Confirmar cancelamento deste pedido?")) return;

                const newOrders = orders.map(o => 
                    o.id === order.id ? { ...o, status_entrega: 'cancelado' } : o
                );
                setOrders(newOrders);

                // Notificar Admin
                const msg = `‚ö†Ô∏è *Pedido Cancelado*\nCliente: ${order.cliente.nome}\nRota: ${order.rota}\nMotivo: Entrega cancelada pelo entregador.`;
                handleWhatsApp(ADMIN_PHONE, msg);
            };

            const openDeliveryModal = (order) => {
                setDeliveryModal({ 
                    open: true, 
                    orderId: order.id, 
                    paymentMethod: order.pagamento.metodo,
                    currentOrder: order 
                });
            };

            const confirmDelivery = () => {
                const { orderId, paymentMethod, currentOrder } = deliveryModal;
                
                const newOrders = orders.map(o => 
                    o.id === orderId ? { ...o, status_entrega: 'entregue', pagamento: { ...o.pagamento, metodo: paymentMethod, status: 'pago' } } : o
                );
                setOrders(newOrders);
                setDeliveryModal({ open: false, orderId: null, paymentMethod: '' });

                // Notificar Admin
                const msg = `‚úÖ *Entrega Realizada*\nCliente: ${currentOrder.cliente.nome}\nPagamento: ${paymentMethod.toUpperCase()}\nValor: R$ ${currentOrder.financeiro.total}`;
                handleWhatsApp(ADMIN_PHONE, msg);
            };

            const toggleRoute = (route) => {
                if (activeRoutes.includes(route)) {
                    setActiveRoutes(activeRoutes.filter(r => r !== route));
                } else {
                    setActiveRoutes([...activeRoutes, route]);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans pb-20">
                    
                    {/* HEADER FIXO */}
                    <header className="bg-blue-600 text-white sticky top-0 z-30 shadow-md">
                        <div className="px-4 py-3 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    <Truck size={24} /> Rota Entrega
                                </h1>
                                <p className="text-sm opacity-90">
                                    Restam <b>{stats.pending}</b> de {stats.total}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                {/* Input Oculto para Importa√ß√£o */}
                                <input 
                                    type="file" 
                                    ref={fileInputRef} 
                                    onChange={handleFileUpload} 
                                    accept=".json" 
                                    className="hidden" 
                                />
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="p-2 bg-blue-500 rounded-lg active:bg-blue-700 shadow-sm border border-blue-400"
                                    title="Importar Pedidos"
                                >
                                    <Upload size={20} />
                                </button>
                                
                                <button 
                                    onClick={() => setShowLoadList(true)}
                                    className="p-2 bg-green-500 rounded-lg font-bold flex items-center gap-1 active:bg-green-600 shadow-sm border border-green-400"
                                >
                                    <List size={20} /> Carga
                                </button>
                            </div>
                        </div>

                        {/* BARRA DE ROTAS (Horizontal Scroll) */}
                        {availableRoutes.length > 0 && (
                            <div className="px-4 pb-3 flex gap-2 overflow-x-auto no-scrollbar">
                                {availableRoutes.map(route => (
                                    <button
                                        key={route}
                                        onClick={() => toggleRoute(route)}
                                        className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all shadow-sm flex-shrink-0 ${
                                            activeRoutes.includes(route) 
                                            ? 'bg-white text-blue-700 scale-105' 
                                            : 'bg-blue-800/50 text-blue-100 border border-blue-500/30'
                                        }`}
                                    >
                                        {route}
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    {/* LISTA DE PEDIDOS */}
                    <main className="p-4 space-y-4">
                        {orders.length === 0 ? (
                             <div className="text-center text-gray-500 py-20 flex flex-col items-center">
                                <Package size={64} className="text-gray-300 mb-4"/>
                                <p className="text-lg font-medium text-gray-600">Nenhum pedido carregado</p>
                                <p className="text-sm text-gray-400 mt-2 max-w-[250px]">Toque no bot√£o de <b>Upload</b> no topo para carregar o arquivo JSON da rota.</p>
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="mt-6 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-transform"
                                >
                                    <Upload size={20} /> Carregar Rota
                                </button>
                            </div>
                        ) : displayedOrders.length === 0 ? (
                            <div className="text-center text-gray-500 py-10">
                                <p>Nenhuma rota selecionada ou sem pedidos para as rotas ativas.</p>
                                <p className="text-sm mt-2">Toque nas rotas acima para visualizar.</p>
                            </div>
                        ) : (
                            displayedOrders.map((order) => {
                                const isPending = order.status_entrega === 'pendente';
                                const isCancelled = order.status_entrega === 'cancelado';
                                
                                return (
                                    <div 
                                        key={order.id} 
                                        className={`rounded-xl shadow-lg overflow-hidden border-2 ${
                                            isPending ? 'bg-white border-transparent' : 
                                            isCancelled ? 'bg-red-50 border-red-200 opacity-60' : 'bg-green-50 border-green-200 opacity-60'
                                        }`}
                                    >
                                        {/* CABE√áALHO DO CARD */}
                                        <div className="bg-gray-50 px-4 py-3 flex justify-between items-start border-b border-gray-100">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h2 className="text-lg font-bold text-gray-800">{order.cliente.nome}</h2>
                                                    {order.cliente.apelido && <span className="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600">{order.cliente.apelido}</span>}
                                                </div>
                                                <span className="inline-block mt-1 text-xs font-bold px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                                    {order.rota}
                                                </span>
                                            </div>
                                            <div className="text-right">
                                                <span className={`block font-bold text-lg ${order.pagamento.status === 'pago' ? 'text-green-600' : 'text-orange-600'}`}>
                                                    R$ {order.financeiro.total}
                                                </span>
                                                <span className="text-xs text-gray-500 uppercase">{order.pagamento.metodo}</span>
                                            </div>
                                        </div>

                                        {/* CORPO DO CARD */}
                                        <div className="p-4">
                                            <div className="mb-4">
                                                <p className="text-gray-700 leading-snug flex items-start gap-2">
                                                    <MapPin className="text-red-500 shrink-0 mt-1" size={18} />
                                                    {order.cliente.endereco}
                                                </p>
                                                {order.obs && (
                                                    <p className="mt-2 text-sm bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-200 flex items-center gap-2">
                                                        <Info size={16} /> <b>Obs:</b> {order.obs}
                                                    </p>
                                                )}
                                            </div>

                                            {/* BOT√ïES DE A√á√ÉO - APENAS SE PENDENTE */}
                                            {isPending && (
                                                <div className="space-y-3">
                                                    
                                                    {/* A√á√ïES R√ÅPIDAS (ZAP + MAPA) */}
                                                    <div className="grid grid-cols-5 gap-2">
                                                        <button 
                                                            onClick={() => handleWhatsApp(order.cliente.telefone, `Ol√° ${order.cliente.nome}, entregador chegando com sua cesta!`)}
                                                            className="col-span-1 bg-green-100 text-green-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-200"
                                                        >
                                                            <Truck size={20} />
                                                            <span className="text-[10px] font-bold">Chegando</span>
                                                        </button>
                                                        <button 
                                                            onClick={() => handleWhatsApp(order.cliente.telefone, `Ol√° ${order.cliente.nome}, o entregador chegou! pode receber?`)}
                                                            className="col-span-1 bg-green-100 text-green-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-200"
                                                        >
                                                            <CheckCircle size={20} />
                                                            <span className="text-[10px] font-bold">Cheguei</span>
                                                        </button>
                                                         <button 
                                                            onClick={() => handleWhatsApp(order.cliente.telefone, "")}
                                                            className="col-span-1 bg-green-500 text-white py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-600 shadow-sm"
                                                        >
                                                            <MessageCircle size={20} />
                                                            <span className="text-[10px] font-bold">Zap</span>
                                                        </button>
                                                        <a 
                                                            href={`tel:${order.cliente.telefone}`}
                                                            className="col-span-1 bg-gray-100 text-gray-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-gray-200"
                                                        >
                                                            <Phone size={20} />
                                                            <span className="text-[10px] font-bold">Ligar</span>
                                                        </a>
                                                        <button 
                                                            onClick={() => openMap(order.cliente.endereco, order.cliente.maps)}
                                                            className="col-span-1 bg-blue-100 text-blue-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-blue-200"
                                                        >
                                                            <Navigation size={20} />
                                                            <span className="text-[10px] font-bold">Mapa</span>
                                                        </button>
                                                    </div>

                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => setDetailsModal({ open: true, order })}
                                                            className="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 border border-indigo-100"
                                                        >
                                                            <Package size={18} /> Ver Detalhes
                                                        </button>
                                                    </div>

                                                    <hr className="border-gray-100 my-2" />

                                                    {/* A√á√ïES PRINCIPAIS (ENTREGUE / CANCELADO) */}
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button 
                                                            onClick={() => handleCancel(order)}
                                                            className="bg-red-50 text-red-600 py-4 rounded-lg font-bold text-lg border border-red-200 active:bg-red-100 flex items-center justify-center gap-2"
                                                        >
                                                            <XCircle size={24} /> Cancelar
                                                        </button>
                                                        <button 
                                                            onClick={() => openDeliveryModal(order)}
                                                            className="bg-green-600 text-white py-4 rounded-lg font-bold text-lg shadow-md active:bg-green-700 flex items-center justify-center gap-2"
                                                        >
                                                            <CheckCircle size={24} /> ENTREGUE
                                                        </button>
                                                    </div>
                                                </div>
                                            )}

                                            {/* STATUS FINALIZADO */}
                                            {!isPending && (
                                                <div className={`p-3 rounded-lg text-center font-bold flex items-center justify-center gap-2 ${isCancelled ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                                    {isCancelled ? <XCircle /> : <CheckCircle />}
                                                    {isCancelled ? 'PEDIDO CANCELADO' : 'PEDIDO ENTREGUE'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </main>

                    {/* --- MODAL LISTA DE CARGA --- */}
                    {showLoadList && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 relative">
                                <button 
                                    onClick={() => setShowLoadList(false)}
                                    className="absolute top-4 right-4 text-gray-500 p-2"
                                >
                                    <XCircle size={28} />
                                </button>
                                <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 text-gray-800">
                                    <Package className="text-blue-600"/> Carga Necess√°ria
                                </h2>
                                <p className="text-gray-500 mb-4 text-sm">Itens para as rotas ativas ({activeRoutes.length > 0 ? activeRoutes.join(', ') : 'Nenhuma'}):</p>
                                
                                <div className="max-h-[60vh] overflow-y-auto space-y-2">
                                    {loadList.length === 0 ? (
                                        <p className="text-center py-4 text-gray-500">Nenhum item para carregar. Importe a rota primeiro.</p>
                                    ) : (
                                        loadList.map(([name, count]) => (
                                            <div key={name} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                <span className="font-medium text-gray-700">{name}</span>
                                                <span className="bg-blue-600 text-white font-bold px-3 py-1 rounded-full">{count}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <button 
                                    onClick={() => setShowLoadList(false)}
                                    className="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold text-lg"
                                >
                                    Fechar
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CONFIRMAR ENTREGA --- */}
                    {deliveryModal.open && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6">
                                <h2 className="text-xl font-bold mb-4 text-center">Confirmar Pagamento</h2>
                                <p className="text-center text-gray-600 mb-6">Como o cliente pagou?</p>
                                
                                <div className="space-y-3">
                                    {['dinheiro', 'cartao', 'pix'].map(method => (
                                        <button
                                            key={method}
                                            onClick={() => setDeliveryModal(prev => ({ ...prev, paymentMethod: method }))}
                                            className={`w-full py-3 px-4 rounded-xl border-2 flex items-center justify-between transition-all ${
                                                deliveryModal.paymentMethod === method 
                                                ? 'border-green-500 bg-green-50 text-green-700 font-bold' 
                                                : 'border-gray-200 text-gray-600'
                                            }`}
                                        >
                                            <span className="capitalize flex items-center gap-2">
                                                {method === 'dinheiro' && <DollarSign size={20}/>}
                                                {method === 'cartao' && <Settings size={20}/>}
                                                {method === 'pix' && <ZapIcon />} 
                                                {method}
                                            </span>
                                            {deliveryModal.paymentMethod === method && <CheckCircle size={20} />}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 gap-3 mt-6">
                                    <button 
                                        onClick={() => setDeliveryModal({ open: false, orderId: null, paymentMethod: '' })}
                                        className="py-3 rounded-xl font-bold text-gray-600 bg-gray-100"
                                    >
                                        Voltar
                                    </button>
                                    <button 
                                        onClick={confirmDelivery}
                                        className="py-3 rounded-xl font-bold text-white bg-green-600 shadow-lg active:scale-95 transition-transform"
                                    >
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL DETALHES --- */}
                    {detailsModal.open && detailsModal.order && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 relative max-h-[90vh] overflow-y-auto shadow-2xl">
                                <button 
                                    onClick={() => setDetailsModal({ open: false, order: null })}
                                    className="absolute top-4 right-4 text-gray-500 bg-gray-100 rounded-full p-1"
                                >
                                    <XCircle size={24} />
                                </button>
                                
                                {/* L√≥gica para vari√°veis de exibi√ß√£o */}
                                {(() => {
                                    const item = detailsModal.order.itens[0] || {};
                                    const isPaid = detailsModal.order.pagamento.status === 'pago';
                                    const isChanged = item.modo === 'alterada';
                                    
                                    return (
                                        <>
                                            {/* BANNER DE STATUS DE PAGAMENTO */}
                                            <div className={`p-4 rounded-xl text-center mb-5 border-2 ${
                                                isPaid 
                                                ? 'bg-green-100 border-green-500 text-green-800' 
                                                : 'bg-red-100 border-red-500 text-red-800'
                                            }`}>
                                                <span className="block text-xs font-bold uppercase tracking-wider mb-1 opacity-80">Situa√ß√£o do Pagamento</span>
                                                <div className="flex flex-col items-center">
                                                    <span className="text-2xl font-black flex items-center gap-2">
                                                        {isPaid ? <CheckCircle size={28}/> : <DollarSign size={28}/>}
                                                        {isPaid ? 'J√Å PAGO' : 'A RECEBER'}
                                                    </span>
                                                    {!isPaid && (
                                                        <div className="mt-1 bg-white/50 px-3 py-1 rounded font-bold text-lg">
                                                            R$ {detailsModal.order.financeiro.total}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* GRID PRINCIPAL: C√ìDIGO E TIPO */}
                                            <div className="grid grid-cols-2 gap-3 mb-5">
                                                {/* Tipo da Cesta (Padrao vs Alterada) */}
                                                <div className={`p-3 rounded-lg border-2 text-center flex flex-col justify-center ${
                                                    isChanged 
                                                    ? 'bg-orange-50 border-orange-400 text-orange-900' 
                                                    : 'bg-blue-50 border-blue-200 text-blue-900'
                                                }`}>
                                                    <span className="text-xs font-bold uppercase opacity-70 mb-1">Tipo da Cesta</span>
                                                    <span className="font-bold text-lg leading-tight">
                                                        {isChanged ? '‚ö†Ô∏è ALTERADA' : 'PADR√ÉO'}
                                                    </span>
                                                </div>

                                                {/* C√≥digo da Cesta */}
                                                <div className="p-3 rounded-lg border-2 bg-gray-50 border-gray-300 text-center flex flex-col justify-center">
                                                    <span className="text-xs font-bold uppercase text-gray-500 mb-1">C√≥digo / ID</span>
                                                    <span className="font-black text-3xl text-gray-800 tracking-tighter">
                                                        {item.identificacao || '-'}
                                                    </span>
                                                </div>
                                            </div>

                                            {/* OBSERVA√á√ÉO (Se houver) */}
                                            {detailsModal.order.obs && (
                                                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-5 rounded-r-lg shadow-sm">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <Info size={20} className="text-yellow-600"/>
                                                        <span className="font-bold text-yellow-800 uppercase text-sm">Observa√ß√£o Importante:</span>
                                                    </div>
                                                    <p className="text-yellow-900 font-medium text-lg leading-snug">
                                                        "{detailsModal.order.obs}"
                                                    </p>
                                                </div>
                                            )}

                                            {/* Descri√ß√£o do Produto */}
                                            <div className="text-center mb-6 pt-4 border-t border-gray-100">
                                                <p className="text-sm text-gray-400 uppercase font-bold mb-1">Produto</p>
                                                <h3 className="text-xl font-bold text-gray-800">{item.tipo || 'Cesta'}</h3>
                                                <p className="text-gray-500 font-medium">{item.marca}</p>
                                            </div>

                                            {/* Brinde (Se houver) */}
                                            {detailsModal.order.brinde && (
                                                <div className="bg-purple-100 text-purple-800 p-4 rounded-xl font-bold text-center mb-6 border-2 border-purple-200 border-dashed">
                                                    <div className="text-xs uppercase opacity-70 mb-1">N√£o esquecer</div>
                                                    <div className="text-lg flex items-center justify-center gap-2">
                                                        üéÅ {detailsModal.order.brinde}
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    );
                                })()}

                                <button 
                                    onClick={() => setDetailsModal({ open: false, order: null })}
                                    className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg"
                                >
                                    Fechar
                                </button>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DeliveryApp />);
    </script>
</body>
</html>
