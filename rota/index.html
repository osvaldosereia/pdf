<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Dona Antonia | CRM & Entregas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- NOTA: Removemos a chamada autom√°tica do clientes.js para usar o upload manual/persistente -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f8fafc', 100: '#f1f5f9', 500: '#64748b', 600: '#475569', 700: '#334155', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Otimiza√ß√µes Mobile */
        body { -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Anima√ß√µes */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6; display: flex; align-items: center; animation: slideIn 0.3s ease; max-width: 90vw; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* Modal Transitions */
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Dropdown Customizado */
        .custom-dropdown-list {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        /* Estilos de Impress√£o (PDF & T√âRMICA) */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Reset geral */
            body { background: white; -webkit-print-color-adjust: exact; margin: 0; padding: 0; }

            /* MODO TICKET T√âRMICO / 10x15 / √çM√É */
            body.mode-print-view > *:not(#ticket-print-area) { display: none !important; }
            
            body.mode-print-view #ticket-print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                box-sizing: border-box;
                color: black;
            }

            /* Estilo 10x15 (A6) */
            .print-10x15 {
                width: 100mm; /* Aprox 10cm */
                height: 148mm; /* Aprox 15cm */
                padding: 5mm;
                font-family: 'Inter', sans-serif;
                font-size: 12px;
                line-height: 1.3;
            }
            .print-10x15 h1 { font-size: 18px; font-weight: 800; margin-bottom: 5px; }
            .print-10x15 .box { border: 2px solid #000; padding: 5px; margin-bottom: 5px; border-radius: 5px; }
            .print-10x15 .label { font-weight: bold; font-size: 10px; text-transform: uppercase; color: #333; }
            .print-10x15 .value { font-weight: bold; font-size: 14px; }
            .print-10x15 .big-total { font-size: 20px; font-weight: 900; text-align: right; }

            /* Estilo √çM√É (Cupom) - Estilo Cupom Estreito */
            .print-ima {
                width: 58mm;
                padding: 2mm;
                font-family: 'Courier New', Courier, monospace;
                text-align: center;
                border: 2px dashed #000;
            }
            .ima-title { font-size: 14px; font-weight: 900; margin-bottom: 5px; }
            .ima-gift { font-size: 16px; font-weight: 800; border: 2px solid #000; padding: 5px; margin: 5px 0; border-radius: 5px; }
            .ima-validity { font-size: 10px; font-weight: bold; margin-top: 5px; }
            
            /* Ajustes Hist√≥rico (Modo Normal - A4) */
            body:not(.mode-print-view) #modal-historico .modal-content { 
                position: static; 
                width: 100%; 
                max-width: 100%; 
                height: auto; 
                max-height: none;
                box-shadow: none;
                border: none;
            }
            body:not(.mode-print-view) #modal-historico { position: static; background: white; }
            body:not(.mode-print-view) .overflow-y-auto { overflow: visible !important; height: auto !important; }
            body:not(.mode-print-view) #crm-summary-bar { background: #f1f5f9 !important; color: black !important; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased pb-24">

    <!-- Toast Container -->
    <div id="toast-container" class="no-print"></div>

    <!-- Container Escondido para Impress√£o -->
    <div id="ticket-print-area" class="hidden"></div>

    <!-- Header Fixo -->
    <header class="bg-white shadow-sm sticky top-0 z-30 border-b border-slate-200 no-print">
        <div class="container mx-auto max-w-5xl px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-slate-800 text-white p-2 rounded-lg shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7" /></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">Rota Dona Antonia</h1>
                    <p class="text-xs text-slate-500" id="header-date">Carregando...</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="App.ui.toggleMenu()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                </button>
            </div>
        </div>
        
        <!-- Menu Dropdown -->
        <div id="main-menu" class="hidden absolute right-4 top-16 bg-white rounded-xl shadow-xl border border-slate-100 w-64 overflow-hidden z-50 ring-1 ring-black ring-opacity-5">
            <button onclick="App.controllers.novaRota()" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 flex items-center gap-3 text-red-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Nova Rota (Reset)
            </button>
            <div class="border-t border-slate-100"></div>
            <button onclick="App.ui.modalHistorico.open()" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 flex items-center gap-3 text-blue-600 font-bold transition-colors bg-blue-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Hist√≥rico & CRM
            </button>
            <button onclick="App.ui.modalRelatorio.open()" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 flex items-center gap-3 text-green-600 font-medium transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Relat√≥rio Cestas (Zap)
            </button>
            
            <div class="border-t border-slate-100"></div>
            
            <!-- NOVO BOT√ÉO: Importar Clientes -->
            <button onclick="document.getElementById('input-carregar-clientes').click()" class="w-full text-left px-4 py-3 text-sm hover:bg-purple-50 flex items-center gap-3 text-purple-700 font-medium transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Importar Base Clientes
            </button>
            
            <button onclick="App.ui.modalExport.open()" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 flex items-center gap-3 text-slate-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Exportar Backup
            </button>
            <button onclick="document.getElementById('input-carregar-arquivo').click()" class="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 flex items-center gap-3 text-slate-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                Carregar Backup
            </button>
        </div>
    </header>

    <main class="container mx-auto max-w-2xl px-4 py-6 no-print">
        
        <!-- KPIs / Placar -->
        <div class="w-full mb-6" id="kpi-container"></div>

        <!-- Filtros de Regi√£o -->
        <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar" id="filtros-regiao"></div>

        <!-- Bot√£o Flutuante (FAB) para Lan√ßamento -->
        <button onclick="App.controllers.iniciarNovoLancamento()" class="fixed bottom-6 right-6 bg-slate-800 text-white rounded-full p-4 shadow-xl hover:bg-slate-900 transition-transform hover:scale-105 z-40 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        </button>

        <!-- Lista de Entregas -->
        <div id="lista-entregas" class="space-y-4 min-h-[200px]"></div>
        
        <div id="lista-vazia" class="hidden flex-col items-center justify-center py-12 text-slate-400">
            <svg class="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 001-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
            <p>Nenhuma entrega nesta regi√£o.</p>
        </div>

    </main>

    <!-- ================= MODAIS ================= -->

    <!-- Modal Lan√ßamento -->
    <div id="modal-lancamento" class="fixed inset-0 z-50 hidden no-print">
        <div class="absolute inset-0 bg-black/60 modal-backdrop transition-opacity" onclick="App.ui.modalLancamento.close()"></div>
        <div class="absolute bottom-0 w-full h-[90vh] flex flex-col bg-white rounded-t-2xl shadow-2xl md:fixed md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl md:h-auto md:max-h-[90vh] md:rounded-xl modal-content">
            
            <div class="flex-none flex justify-between items-center p-4 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-800" id="modal-lancamento-title">Nova Entrega</h3>
                <button onclick="App.ui.modalLancamento.close()" class="text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <div class="overflow-y-auto p-4 flex-1 space-y-5">
                <!-- Seletor de Cliente Customizado -->
                <div class="relative group">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
                    <input type="text" id="input-cliente" class="w-full rounded-lg border-slate-300 border p-3 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 transition-all bg-slate-50" placeholder="Digite o nome para buscar..." autocomplete="off">
                    
                    <!-- Dropdown de Sugest√µes -->
                    <div id="dropdown-clientes" class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl custom-dropdown-list">
                        <!-- Lista preenchida via JS -->
                    </div>

                    <div id="info-cliente-preview" class="hidden mt-2 text-sm bg-blue-50 text-blue-800 p-3 rounded-lg border border-blue-100">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- Regi√£o -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Regi√£o <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-4 gap-2 text-sm" id="container-radio-regiao">
                        <!-- Gerado via JS -->
                    </div>
                </div>

                <!-- Adicionar Cestas -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <label class="block text-sm font-bold text-slate-700 mb-3">Montar Pedido</label>
                    
                    <div class="flex gap-2 mb-3">
                        <!-- Seletor Customizado de Cesta -->
                        <div class="relative flex-1" id="container-custom-select-cesta">
                            <button type="button" id="btn-custom-select-cesta" class="w-full text-left rounded-lg border-slate-300 border p-2 text-sm bg-white flex justify-between items-center focus:ring-2 focus:ring-slate-500">
                                <span id="label-select-cesta">Selecione a Cesta...</span>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <!-- Dropdown Cestas -->
                            <div id="dropdown-cestas" class="hidden absolute z-40 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl custom-dropdown-list">
                                <!-- Op√ß√µes via JS -->
                            </div>
                            <!-- Inputs Ocultos para valor -->
                            <input type="hidden" id="hidden-cesta-nome" value="">
                            <input type="hidden" id="hidden-cesta-valor" value="0">
                        </div>

                        <input type="number" id="qtd-cesta" value="1" min="1" class="w-16 text-center rounded-lg border-slate-300 border p-2 bg-white">
                    </div>

                    <!-- Op√ß√µes Avan√ßadas (Toggle) -->
                    <div class="mb-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="check-alterada" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                            <span class="ms-3 text-sm font-medium text-slate-700">Cesta Alterada?</span>
                        </label>
                    </div>

                    <!-- CAMPOS TIRAR / P√îR -->
                    <div id="box-detalhes-alterada" class="hidden space-y-2 mb-3 bg-amber-50 p-3 rounded border border-amber-200">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs font-bold text-red-600 block mb-1">TIRAR:</label>
                                <input type="text" id="input-tirar" placeholder="Ex: Arroz" class="w-full text-sm p-2 rounded border border-amber-200 focus:border-red-400 focus:ring-1 focus:ring-red-400 outline-none bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-green-600 block mb-1">P√îR:</label>
                                <input type="text" id="input-por" placeholder="Ex: Caf√©" class="w-full text-sm p-2 rounded border border-amber-200 focus:border-green-400 focus:ring-1 focus:ring-green-400 outline-none bg-white">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="text-xs font-semibold text-slate-500 uppercase">Brindes:</span>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border border-slate-200"><input type="checkbox" class="mr-1" value="Ovo" name="brindes">Ovo</label>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border border-slate-200"><input type="checkbox" class="mr-1" value="Amaciante" name="brindes">Amaciante</label>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border border-slate-200"><input type="checkbox" class="mr-1" value="Cafe 250g" name="brindes">Caf√©</label>
                    </div>

                    <button onclick="App.controllers.adicionarItemAoCarrinho()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-medium hover:bg-slate-900 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Adicionar ao Carrinho
                    </button>
                </div>

                <!-- Carrinho Visual -->
                <div id="carrinho-visual" class="space-y-2">
                    <!-- Itens adicionados aparecem aqui -->
                </div>
                
                <div>
                     <label class="block text-sm font-medium text-slate-700">Obs Geral</label>
                     <input type="text" id="input-obs-geral" class="w-full mt-1 border-slate-300 rounded-lg p-2 border bg-slate-50" placeholder="Casa port√£o azul...">
                </div>

                <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                    <span class="text-slate-600">Total Previsto:</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400">R$</span>
                        <input type="number" id="input-valor-final" step="0.01" class="text-xl font-bold text-slate-900 w-28 text-right bg-transparent border-none focus:ring-0 p-0" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="flex-none p-4 border-t border-slate-100 bg-white md:rounded-b-xl flex gap-3">
                <button onclick="App.ui.modalLancamento.close()" class="flex-1 py-3 text-slate-600 font-medium hover:bg-slate-50 rounded-lg transition-colors border border-slate-200">Cancelar</button>
                <button onclick="App.controllers.salvarEntrega()" class="flex-[2] py-3 bg-slate-800 text-white font-bold rounded-lg shadow-lg hover:bg-slate-900 transition-colors" id="btn-submit-lancamento">Confirmar Lan√ßamento</button>
            </div>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="bg-green-600 p-4 text-white text-center">
                <h3 class="text-lg font-bold">Concluir Entrega</h3>
                <p class="text-green-100 text-sm" id="pag-cliente-nome">Cliente</p>
                <p class="text-2xl font-bold mt-1" id="pag-valor-total">R$ 0,00</p>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-600 font-medium">Forma de Pagamento:</p>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="DINHEIRO" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">Dinheiro</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="PIX" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">PIX</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="CART√ÉO" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">Cart√£o</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="S√ì ENTREGAR" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">S√≥ Entregar</span></label>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="document.getElementById('modal-pagamento').classList.add('hidden')" class="flex-1 py-2 text-gray-600 border rounded-lg">Voltar</button>
                    <button onclick="App.controllers.confirmarPagamento()" class="flex-1 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal P√≥s Venda -->
    <div id="modal-pos-venda" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4 no-print">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
            <div class="p-4 border-b flex justify-between items-center bg-purple-50 rounded-t-xl">
                <h3 class="font-bold text-purple-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                    P√≥s Venda
                </h3>
                <button onclick="document.getElementById('modal-pos-venda').classList.add('hidden')" class="text-gray-400">X</button>
            </div>
            <div class="p-4 space-y-3">
                <p class="text-sm text-gray-600 mb-2">Selecione a mensagem para <strong id="pos-venda-cliente-nome">Cliente</strong>:</p>
                <button onclick="App.controllers.enviarPosVenda(1)" class="w-full text-left p-3 rounded-lg bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-100 transition-all font-medium flex items-center gap-3"><span class="text-xl">üôè</span> Agradecimento</button>
                <button onclick="App.controllers.enviarPosVenda(2)" class="w-full text-left p-3 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 border border-green-100 transition-all font-medium flex items-center gap-3"><span class="text-xl">üé´</span> Cupom R$ 10,00</button>
                <button id="btn-pos-google" onclick="App.controllers.enviarPosVenda(3)" class="w-full text-left p-3 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-100 transition-all font-medium flex items-center gap-3"><span class="text-xl">‚≠ê</span> Avaliar no Google</button>
                <button id="btn-pos-insta" onclick="App.controllers.enviarPosVenda(4)" class="w-full text-left p-3 rounded-lg bg-pink-50 text-pink-700 hover:bg-pink-100 border border-pink-100 transition-all font-medium flex items-center gap-3"><span class="text-xl">üì∏</span> Seguir no Instagram</button>
                <button onclick="App.controllers.enviarPosVenda(5)" class="w-full text-left p-3 rounded-lg bg-slate-50 text-slate-700 hover:bg-slate-100 border border-slate-100 transition-all font-medium flex items-center gap-3"><span class="text-xl">üì±</span> Baixar APP</button>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div id="modal-whatsapp" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4 no-print">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
            <div class="p-4 border-b flex justify-between items-center bg-green-50 rounded-t-xl">
                <h3 class="font-bold text-green-800 flex items-center gap-2">WhatsApp</h3>
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="text-gray-400">X</button>
            </div>
            <div class="p-2 space-y-2">
                <button onclick="App.controllers.enviarMsgZap(1)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üöó Aviso: Chegando em 10 min</button>
                <button onclick="App.controllers.enviarMsgZap(2)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üö™ Aviso: Cheguei no local</button>
                <button onclick="App.controllers.enviarMsgZap(3)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üí∞ Dados do PIX</button>
                <button onclick="App.controllers.enviarMsgZap(4)" class="w-full text-left p-3 rounded hover:bg-red-50 text-sm font-medium text-red-700 border border-red-100 transition-all">üö® Pedido p/ Montador</button>
            </div>
        </div>
    </div>

    <!-- Modal Exportar -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4 no-print">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Exportar Backup</h3>
            
            <button onclick="App.controllers.baixarBackup('completo')" class="w-full bg-slate-800 text-white py-4 rounded-lg font-bold hover:bg-slate-900 shadow-lg transition-transform hover:scale-105 flex items-center justify-center gap-2 mb-6">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                Backup Completo (Tudo)
            </button>

            <div class="border-t border-slate-100 pt-4">
                <p class="text-sm text-slate-500 mb-2 font-medium">Ou exportar apenas rota de hoje:</p>
                <div class="grid grid-cols-2 gap-2 mb-3" id="export-regioes-list"></div>
                <button onclick="App.controllers.baixarBackup('parcial')" class="w-full bg-blue-50 text-blue-700 py-2 rounded-lg font-bold hover:bg-blue-100 transition-colors text-sm">Baixar Apenas Rota Selecionada</button>
            </div>

            <button onclick="App.ui.modalExport.close()" class="w-full mt-4 text-slate-500 py-2 hover:bg-slate-50 rounded-lg transition-colors">Cancelar</button>
        </div>
    </div>

    <!-- Modal Relat√≥rio Cestas -->
    <div id="modal-relatorio" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4 no-print">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-green-800 mb-2 flex items-center gap-2">Relat√≥rio de Cestas</h3>
            <p class="text-sm text-slate-500 mb-4">Selecione as regi√µes:</p>
            <div class="space-y-2 mb-6">
                <div class="grid grid-cols-2 gap-2" id="relatorio-regioes-list"></div>
            </div>
            <button onclick="App.controllers.gerarRelatorioCestas()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2 shadow-md transition-colors">Enviar para WhatsApp</button>
            <button onclick="App.ui.modalRelatorio.close()" class="w-full mt-2 text-slate-500 py-2 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
        </div>
    </div>

    <!-- Modal HIST√ìRICO E CRM (FULL SCREEN) -->
    <div id="modal-historico" class="fixed inset-0 z-50 hidden overflow-hidden bg-white">
        <div class="h-full flex flex-col modal-content">
            <!-- Header Hist√≥rico -->
            <div class="bg-slate-900 text-white p-4 shadow-md flex justify-between items-center no-print">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Hist√≥rico & CRM
                </h2>
                <div class="flex gap-2">
                    <button onclick="App.controllers.resetarCRM()" class="bg-red-800 hover:bg-red-700 text-red-100 px-4 py-2 rounded text-sm font-bold border border-red-700">Zerar CRM</button>
                    <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-sm font-medium">Exportar PDF</button>
                    <button onclick="App.ui.modalHistorico.close()" class="bg-slate-700 hover:bg-red-600 px-4 py-2 rounded text-sm font-medium">Fechar</button>
                </div>
            </div>

            <!-- Tab Navigation (NOVO) -->
            <div class="bg-white border-b border-slate-200 px-4 flex gap-6 overflow-x-auto no-print">
                <button onclick="App.controllers.switchCRMTab('diario')" id="tab-diario" class="py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 hover:text-blue-800 transition-colors whitespace-nowrap">üìÖ Vendas por Dia</button>
                <button onclick="App.controllers.switchCRMTab('busca')" id="tab-busca" class="py-3 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-800 transition-colors whitespace-nowrap">üîç Buscar Cliente</button>
                <button onclick="App.controllers.switchCRMTab('cupons')" id="tab-cupons" class="py-3 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-800 transition-colors whitespace-nowrap">üé´ Cupons a Vencer</button>
                <button onclick="App.controllers.switchCRMTab('relatorios')" id="tab-relatorios" class="py-3 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-800 transition-colors whitespace-nowrap">üìä Relat√≥rios Gerenciais</button>
            </div>

            <!-- CONTEUDO: Vendas Di√°rias (Substituindo antiga lista de Clientes) -->
            <div id="crm-view-daily" class="flex-1 flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 no-print">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-2">Filtrar por data:</p>
                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="daily-filters">
                        <!-- Bot√µes gerados via JS -->
                    </div>
                </div>
                
                <div class="flex-1 overflow-auto bg-slate-100 p-4">
                    <div class="bg-white rounded shadow">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-800 text-white text-sm sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">Data/Hora</th>
                                    <th class="p-3">Cliente</th>
                                    <th class="p-3">Compra</th>
                                    <th class="p-3">Pagamento</th>
                                    <th class="p-3">Regi√£o</th>
                                    <th class="p-3 text-right">Valor</th>
                                    <th class="p-3 text-center w-40">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="crm-daily-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                <!-- JS preenche aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONTEUDO: Busca Cliente (Nova Sess√£o) -->
            <div id="crm-view-search" class="hidden flex-1 flex flex-col overflow-hidden bg-slate-100">
                <div class="p-4 bg-white border-b border-slate-200 no-print shadow-sm">
                    <label class="block text-sm font-bold text-slate-700 mb-1">Buscar Cliente (Todo Hist√≥rico)</label>
                    <div class="flex gap-2">
                        <input type="text" id="crm-client-search-input" placeholder="Digite nome ou telefone..." class="flex-1 border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50" onkeyup="if(event.key === 'Enter') App.controllers.crmSearchClient()">
                        <button onclick="App.controllers.crmSearchClient()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Buscar</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto p-4">
                    <div id="crm-search-results" class="space-y-4">
                        <p class="text-center text-slate-400 mt-10">Use a busca acima para encontrar todas as compras de um cliente.</p>
                    </div>
                </div>
            </div>

            <!-- CONTEUDO: Cupons a Vencer (NOVO) -->
            <div id="crm-view-cupons" class="hidden flex-1 flex flex-col overflow-hidden bg-slate-100">
                <div class="flex-1 overflow-auto p-4">
                    <div class="bg-white rounded shadow">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-800 text-white text-sm sticky top-0 z-10">
                                <tr>
                                    <th class="p-3">Cliente</th>
                                    <th class="p-3">Compra Original</th>
                                    <th class="p-3">Brinde (Previsto)</th>
                                    <th class="p-3 text-center">Vencimento</th>
                                    <th class="p-3 text-center">Avisar</th>
                                </tr>
                            </thead>
                            <tbody id="crm-cupons-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                <!-- JS -->
                            </tbody>
                        </table>
                        <div class="p-4 text-center border-t border-slate-100">
                            <button id="btn-load-more-cupons" onclick="App.controllers.loadMoreCoupons()" class="text-blue-600 font-bold hover:text-blue-800 text-sm">Carregar Mais...</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTEUDO: Relat√≥rios -->
            <div id="crm-view-reports" class="hidden flex-1 overflow-y-auto bg-slate-100 p-4">
                <div class="max-w-5xl mx-auto space-y-6">
                    
                    <!-- Filtro de Data -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            Per√≠odo do Relat√≥rio
                        </h3>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Data Inicial</label>
                                <input type="date" id="rel-start" class="w-full border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Data Final</label>
                                <input type="date" id="rel-end" class="w-full border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50">
                            </div>
                            <button onclick="App.controllers.gerarRelatorioVendas()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Atualizar Dados
                            </button>
                        </div>
                    </div>

                    <!-- Container Resultados -->
                    <div id="relatorio-resultados" class="hidden space-y-6 animate-in fade-in">
                        <!-- Cards de Topo -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                                <p class="text-xs font-bold text-slate-400 uppercase">Faturamento Total</p>
                                <p class="text-3xl font-black text-slate-800 mt-1" id="rel-total-valor">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                                <p class="text-xs font-bold text-slate-400 uppercase">Total Pedidos</p>
                                <p class="text-3xl font-black text-slate-800 mt-1" id="rel-total-pedidos">0</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500">
                                <p class="text-xs font-bold text-slate-400 uppercase">Ticket M√©dio</p>
                                <p class="text-3xl font-black text-slate-800 mt-1" id="rel-ticket-medio">R$ 0,00</p>
                            </div>
                        </div>

                        <!-- Grids Detalhados -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Regi√£o -->
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                                <h4 class="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">üìç Vendas por Regi√£o</h4>
                                <div id="rel-grid-regiao" class="space-y-3"></div>
                            </div>

                            <!-- Pagamento -->
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                                <h4 class="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">üí≥ Formas de Pagamento</h4>
                                <div id="rel-grid-pagamento" class="space-y-3"></div>
                            </div>

                            <!-- Cestas -->
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 md:col-span-2">
                                <h4 class="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">üì¶ Ranking de Cestas & Produtos</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Por Tipo de Cesta</p>
                                        <div id="rel-grid-cestas" class="space-y-2"></div>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Modifica√ß√µes</p>
                                            <div class="flex items-center justify-between p-2 bg-green-50 rounded mb-2">
                                                <span class="text-sm font-medium text-green-800">Cestas Normais</span>
                                                <span class="font-bold text-green-800" id="rel-qtd-normal">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-2 bg-amber-50 rounded">
                                                <span class="text-sm font-medium text-amber-800">Cestas Alteradas</span>
                                                <span class="font-bold text-amber-800" id="rel-qtd-alterada">0</span>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Brindes Entregues</p>
                                            <div id="rel-grid-brindes" class="flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Inputs de Arquivo Ocultos -->
    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json" onchange="App.controllers.importarBackup(this)">
    <input type="file" id="input-carregar-clientes" class="hidden" accept=".js,.json,text/javascript,application/json" onchange="App.controllers.importarClientes(this)">

    <!-- JAVASCRIPT APP -->
    <script>
        const CONSTANTS = {
            PIX_NOME: "Osvaldo Sereia Junior",
            PIX_CELULAR: "65984491018",
            NUMERO_GERENTE: "5565996884599",
            NUMERO_RELATORIO: "5565998150975",
            NUMERO_CONFIRMACAO_ENTREGA: "5565998150975",
            LINK_APP: "https://play.google.com/store/apps", // Link gen√©rico placeholder
            REGIOES: ["VG", "CUIABA", "COXIPO", "CPA"],
            STORAGE_KEY: "rotaflow_v2_db",
            HISTORY_KEY: "rotaflow_historico_db",
            METADATA_KEY: "rotaflow_clientes_meta_db", // Guarda datas de a√ß√µes (cupom, avaliacao)
            CLIENTS_DB_KEY: "rotaflow_clientes_db", // NOVO: Chave para persistir clientes
            CESTAS_OPTIONS: [
                { value: "ECONOMICA", label: "ECONOMICA", price: 85.00 },
                { value: "Mini Bonini", label: "Mini Bonini", price: 165.00 },
                { value: "Mini Koblenz", label: "Mini Koblenz", price: 170.00 },
                { value: "Pequena Bonini", label: "Pequena Bonini", price: 215.00 },
                { value: "Pequena Koblenz", label: "Pequena Koblenz", price: 220.00 },
                { value: "M√©dia Bonini", label: "M√©dia Bonini", price: 320.00 },
                { value: "M√©dia Koblenz", label: "M√©dia Koblenz", price: 325.00 },
                { value: "Grande Bonini", label: "Grande Bonini", price: 380.00 },
                { value: "Grande Koblenz", label: "Grande Koblenz", price: 390.00 }
            ]
        };

        const Store = {
            data: { rotaAtiva: null, regiaoFiltro: 'VG', carrinhoTemp: [], entregaEmAcaoId: null, editingId: null, history: [], meta: {} },
            init() {
                // Carrega Rota Atual
                const saved = localStorage.getItem(CONSTANTS.STORAGE_KEY);
                if (saved) {
                    this.data.rotaAtiva = JSON.parse(saved);
                    if(!Array.isArray(this.data.rotaAtiva.entregas)) this.data.rotaAtiva.entregas = [];
                } else { this.novaRota(); }

                // Carrega Hist√≥rico
                const savedHistory = localStorage.getItem(CONSTANTS.HISTORY_KEY);
                this.data.history = savedHistory ? JSON.parse(savedHistory) : [];

                // Carrega Metadados (A√ß√µes de marketing)
                const savedMeta = localStorage.getItem(CONSTANTS.METADATA_KEY);
                this.data.meta = savedMeta ? JSON.parse(savedMeta) : {};

                // NOVO: Carregar base de Clientes Persistente
                const savedClients = localStorage.getItem(CONSTANTS.CLIENTS_DB_KEY);
                if(savedClients) {
                    try {
                        window.CLIENTES_DB = JSON.parse(savedClients);
                        console.log("Clientes carregados do cache local:", window.CLIENTES_DB.length);
                    } catch(e) { console.error("Erro ao carregar clientes do cache"); }
                }
            },
            novaRota() {
                this.data.rotaAtiva = { id: Date.now(), dataCriacao: new Date().toISOString(), entregas: [] };
                this.save();
            },
            save() {
                localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(this.data.rotaAtiva));
                App.ui.render();
            },
            saveHistory() {
                localStorage.setItem(CONSTANTS.HISTORY_KEY, JSON.stringify(this.data.history));
            },
            saveMeta() {
                localStorage.setItem(CONSTANTS.METADATA_KEY, JSON.stringify(this.data.meta));
            },
            // Adiciona uma entrega finalizada ao hist√≥rico
            addToHistory(entrega) {
                // Remove duplicatas se houver
                this.data.history = this.data.history.filter(h => h.id !== entrega.id);
                this.data.history.push(entrega);
                // Limpa hist√≥rico muito antigo (> 12 meses)
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                this.data.history = this.data.history.filter(h => new Date(h.updatedAt) > oneYearAgo);
                this.saveHistory();
            },
            // NOVO: Remove hist√≥rico de um cliente
            removeFromHistory(clienteNome) {
                if(!clienteNome) return;
                const initialCount = this.data.history.length;
                this.data.history = this.data.history.filter(h => h.cliente.nome !== clienteNome);
                if(this.data.history.length < initialCount) {
                    this.saveHistory();
                    return true;
                }
                return false;
            },
            updateMeta(clienteNome, field, value) {
                if(!this.data.meta[clienteNome]) this.data.meta[clienteNome] = {};
                this.data.meta[clienteNome][field] = value;
                this.saveMeta();
            },
            getEntregasFiltradas() {
                if (!this.data.rotaAtiva) return [];
                let lista = this.data.rotaAtiva.entregas.filter(e => e.regiao === this.data.regiaoFiltro);
                return lista.sort((a, b) => {
                    if (a.status === 'Pendente' && b.status !== 'Pendente') return -1;
                    if (a.status !== 'Pendente' && b.status === 'Pendente') return 1;
                    return 0; 
                });
            },
            addEntrega(entrega) { this.data.rotaAtiva.entregas.push(entrega); this.save(); },
            updateEntrega(id, updates) {
                const index = this.data.rotaAtiva.entregas.findIndex(e => e.id == id);
                if (index !== -1) {
                    this.data.rotaAtiva.entregas[index] = { ...this.data.rotaAtiva.entregas[index], ...updates, updatedAt: new Date().toISOString() };
                    this.save();
                }
            },
            moverEntrega(id, direcao) {
                const entregas = this.data.rotaAtiva.entregas;
                const indicesRegiao = entregas.map((e, i) => ({ ...e, originalIndex: i })).filter(e => e.regiao === this.data.regiaoFiltro && e.status === 'Pendente');
                const itemRegiaoIndex = indicesRegiao.findIndex(e => e.id == id);
                if (itemRegiaoIndex === -1) return;
                const targetRegiaoIndex = direcao === 'cima' ? itemRegiaoIndex - 1 : itemRegiaoIndex + 1;
                if (targetRegiaoIndex >= 0 && targetRegiaoIndex < indicesRegiao.length) {
                    const idxA = indicesRegiao[itemRegiaoIndex].originalIndex;
                    const idxB = indicesRegiao[targetRegiaoIndex].originalIndex;
                    [entregas[idxA], entregas[idxB]] = [entregas[idxB], entregas[idxA]];
                    this.save();
                }
            }
        };

        const Utils = {
            formatMoeda: (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0),
            formatData: (iso) => new Date(iso).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' }),
            formatDataCurta: (iso) => new Date(iso).toLocaleDateString('pt-BR'),
            formatHora: (iso) => new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
            diffDias: (dataAntiga) => {
                const diffTime = Math.abs(new Date() - new Date(dataAntiga));
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            },
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast text-sm font-medium ${type === 'error' ? 'border-red-500 text-red-800' : 'text-slate-800'}`;
                el.innerHTML = msg;
                container.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(100%)'; setTimeout(() => el.remove(), 300); }, 3000);
            }
        };

        const App = {
            ui: {
                modalLancamento: {
                    open: () => {
                        document.getElementById('modal-lancamento').classList.remove('hidden');
                    },
                    close: () => document.getElementById('modal-lancamento').classList.add('hidden')
                },
                modalExport: {
                    open: () => {
                        const container = document.getElementById('export-regioes-list');
                        container.innerHTML = CONSTANTS.REGIOES.map(r => `<label class="flex items-center space-x-2 border p-2 rounded cursor-pointer"><input type="checkbox" checked value="${r}" class="text-blue-600 rounded focus:ring-blue-500"><span class="text-sm text-slate-700">${r}</span></label>`).join('');
                        document.getElementById('modal-exportar').classList.remove('hidden');
                    },
                    close: () => document.getElementById('modal-exportar').classList.add('hidden')
                },
                modalRelatorio: {
                    open: () => {
                        document.getElementById('main-menu').classList.add('hidden');
                        const container = document.getElementById('relatorio-regioes-list');
                        container.innerHTML = CONSTANTS.REGIOES.map(r => `<label class="flex items-center space-x-2 border p-2 rounded cursor-pointer bg-slate-50 hover:bg-slate-100"><input type="checkbox" checked value="${r}" class="text-green-600 rounded focus:ring-green-500"><span class="text-sm text-slate-700 font-medium">${r}</span></label>`).join('');
                        document.getElementById('modal-relatorio').classList.remove('hidden');
                    },
                    close: () => document.getElementById('modal-relatorio').classList.add('hidden')
                },
                modalHistorico: {
                    open: () => {
                        document.getElementById('main-menu').classList.add('hidden');
                        document.getElementById('modal-historico').classList.remove('hidden');
                        App.controllers.switchCRMTab('diario'); // Default tab
                        
                        // Set datas padr√£o no relat√≥rio
                        const today = new Date();
                        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                        document.getElementById('rel-start').valueAsDate = firstDay;
                        document.getElementById('rel-end').valueAsDate = today;
                    },
                    close: () => document.getElementById('modal-historico').classList.add('hidden')
                },
                toggleMenu: () => { document.getElementById('main-menu').classList.toggle('hidden'); },
                renderCarrinho: () => {
                    const container = document.getElementById('carrinho-visual');
                    const totalInput = document.getElementById('input-valor-final');
                    if(Store.data.carrinhoTemp.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 text-sm py-2">Nenhum item adicionado</div>'; totalInput.value = ''; return; }
                    let totalCalculado = 0;
                    container.innerHTML = Store.data.carrinhoTemp.map((item, idx) => {
                        totalCalculado += (item.valor * item.qtd);
                        return `<div class="flex justify-between items-start bg-white p-2 rounded border border-slate-100 shadow-sm animate-in fade-in"><div><p class="text-sm font-bold text-slate-800">${item.qtd}x ${item.nome}</p>${item.tipo === 'Alterada' ? `<div class="text-xs mt-1">${item.tirar ? `<span class="text-red-500 font-semibold block">Tirar: ${item.tirar}</span>` : ''}${item.por ? `<span class="text-green-600 font-semibold block">P√¥r: ${item.por}</span>` : ''}</div>` : ''}${item.brindes && item.brindes.length ? `<p class="text-xs text-pink-500">+ ${item.brindes.join(', ')}</p>` : ''}</div><div class="flex items-center gap-2"><span class="text-sm font-semibold text-blue-600">${Utils.formatMoeda(item.valor * item.qtd)}</span><button onclick="App.controllers.removerItemCarrinho(${idx})" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></div>`;
                    }).join('');
                    if (!totalInput.value || parseFloat(totalInput.value) === 0) totalInput.value = totalCalculado.toFixed(2);
                },
                render: () => {
                    const entregas = Store.getEntregasFiltradas();
                    const container = document.getElementById('lista-entregas');
                    const emptyState = document.getElementById('lista-vazia');
                    document.getElementById('header-date').innerText = Utils.formatData(Store.data.rotaAtiva.dataCriacao);
                    const totalGeral = Store.data.rotaAtiva.entregas.length;
                    const entreguesGeral = Store.data.rotaAtiva.entregas.filter(e => e.status === 'Entregue').length;
                    let percentual = totalGeral > 0 ? (entreguesGeral / totalGeral) * 100 : 0;
                    
                    document.getElementById('kpi-container').innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div class="flex-1"><p class="text-slate-500 text-sm font-bold uppercase mb-1">Status Rota</p><div class="flex items-baseline gap-2"><span class="text-4xl font-black text-slate-800">${entreguesGeral}</span><span class="text-lg text-slate-400 font-medium">de ${totalGeral}</span></div><div class="w-full bg-slate-100 rounded-full h-2.5 mt-2"><div class="bg-slate-800 h-2.5 rounded-full transition-all duration-500" style="width: ${percentual}%"></div></div></div></div>`;
                    
                    const regioesHtml = CONSTANTS.REGIOES.map(r => {
                        const count = Store.data.rotaAtiva.entregas.filter(e => e.regiao === r && e.status === 'Pendente').length;
                        const active = Store.data.regiaoFiltro === r;
                        return `<button onclick="App.controllers.mudarFiltro('${r}')" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium transition-colors border ${active ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}">${r} <span class="${active ? 'bg-slate-600 text-white' : 'bg-slate-200 text-slate-600'} text-xs py-0.5 px-1.5 rounded-full ml-1">${count}</span></button>`;
                    }).join('');
                    document.getElementById('filtros-regiao').innerHTML = regioesHtml;
                    if (entregas.length === 0) { container.innerHTML = ''; emptyState.classList.remove('hidden'); emptyState.classList.add('flex'); return; }
                    emptyState.classList.add('hidden'); emptyState.classList.remove('flex');
                    container.innerHTML = entregas.map((entrega, index) => {
                        const isPendente = entrega.status === 'Pendente';
                        const itensHtml = entrega.cestas.map(c => `
                            <div class="py-2">
                                <div class="flex justify-between items-center text-slate-900">
                                    <div class="text-base font-bold flex-1 truncate pr-2">${c.qtd}x ${c.nome}</div>
                                    <div class="text-base font-semibold text-slate-600 whitespace-nowrap">${Utils.formatMoeda(c.valor * c.qtd)}</div>
                                </div>
                                ${c.tipo === 'Alterada' ? `<div class="mt-2 pt-2 border-t border-slate-100 text-sm text-slate-600">${c.tirar ? `<div class="flex gap-1"><span class="font-bold text-red-600">Tirar:</span> <span>${c.tirar}</span></div>` : ''}${c.por ? `<div class="flex gap-1"><span class="font-bold text-green-600">P√¥r:</span> <span>${c.por}</span></div>` : ''}</div>` : ''}
                                ${c.brindes && c.brindes.length ? `<div class="mt-2 pt-2 border-t border-slate-100 text-sm text-slate-600 font-medium"><span class="text-slate-400 font-normal mr-1">Brinde:</span> ${c.brindes.join(', ')}</div>` : ''}
                            </div>
                        `).join('<div class="border-b border-slate-100 my-1"></div>');
                        return `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative transition-transform transform ${isPendente ? 'hover:shadow-md' : 'opacity-70 bg-slate-50'}">
                            ${!isPendente ? `<div class="absolute inset-0 z-10 flex items-center justify-center pointer-events-none"><div class="bg-white/90 border-2 ${entrega.status === 'Entregue' ? 'border-green-500 text-green-600' : 'border-red-500 text-red-600'} px-4 py-1 rounded-lg text-xl font-black uppercase rotate-[-12deg] shadow-lg">${entrega.status}</div></div>` : ''}
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2"><h4 class="text-lg font-bold text-slate-900 leading-tight truncate max-w-[200px]" title="${entrega.cliente.nome}">${entrega.cliente.nome}</h4></div></div>
                                ${entrega.cliente.complemento ? `<div class="mb-4"><p class="text-base font-medium text-slate-700 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100 inline-block leading-snug w-full">${entrega.cliente.complemento}</p></div>` : ''}
                                <div class="mb-4 border-t border-b border-slate-100 py-1">${itensHtml}</div>
                                ${entrega.observacao ? `<div class="mb-4 pt-2 border-t border-slate-100"><p class="text-sm text-red-600 font-bold flex items-start gap-1">‚ö†Ô∏è ${entrega.observacao}</p></div>` : ''}
                                <div class="space-y-3"><div class="grid grid-cols-4 gap-3"><button onclick="App.controllers.abrirZap(${entrega.id})" class="py-2.5 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50 transition-colors uppercase tracking-wide flex flex-col items-center justify-center"><svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>Zap</button><button onclick="App.controllers.abrirMapa('${entrega.cliente.endereco}')" class="py-2.5 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50 transition-colors uppercase tracking-wide flex flex-col items-center justify-center"><svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Mapa</button>${isPendente ? `<button onclick="App.controllers.editarEntrega(${entrega.id})" class="py-2.5 bg-white border border-amber-200 text-amber-600 text-xs font-bold rounded-lg hover:bg-amber-50 transition-colors uppercase tracking-wide flex flex-col items-center justify-center col-span-2"><svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Editar</button>` : ''}</div><div class="grid grid-cols-3 gap-3"><a href="${entrega.cliente.celular ? 'tel:'+entrega.cliente.celular : '#'}" class="py-2.5 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center uppercase tracking-wide">Ligar</a>${isPendente ? `<button onclick="App.controllers.iniciarPagamento(${entrega.id})" class="col-span-1 py-2.5 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-900 shadow-sm transition-colors uppercase tracking-wide">Entregue</button><button onclick="App.controllers.cancelarEntrega(${entrega.id})" class="col-span-1 py-2.5 bg-white border border-red-100 text-red-500 text-xs font-bold rounded-lg hover:bg-red-50 transition-colors uppercase tracking-wide">Cancelar</button>` : (entrega.status === 'Entregue' ? `<button onclick="App.controllers.abrirPosVenda(${entrega.id})" class="col-span-2 py-2.5 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-900 shadow-sm transition-colors uppercase tracking-wide">P√≥s Venda</button>` : '')}</div>${isPendente ? `<div class="flex justify-center gap-6 mt-2 pt-2 border-t border-slate-50"><button onclick="App.controllers.moverEntrega(${entrega.id}, 'cima')" class="text-slate-300 hover:text-slate-600 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg></button><button onclick="App.controllers.moverEntrega(${entrega.id}, 'baixo')" class="text-slate-300 hover:text-slate-600 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button></div>` : ''}</div></div></div>`;
                    }).join('');
                }
            },
            controllers: {
                novaRota: () => { if(confirm('Isso apagar√° a rota atual e criar√° uma nova. Confirmar?')) { Store.novaRota(); window.location.reload(); } },
                mudarFiltro: (regiao) => { Store.data.regiaoFiltro = regiao; App.ui.render(); },
                toggleCheckAlterada: () => { const check = document.getElementById('check-alterada'); const box = document.getElementById('box-detalhes-alterada'); if(check.checked) box.classList.remove('hidden'); else box.classList.add('hidden'); },
                
                resetarCRM: () => {
                    if(confirm('‚ö†Ô∏è PERIGO: Voc√™ est√° prestes a apagar TODO o hist√≥rico de vendas e clientes (CRM).\n\nEssa a√ß√£o N√ÉO pode ser desfeita.\n\nDeseja continuar?')) {
                        if(confirm('Tem certeza absoluta? Digite OK para confirmar.')) { 
                             Store.data.history = [];
                             Store.data.meta = {};
                             Store.saveHistory();
                             Store.saveMeta();
                             App.controllers.crmDailyFilter(0); // Refresh
                             Utils.toast('CRM resetado completamente.', 'error');
                        }
                    }
                },

                // TAB SWITCHER
                switchCRMTab: (tabName) => {
                    const tabs = {
                        'diario': document.getElementById('tab-diario'),
                        'busca': document.getElementById('tab-busca'),
                        'cupons': document.getElementById('tab-cupons'),
                        'relatorios': document.getElementById('tab-relatorios')
                    };
                    const views = {
                        'diario': document.getElementById('crm-view-daily'),
                        'busca': document.getElementById('crm-view-search'),
                        'cupons': document.getElementById('crm-view-cupons'),
                        'relatorios': document.getElementById('crm-view-reports')
                    };

                    // Reset
                    Object.values(tabs).forEach(t => {
                        t.classList.remove('border-blue-600', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-slate-500');
                    });
                    Object.values(views).forEach(v => v.classList.add('hidden'));

                    // Active
                    if(tabs[tabName]) {
                        tabs[tabName].classList.remove('border-transparent', 'text-slate-500');
                        tabs[tabName].classList.add('border-blue-600', 'text-blue-600');
                    }
                    if(views[tabName]) views[tabName].classList.remove('hidden');

                    if(tabName === 'diario') App.controllers.crmDailyFilter(0);
                    if(tabName === 'cupons') { App.controllers.couponPagination = 20; App.controllers.crmCouponsFilter(); }
                },

                // === CRM: VENDAS POR DIA ===
                crmDailyFilter: (daysAgo) => {
                    const btnContainer = document.getElementById('daily-filters');
                    btnContainer.innerHTML = [0, 1, 2, 3, 4, 5].map(d => {
                        const label = d === 0 ? 'Hoje' : (d === 1 ? 'Ontem' : `H√° ${d} dias`);
                        const isActive = d === daysAgo;
                        return `<button onclick="App.controllers.crmDailyFilter(${d})" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-colors border ${isActive ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}">${label}</button>`;
                    }).join('');

                    const targetDate = new Date();
                    targetDate.setDate(targetDate.getDate() - daysAgo);
                    const targetDateStr = targetDate.toLocaleDateString('pt-BR');

                    const filtered = Store.data.history.filter(item => {
                        const itemDate = new Date(item.updatedAt || item.dataCriacao).toLocaleDateString('pt-BR');
                        return itemDate === targetDateStr;
                    });

                    const tbody = document.getElementById('crm-daily-body');
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">Nenhuma venda encontrada nesta data.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = filtered.map(item => {
                        const cestasStr = item.cestas.map(c => `${c.qtd}x ${c.nome}`).join(', ');
                        return `
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-3 text-xs font-medium text-slate-500">${Utils.formatHora(item.updatedAt)}</td>
                            <td class="p-3">
                                <div class="font-bold text-slate-800 text-sm">${item.cliente.nome}</div>
                                <div class="text-xs text-slate-400">${item.cliente.celular || ''}</div>
                            </td>
                            <td class="p-3 text-xs text-slate-600 max-w-[200px] truncate" title="${cestasStr}">${cestasStr}</td>
                            <td class="p-3 text-xs text-slate-600">${item.formaPagamento ? item.formaPagamento.join(', ') : '-'}</td>
                            <td class="p-3 text-xs font-bold text-slate-700">${item.regiao}</td>
                            <td class="p-3 text-right font-bold text-green-600 text-sm">${Utils.formatMoeda(item.valorTotalAjustado)}</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick='App.controllers.imprimirPedido10x15(${item.id})' class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-1.5 rounded transition-colors text-xs font-bold border border-slate-300" title="Imprimir Pedido">üñ®Ô∏è Pedido</button>
                                    <button onclick='App.controllers.imprimirIma(${item.id})' class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 p-1.5 rounded transition-colors text-xs font-bold border border-yellow-300" title="Imprimir √çm√£">üé´ √çm√£</button>
                                    <button onclick='App.controllers.triggerAdminLinks(${item.id})' class="bg-green-100 hover:bg-green-200 text-green-700 p-1.5 rounded transition-colors text-xs font-bold border border-green-300" title="Enviar Links ao Admin">üì± Zap</button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');
                },

                triggerAdminLinks: (id) => {
                    const item = Store.data.history.find(h => h.id == id);
                    if(item) App.controllers.enviarRelatorioFinalZap(item);
                },

                // === IMPRESS√ÉO 10x15 PEDIDO ===
                imprimirPedido10x15: (id) => {
                    const entrega = Store.data.history.find(e => e.id == id) || Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    if(!entrega) return;

                    const container = document.getElementById('ticket-print-area');
                    const dataHora = new Date(entrega.updatedAt || entrega.dataCriacao).toLocaleString('pt-BR');
                    
                    let itensHtml = entrega.cestas.map(c => `
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px; border-bottom:1px dashed #ccc; padding-bottom:2px;">
                            <span>${c.qtd}x ${c.nome}</span>
                            <span>${Utils.formatMoeda(c.valor * c.qtd)}</span>
                        </div>
                        ${c.tipo === 'Alterada' ? `<div style="font-size:10px; margin-bottom:4px;"><b>TIRAR:</b> ${c.tirar || '-'} <br> <b>P√îR:</b> ${c.por || '-'}</div>` : ''}
                        ${c.brindes && c.brindes.length ? `<div style="font-size:10px; margin-bottom:4px;"><b>+ BRINDE:</b> ${c.brindes.join(', ')}</div>` : ''}
                    `).join('');

                    container.innerHTML = `
                        <div class="print-10x15">
                            <h1>ROTA DONA ANTONIA</h1>
                            <div style="font-size:12px; margin-bottom:10px;">${dataHora} | PEDIDO #${id.toString().slice(-4)}</div>
                            
                            <div class="box">
                                <div class="label">CLIENTE</div>
                                <div class="value" style="font-size:16px;">${entrega.cliente.nome}</div>
                                <div>${entrega.cliente.celular || ''}</div>
                                <div style="margin-top:2px;">${entrega.cliente.endereco || 'Retirar'}</div>
                                ${entrega.cliente.complemento ? `<div>(${entrega.cliente.complemento})</div>` : ''}
                                <div class="label" style="margin-top:5px;">REGI√ÉO: ${entrega.regiao}</div>
                            </div>

                            <div class="box">
                                <div class="label">ITENS DO PEDIDO</div>
                                ${itensHtml}
                            </div>

                            ${entrega.observacao ? `<div class="box"><div class="label">OBSERVA√á√ÉO</div>${entrega.observacao}</div>` : ''}

                            <div class="big-total">
                                TOTAL: ${Utils.formatMoeda(entrega.valorTotalAjustado)}
                            </div>
                            <div style="text-align:right; font-size:12px;">
                                Pagamento: ${entrega.formaPagamento ? entrega.formaPagamento.join(', ') : '-'}
                            </div>
                        </div>
                    `;

                    document.body.classList.add('mode-print-view');
                    setTimeout(() => { window.print(); setTimeout(() => document.body.classList.remove('mode-print-view'), 500); }, 100);
                },

                // === IMPRESS√ÉO √çM√É (CUPOM) ===
                imprimirIma: (id) => {
                    const entrega = Store.data.history.find(e => e.id == id) || Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    if(!entrega) return;

                    // L√≥gica de Brinde
                    let gift = "Brinde Surpresa";
                    const hasBasket = (str) => entrega.cestas.some(c => c.nome.toLowerCase().includes(str));
                    
                    if(hasBasket('grande') || hasBasket('m√©dia') || hasBasket('media')) gift = "1 Caf√© 250g";
                    else if(hasBasket('pequena') || hasBasket('mini')) gift = "1 Amaciante";
                    else if(hasBasket('economica') || hasBasket('econ√¥mica')) gift = "1 Detergente";

                    // Validade
                    const date = new Date(entrega.updatedAt || entrega.dataCriacao);
                    date.setDate(date.getDate() + 40);
                    const validade = date.toLocaleDateString('pt-BR');

                    const container = document.getElementById('ticket-print-area');
                    container.innerHTML = `
                        <div class="print-ima">
                            <div class="ima-title">VALE BRINDE</div>
                            <div style="font-size:10px;">Para sua pr√≥xima compra!</div>
                            <div class="ima-gift">${gift}</div>
                            <div>V√°lido at√©:</div>
                            <div class="ima-validity">${validade}</div>
                            <div style="font-size:9px; margin-top:5px;">Rota Dona Antonia</div>
                        </div>
                    `;

                    document.body.classList.add('mode-print-view');
                    setTimeout(() => { window.print(); setTimeout(() => document.body.classList.remove('mode-print-view'), 500); }, 100);
                },

                // === CRM: CUPONS ===
                couponPagination: 20,
                crmCouponsFilter: () => {
                    const now = new Date();
                    // Filtra vendas com menos de 40 dias (que ainda podem ter cupom v√°lido ou rec√©m vencido)
                    // Mas vamos pegar um range maior para garantir hist√≥rico
                    let allWithCoupons = Store.data.history.map(h => {
                        const purchaseDate = new Date(h.updatedAt || h.dataCriacao);
                        const expDate = new Date(purchaseDate);
                        expDate.setDate(purchaseDate.getDate() + 40);
                        
                        // Determinar brinde novamente
                        let gift = "Brinde Surpresa";
                        const hasBasket = (str) => h.cestas.some(c => c.nome.toLowerCase().includes(str));
                        if(hasBasket('grande') || hasBasket('m√©dia') || hasBasket('media')) gift = "1 Caf√© 250g";
                        else if(hasBasket('pequena') || hasBasket('mini')) gift = "1 Amaciante";
                        else if(hasBasket('economica') || hasBasket('econ√¥mica')) gift = "1 Detergente";

                        return {
                            ...h,
                            expDate: expDate,
                            gift: gift,
                            daysLeft: Math.ceil((expDate - now) / (1000 * 60 * 60 * 24))
                        };
                    });

                    // Filtra apenas os que vencem no futuro ou venceram recentemente (ex: -5 dias) para n√£o mostrar hist√≥rico de 1 ano atr√°s
                    allWithCoupons = allWithCoupons.filter(i => i.daysLeft > -5);

                    // Ordena: Menor daysLeft primeiro (mais urgente)
                    allWithCoupons.sort((a,b) => a.daysLeft - b.daysLeft);

                    const visible = allWithCoupons.slice(0, App.controllers.couponPagination);
                    const tbody = document.getElementById('crm-cupons-body');
                    
                    if(visible.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400">Nenhum cupom pr√≥ximo do vencimento.</td></tr>';
                        document.getElementById('btn-load-more-cupons').classList.add('hidden');
                        return;
                    }

                    tbody.innerHTML = visible.map(item => {
                        const styleClass = item.daysLeft < 0 ? 'text-red-600 bg-red-50' : (item.daysLeft <= 5 ? 'text-amber-600 bg-amber-50' : 'text-green-600 bg-green-50');
                        const status = item.daysLeft < 0 ? `Venceu h√° ${Math.abs(item.daysLeft)} dias` : (item.daysLeft === 0 ? 'VENCE HOJE' : `Vence em ${item.daysLeft} dias`);
                        
                        return `
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-3">
                                <div class="font-bold text-slate-800">${item.cliente.nome}</div>
                                <div class="text-xs text-slate-400">${item.cliente.celular || '-'}</div>
                            </td>
                            <td class="p-3 text-xs text-slate-600">${new Date(item.updatedAt).toLocaleDateString('pt-BR')}</td>
                            <td class="p-3 text-sm font-bold text-slate-700">${item.gift}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold ${styleClass}">${status}</span>
                                <div class="text-xs text-slate-400 mt-1">${item.expDate.toLocaleDateString('pt-BR')}</div>
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="App.controllers.avisarVencimentoCupom('${item.cliente.celular}', '${item.cliente.nome}', '${item.expDate.toLocaleDateString('pt-BR')}', '${item.gift}')" class="bg-green-100 hover:bg-green-200 text-green-700 p-2 rounded-full transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('');

                    if (allWithCoupons.length > App.controllers.couponPagination) {
                        document.getElementById('btn-load-more-cupons').classList.remove('hidden');
                    } else {
                        document.getElementById('btn-load-more-cupons').classList.add('hidden');
                    }
                },

                loadMoreCoupons: () => {
                    App.controllers.couponPagination += 20;
                    App.controllers.crmCouponsFilter();
                },

                avisarVencimentoCupom: (celular, nome, data, brinde) => {
                    if(!celular) return Utils.toast('Cliente sem celular cadastrado', 'error');
                    let num = celular.replace(/\D/g, '');
                    if(!num.startsWith('55')) num = '55' + num;
                    
                    const msg = `Ol√° ${nome}! Aqui √© da Rota Dona Antonia. üåü\n\nPassando para lembrar que voc√™ tem um vale-brinde de *${brinde}* que vence dia *${data}*! üóìÔ∏è\n\nAproveite para fazer seu pedido e garantir seu brinde! üööüì¶`;
                    
                    window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                },

                // === CRM: BUSCA CLIENTE ===
                crmSearchClient: () => {
                    const term = document.getElementById('crm-client-search-input').value.toLowerCase().trim();
                    const container = document.getElementById('crm-search-results');
                    
                    if(term.length < 2) {
                        container.innerHTML = '<p class="text-center text-slate-400 mt-10">Digite pelo menos 2 caracteres.</p>';
                        return;
                    }

                    const filtered = Store.data.history.filter(h => {
                        const nome = h.cliente.nome.toLowerCase();
                        const cel = h.cliente.celular ? h.cliente.celular.replace(/\D/g, '') : '';
                        return nome.includes(term) || cel.includes(term);
                    });

                    filtered.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)); // Mais recente primeiro

                    if(filtered.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-400 mt-10">Nenhuma compra encontrada para este cliente.</p>';
                        return;
                    }

                    container.innerHTML = filtered.map(item => {
                        const date = new Date(item.updatedAt).toLocaleDateString('pt-BR');
                        const cestasHtml = item.cestas.map(c => `
                            <div class="text-sm">
                                <span class="font-bold">${c.qtd}x ${c.nome}</span> 
                                <span class="text-slate-500 text-xs">(${Utils.formatMoeda(c.valor * c.qtd)})</span>
                                ${c.tipo === 'Alterada' ? `<div class="text-xs pl-2 text-amber-600">Tirar: ${c.tirar} / P√¥r: ${c.por}</div>` : ''}
                            </div>
                        `).join('');

                        return `
                        <div class="bg-white p-4 rounded-lg shadow border border-slate-200">
                            <div class="flex justify-between items-start border-b border-slate-100 pb-2 mb-2">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${item.cliente.nome}</h4>
                                    <p class="text-xs text-slate-500">${date} - ${item.cliente.celular || 'Sem celular'}</p>
                                </div>
                                <div class="text-right">
                                    <div class="font-black text-green-600 text-lg">${Utils.formatMoeda(item.valorTotalAjustado)}</div>
                                    <div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded inline-block mt-1">${item.formaPagamento ? item.formaPagamento.join('+') : '-'}</div>
                                </div>
                            </div>
                            <div class="space-y-2 mb-3">
                                ${cestasHtml}
                            </div>
                            ${item.observacao ? `<div class="text-xs text-red-600 font-bold bg-red-50 p-2 rounded mb-2">Obs: ${item.observacao}</div>` : ''}
                            <div class="text-xs text-slate-400">Regi√£o: ${item.regiao}</div>
                        </div>`;
                    }).join('');
                },

                // RELATORIO VENDAS LOGIC (BI)
                gerarRelatorioVendas: () => {
                    const startInput = document.getElementById('rel-start').value;
                    const endInput = document.getElementById('rel-end').value;

                    if(!startInput || !endInput) return Utils.toast('Selecione as datas inicial e final.', 'error');

                    // Ajuste para comparar datas (zerar horas)
                    const startDate = new Date(startInput + 'T00:00:00');
                    const endDate = new Date(endInput + 'T23:59:59');

                    const filtered = Store.data.history.filter(item => {
                        const d = new Date(item.updatedAt);
                        return d >= startDate && d <= endDate;
                    });

                    // Stats
                    let totalVal = 0;
                    let regiaoStats = {};
                    let pagamentoStats = {};
                    let cestaStats = {};
                    let normalCount = 0;
                    let alteradaCount = 0;
                    let brindesCount = {};

                    filtered.forEach(order => {
                        totalVal += (order.valorTotalAjustado || 0);

                        // Regiao
                        if(!regiaoStats[order.regiao]) regiaoStats[order.regiao] = { qtd: 0, val: 0 };
                        regiaoStats[order.regiao].qtd++;
                        regiaoStats[order.regiao].val += (order.valorTotalAjustado || 0);

                        // Pagamento
                        if(order.formaPagamento && Array.isArray(order.formaPagamento)) {
                            order.formaPagamento.forEach(p => {
                                const pClean = p.toUpperCase().trim();
                                if(!pagamentoStats[pClean]) pagamentoStats[pClean] = 0;
                                pagamentoStats[pClean]++;
                            });
                        }

                        // Cestas e Brindes
                        if(order.cestas && Array.isArray(order.cestas)) {
                            order.cestas.forEach(c => {
                                // Cesta
                                if(!cestaStats[c.nome]) cestaStats[c.nome] = { qtd: 0, val: 0 };
                                cestaStats[c.nome].qtd += c.qtd;
                                cestaStats[c.nome].val += (c.valor * c.qtd);

                                // Tipo
                                if(c.tipo === 'Normal') normalCount += c.qtd;
                                else alteradaCount += c.qtd;

                                // Brindes
                                if(c.brindes && Array.isArray(c.brindes)) {
                                    c.brindes.forEach(b => {
                                        if(!brindesCount[b]) brindesCount[b] = 0;
                                        brindesCount[b]++;
                                    });
                                }
                            });
                        }
                    });

                    // Renderiza√ß√£o
                    document.getElementById('rel-total-valor').innerText = Utils.formatMoeda(totalVal);
                    document.getElementById('rel-total-pedidos').innerText = filtered.length;
                    document.getElementById('rel-ticket-medio').innerText = filtered.length ? Utils.formatMoeda(totalVal / filtered.length) : 'R$ 0,00';

                    // Grid Regiao
                    const htmlRegiao = Object.entries(regiaoStats)
                        .sort((a,b) => b[1].val - a[1].val)
                        .map(([k,v]) => `
                            <div class="flex justify-between items-center text-sm border-b border-dashed border-slate-100 pb-2">
                                <span class="font-medium text-slate-600">${k}</span>
                                <div class="text-right">
                                    <div class="font-bold text-slate-800">${Utils.formatMoeda(v.val)}</div>
                                    <div class="text-xs text-slate-400">${v.qtd} pedidos</div>
                                </div>
                            </div>`)
                        .join('');
                    document.getElementById('rel-grid-regiao').innerHTML = htmlRegiao || '<p class="text-sm text-slate-400">Sem dados</p>';

                    // Grid Pagamento
                    const htmlPag = Object.entries(pagamentoStats)
                        .sort((a,b) => b[1] - a[1])
                        .map(([k,v]) => {
                            const pct = Math.round((v / filtered.length) * 100) || 0;
                            return `
                            <div class="mb-2">
                                <div class="flex justify-between text-xs font-bold text-slate-600 mb-1">
                                    <span>${k}</span>
                                    <span>${v} (${pct}%)</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${pct}%"></div>
                                </div>
                            </div>`;
                        }).join('');
                    document.getElementById('rel-grid-pagamento').innerHTML = htmlPag || '<p class="text-sm text-slate-400">Sem dados</p>';

                    // Grid Cestas
                    const htmlCestas = Object.entries(cestaStats)
                        .sort((a,b) => b[1].qtd - a[1].qtd)
                        .map(([k,v]) => `
                            <div class="flex justify-between items-center bg-slate-50 p-2 rounded text-sm mb-1">
                                <span class="font-bold text-slate-700 truncate flex-1 pr-2">${k}</span>
                                <span class="font-medium text-slate-600 bg-white px-2 rounded shadow-sm border border-slate-100">${v.qtd}un</span>
                                <span class="ml-2 text-xs text-slate-400">${Utils.formatMoeda(v.val)}</span>
                            </div>
                        `).join('');
                    document.getElementById('rel-grid-cestas').innerHTML = htmlCestas || '<p class="text-sm text-slate-400">Sem dados</p>';

                    document.getElementById('rel-qtd-normal').innerText = normalCount;
                    document.getElementById('rel-qtd-alterada').innerText = alteradaCount;

                    // Grid Brindes
                    const htmlBrindes = Object.entries(brindesCount)
                        .sort((a,b) => b[1] - a[1])
                        .map(([k,v]) => `<span class="inline-block bg-pink-50 text-pink-700 px-2 py-1 rounded text-xs font-bold border border-pink-100">${v}x ${k}</span>`)
                        .join('');
                    document.getElementById('rel-grid-brindes').innerHTML = htmlBrindes || '<span class="text-slate-400 text-xs italic">Nenhum brinde registrado</span>';

                    document.getElementById('relatorio-resultados').classList.remove('hidden');
                },

                // Dropdowns
                abrirDropdownCliente: () => { document.getElementById('dropdown-clientes').classList.remove('hidden'); },
                fecharDropdownCliente: () => { setTimeout(() => document.getElementById('dropdown-clientes').classList.add('hidden'), 200); },
                selecionarCliente: (nome) => {
                    document.getElementById('input-cliente').value = nome;
                    const event = new Event('input'); document.getElementById('input-cliente').dispatchEvent(event);
                    App.controllers.fecharDropdownCliente();
                },
                toggleDropdownCesta: () => { document.getElementById('dropdown-cestas').classList.toggle('hidden'); },
                fecharDropdownCesta: () => { document.getElementById('dropdown-cestas').classList.add('hidden'); },
                selecionarCesta: (valor, label, preco) => {
                    document.getElementById('label-select-cesta').innerText = label;
                    document.getElementById('hidden-cesta-nome').value = valor;
                    document.getElementById('hidden-cesta-valor').value = preco;
                    document.getElementById('label-select-cesta').classList.add('text-slate-900', 'font-medium');
                    App.controllers.fecharDropdownCesta();
                },

                adicionarItemAoCarrinho: () => {
                    const nomeCesta = document.getElementById('hidden-cesta-nome').value;
                    const valorCesta = parseFloat(document.getElementById('hidden-cesta-valor').value);
                    const qtd = parseInt(document.getElementById('qtd-cesta').value);
                    const isAlterada = document.getElementById('check-alterada').checked;
                    
                    if(!nomeCesta) return Utils.toast('Selecione uma cesta', 'error');
                    if(qtd < 1) return Utils.toast('Quantidade inv√°lida', 'error');

                    const item = {
                        nome: nomeCesta,
                        valor: valorCesta,
                        qtd: qtd,
                        tipo: isAlterada ? 'Alterada' : 'Normal',
                        tirar: isAlterada ? document.getElementById('input-tirar').value : '',
                        por: isAlterada ? document.getElementById('input-por').value : '',
                        brindes: Array.from(document.querySelectorAll('input[name="brindes"]:checked')).map(el => el.value)
                    };

                    Store.data.carrinhoTemp.push(item);
                    App.ui.renderCarrinho();
                    
                    document.getElementById('check-alterada').checked = false;
                    App.controllers.toggleCheckAlterada();
                    document.getElementById('qtd-cesta').value = 1;
                    document.getElementById('input-tirar').value = '';
                    document.getElementById('input-por').value = '';
                    document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                    document.getElementById('label-select-cesta').innerText = 'Selecione a Cesta...';
                    document.getElementById('hidden-cesta-nome').value = '';
                },

                removerItemCarrinho: (index) => { Store.data.carrinhoTemp.splice(index, 1); App.ui.renderCarrinho(); },
                
                // NOVO: Prepara o modal para um novo lan√ßamento (Reset)
                iniciarNovoLancamento: () => {
                    Store.data.editingId = null;
                    Store.data.carrinhoTemp = [];
                    
                    // Reset UI
                    document.getElementById('modal-lancamento-title').innerText = "Nova Entrega";
                    document.getElementById('btn-submit-lancamento').innerText = "Confirmar Lan√ßamento";
                    document.getElementById('btn-submit-lancamento').classList.remove('bg-amber-600', 'hover:bg-amber-700');
                    document.getElementById('btn-submit-lancamento').classList.add('bg-slate-800', 'hover:bg-slate-900');
                    
                    document.getElementById('input-cliente').value = '';
                    document.getElementById('info-cliente-preview').classList.add('hidden');
                    document.getElementById('input-valor-final').value = '';
                    document.getElementById('input-obs-geral').value = '';
                    const regiaoPadrao = document.querySelector(`input[name="regiao"][value="VG"]`);
                    if(regiaoPadrao) regiaoPadrao.checked = true;

                    App.ui.renderCarrinho();
                    App.controllers.fecharDropdownCliente();
                    App.controllers.fecharDropdownCesta();
                    App.ui.modalLancamento.open();
                },

                // NOVO: Prepara o modal para EDI√á√ÉO
                editarEntrega: (id) => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    if (!entrega) return Utils.toast('Entrega n√£o encontrada', 'error');

                    Store.data.editingId = id;
                    Store.data.carrinhoTemp = JSON.parse(JSON.stringify(entrega.cestas)); // C√≥pia profunda

                    // UI Setup
                    document.getElementById('modal-lancamento-title').innerText = "Editar Entrega";
                    document.getElementById('btn-submit-lancamento').innerText = "Salvar Altera√ß√µes";
                    document.getElementById('btn-submit-lancamento').classList.remove('bg-slate-800', 'hover:bg-slate-900');
                    document.getElementById('btn-submit-lancamento').classList.add('bg-amber-600', 'hover:bg-amber-700');

                    // Preencher Campos
                    document.getElementById('input-cliente').value = entrega.cliente.nome;
                    const event = new Event('input'); document.getElementById('input-cliente').dispatchEvent(event); // Trigger preview
                    
                    const radio = document.querySelector(`input[name="regiao"][value="${entrega.regiao}"]`);
                    if(radio) radio.checked = true;

                    document.getElementById('input-obs-geral').value = entrega.observacao || '';
                    document.getElementById('input-valor-final').value = entrega.valorTotalAjustado || '';

                    App.ui.renderCarrinho();
                    App.ui.modalLancamento.open();
                },

                salvarEntrega: () => {
                    const nome = document.getElementById('input-cliente').value.trim();
                    const regiaoInput = document.querySelector('input[name="regiao"]:checked');
                    
                    if(!nome) return Utils.toast('Informe o nome do cliente', 'error');
                    if(!regiaoInput) return Utils.toast('Selecione a regi√£o', 'error');
                    if(Store.data.carrinhoTemp.length === 0) return Utils.toast('Adicione cestas ao pedido', 'error');
                    
                    let clienteData = { nome: nome, endereco: '', celular: '' };
                    if (typeof CLIENTES_DB !== 'undefined') {
                        const found = CLIENTES_DB.find(c => c.nome.toLowerCase() === nome.toLowerCase());
                        if (found) clienteData = found;
                    }
                    
                    const valorFinalManual = parseFloat(document.getElementById('input-valor-final').value) || 0;
                    
                    if (Store.data.editingId) {
                        // MODO EDI√á√ÉO: Atualiza existente
                        const updates = {
                            cliente: clienteData,
                            regiao: regiaoInput.value,
                            cestas: [...Store.data.carrinhoTemp],
                            valorTotalAjustado: valorFinalManual,
                            observacao: document.getElementById('input-obs-geral').value,
                            updatedAt: new Date().toISOString()
                        };
                        Store.updateEntrega(Store.data.editingId, updates);
                        Utils.toast('Entrega atualizada com sucesso!');
                    } else {
                        // MODO CRIA√á√ÉO: Novo ID
                        const novaEntrega = { 
                            id: Date.now(), 
                            cliente: clienteData, 
                            regiao: regiaoInput.value, 
                            cestas: [...Store.data.carrinhoTemp], 
                            valorTotalAjustado: valorFinalManual, 
                            observacao: document.getElementById('input-obs-geral').value, 
                            status: 'Pendente', 
                            updatedAt: new Date().toISOString(), 
                            formaPagamento: [] 
                        };
                        Store.addEntrega(novaEntrega);
                        Utils.toast('Entrega lan√ßada com sucesso!');
                    }

                    App.ui.modalLancamento.close();
                    Store.data.regiaoFiltro = regiaoInput.value;
                    App.ui.render();
                },
                moverEntrega: (id, dir) => Store.moverEntrega(id, dir),
                cancelarEntrega: (id) => { if(confirm('Cancelar esta entrega?')) { Store.updateEntrega(id, { status: 'Cancelada' }); App.ui.render(); } },
                abrirMapa: (endereco) => { if(!endereco || endereco.length < 3) return Utils.toast('Endere√ßo n√£o cadastrado', 'error'); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(endereco)}`, '_blank'); },
                iniciarPagamento: (id) => {
                    Store.data.entregaEmAcaoId = id;
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    document.getElementById('pag-cliente-nome').innerText = entrega.cliente.nome;
                    document.getElementById('pag-valor-total').innerText = Utils.formatMoeda(entrega.valorTotalAjustado);
                    document.querySelectorAll('input[name="pagamento"]').forEach(el => el.checked = false);
                    document.getElementById('modal-pagamento').classList.remove('hidden');
                },
                confirmarPagamento: () => {
                    const pags = Array.from(document.querySelectorAll('input[name="pagamento"]:checked')).map(el => el.value);
                    if(pags.length === 0) return Utils.toast('Selecione uma forma de pagamento', 'error');
                    Store.updateEntrega(Store.data.entregaEmAcaoId, { status: 'Entregue', formaPagamento: pags });
                    document.getElementById('modal-pagamento').classList.add('hidden');
                    
                    // Salvar no Hist√≥rico Permanente
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == Store.data.entregaEmAcaoId);
                    Store.addToHistory(entrega);

                    App.controllers.enviarRelatorioFinalZap(entrega);
                    App.ui.render();
                    Utils.toast('Entrega conclu√≠da e salva no hist√≥rico! üéâ');
                },
                abrirZap: (id) => { Store.data.entregaEmAcaoId = id; document.getElementById('modal-whatsapp').classList.remove('hidden'); },
                
                // === NOVA FUN√á√ÉO DE IMPRESS√ÉO (TICKET) ===
                imprimirTicket: (id) => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    if(!entrega) return;

                    const container = document.getElementById('ticket-print-area');
                    const dataHora = new Date(entrega.dataCriacao || new Date()).toLocaleString('pt-BR');
                    
                    let itensHtml = entrega.cestas.map(c => `
                        <div class="ticket-item">
                            <span>${c.qtd}x ${c.nome}</span>
                            <span>${Utils.formatMoeda(c.valor * c.qtd)}</span>
                        </div>
                        ${c.tipo === 'Alterada' ? `<span class="ticket-sub">ALT: T(${c.tirar}) / P(${c.por})</span>` : ''}
                        ${c.brindes && c.brindes.length ? `<span class="ticket-sub">+ Brinde: ${c.brindes.join(', ')}</span>` : ''}
                    `).join('');

                    container.innerHTML = `
                        <div class="ticket-header">
                            <div class="ticket-bold ticket-big">ROTA DONA ANTONIA</div>
                            <div>CRM & Entregas</div>
                            <div class="ticket-line"></div>
                            <div>${dataHora}</div>
                            <div class="ticket-bold">PEDIDO #${id.toString().slice(-4)}</div>
                        </div>
                        
                        <div style="margin-bottom: 5px;">
                            <div class="ticket-bold">CLIENTE:</div>
                            <div>${entrega.cliente.nome}</div>
                            <div>${entrega.cliente.celular || 'Sem celular'}</div>
                            <div>${entrega.cliente.endereco || 'Retirar no local'}</div>
                            ${entrega.cliente.complemento ? `<div>(${entrega.cliente.complemento})</div>` : ''}
                            <div class="ticket-bold" style="margin-top:2px">REGI√ÉO: ${entrega.regiao}</div>
                        </div>
                        
                        <div class="ticket-line"></div>
                        
                        <div style="margin-bottom: 5px;">
                            ${itensHtml}
                        </div>
                        
                        <div class="ticket-line"></div>
                        
                        <div class="ticket-total">
                            TOTAL: ${Utils.formatMoeda(entrega.valorTotalAjustado)}
                        </div>
                        
                        ${entrega.formaPagamento && entrega.formaPagamento.length > 0 ? `<div style="text-align:right; font-size:11px;">Pagamento: ${entrega.formaPagamento.join(', ')}</div>` : ''}
                        
                        ${entrega.observacao ? `<div class="ticket-line"></div><div class="ticket-bold">OBSERVA√á√ÉO:</div><div>${entrega.observacao}</div>` : ''}

                        <div class="ticket-footer">
                            <div class="ticket-line"></div>
                            Obrigado pela prefer√™ncia!<br>
                            Deus aben√ßoe sua fam√≠lia.
                        </div>
                    `;

                    // Ativa modo ticket e imprime
                    document.body.classList.add('mode-ticket');
                    
                    // Pequeno delay para renderizar e imprimir
                    setTimeout(() => {
                        window.print();
                        // Remove classe ap√≥s impress√£o (timeout para garantir que print dialog abriu)
                        // A maioria dos browsers pausa JS durante o print dialog, ent√£o isso roda depois que fecha
                        setTimeout(() => {
                            document.body.classList.remove('mode-ticket');
                        }, 500);
                    }, 100);
                },

                abrirPosVenda: (id) => { 
                    Store.data.entregaEmAcaoId = id; 
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == id); 
                    if (!entrega) return Utils.toast('Erro', 'error'); 
                    document.getElementById('pos-venda-cliente-nome').innerText = entrega.cliente.nome; 
                    
                    // Verificar bloqueios (60 dias)
                    const meta = Store.data.meta[entrega.cliente.nome] || {};
                    const diasGoogle = meta.lastGoogleReview ? Utils.diffDias(meta.lastGoogleReview) : 999;
                    const diasInsta = meta.lastInstaFollow ? Utils.diffDias(meta.lastInstaFollow) : 999;

                    const btnGoogle = document.getElementById('btn-pos-google');
                    const btnInsta = document.getElementById('btn-pos-insta');

                    if(diasGoogle < 60) { btnGoogle.classList.add('opacity-50', 'pointer-events-none'); btnGoogle.innerText = `‚≠ê Avaliado h√° ${diasGoogle} dias`; }
                    else { btnGoogle.classList.remove('opacity-50', 'pointer-events-none'); btnGoogle.innerHTML = `<span class="text-xl">‚≠ê</span> Avaliar no Google`; }

                    if(diasInsta < 60) { btnInsta.classList.add('opacity-50', 'pointer-events-none'); btnInsta.innerText = `üì∏ Seguido h√° ${diasInsta} dias`; }
                    else { btnInsta.classList.remove('opacity-50', 'pointer-events-none'); btnInsta.innerHTML = `<span class="text-xl">üì∏</span> Seguir no Instagram`; }

                    document.getElementById('modal-pos-venda').classList.remove('hidden'); 
                },
                enviarPosVenda: (tipo) => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == Store.data.entregaEmAcaoId);
                    let num = entrega.cliente.celular.replace(/\D/g, '');
                    if(!num) return Utils.toast('Sem celular', 'error');
                    if(!num.startsWith('55')) num = '55' + num;
                    
                    let msg = '';
                    // Mensagens sem personaliza√ß√£o de nome (gen√©ricas)
                    if(tipo===1) msg = `Ol√°! Tudo bem? Aqui √© da Rota Dona Antonia. Muito obrigado pela sua compra! Deus aben√ßoe voc√™ e sua fam√≠lia. üôè`;
                    else if(tipo===2) { 
                        const h = new Date(); h.setDate(h.getDate()+30); 
                        msg = `Ol√°! Como agradecimento, voc√™ ganhou um *DESCONTO DE R$ 10,00* na sua pr√≥xima compra! üéÅ V√°lido at√© *${h.toLocaleDateString('pt-BR')}*.`; 
                        Store.updateMeta(entrega.cliente.nome, 'lastCouponDate', new Date().toISOString());
                    }
                    else if(tipo===3) { 
                        msg = `Ol√°, poderia nos ajudar? üôè Clique no link e avalie com 5 estrelas ‚≠ê: https://g.page/r/CaIREJtO1L6WEBM/review Deus aben√ßoe!`;
                        Store.updateMeta(entrega.cliente.nome, 'lastGoogleReview', new Date().toISOString());
                    }
                    else if(tipo===4) { 
                        msg = `Ol√°! Segue a gente no Instagram! üì∏ https://www.instagram.com/super.cestas.dona.antonia/`;
                        Store.updateMeta(entrega.cliente.nome, 'lastInstaFollow', new Date().toISOString());
                    }
                    else if(tipo===5) msg = `Ol√°! Para facilitar seus pedidos, baixe nosso App clicando aqui: ${CONSTANTS.LINK_APP}`;

                    window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                    document.getElementById('modal-pos-venda').classList.add('hidden');
                },
                enviarMsgZap: (tipo) => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == Store.data.entregaEmAcaoId);
                    let num = entrega.cliente.celular.replace(/\D/g, '');
                    if(!num) { if(tipo!==4) return Utils.toast('Sem celular', 'error'); else num = CONSTANTS.NUMERO_GERENTE; } else if(!num.startsWith('55')) num = '55' + num;
                    let msg = '';
                    switch(tipo) {
                        case 1: msg = `Ol√°! Aqui √© da Cesta B√°sica. Chegando em 10 minutos! üöö`; break;
                        case 2: msg = `Ol√°! O entregador chegou no seu endere√ßo.`; break;
                        case 3: msg = `Dados PIX:\nCelular: ${CONSTANTS.PIX_CELULAR}\nNome: ${CONSTANTS.PIX_NOME}\nValor: ${Utils.formatMoeda(entrega.valorTotalAjustado)}`; break;
                        // MENSAGEM DO MONTADOR - FORMATO SOLICITADO
                        case 4: 
                            num = CONSTANTS.NUMERO_GERENTE; 
                            msg = `*PEDIDO MONTADOR*`; 
                            entrega.cestas.forEach(c => {
                                msg += `\n-----------------`;
                                msg += `\n- REGI√ÉO: ${entrega.regiao}`;
                                msg += `\n- Quantidade: ${c.qtd}`;
                                msg += `\n- CESTA: ${c.nome}`;
                                if(c.tipo === 'Alterada') {
                                    if(c.tirar) msg += `\n- TIRAR: ${c.tirar}`;
                                    if(c.por) msg += `\n- POR: ${c.por}`;
                                }
                                if(c.brindes && c.brindes.length > 0) msg += `\n- BRINDE: ${c.brindes.join(', ')}`;
                                
                                // Verifica Final (se o numero tiver pelo menos 2 digitos)
                                const cell = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g,'') : '';
                                if(c.tipo === 'Alterada' && cell.length >= 2) {
                                    msg += `\n- FINAL: ${cell.slice(-2)}`;
                                }
                            }); 
                            break;
                    }
                    window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                    document.getElementById('modal-whatsapp').classList.add('hidden');
                },
                enviarRelatorioFinalZap: (entrega) => {
                     const numAdmin = CONSTANTS.NUMERO_CONFIRMACAO_ENTREGA; 
                     let msg = `*‚úÖ ENTREGA REALIZADA*\nCliente: ${entrega.cliente.nome}\nValor: ${Utils.formatMoeda(entrega.valorTotalAjustado)}\nPagamento: ${entrega.formaPagamento.join(', ')}\n\n`;
                     entrega.cestas.forEach(c => { msg += `${c.qtd}x ${c.nome}\n`; });
                     
                     // --- ADICIONADO: Links P√≥s Venda ---
                     let clientPhone = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : '';
                     if(clientPhone && clientPhone.length >= 10) {
                         if(!clientPhone.startsWith('55')) clientPhone = '55' + clientPhone;
                         
                         // Helper para gerar link do WhatsApp (wa.me)
                         const genLink = (texto) => `https://wa.me/${clientPhone}?text=${encodeURIComponent(texto)}`;
                         
                         // 1. Agradecimento
                         const msgAgrad = `Ol√°! Tudo bem? Aqui √© da Rota Dona Antonia. Muito obrigado pela sua compra! Deus aben√ßoe voc√™ e sua fam√≠lia. üôè`;
                         
                         // 2. Cupom
                         const h = new Date(); h.setDate(h.getDate()+30); 
                         const msgCupom = `Ol√°! Como agradecimento, voc√™ ganhou um *DESCONTO DE R$ 10,00* na sua pr√≥xima compra! üéÅ V√°lido at√© *${h.toLocaleDateString('pt-BR')}*.`;

                         // 3. Google
                         const msgGoogle = `Ol√°, poderia nos ajudar? üôè Clique no link e avalie com 5 estrelas ‚≠ê: https://g.page/r/CaIREJtO1L6WEBM/review Deus aben√ßoe!`;

                         // 4. Instagram
                         const msgInsta = `Ol√°! Segue a gente no Instagram! üì∏ https://www.instagram.com/super.cestas.dona.antonia/`;

                         msg += `\n-------- P√ìS VENDA --------\n`;
                         msg += `üôè Agradecer: ${genLink(msgAgrad)}\n\n`;
                         msg += `‚≠ê Google: ${genLink(msgGoogle)}\n\n`;
                         msg += `üé´ Cupom: ${genLink(msgCupom)}\n\n`;
                         msg += `üì∏ Insta: ${genLink(msgInsta)}`;
                     } else {
                         msg += `\n(Cliente sem celular para P√≥s-Venda)`;
                     }

                     setTimeout(() => { if(confirm('Abrir WhatsApp para enviar comprovante?')) { window.open(`https://api.whatsapp.com/send?phone=${numAdmin}&text=${encodeURIComponent(msg)}`, '_blank'); } }, 500);
                },
                gerarRelatorioCestas: () => {
                    const regioes = Array.from(document.querySelectorAll('#relatorio-regioes-list input:checked')).map(el => el.value);
                    if(regioes.length === 0) return Utils.toast('Selecione regi√£o', 'error');
                    const entregas = Store.data.rotaAtiva.entregas.filter(e => regioes.includes(e.regiao));
                    if(entregas.length === 0) return Utils.toast('Sem entregas', 'error');
                    let msg = `*üìã RELAT√ìRIO DE CESTAS*\nData: ${Utils.formatData(Store.data.rotaAtiva.dataCriacao)}\n`;
                    regioes.forEach(r => {
                        const itens = entregas.filter(e => e.regiao === r);
                        if(itens.length > 0) {
                            msg += `\n*üìç REGI√ÉO: ${r}*\n`;
                            itens.forEach(e => { e.cestas.forEach(c => { let linha = `üë§ ${e.cliente.nome}\nüì¶ ${c.qtd}x ${c.nome}`; if(c.tipo === 'Alterada') linha += `\n‚ö†Ô∏è ALT: Tirar ${c.tirar} / P√¥r ${c.por}`; msg += `${linha}\n------------------\n`; }); });
                        }
                    });
                    window.open(`https://api.whatsapp.com/send?phone=${CONSTANTS.NUMERO_RELATORIO}&text=${encodeURIComponent(msg)}`, '_blank');
                    App.ui.modalRelatorio.close();
                },
                baixarBackup: (tipo) => {
                    let backup;
                    let filename;

                    if (tipo === 'completo') {
                        // EXPORTA TUDO (Rota + Hist√≥rico + Meta)
                        backup = { 
                            fullDump: true,
                            timestamp: new Date().toISOString(),
                            rotaAtiva: Store.data.rotaAtiva,
                            history: Store.data.history,
                            meta: Store.data.meta,
                            version: '2.0'
                        };
                        filename = `Backup_COMPLETO_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`;
                    } else {
                        // Exporta apenas Rota (L√≥gica Original)
                        const regioes = Array.from(document.querySelectorAll('#export-regioes-list input:checked')).map(el => el.value);
                        if(regioes.length === 0) return Utils.toast('Selecione regi√£o', 'error');
                        backup = { ...Store.data.rotaAtiva, entregas: Store.data.rotaAtiva.entregas.filter(e => regioes.includes(e.regiao)) };
                        filename = `Rota_Parcial_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`;
                    }

                    const link = document.createElement("a");
                    link.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup)));
                    link.setAttribute("download", filename);
                    document.body.appendChild(link); link.click(); link.remove();
                    App.ui.modalExport.close();
                },
                importarBackup: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            
                            // Verifica se √© um Backup Completo
                            if(json.fullDump) {
                                if(confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° substituir TODO o hist√≥rico, rotas e dados de clientes pelos do arquivo. Continuar?')) {
                                    Store.data.rotaAtiva = json.rotaAtiva || Store.novaRota();
                                    Store.data.history = json.history || [];
                                    Store.data.meta = json.meta || {};
                                    Store.save();
                                    Store.saveHistory();
                                    Store.saveMeta();
                                    alert('Backup Completo restaurado com sucesso!');
                                    window.location.reload();
                                }
                            }
                            // Verifica se √© Backup de Rota Antigo
                            else if(json.entregas) { 
                                Store.data.rotaAtiva = json; 
                                Store.save(); 
                                Utils.toast('Rota importada com sucesso!');
                                window.location.reload(); 
                            }
                            else { throw new Error('Formato inv√°lido'); }
                        } catch(err) { Utils.toast('Erro ao ler arquivo', 'error'); }
                    };
                    reader.readAsText(file);
                },

                // NOVO: Fun√ß√£o para Importar Lista de Clientes
                importarClientes: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        let content = e.target.result;
                        
                        // Tentar limpar declara√ß√£o de vari√°vel JS (ex: const CLIENTES_DB = [...])
                        // Remove tudo antes do primeiro [ e tudo depois do √∫ltimo ]
                        // Isso √© uma limpeza simples para aceitar arquivos JS ou JSON
                        try {
                            // Se for arquivo JS com "const CLIENTES_DB =", tentamos limpar
                            if (content.includes('=')) {
                                content = content.substring(content.indexOf('['));
                                content = content.substring(0, content.lastIndexOf(']') + 1);
                            }

                            const clientes = JSON.parse(content);
                            
                            if (Array.isArray(clientes)) {
                                // Salvar no LocalStorage para persistir
                                localStorage.setItem(CONSTANTS.CLIENTS_DB_KEY, JSON.stringify(clientes));
                                window.CLIENTES_DB = clientes;
                                Utils.toast(`Base importada com sucesso! ${clientes.length} clientes.`);
                                
                                // Opcional: Recarregar a p√°gina para garantir que tudo atualize
                                setTimeout(() => window.location.reload(), 1500);
                            } else {
                                Utils.toast('Arquivo inv√°lido: N√£o √© uma lista.', 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            Utils.toast('Erro ao ler base de clientes. Verifique o formato.', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // === CRM CONTROLLERS ===
                crmClientsCache: [],
                crmSearch: () => {
                    const term = document.getElementById('crm-search').value.toLowerCase();
                    App.controllers.renderCRMTable(App.controllers.crmClientsCache.filter(c => c.nome.toLowerCase().includes(term)));
                },
                toggleCrmActions: (id) => {
                   const el = document.getElementById(id);
                   if (el.classList.contains('hidden')) el.classList.remove('hidden'); else el.classList.add('hidden');
                },
                crmFilter: (type) => {
                    // Processar dados brutos do hist√≥rico para criar perfil de cliente
                    const map = {};
                    Store.data.history.forEach(order => {
                        const nome = order.cliente.nome;
                        if(!map[nome]) map[nome] = { 
                            nome: nome, 
                            celular: order.cliente.celular,
                            orders: [], 
                            totalValue: 0,
                            lastRota: order.regiao 
                        };
                        map[nome].orders.push(order);
                        map[nome].totalValue += (order.valorTotalAjustado || 0);
                    });

                    let clients = Object.values(map).map(c => {
                        // Ordenar ordens por data desc
                        c.orders.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                        c.lastPurchase = c.orders[0].updatedAt;
                        c.daysSince = Utils.diffDias(c.lastPurchase);
                        
                        // Verificar cupom vencendo (se a ultima compra for entre 27 e 30 dias atr√°s)
                        c.couponExpiring = c.daysSince >= 27 && c.daysSince <= 30;
                        return c;
                    });

                    // Aplica filtros
                    if(type === 'recent') clients = clients.filter(c => c.daysSince <= 3);
                    if(type === 'vencendo') clients = clients.filter(c => c.couponExpiring);
                    if(type === 'inativo40') clients = clients.filter(c => c.daysSince > 40);
                    if(type === 'inativo60') clients = clients.filter(c => c.daysSince > 60);

                    // Ordena por data (mais recente primeiro)
                    clients.sort((a,b) => new Date(b.lastPurchase) - new Date(a.lastPurchase));

                    App.controllers.crmClientsCache = clients;
                    App.controllers.renderCRMTable(clients);
                },
                renderCRMTable: (clients) => {
                    const tbody = document.getElementById('crm-table-body');
                    
                    // Atualizar Resumo
                    let totalVal = 0;
                    let totalCount = 0;
                    let basketsCount = {};

                    clients.forEach(c => {
                        // Como estamos vendo clientes, podemos somar todas as ordens deles que est√£o no hist√≥rico ou apenas as recentes
                        // A l√≥gica aqui depende se queremos somar TUDO do cliente ou s√≥ o que est√° filtrado
                        // Para simplicidade e consist√™ncia, somaremos o totalValue j√° calculado no crmFilter (que √© o hist√≥rico total do cliente)
                        // POR√âM, se o filtro for 'recent' (3 dias), talvez queiramos ver apenas vendas desses 3 dias? 
                        // O crmFilter filtra CLIENTES que tiveram atividade.
                        totalVal += c.totalValue; // Total gasto pelo cliente no hist√≥rico todo
                        totalCount += c.orders.length; // Quantidade de pedidos no hist√≥rico

                        c.orders.forEach(o => {
                            o.cestas.forEach(b => {
                                if(!basketsCount[b.nome]) basketsCount[b.nome] = 0;
                                basketsCount[b.nome] += b.qtd;
                            });
                        });
                    });

                    document.getElementById('summary-count').innerText = totalCount;
                    document.getElementById('summary-value').innerText = Utils.formatMoeda(totalVal);
                    
                    const basketStr = Object.entries(basketsCount)
                        .map(([name, count]) => `<span class="whitespace-nowrap font-bold text-slate-200">${count}x ${name}</span>`)
                        .join('<span class="mx-2 text-slate-600">|</span>');
                    document.getElementById('summary-baskets').innerHTML = basketStr || 'Nenhuma venda';

                    if(clients.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">Nenhum cliente encontrado com este filtro.</td></tr>'; return; }
                    
                    tbody.innerHTML = clients.map((c, idx) => {
                        // Pegar ultimos 3
                        const last3 = c.orders.slice(0, 3);
                        const dates = last3.map(o => Utils.formatDataCurta(o.updatedAt)).join('<br>');
                        const cestas = last3.map(o => o.cestas.map(x => x.nome).join(', ')).join('<br>');
                        const pays = last3.map(o => o.formaPagamento.join(', ')).join('<br>');
                        
                        // C√°lculo de dias para vencimento (Assumindo ciclo de 30 dias)
                        const diasRestantes = 30 - c.daysSince;
                        const labelVencimento = diasRestantes > 0 ? `${diasRestantes} dias` : 'Hoje';

                        return `
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-3">
                                <div class="font-bold text-slate-800">${c.nome}</div>
                                <div class="text-xs text-slate-500">${c.daysSince} dias sem comprar</div>
                                ${c.couponExpiring ? '<span class="inline-block bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded font-bold mt-1">CUPOM VENCENDO</span>' : ''}
                            </td>
                            <td class="p-3 text-xs text-slate-600">${dates}</td>
                            <td class="p-3 text-xs text-slate-600">${cestas}</td>
                            <td class="p-3 text-xs text-slate-600">${pays}</td>
                            <td class="p-3 text-xs font-semibold">${c.lastRota}</td>
                            <td class="p-3 text-right font-bold text-slate-700">${Utils.formatMoeda(c.totalValue)}</td>
                            <td class="p-3 text-center no-print align-top relative">
                                <button onclick="App.controllers.toggleCrmActions('crm-actions-${idx}')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-1 px-3 rounded text-xs border border-slate-300">
                                    ‚ö° Op√ß√µes
                                </button>
                                <div id="crm-actions-${idx}" class="hidden absolute right-0 mt-2 w-48 bg-white border border-slate-200 rounded-lg shadow-xl z-20 text-left overflow-hidden">
                                    <button onclick="App.controllers.avisarZap('${c.celular}', 'vencimento_custom', ${diasRestantes})" class="w-full text-left px-4 py-3 hover:bg-yellow-50 text-xs font-bold text-yellow-700 border-b border-slate-100">
                                        üé´ Cupom (Vence ${labelVencimento})
                                    </button>
                                    <button onclick="App.controllers.avisarZap('${c.celular}', 'oferta')" class="w-full text-left px-4 py-3 hover:bg-blue-50 text-xs font-bold text-blue-700 border-b border-slate-100">
                                        üî• Avisar Oferta
                                    </button>
                                    <button onclick="App.controllers.avisarZap('${c.celular}', 'sorteio')" class="w-full text-left px-4 py-3 hover:bg-green-50 text-xs font-bold text-green-700 border-b border-slate-100">
                                        üçÄ Avisar Sorteio
                                    </button>
                                    <button onclick="if(confirm('Tem certeza? Isso apagar√° TODO o hist√≥rico deste cliente.')) { Store.removeFromHistory('${c.nome}'); App.controllers.crmFilter('todos'); }" class="w-full text-left px-4 py-3 hover:bg-red-50 text-xs font-bold text-red-700">
                                        üóëÔ∏è Excluir Hist√≥rico
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');
                },
                avisarZap: (celular, tipo, diasRestantes = 0) => {
                    if(!celular) return Utils.toast('Cliente sem celular', 'error');
                    let num = celular.replace(/\D/g, '');
                    if(!num.startsWith('55')) num = '55' + num;
                    let msg = "";
                    
                    if(tipo === 'vencendo') msg = "Ol√°! Seu cupom de desconto especial est√° quase vencendo (faltam 3 dias)! Aproveite para fazer seu pedido hoje.";
                    
                    else if(tipo === 'vencimento_custom') {
                        if(diasRestantes > 0) msg = `Ol√°! Passando para avisar que seu cupom de desconto vence em apenas *${diasRestantes} dias*! üèÉ‚Äç‚ôÇÔ∏è Aproveite para garantir sua cesta hoje.`;
                        else msg = `Ol√°! Seu cupom de desconto vence *HOJE*! üö® N√£o perca essa oportunidade.`;
                    }
                    
                    else if(tipo === 'oferta') msg = "Ol√°! üåü Temos uma *OFERTA REL√ÇMPAGO* especial para voc√™ hoje! Gostaria de conferir os itens em promo√ß√£o?";
                    
                    else if(tipo === 'sorteio') msg = "Ol√°! üçÄ Estamos realizando um *SORTEIO* exclusivo para clientes fi√©is! Responda essa mensagem para participar!";
                    
                    window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            Store.init();
            App.ui.render();
            document.getElementById('check-alterada').addEventListener('change', App.controllers.toggleCheckAlterada);
            const radioContainer = document.getElementById('container-radio-regiao');
            radioContainer.innerHTML = CONSTANTS.REGIOES.map(r => `<label class="cursor-pointer"><input type="radio" name="regiao" value="${r}" class="peer sr-only" ${r === 'VG' ? 'checked' : ''}><div class="rounded-md border border-gray-200 bg-white p-2 text-center text-slate-600 peer-checked:border-slate-800 peer-checked:bg-slate-800 peer-checked:text-white transition-all font-semibold shadow-sm">${r}</div></label>`).join('');
            
            // L√≥gica Dropdown Clientes
            const inputCliente = document.getElementById('input-cliente');
            const dropdownClientes = document.getElementById('dropdown-clientes');
            inputCliente.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const preview = document.getElementById('info-cliente-preview');
                if(typeof CLIENTES_DB !== 'undefined' && val.length > 0) {
                    const filtrados = CLIENTES_DB.filter(c => c.nome.toLowerCase().includes(val)).slice(0, 50);
                    if(filtrados.length > 0) {
                        dropdownClientes.innerHTML = filtrados.map(c => `<div class="p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors" onclick="App.controllers.selecionarCliente('${c.nome}')"><p class="font-bold text-sm text-slate-800">${c.nome}</p><p class="text-xs text-slate-500">${c.endereco || ''}</p></div>`).join('');
                        App.controllers.abrirDropdownCliente();
                    } else { dropdownClientes.innerHTML = '<div class="p-3 text-sm text-slate-400">Nenhum cliente encontrado</div>'; App.controllers.abrirDropdownCliente(); }
                    const found = CLIENTES_DB.find(c => c.nome.toLowerCase() === val);
                    if(found) { preview.innerHTML = `<strong>Nome:</strong> ${found.nome}<br><strong>Tel:</strong> ${found.celular || '-'}<br><strong>End:</strong> ${found.endereco || '-'}<br><strong>Comp:</strong> ${found.complemento || '-'}`; preview.classList.remove('hidden'); } else { preview.classList.add('hidden'); }
                } else { App.controllers.fecharDropdownCliente(); preview.classList.add('hidden'); }
            });

            document.addEventListener('click', (e) => {
                if(!e.target.closest('.group')) App.controllers.fecharDropdownCliente();
                if(!e.target.closest('#container-custom-select-cesta')) App.controllers.fecharDropdownCesta();
                // Fecha CRM Actions se clicar fora
                if(!e.target.closest('td.relative')) {
                    document.querySelectorAll('[id^="crm-actions-"]').forEach(el => el.classList.add('hidden'));
                }
            });

            const btnCesta = document.getElementById('btn-custom-select-cesta');
            const dropdownCesta = document.getElementById('dropdown-cestas');
            dropdownCesta.innerHTML = CONSTANTS.CESTAS_OPTIONS.map(opt => `<div class="p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors" onclick="App.controllers.selecionarCesta('${opt.value}', '${opt.label}', ${opt.price})"><div class="flex justify-between items-center"><span class="font-medium text-sm text-slate-700">${opt.label}</span><span class="text-xs font-bold text-blue-600">${opt.price > 0 ? Utils.formatMoeda(opt.price) : '-'}</span></div></div>`).join('');
            btnCesta.addEventListener('click', App.controllers.toggleDropdownCesta);

            const urlParams = new URLSearchParams(window.location.search);
            const pedidoId = urlParams.get('pedidoId');
            if(pedidoId) {
                setTimeout(() => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == pedidoId);
                    if(entrega) {
                        if(Store.data.regiaoFiltro !== entrega.regiao) App.controllers.mudarFiltro(entrega.regiao);
                        App.controllers.abrirPosVenda(pedidoId);
                        Utils.toast('Pedido carregado via link!', 'info');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else { Utils.toast('Pedido do link n√£o encontrado.', 'error'); }
                }, 500);
            }
        });
    </script>
</body>
</html>
