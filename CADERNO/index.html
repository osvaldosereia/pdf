<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Law Study Notes - Direito</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3, .serif { font-family: 'Merriweather', serif; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .calendar-day { transition: all 0.2s; }
        
        .has-reminder::after {
            content: ''; display: block; width: 5px; height: 5px; 
            background-color: #ef4444; border-radius: 50%; margin: 1px auto 0;
        }
        .selected-day.has-reminder::after { background-color: #fca5a5; }

        /* Estilos Rich Text */
        .rich-content ul { list-style-type: disc; margin-left: 1.5em; }
        .rich-content ol { list-style-type: decimal; margin-left: 1.5em; }
        .rich-content strong { font-weight: 700; color: #1e293b; }
        .rich-content em { font-style: italic; }
        .rich-content p { margin-bottom: 0.5em; }
        .rich-content * {
            font-size: 0.875rem !important;
            font-family: 'Open Sans', sans-serif !important;
            line-height: 1.6 !important;
            background-color: transparent !important;
            color: inherit;
        }
        
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            display: block;
        }

        /* Animação suave */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-scale-balanced text-2xl text-amber-500"></i>
            <h1 class="text-xl font-bold">Caderno de Estudos Jurídicos</h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="exportData()" class="text-xs text-slate-400 hover:text-white transition flex items-center gap-1" title="Baixar Backup (JSON)">
                <i class="fa-solid fa-download"></i> Backup
            </button>
            <label class="text-xs text-slate-400 hover:text-white transition flex items-center gap-1 cursor-pointer" title="Restaurar Backup (JSON)">
                <i class="fa-solid fa-upload"></i> Restaurar
                <input type="file" id="restoreInput" accept=".json" class="hidden" onchange="importData(this)">
            </label>
        </div>
    </header>

    <!-- Layout Principal -->
    <main class="flex flex-1 overflow-hidden">
        
        <!-- Coluna Esquerda -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shadow-sm z-10">
            <div class="p-5 border-b border-gray-100 overflow-y-auto flex-1">
                <h2 class="text-sm font-bold uppercase text-slate-500 mb-3 tracking-wide">Matérias / Tags</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newTagInput" placeholder="Nova tag..." 
                           class="w-full px-3 py-1.5 text-sm border rounded focus:outline-none focus:border-slate-600">
                    <button onclick="addTag()" class="bg-slate-800 text-white px-3 rounded hover:bg-slate-700"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="tagFilterList" class="flex flex-col gap-2"></div>
            </div>

            <div class="p-5 bg-slate-50">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="text-slate-500 hover:text-slate-800"><i class="fa-solid fa-chevron-left"></i></button>
                    <h3 id="currentMonthYear" class="font-bold text-slate-700 capitalize"></h3>
                    <button onclick="changeMonth(1)" class="text-slate-500 hover:text-slate-800"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-500 mb-2">
                    <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm"></div>
                <div class="mt-3 text-center">
                    <button onclick="selectDate(new Date().toISOString().split('T')[0])" class="text-xs text-blue-600 hover:underline">Voltar para Hoje</button>
                </div>
            </div>
        </aside>

        <!-- Coluna Direita -->
        <section class="flex-1 flex flex-col bg-gray-50 h-full relative">
            <!-- Input Area -->
            <div class="p-6 bg-white shadow-sm shrink-0 z-20">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-2 flex gap-2 justify-between items-end">
                        <div class="flex gap-2 items-center">
                            <select id="noteTagSelect" class="border rounded px-3 py-1 text-sm text-slate-600 focus:outline-none">
                                <option value="">Sem Tag</option>
                            </select>
                            <span class="text-sm font-semibold text-slate-700 ml-2 border-l pl-3 border-gray-300">
                                <i class="fa-regular fa-calendar mr-1"></i> <span id="displayDate" class="capitalize"></span>
                            </span>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="noteContent" rows="3" 
                            class="w-full border border-gray-300 rounded-lg p-4 pr-12 text-slate-700 focus:ring-2 focus:ring-slate-200 focus:border-slate-400 outline-none resize-none shadow-sm serif"
                            placeholder="Escreva sua anotação jurídica para a data selecionada..."></textarea>
                        <button onclick="addNote()" 
                            class="absolute bottom-3 right-3 bg-amber-600 text-white w-10 h-10 rounded-full hover:bg-amber-700 shadow-lg transition flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Notas -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth" id="notesContainer">
                <div class="max-w-4xl mx-auto space-y-6" id="notesList">
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                        <p>Nenhuma anotação encontrada.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Unificado (Criação/Edição) -->
    <div id="inputModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-[500px] max-h-[90vh] overflow-y-auto">
            <h3 id="modalTitle" class="font-bold mb-4 text-lg text-slate-800">Gerenciar</h3>
            
            <!-- CAMPOS PARA SUBNOTA -->
            <div id="subnoteFields" class="hidden">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo / Título</label>
                    <select id="modalSubTitleSelect" class="w-full border p-2 rounded focus:border-slate-800 outline-none text-sm bg-white">
                        <option value="Explica">Explica</option>
                        <option value="Glossário">Glossário</option>
                        <option value="Artigo">Artigo</option>
                        <option value="Casos">Casos</option>
                        <option value="Questões">Questões</option>
                        <option value="Prática">Prática</option>
                        <option value="Majoritário">Majoritário</option>
                        <option value="Doutrina">Doutrina</option>
                        <option value="Correlatos">Correlatos</option>
                        <option value="Lei">Lei</option>
                        <option value="Youtube">Youtube</option>
                        <option value="Matéria">Matéria</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Conteúdo (Texto)</label>
                    <div id="modalInputRich" contenteditable="true" 
                        class="w-full border p-2 rounded focus:border-slate-800 outline-none min-h-[150px] max-h-[300px] overflow-y-auto bg-gray-50 rich-content"
                        placeholder="Cole aqui seu texto com formatação..."></div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link Relacionado (Opcional)</label>
                    <input type="text" id="modalInputSubLink" class="w-full border p-2 rounded focus:border-slate-800 outline-none text-sm" placeholder="https://...">
                </div>
            </div>

            <!-- CAMPOS PARA NOTA PRINCIPAL -->
            <div id="mainNoteFields" class="hidden">
                 <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tag / Matéria</label>
                    <select id="modalMainTagSelect" class="w-full border p-2 rounded focus:border-slate-800 outline-none text-sm bg-white">
                        <!-- Preenchido via JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Anotação</label>
                    <textarea id="modalMainContent" rows="6" 
                        class="w-full border p-3 rounded focus:border-slate-800 outline-none text-sm serif resize-none" 
                        placeholder="Edite sua anotação..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-2 border-t border-gray-100">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-600 hover:bg-gray-100 rounded text-sm font-semibold">Cancelar</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 text-sm font-semibold">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const STORE_KEY = 'law_notes_db_v6'; 
        let state = {
            tags: ['Constitucional', 'Penal', 'Civil', 'Processo Civil'],
            notes: [], 
            filterTag: null,
            currentDate: new Date(),
            selectedDate: new Date().toISOString().split('T')[0]
        };

        // --- INIT ---
        function init() {
            loadData();
            if (!state.selectedDate) state.selectedDate = new Date().toISOString().split('T')[0];
            
            const parts = state.selectedDate.split('-');
            state.currentDate = new Date(parts[0], parts[1] - 1, parts[2]);

            renderTags();
            renderCalendar();
            renderNotes();
            updateDateDisplay();
            
            document.getElementById('noteContent').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') addNote();
            });
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(state));
            renderTags();
            renderCalendar();
            renderNotes();
        }

        function loadData() {
            const data = localStorage.getItem(STORE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                state.tags = parsed.tags || state.tags;
                state.notes = parsed.notes || [];
                if (parsed.selectedDate) state.selectedDate = parsed.selectedDate;
                if (parsed.filterTag) state.filterTag = parsed.filterTag;
            }
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            const dataStr = JSON.stringify(state);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'law_notes_backup_' + new Date().toISOString().slice(0,10) + '.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.notes) {
                        if(confirm('Isso substituirá suas notas atuais. Continuar?')) {
                            state = json;
                            if(!state.currentDate) state.currentDate = new Date();
                            else state.currentDate = new Date(state.currentDate);
                            saveData();
                            alert('Restaurado com sucesso!');
                        }
                    }
                } catch (err) { alert('Erro ao ler arquivo.'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- DATA & CALENDÁRIO ---
        function updateDateDisplay() {
            const parts = state.selectedDate.split('-');
            const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('displayDate').textContent = dateObj.toLocaleDateString('pt-BR', options);
        }

        function selectDate(dateStr) {
            state.selectedDate = dateStr;
            updateDateDisplay();
            renderCalendar(); 
            renderNotes();
            saveData();
        }

        function changeMonth(delta) { 
            state.currentDate.setMonth(state.currentDate.getMonth() + delta); 
            renderCalendar(); 
        }

        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            document.getElementById('currentMonthYear').textContent = state.currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendarGrid');
            const todayStr = new Date().toISOString().split('T')[0];

            grid.innerHTML = '';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasReminder = state.notes.some(n => n.reminder && n.date === dateStr);
                const isToday = dateStr === todayStr;
                const isSelected = dateStr === state.selectedDate;

                let classes = "calendar-day h-8 w-8 flex flex-col items-center justify-center rounded-full text-xs cursor-pointer mx-auto select-none";
                if (isSelected) classes += " bg-slate-800 text-white shadow-md transform scale-110 selected-day font-bold";
                else if (isToday) classes += " bg-slate-200 font-bold text-slate-700 hover:bg-slate-300";
                else classes += " text-slate-600 hover:bg-gray-100";

                if (hasReminder) classes += " has-reminder";

                const dayEl = document.createElement('div');
                dayEl.className = classes;
                dayEl.textContent = day;
                dayEl.onclick = () => selectDate(dateStr);
                grid.appendChild(dayEl);
            }
        }

        // --- NOTAS ---
        function addNote() {
            const content = document.getElementById('noteContent').value.trim();
            if (!content) return;
            
            const dateStr = state.selectedDate;
            const now = new Date();

            state.notes.unshift({
                id: Date.now(),
                content: content,
                tag: document.getElementById('noteTagSelect').value,
                date: dateStr,
                timestamp: now.getTime(),
                reminder: false,
                subnotes: [] 
            });
            document.getElementById('noteContent').value = '';
            saveData();
        }

        function renderNotes() {
            const container = document.getElementById('notesList');
            container.innerHTML = '';

            const filteredNotes = state.notes.filter(n => {
                if (state.filterTag && n.tag !== state.filterTag) return false;
                if (n.date !== state.selectedDate) return false;
                return true;
            });

            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-2 opacity-30"></i>
                        <p>Nenhuma anotação para este dia.</p>
                        <p class="text-xs mt-2 opacity-70">Escreva acima para adicionar.</p>
                    </div>`;
                return;
            }

            filteredNotes.sort((a, b) => b.timestamp - a.timestamp);

            filteredNotes.forEach(note => {
                const timeCreated = new Date(note.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                const promptBase = encodeURIComponent(note.content.substring(0, 100));
                
                // Gera links com novos prompts de IA
                const makeLink = (prompt) => `https://www.google.com/search?q=${encodeURIComponent(prompt + ': ' + promptBase)}&udm=50`;

                const links = {
                    explicar: makeLink("Explique didaticamente o conceito jurídico"),
                    glossario: makeLink("Glossário jurídico definição de"),
                    artigo: makeLink("Artigo acadêmico direito sobre"),
                    caso: makeLink("Crie 3 casos concretos jurídicos sobre"),
                    questoes: makeLink("Crie 5 questões objetivas de direito com gabarito sobre"),
                    pratica: makeLink("Como aplicar na prática jurídica o tema"),
                    majoritario: makeLink("Entendimentos jurisprudenciais majoritários sobre"),
                    doutrina: makeLink("Entendimentos doutrinários divergentes e majoritários sobre"),
                    correlatos: makeLink("Artigos de lei, súmulas e teses jurídicas correlatas a")
                };

                const subnotes = note.subnotes || [];

                const el = document.createElement('div');
                el.className = "bg-white border border-gray-200 rounded-lg shadow-sm p-4 hover:shadow-md transition group flex flex-col relative";
                
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            ${note.tag ? `<span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider mr-2">${note.tag}</span>` : ''}
                            <span class="text-[10px] text-gray-400"><i class="fa-regular fa-clock"></i> ${timeCreated}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openModal('edit_note', ${note.id})" class="text-gray-300 hover:text-blue-500 transition text-xs" title="Editar Nota"><i class="fa-solid fa-pencil"></i></button>
                             <button onclick="toggleReminder(${note.id})" class="text-gray-300 hover:text-amber-500 transition text-xs ${note.reminder ? 'text-amber-500' : ''}" title="Destaque no Calendário"><i class="fa-solid fa-bell"></i></button>
                            <button onclick="deleteNote(${note.id})" class="text-gray-300 hover:text-red-500 transition text-xs" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="serif text-gray-800 whitespace-pre-wrap mb-4 text-base leading-relaxed">${note.content}</div>

                    <!-- Botão IA com Chips Expansíveis -->
                    <div class="mb-3">
                        <button onclick="toggleIAChips(${note.id})" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold hover:bg-indigo-100 flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Assistente IA <i id="icon-ia-${note.id}" class="fa-solid fa-chevron-down text-[10px] ml-1 transition-transform"></i>
                        </button>
                        
                        <!-- Chips Container -->
                        <div id="ia-chips-${note.id}" class="hidden flex flex-wrap gap-2 mt-2 p-2 bg-indigo-50/50 rounded-lg border border-indigo-100 fade-in">
                            <a href="${links.explicar}" target="_blank" class="bg-white border border-indigo-200 text-indigo-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-indigo-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-chalkboard-user"></i> Explicar</a>
                            <a href="${links.glossario}" target="_blank" class="bg-white border border-teal-200 text-teal-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-teal-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-book"></i> Glossário</a>
                            <a href="${links.artigo}" target="_blank" class="bg-white border border-purple-200 text-purple-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-purple-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-pen-nib"></i> Artigo</a>
                            <a href="${links.caso}" target="_blank" class="bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-blue-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-briefcase"></i> Casos (3)</a>
                            <a href="${links.questoes}" target="_blank" class="bg-white border border-orange-200 text-orange-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-orange-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-list-check"></i> Questões (5)</a>
                            <a href="${links.pratica}" target="_blank" class="bg-white border border-green-200 text-green-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-green-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-gavel"></i> Prática</a>
                            <a href="${links.majoritario}" target="_blank" class="bg-white border border-red-200 text-red-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-red-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-scale-balanced"></i> Majoritário</a>
                            <a href="${links.doutrina}" target="_blank" class="bg-white border border-amber-200 text-amber-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-amber-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-book-open"></i> Doutrina</a>
                            <a href="${links.correlatos}" target="_blank" class="bg-white border border-gray-400 text-gray-700 px-2 py-1 rounded text-[10px] font-medium hover:bg-gray-600 hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-link"></i> Correlatos</a>
                        </div>
                    </div>

                    <!-- Rodapé Compacto -->
                    <div class="mt-auto border-t border-gray-100 pt-2">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Subnotas</span>
                            <button onclick="openModal('add_subnote', ${note.id})" class="text-slate-500 hover:bg-slate-100 px-2 py-1 rounded text-[10px] flex items-center gap-1 font-semibold border border-transparent hover:border-gray-200 transition">
                                <i class="fa-solid fa-plus"></i> Nova
                            </button>
                        </div>
                        ${renderSubnoteChips(note.id, subnotes)}
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- SISTEMA DE CHIPS IA ---
        function toggleIAChips(noteId) {
            const chips = document.getElementById(`ia-chips-${noteId}`);
            const icon = document.getElementById(`icon-ia-${noteId}`);
            
            // Fecha outros abertos (opcional, mas bom pra limpeza)
            document.querySelectorAll('[id^="ia-chips-"]').forEach(el => {
                if(el.id !== `ia-chips-${noteId}`) el.classList.add('hidden');
            });
             document.querySelectorAll('[id^="icon-ia-"]').forEach(el => {
                if(el.id !== `icon-ia-${noteId}`) el.classList.remove('rotate-180');
            });

            if(chips.classList.contains('hidden')) {
                chips.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                chips.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        function closeAllDropdowns(event) {
            // Função mantida para compatibilidade, mas agora os chips não fecham ao clicar fora necessariamente, 
            // a menos que queiramos essa lógica.
            // Para simplicidade, deixamos o usuário fechar clicando no botão novamente.
        }

        // --- SISTEMA DE CHIPS PARA SUBNOTAS ---
        function renderSubnoteChips(noteId, subnotes) {
            if (!subnotes || subnotes.length === 0) return '';

            // Renderiza os botões (chips) com o título escolhido
            const chipsHtml = subnotes.map((sn, idx) => `
                <button onclick="toggleSubnote(${noteId}, ${sn.id})" 
                    id="chip-${sn.id}"
                    class="chip-btn flex-shrink-0 bg-white border border-gray-200 text-slate-600 px-2 py-0.5 rounded-full text-[10px] font-semibold hover:bg-indigo-50 hover:border-indigo-200 transition focus:outline-none whitespace-nowrap">
                    ${sn.title || 'Subnota ' + (idx + 1)}
                </button>
            `).join('');

            // Renderiza os conteúdos
            const contentsHtml = subnotes.map((sn) => `
                <div id="content-${sn.id}" class="hidden mt-2 bg-white p-3 rounded-lg border border-gray-200 shadow-sm relative fade-in">
                    <div class="absolute top-2 right-2 flex gap-2">
                        <button onclick="openModal('edit_subnote', ${noteId}, ${sn.id})" class="text-gray-300 hover:text-blue-500 text-xs" title="Editar Subnota">
                            <i class="fa-solid fa-pencil"></i>
                        </button>
                        <button onclick="deleteSubnote(${noteId}, ${sn.id})" class="text-gray-300 hover:text-red-400 text-xs" title="Excluir Subnota">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="rich-content text-xs text-slate-700 mb-2 mt-3 leading-relaxed">${sn.text}</div>
                    ${sn.link ? `
                        <div class="text-right border-t border-gray-100 pt-2">
                            <a href="${sn.link}" target="_blank" class="inline-flex items-center gap-1 bg-indigo-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-indigo-700 transition">
                                Abrir Link <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </a>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            return `
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">${chipsHtml}</div>
                <div id="subnotes-container-${noteId}">${contentsHtml}</div>
            `;
        }

        function toggleSubnote(noteId, subId) {
            const content = document.getElementById(`content-${subId}`);
            const chip = document.getElementById(`chip-${subId}`);
            const isOpening = content.classList.contains('hidden');
            
            const container = document.getElementById(`subnotes-container-${noteId}`);
            const allContents = container.querySelectorAll('[id^="content-"]');
            allContents.forEach(el => el.classList.add('hidden'));

            const chipsContainer = container.previousElementSibling;
            const allChips = chipsContainer.querySelectorAll('.chip-btn');
            allChips.forEach(el => {
                el.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                el.classList.add('bg-white', 'text-slate-600', 'border-gray-200');
            });

            if (isOpening) {
                content.classList.remove('hidden');
                chip.classList.remove('bg-white', 'text-slate-600', 'border-gray-200');
                chip.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            }
        }

        // --- MANIPULADORES MODAL ---
        let currentModalMode = null; // 'edit_note', 'add_subnote', 'edit_subnote'
        let currentNoteId = null;
        let currentSubId = null;

        function openModal(mode, noteId, subId = null) {
            currentModalMode = mode;
            currentNoteId = noteId;
            currentSubId = subId;

            const modal = document.getElementById('inputModal');
            const modalTitle = document.getElementById('modalTitle');
            const subnoteFields = document.getElementById('subnoteFields');
            const mainNoteFields = document.getElementById('mainNoteFields');
            
            modal.classList.remove('hidden');

            if (mode === 'edit_note') {
                modalTitle.innerText = "Editar Nota Principal";
                subnoteFields.classList.add('hidden');
                mainNoteFields.classList.remove('hidden');
                
                // Preencher dados
                const note = state.notes.find(n => n.id === noteId);
                if(note) {
                    document.getElementById('modalMainContent').value = note.content;
                    // Popular Tags e selecionar atual
                    const tagSelect = document.getElementById('modalMainTagSelect');
                    tagSelect.innerHTML = '<option value="">Sem Tag</option>';
                    state.tags.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t; opt.innerText = t;
                        if(t === note.tag) opt.selected = true;
                        tagSelect.appendChild(opt);
                    });
                }
            } 
            else if (mode === 'add_subnote') {
                modalTitle.innerText = "Nova Subnota";
                mainNoteFields.classList.add('hidden');
                subnoteFields.classList.remove('hidden');
                
                // Limpar campos
                document.getElementById('modalInputRich').innerHTML = '';
                document.getElementById('modalInputSubLink').value = '';
                document.getElementById('modalSubTitleSelect').value = 'Explica';
                document.getElementById('modalInputRich').focus();
            }
            else if (mode === 'edit_subnote') {
                modalTitle.innerText = "Editar Subnota";
                mainNoteFields.classList.add('hidden');
                subnoteFields.classList.remove('hidden');

                // Preencher dados
                const note = state.notes.find(n => n.id === noteId);
                const subnote = note.subnotes.find(s => s.id === subId);
                if(subnote) {
                    document.getElementById('modalInputRich').innerHTML = subnote.text;
                    document.getElementById('modalInputSubLink').value = subnote.link || '';
                    document.getElementById('modalSubTitleSelect').value = subnote.title || 'Explica';
                }
            }
        }

        function closeModal() { document.getElementById('inputModal').classList.add('hidden'); }

        document.getElementById('modalConfirmBtn').addEventListener('click', () => {
            const note = state.notes.find(n => n.id === currentNoteId);
            if (!note) return;

            if (currentModalMode === 'edit_note') {
                const newContent = document.getElementById('modalMainContent').value.trim();
                const newTag = document.getElementById('modalMainTagSelect').value;
                if(newContent) {
                    note.content = newContent;
                    note.tag = newTag;
                }
            }
            else if (currentModalMode === 'add_subnote') {
                const richText = document.getElementById('modalInputRich').innerHTML;
                const plainText = document.getElementById('modalInputRich').innerText;
                const link = document.getElementById('modalInputSubLink').value.trim();
                const title = document.getElementById('modalSubTitleSelect').value;

                if (!plainText.trim() && !richText.includes('<img')) return;

                note.subnotes = note.subnotes || [];
                note.subnotes.push({ 
                    id: Date.now(), 
                    text: richText,
                    link: link,
                    title: title
                });
            }
            else if (currentModalMode === 'edit_subnote') {
                const subnote = note.subnotes.find(s => s.id === currentSubId);
                if(subnote) {
                    subnote.text = document.getElementById('modalInputRich').innerHTML;
                    subnote.link = document.getElementById('modalInputSubLink').value.trim();
                    subnote.title = document.getElementById('modalSubTitleSelect').value;
                }
            }

            saveData(); 
            closeModal();
        });

        // --- DELEÇÃO E UTILS ---
        function deleteSubnote(noteId, subId) {
            if(!confirm('Apagar subnota?')) return;
            const note = state.notes.find(n => n.id === noteId);
            note.subnotes = note.subnotes.filter(s => s.id !== subId); 
            saveData();
        }

        function addTag() {
            const val = document.getElementById('newTagInput').value.trim();
            if (val && !state.tags.includes(val)) { state.tags.push(val); document.getElementById('newTagInput').value = ''; saveData(); }
        }
        function removeTag(tag) {
            if (confirm(`Excluir tag "${tag}"?`)) {
                state.tags = state.tags.filter(t => t !== tag);
                state.notes.forEach(n => { if (n.tag === tag) n.tag = ''; });
                if (state.filterTag === tag) state.filterTag = null;
                saveData();
            }
        }
        function toggleFilter(tag) { 
            state.filterTag = state.filterTag === tag ? null : tag; 
            renderTags(); 
            renderNotes(); 
            saveData(); 
        }
        function renderTags() {
            const list = document.getElementById('tagFilterList');
            const select = document.getElementById('noteTagSelect');
            list.innerHTML = ''; select.innerHTML = '<option value="">Sem Tag</option>';
            state.tags.forEach(tag => {
                const isActive = state.filterTag === tag;
                list.innerHTML += `<div class="flex justify-between items-center px-3 py-2 rounded cursor-pointer text-sm transition ${isActive ? 'bg-slate-200 font-semibold' : 'hover:bg-gray-100'}"><span onclick="toggleFilter('${tag}')" class="flex-1 truncate"><i class="fa-solid fa-tag text-xs mr-2 text-slate-400"></i>${tag}</span><button onclick="removeTag('${tag}')" class="text-gray-300 hover:text-red-500 ml-2"><i class="fa-solid fa-times"></i></button></div>`;
                select.innerHTML += `<option value="${tag}">${tag}</option>`;
            });
        }
        function deleteNote(id) { if (confirm('Apagar nota?')) { state.notes = state.notes.filter(n => n.id !== id); saveData(); } }
        function toggleReminder(id) { const n = state.notes.find(x => x.id === id); if(n) { n.reminder = !n.reminder; saveData(); } }

        init();
    </script>
</body>
</html>
