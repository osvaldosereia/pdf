<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caderno Digital Pessoal</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais e cores CLARAS para conforto visual */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo claro (Tailwind gray-100) */
            color: #1f2937; /* Texto escuro (Tailwind gray-800) */
        }
        /* Estilo para a √°rea de edi√ß√£o (textarea) */
        #noteContent {
            resize: none;
            line-height: 1.6;
        }
        /* Estilo para o bot√£o flutuante da IA */
        #iaFloatingButton {
            position: absolute;
            z-index: 100;
            display: none;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        /* Esconder a barra de rolagem horizontal em telas largas, se necess√°rio */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 bg-gray-100 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-xl font-semibold text-indigo-600">
            A carregar o caderno...
        </div>
    </div>

    <!-- Layout Principal: 3 Colunas (Tema Claro) -->
    <div class="flex h-screen overflow-hidden">
        
        <!-- Coluna de Navega√ß√£o/Filtros (Sidebar) -->
        <div class="w-1/4 bg-white p-4 border-r border-gray-200 overflow-y-auto no-scrollbar">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Filtros & Categorias</h2>
            
            <button id="newNoteBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 mb-4">
                + Nova Nota
            </button>
            
            <div class="mb-6">
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoria</label>
                <select id="categoryFilter" class="w-full p-2 bg-gray-50 border border-gray-300 text-gray-800 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="">Todas as Categorias</option>
                    <!-- Op√ß√µes de categorias ser√£o preenchidas via JS -->
                </select>
            </div>
            
            <div class="mb-6">
                <label for="dateSearch" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Data (In√≠cio)</label>
                <input type="date" id="dateSearch" class="w-full p-2 bg-gray-50 border border-gray-300 text-gray-800 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <p class="text-xs text-gray-500 mt-1">Busca notas criadas a partir desta data.</p>
            </div>
            
            <!-- NOVO: Gest√£o de Dados -->
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Gest√£o de Dados</h3>
                <button id="exportBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 mb-2 text-sm">
                    Exportar Notas (JSON)
                </button>
                <label for="importFile" class="w-full block text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg cursor-pointer shadow-md transition duration-200 text-sm">
                    Importar Notas (JSON)
                </label>
                <!-- Campo de input de ficheiro escondido -->
                <input type="file" id="importFile" accept=".json" class="hidden">
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    <span class="font-semibold text-indigo-600">Armazenamento Local.</span>
                </p>
                <p class="text-xs text-gray-500 mt-2">
                    As suas notas s√£o salvas no seu navegador e n√£o s√£o sincronizadas online.
                </p>
            </div>
        </div>

        <!-- Coluna da Lista de Notas -->
        <div class="w-1/4 bg-gray-100 p-4 border-r border-gray-200 overflow-y-auto no-scrollbar">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Minhas Notas</h2>
            <div id="notesList" class="space-y-3">
                <!-- Notas ser√£o carregadas aqui -->
                <p class="text-center text-gray-500" id="listPlaceholder">Nenhuma nota ainda. Crie uma!</p>
            </div>
        </div>

        <!-- Coluna do Editor/Visualizador de Notas -->
        <div class="flex-1 bg-white p-6 overflow-y-auto relative">
            <div id="editorPlaceholder" class="flex items-center justify-center h-full text-gray-400 text-lg">
                Selecione uma nota ou crie uma nova para come√ßar a escrever.
            </div>

            <div id="noteEditor" class="hidden">
                <input type="text" id="noteTitle" placeholder="T√≠tulo da Nota" class="w-full text-2xl font-bold mb-4 p-2 bg-gray-100 border border-gray-300 text-gray-900 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <div class="flex space-x-4 mb-4">
                    <select id="noteCategory" class="p-2 bg-gray-100 border border-gray-300 text-gray-800 rounded-lg text-sm">
                        <option value="Geral">Geral</option>
                        <option value="Ideias">Ideias</option>
                        <option value="Trabalho">Trabalho</option>
                        <option value="Pessoal">Pessoal</option>
                    </select>
                    <p id="noteDate" class="text-sm text-gray-500 self-center"></p>
                </div>

                <textarea id="noteContent" rows="25" placeholder="Comece a escrever a sua nota aqui... (Selecione texto para usar a funcionalidade de IA!)" class="w-full p-3 bg-gray-100 border border-gray-300 text-gray-900 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>

                <div class="flex justify-between mt-4">
                    <div>
                        <button id="saveNoteBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                            Guardar Nota
                        </button>
                        <button id="cancelEditBtn" class="ml-3 bg-gray-400 hover:bg-gray-500 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                            Cancelar
                        </button>
                    </div>
                    <button id="deleteNoteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 hidden">
                        Excluir Nota
                    </button>
                </div>

                <!-- Bot√£o flutuante para a funcionalidade IA -->
                <button id="iaFloatingButton" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-1 px-2 rounded-full shadow-lg transition duration-150 transform hover:scale-105"
                    title="Enviar texto selecionado para o Google IA (udm=50)">
                    üöÄ Perguntar √† IA...
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts da L√≥gica da Aplica√ß√£o -->
    <script type="module">
        
        // --- Constantes e Vari√°veis de Configura√ß√£o ---
        
        // Chave de armazenamento local para as notas
        const LOCAL_STORAGE_KEY = 'notebook_personal_notes';
        
        // Prompt predefinido para a funcionalidade de IA (Mantenha o espa√ßo no final!)
        const IA_PROMPT = "Analise e explique este conceito: "; 

        // Lista das categorias dispon√≠veis (para o editor e filtro)
        const DEFAULT_CATEGORIES = ["Geral", "Ideias", "Trabalho", "Pessoal", "Estudo", "Rascunho"];

        // Vari√°veis globais de estado
        let allNotes = []; // Armazena todas as notas carregadas
        let currentNoteId = null; // ID da nota atualmente em edi√ß√£o

        // --- Fun√ß√µes de Manipula√ß√£o do LocalStorage ---

        // Carrega todas as notas do localStorage
        const loadNotesFromLocalStorage = () => {
            try {
                const storedNotes = localStorage.getItem(LOCAL_STORAGE_KEY);
                allNotes = storedNotes ? JSON.parse(storedNotes) : [];
                console.log(`Notas carregadas: ${allNotes.length}`);
            } catch (error) {
                console.error("Erro ao carregar notas do LocalStorage:", error);
                allNotes = [];
            }
        };

        // Salva o array 'allNotes' completo no localStorage
        const saveNotesToLocalStorage = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allNotes));
                console.log(`Notas salvas: ${allNotes.length}`);
            } catch (error) {
                console.error("Erro ao salvar notas no LocalStorage:", error);
                alertMessage("Erro ao salvar dados localmente. O navegador pode estar cheio.", 'red');
            }
        };

        // --- NOVO: Fun√ß√µes de Exporta√ß√£o e Importa√ß√£o ---

        // Fun√ß√£o para exportar todas as notas para um ficheiro JSON
        const handleExport = () => {
            if (allNotes.length === 0) {
                alertMessage("N√£o h√° notas para exportar.", 'yellow');
                return;
            }

            // 1. Prepara o conte√∫do
            const dataStr = JSON.stringify(allNotes, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            
            // 2. Cria o URL de download tempor√°rio
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // 3. Define o nome do ficheiro
            const date = new Date().toISOString().slice(0, 10);
            a.download = `caderno_notas_export_${date}.json`;
            a.href = url;
            
            // 4. Dispara o download e limpa
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alertMessage(`Exporta√ß√£o de ${allNotes.length} notas conclu√≠da!`, 'green');
        };

        // Fun√ß√£o para importar notas de um ficheiro JSON
        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirmAction("Importar substituir√° todas as notas existentes. Tem certeza que deseja continuar?")) {
                // Se o usu√°rio cancelar, limpa o input de arquivo para permitir nova sele√ß√£o
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedNotes) || importedNotes.some(n => !n.id || !n.content)) {
                        throw new Error("Formato de ficheiro JSON inv√°lido para notas.");
                    }

                    // Substitui o array de notas
                    allNotes = importedNotes; 
                    saveNotesToLocalStorage();
                    renderNotes();
                    
                    alertMessage(`Importa√ß√£o de ${importedNotes.length} notas conclu√≠da com sucesso!`, 'green');
                } catch (error) {
                    console.error("Erro ao processar ficheiro de importa√ß√£o:", error);
                    alertMessage("Erro na importa√ß√£o. Ficheiro corrompido ou formato inv√°lido.", 'red');
                } finally {
                    // Limpa o input de arquivo
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        };


        // --- Fun√ß√µes Auxiliares de UI ---

        // Preenche as op√ß√µes de categoria no filtro e no editor
        const populateCategories = () => {
            const filterEl = document.getElementById('categoryFilter');
            const editorEl = document.getElementById('noteCategory');
            
            // Limpa e adiciona a op√ß√£o "Todas" no filtro
            filterEl.innerHTML = '<option value="">Todas as Categorias</option>';
            
            // Limpa e preenche as op√ß√µes
            editorEl.innerHTML = ''; 

            DEFAULT_CATEGORIES.forEach(cat => {
                const optFilter = document.createElement('option');
                optFilter.value = optFilter.textContent = cat;
                filterEl.appendChild(optFilter);

                const optEditor = document.createElement('option');
                optEditor.value = optEditor.textContent = cat;
                editorEl.appendChild(optEditor);
            });
        };

        // Reseta o editor para o estado de "nova nota"
        const resetEditor = () => {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteCategory').value = 'Geral';
            document.getElementById('noteDate').textContent = 'Nova Nota (n√£o gravada)';
            document.getElementById('deleteNoteBtn').classList.add('hidden');
            
            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
            renderNotes(); // Limpa qualquer destaque na lista
        };

        // Preenche o editor com os dados de uma nota
        const loadNoteToEditor = (note) => {
            currentNoteId = note.id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteCategory').value = note.category || 'Geral';
            // 'createdAt' √© um timestamp em milissegundos
            document.getElementById('noteDate').textContent = `Criada em: ${formatDate(note.createdAt)}`;
            document.getElementById('deleteNoteBtn').classList.remove('hidden');

            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
        };

        // Formata o timestamp (milisegundos) para uma string leg√≠vel
        const formatDate = (timestamp) => {
            if (timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('pt-PT', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
            }
            return new Date().toLocaleDateString('pt-PT');
        };
        
        // --- Fun√ß√µes de Renderiza√ß√£o e L√≥gica da Aplica√ß√£o ---
        
        // Renderiza a lista de notas com base nos filtros
        const renderNotes = () => {
            const listEl = document.getElementById('notesList');
            const categoryFilter = document.getElementById('categoryFilter').value;
            const dateSearch = document.getElementById('dateSearch').value;
            
            listEl.innerHTML = '';

            let filteredNotes = allNotes;

            // 1. Filtrar por Categoria
            if (categoryFilter) {
                filteredNotes = filteredNotes.filter(note => note.category === categoryFilter);
            }

            // 2. Filtrar por Data (A partir de...)
            if (dateSearch) {
                const searchDate = new Date(dateSearch);
                searchDate.setHours(0, 0, 0, 0); // In√≠cio do dia
                const searchTimestamp = searchDate.getTime();

                filteredNotes = filteredNotes.filter(note => {
                    // note.createdAt √© um timestamp em milissegundos (Date.now())
                    return note.createdAt && note.createdAt >= searchTimestamp;
                });
            }
            
            if (filteredNotes.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500">Nenhuma nota encontrada.</p>`;
                // Certifica-se de que o placeholder est√° escondido se houver notas, ou vis√≠vel se n√£o houver
                if (allNotes.length > 0) {
                     document.getElementById('listPlaceholder').textContent = 'Nenhuma nota correspondente aos filtros.';
                } else {
                     document.getElementById('listPlaceholder').textContent = 'Nenhuma nota ainda. Crie uma!';
                }
                return;
            }

            // 3. Ordenar (Mais recente primeiro) e Renderizar
            filteredNotes.sort((a, b) => b.createdAt - a.createdAt); // Ordena pelo timestamp

            filteredNotes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = `p-3 bg-white hover:bg-indigo-50 rounded-lg cursor-pointer transition duration-150 shadow-md ${note.id === currentNoteId ? 'ring-2 ring-indigo-500' : ''}`;
                noteCard.innerHTML = `
                    <h3 class="text-base font-semibold truncate text-indigo-700">${note.title || 'Nota Sem T√≠tulo'}</h3>
                    <p class="text-xs text-gray-500 mt-1">
                        ${note.category} ‚Ä¢ ${formatDate(note.createdAt)}
                    </p>
                    <p class="text-sm text-gray-600 mt-2 line-clamp-2">${note.content.substring(0, 100).trim()}...</p>
                `;
                noteCard.onclick = () => {
                    loadNoteToEditor(note);
                    renderNotes(); // Atualiza o destaque na lista
                };
                listEl.appendChild(noteCard);
            });

            document.getElementById('listPlaceholder').textContent = allNotes.length === 0 ? 'Nenhuma nota ainda. Crie uma!' : '';
        };

        // Guarda ou Atualiza a nota no array e no LocalStorage
        const saveNote = () => {
            const title = document.getElementById('noteTitle').value.trim() || 'Nota Sem T√≠tulo';
            const content = document.getElementById('noteContent').value.trim();
            const category = document.getElementById('noteCategory').value;

            if (!content) {
                alertMessage("O conte√∫do da nota n√£o pode estar vazio!", 'red');
                return;
            }

            const now = Date.now();
            
            if (currentNoteId) {
                // Atualiza nota existente
                const index = allNotes.findIndex(n => n.id === currentNoteId);
                if (index !== -1) {
                    allNotes[index] = {
                        ...allNotes[index],
                        title: title,
                        content: content,
                        category: category,
                        updatedAt: now,
                    };
                }
                alertMessage("Nota atualizada com sucesso!", 'green');
            } else {
                // Cria nova nota
                const newNote = {
                    id: crypto.randomUUID(),
                    title: title,
                    content: content,
                    category: category,
                    createdAt: now,
                    updatedAt: now,
                };
                allNotes.push(newNote);
                currentNoteId = newNote.id; // Define o ID da nota rec√©m-criada
                alertMessage("Nota criada com sucesso!", 'green');
            }

            saveNotesToLocalStorage();
            renderNotes(); // Recarrega e ordena a lista
        };

        // Exclui a nota do array e do LocalStorage
        const deleteNote = () => {
            if (!currentNoteId) return;

            if (!confirmAction("Tem certeza que deseja excluir esta nota? Esta a√ß√£o √© irrevers√≠vel.")) {
                return;
            }

            // Filtra todas as notas, mantendo apenas as que n√£o t√™m o ID atual
            allNotes = allNotes.filter(n => n.id !== currentNoteId);
            saveNotesToLocalStorage();
            
            // Limpa o editor e mostra o placeholder
            resetEditor();
            document.getElementById('noteEditor').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
            
            alertMessage("Nota exclu√≠da com sucesso!", 'yellow');
            renderNotes();
        };


        // --- Funcionalidade de IA e Mensagens Personalizadas ---

        // Substitui o alert/confirm nativo por uma fun√ß√£o customizada
        const alertMessage = (message, color) => {
             console.log(`[Mensagem ${color.toUpperCase()}]: ${message}`);
             const statusEl = document.getElementById('noteDate');
             const originalText = statusEl.textContent;
             
             statusEl.classList.remove('text-gray-500', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-indigo-600'); 
             
             statusEl.textContent = message;
             
             const colorMap = { 'green': 'text-green-600', 'red': 'text-red-600', 'yellow': 'text-yellow-600' };
             statusEl.classList.add(colorMap[color] || 'text-indigo-600');
             
             setTimeout(() => {
                statusEl.textContent = originalText;
                statusEl.classList.remove(...Object.values(colorMap));
                statusEl.classList.add('text-gray-500');
             }, 3000);
        };

        const confirmAction = (message) => {
            return window.confirm(message); 
        }

        // CORRIGIDO: Agora usa propriedades do textarea para obter o texto selecionado
        // Trata o texto selecionado e abre a pesquisa do Google AI
        const handleIaSearch = (event) => {
            const editor = document.getElementById('noteContent');
            // Obt√©m o texto selecionado usando propriedades espec√≠ficas do textarea
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd).trim();
            
            if (!selectedText) {
                alertMessage("Nenhum texto selecionado para enviar √† IA.", 'yellow');
                return;
            }
            
            // O prompt predefinido + o texto selecionado
            const query = IA_PROMPT + selectedText;
            const encodedQuery = encodeURIComponent(query);
            
            // URL com o modo IA (udm=50)
            const googleUrl = `https://www.google.com/search?udm=50&q=${encodedQuery}`;
            
            window.open(googleUrl, '_blank');
            
            // Oculta o bot√£o flutuante ap√≥s a a√ß√£o
            document.getElementById('iaFloatingButton').style.display = 'none';
        };

        // CORRIGIDO: Agora usa propriedades do textarea para verificar e posicionar
        // Exibe ou move o bot√£o flutuante com base na sele√ß√£o de texto
        const checkSelection = () => {
            const editor = document.getElementById('noteContent');
            const iaButton = document.getElementById('iaFloatingButton');

            // 1. Usa propriedades espec√≠ficas do textarea para verificar a sele√ß√£o
            const selectedTextLength = editor.selectionEnd - editor.selectionStart;

            if (selectedTextLength > 0) {
                iaButton.style.display = 'block';
                
                // 2. Posicionamento simplificado e robusto: Canto superior direito do editor
                
                // Obt√©m a posi√ß√£o do elemento `#noteContent` no ecr√£
                const editorRect = editor.getBoundingClientRect();
                
                // Obt√©m a posi√ß√£o do cont√™iner da coluna (pai da notaEditor) no ecr√£
                // .flex-1.bg-white √© o cont√™iner de coluna com position: relative
                const containerRect = document.querySelector('.flex-1.bg-white').getBoundingClientRect(); 

                // Calcula a posi√ß√£o (top/right) do bot√£o *relativo* ao cont√™iner da coluna.
                // Subtrai as coordenadas do cont√™iner pai para obter a posi√ß√£o relativa.

                const topPositionRelativeToContainer = editorRect.top - containerRect.top;

                // O bot√£o tem cerca de 40px de altura (ajuste para aparecer acima da textarea)
                iaButton.style.top = `${topPositionRelativeToContainer - 40}px`; 
                // Posiciona 10px da margem direita da coluna
                iaButton.style.right = '10px'; 
                iaButton.style.left = 'auto'; // Garante que n√£o h√° conflito de left/right
            } else {
                iaButton.style.display = 'none';
            }
        };

        // --- Inicializa√ß√£o e Event Listeners ---

        const initializeApp = () => {
            loadNotesFromLocalStorage();
            populateCategories();
            renderNotes();
            // Remove o indicador de loading, pois o carregamento √© instant√¢neo
            document.getElementById('loading').classList.add('hidden');
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Listeners existentes
        document.getElementById('newNoteBtn').addEventListener('click', resetEditor);
        document.getElementById('saveNoteBtn').addEventListener('click', saveNote);
        document.getElementById('deleteNoteBtn').addEventListener('click', deleteNote);
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            currentNoteId = null;
            document.getElementById('noteEditor').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
            renderNotes();
        });

        // Listeners para filtrar a lista
        document.getElementById('categoryFilter').addEventListener('change', renderNotes);
        document.getElementById('dateSearch').addEventListener('change', renderNotes);
        
        // Listeners para a funcionalidade IA:
        // Estes listeners est√£o corretos, mas agora chamam a fun√ß√£o checkSelection corrigida.
        document.getElementById('noteContent').addEventListener('mouseup', checkSelection);
        document.getElementById('noteContent').addEventListener('keyup', checkSelection);
        document.getElementById('iaFloatingButton').addEventListener('click', handleIaSearch);
        
        // NOVOS Listeners para Exportar/Importar
        document.getElementById('exportBtn').addEventListener('click', handleExport);
        document.getElementById('importFile').addEventListener('change', handleImport);

    </script>
</body>
</html>
