<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Stories V17 - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Playfair+Display:ital,wght@0,700;1,400&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Biblioteca para processar GIFs Animados -->
    <script src="https://cdn.jsdelivr.net/gh/buzzfeed/libgif-js@master/libgif.js"></script>

    <style>
        /* BASE */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000;
            overflow: hidden; 
            position: fixed; width: 100%; height: 100%;
            touch-action: none;
        }

        /* CANVAS */
        #canvas-container {
            position: absolute; inset: 0; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            background-color: #000;
        }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* UI LAYERS */
        #ui-layer {
            position: absolute; inset: 0; z-index: 20; pointer-events: none;
            transition: opacity 0.3s;
        }
        body.preview-active #ui-layer { opacity: 0; pointer-events: none; }

        /* BOTÃO SAIR PREVIEW */
        #exit-preview-btn {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); color: black;
            padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        body.preview-active #exit-preview-btn { opacity: 1; pointer-events: auto; }
        
        .floating-menu {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 8px; pointer-events: auto;
        }

        #drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
            z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #drawer-overlay.open { opacity: 1; pointer-events: auto; }

        #drawers-layer { position: fixed; inset: 0; z-index: 50; pointer-events: none; }

        /* COMPONENTES */
        .menu-btn {
            width: 50px; height: 48px; 
            border-top-left-radius: 12px; border-bottom-left-radius: 12px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc; display: flex; align-items: center; justify-content: center;
            box-shadow: -4px 4px 10px rgba(0,0,0,0.3); cursor: pointer; pointer-events: auto;
        }
        .menu-btn:active { transform: scale(0.95); background: #555; }
        .menu-btn.active { background: white; color: black; width: 55px; }
        .menu-btn.action-green { background: #22c55e; color: white; border: none; margin-top: 10px; }

        /* DRAWER PANEL (COMPACTO) */
        .drawer-panel {
            position: absolute; left: 0; top: 50%;
            transform: translateY(-50%) translateX(-100%);
            width: 85%; max-width: 320px; 
            height: 45vh; max-height: 400px; 
            background: rgba(20, 20, 20, 0.98);
            border-radius: 0 20px 20px 0;
            border: 1px solid rgba(255,255,255,0.15); border-left: none;
            padding: 20px; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
            opacity: 0; overflow-y: auto; pointer-events: auto;
            box-shadow: 10px 10px 50px rgba(0,0,0,0.8); color: white; touch-action: pan-y;
        }
        .drawer-panel.open { opacity: 1; transform: translateY(-50%) translateX(0); }

        .dark-input {
            width: 100%; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 10px; border-radius: 8px; outline: none; font-size: 14px;
        }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .filter-item { aspect-ratio: 16/9; background: #222; border-radius: 6px; position: relative; border: 2px solid transparent; overflow: hidden; }
        .filter-item.selected { border-color: white; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }
        .filter-name { position: absolute; bottom:0; width: 100%; background: rgba(0,0,0,0.7); font-size: 10px; text-align: center; padding: 4px; font-weight: bold; }

        /* Stickers Grid */
        .stickers-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .sticker-thumb { 
            aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 8px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            border: 1px solid transparent; transition: 0.2s; overflow: hidden;
        }
        .sticker-thumb:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .sticker-thumb img { max-width: 90%; max-height: 90%; object-fit: contain; pointer-events: none; }

        #welcome-screen {
            position: fixed; inset: 0; z-index: 200; background: #111;
            display: flex; flex-col: column; align-items: center; justify-content: center;
            transition: opacity 0.4s;
        }
        #welcome-screen.hidden { opacity: 0; pointer-events: none; }

        .label-xs { font-size: 10px; text-transform: uppercase; color: #888; margin: 12px 0 4px 0; font-weight: 700; display: block; }
        .row { display: flex; gap: 10px; align-items: center; }
        .btn-select { 
            flex: 1; padding: 8px; font-size: 11px; border-radius: 6px; 
            text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .btn-select.active { background: white; color: black; font-weight: 800; }
        .btn-select.inactive { background: rgba(255,255,255,0.05); color: #888; }
        
        .close-drawer { position: absolute; top: 15px; right: 15px; padding: 5px; color: #888; }
        .gesture-hint { position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 10px; color: rgba(255,255,255,0.4); pointer-events: none; text-shadow: 0 2px 4px black; }

        input[type="range"] { width: 100%; height: 20px; background: transparent; -webkit-appearance: none; margin: 8px 0; touch-action: pan-x; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; margin-top: -8px; background: white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* Giphy Link */
        .giphy-link {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            background: linear-gradient(45deg, #9933ff, #ff6666);
            color: white; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px;
            margin-bottom: 12px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .giphy-link:hover { opacity: 0.9; }

    </style>
</head>
<body>

    <!-- BOTÃO SAIR PREVIEW -->
    <div id="exit-preview-btn" onclick="togglePreview()">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar à Edição
    </div>

    <!-- START SCREEN -->
    <div id="welcome-screen">
        <div class="p-6 text-center">
            <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="camera" class="w-10 h-10 text-black"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Studio Stories</h1>
            <p class="text-gray-500 text-xs mb-8">Pince para Zoom • Arraste para Mover</p>
            <label class="block w-full max-w-xs mx-auto">
                <div class="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2 cursor-pointer active:scale-95 transition">
                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                    Carregar Foto
                </div>
                <input type="file" id="startInput" accept="image/*" class="hidden">
            </label>
        </div>
    </div>

    <!-- CANVAS -->
    <div id="canvas-container">
        <canvas id="storyCanvas" width="1080" height="1920"></canvas>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="gesture-hint">Toque e Arraste qualquer elemento • Pince para Zoom</div>
        <div class="floating-menu">
            <div onclick="togglePreview()" class="menu-btn" title="Ver"><i data-lucide="eye"></i></div>
            <div class="h-[1px] bg-white/10 w-[30px] mx-auto my-1"></div>
            
            <div onclick="toggleDrawer('bg')" class="menu-btn" id="btn-bg"><i data-lucide="image"></i></div>
            <div onclick="toggleDrawer('filters')" class="menu-btn" id="btn-filters"><i data-lucide="wand-2"></i></div>
            <div onclick="toggleDrawer('text')" class="menu-btn" id="btn-text"><i data-lucide="type"></i></div>
            <div onclick="toggleDrawer('logo')" class="menu-btn" id="btn-logo"><i data-lucide="store"></i></div>
            <!-- Botão Figurinhas -->
            <div onclick="toggleDrawer('stickers')" class="menu-btn" id="btn-stickers"><i data-lucide="smile"></i></div>
            
            <div class="h-[1px] bg-white/10 w-[30px] mx-auto my-1"></div>
            <!-- Download IMG -->
            <div onclick="downloadStory()" class="menu-btn action-green" title="Imagem Otimizada"><i data-lucide="image-down"></i></div>
            <!-- Download VIDEO -->
            <div onclick="downloadVideo()" class="menu-btn action-green mt-2" id="btn-video-dl" title="Vídeo Leve"><i data-lucide="video"></i></div>
        </div>
    </div>

    <div id="drawer-overlay" onclick="closeAllDrawers()"></div>

    <!-- MODAIS -->
    <div id="drawers-layer">
        
        <!-- BG -->
        <div id="drawer-bg" class="drawer-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base flex gap-2"><i data-lucide="image"></i> Fundo</h3>
                <i data-lucide="x" class="close-drawer" onclick="closeAllDrawers()"></i>
            </div>
            <label class="block w-full bg-white/5 p-3 rounded-lg text-center text-xs cursor-pointer border border-white/10 mb-4">
                Trocar Foto
                <input type="file" id="bgInputDrawer" accept="image/*" class="hidden">
            </label>
            <p class="text-[10px] text-gray-400">Use dois dedos na tela para dar zoom e um para mover o fundo.</p>
        </div>

        <!-- FILTROS -->
        <div id="drawer-filters" class="drawer-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base flex gap-2"><i data-lucide="wand-2"></i> Filtros</h3>
                <i data-lucide="x" class="close-drawer" onclick="closeAllDrawers()"></i>
            </div>
            <div class="filter-grid" id="filterList"></div>
        </div>

        <!-- TEXTO -->
        <div id="drawer-text" class="drawer-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base flex gap-2"><i data-lucide="type"></i> Informações</h3>
                <i data-lucide="x" class="close-drawer" onclick="closeAllDrawers()"></i>
            </div>
            <button onclick="toggleInvert()" id="btnInvert" class="w-full py-2 mb-4 rounded-lg bg-white text-black font-bold text-xs">Inverter Cores</button>
            
            <label class="label-xs mt-0">Dados</label>
            <input type="text" id="inpName" class="dark-input mb-2" placeholder="Nome">
            <div class="row">
                <div class="w-2/3"><input type="text" id="inpPrice" class="dark-input font-bold" placeholder="0,00"></div>
                <div class="w-1/3"><input type="text" id="inpUnit" class="dark-input text-center" placeholder="un"></div>
            </div>

            <label class="label-xs">Fonte</label>
            <div class="flex bg-white/5 p-1 rounded-lg gap-1">
                <div onclick="setFont('Inter')" class="btn-select" id="font-Inter">Modern</div>
                <div onclick="setFont('Playfair Display')" class="btn-select" id="font-Playfair">Elegant</div>
                <div onclick="setFont('Oswald')" class="btn-select" id="font-Oswald">Bold</div>
            </div>
        </div>

        <!-- LOGO -->
        <div id="drawer-logo" class="drawer-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base flex gap-2"><i data-lucide="store"></i> Logo</h3>
                <i data-lucide="x" class="close-drawer" onclick="closeAllDrawers()"></i>
            </div>
            <label class="block w-full bg-white/5 p-3 rounded-lg text-center text-xs mb-4 cursor-pointer border border-white/10">
                Carregar PNG
                <input type="file" id="logoInput" accept="image/*" class="hidden">
            </label>
            <label class="label-xs">Formato</label>
            <div class="flex bg-white/5 p-1 rounded-lg gap-1 mb-2">
                <div onclick="setLogoFormat('horizontal')" class="btn-select" id="fmt-horizontal">Horiz.</div>
                <div onclick="setLogoFormat('square')" class="btn-select" id="fmt-square">Quad.</div>
            </div>
            
            <label class="label-xs">Tamanho (Slider ou Pinça)</label>
            <div class="flex items-center gap-2 bg-white/5 p-2 rounded-lg mb-2">
                <i data-lucide="minus" class="w-3 h-3 text-gray-400"></i>
                <input type="range" id="logoScaleInput" oninput="adjustLogoScale(this.value)" min="0.2" max="3" step="0.1" value="1">
                <i data-lucide="plus" class="w-3 h-3 text-gray-400"></i>
            </div>
        </div>

        <!-- STICKERS (GIF/PNG) -->
        <div id="drawer-stickers" class="drawer-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base flex gap-2"><i data-lucide="smile"></i> GIFs & Figuras</h3>
                <i data-lucide="x" class="close-drawer" onclick="closeAllDrawers()"></i>
            </div>
            
            <!-- GIPHY LINK -->
            <a href="https://giphy.com/" target="_blank" class="giphy-link">
                <i data-lucide="search" class="w-4 h-4"></i> Buscar GIFs no GIPHY
            </a>

            <label class="block w-full bg-white/5 p-3 rounded-lg text-center text-xs cursor-pointer border border-white/10 mb-4">
                Carregar GIF/IMG do Dispositivo
                <input type="file" id="stickerInput" accept="image/gif, image/png, image/jpeg" class="hidden">
            </label>

            <p class="text-[10px] text-gray-400 mb-2">Galeria (img1...img100)</p>
            <div class="stickers-grid" id="stickersGrid">
                <!-- Gerado via JS -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const canvas = document.getElementById('storyCanvas');
        const ctx = canvas.getContext('2d');
        const welcomeScreen = document.getElementById('welcome-screen');

        // --- DADOS ---
        const FILTERS = [
            { id: 'normal', name: 'Normal', filter: 'none' },
            { id: 'vignette', name: 'Vinheta', filter: 'none', overlay: 'vignette_strong' },
            { id: 'bw', name: 'P&B', filter: 'grayscale(100%) contrast(1.1)' },
            { id: 'sharp', name: 'Nitidez', filter: 'contrast(1.4) saturate(1.1)' },
        ];

        let state = {
            bgImg: null, logoImg: null,
            name: 'Nome do Produto', price: '99,90', unit: 'un',
            
            boxW: 800, boxH: 300, 
            boxManualX: null, boxManualY: null,
            boxScale: 1.0, isDarkMode: false,
            
            fontFamily: 'Inter', titleSize: 50, priceSize: 140,
            bgScale: 1, bgX: 0, bgY: 0, currentFilterId: 'normal',
            logoFormat: 'horizontal', logoScale: 1, logoX: null, logoY: null,
            
            stickers: [], 
            
            // Video Config
            videoDuration: 5, // segundos
        };

        // --- LOADERS PADRÃO ---
        const phBg = new Image(); phBg.crossOrigin = "anonymous";
        phBg.src = 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=1080&auto=format&fit=crop';
        const phLogo = new Image(); phLogo.crossOrigin = "anonymous";
        phLogo.src = 'https://placehold.co/400x200/ffffff/000000.png?text=LOGO';

        phBg.onload = () => { if(!state.bgImg) { state.bgImg = phBg; } };
        phLogo.onload = () => { if(!state.logoImg) { state.logoImg = phLogo; } };

        // --- STICKERS LOADER (Local + Upload) ---
        const stickersGrid = document.getElementById('stickersGrid');
        
        // Carrega 100 GIFs presumidos (Expandido)
        for(let i=1; i<=100; i++) {
            const div = document.createElement('div');
            div.className = 'sticker-thumb';
            // Caminho da imagem
            const src = `studio/img/img${i}.gif`;
            
            const img = new Image();
            img.src = src;
            img.onerror = () => { div.style.display = 'none'; }; 
            img.onload = () => {
                div.appendChild(img);
                div.onclick = () => loadSticker(src); // Carrega a URL
            };
            stickersGrid.appendChild(div);
        }

        // Upload Manual de Sticker
        document.getElementById('stickerInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (evt) => loadSticker(evt.target.result);
                reader.readAsDataURL(file);
            }
        });

        // Lógica Unificada de Carregamento de Sticker (GIF vs IMG)
        function loadSticker(src) {
            // Verifica se é GIF (pela extensão ou dataURI)
            const isGif = src.toLowerCase().includes('.gif') || src.startsWith('data:image/gif');
            
            // Cria elemento de imagem temporário
            const imgEl = document.createElement('img');
            imgEl.src = src;
            
            if(isGif) {
                // Configura SuperGif
                const wrapper = document.createElement('div');
                // Atributo rel:auto_play é necessário para libgif iniciar
                imgEl.setAttribute('rel:auto_play', '1'); 
                imgEl.setAttribute('rel:rubbable', '0');
                wrapper.appendChild(imgEl);
                
                const gifObj = new SuperGif({ gif: imgEl, auto_play: true });
                
                gifObj.load(() => {
                    // Loaded!
                    state.stickers.push({
                        type: 'gif',
                        obj: gifObj,
                        x: 1080/2 - 150,
                        y: 1920/2 - 150,
                        scale: 1.0
                    });
                    closeAllDrawers();
                });
            } else {
                // Imagem Normal
                imgEl.onload = () => {
                    state.stickers.push({
                        type: 'img',
                        obj: imgEl,
                        x: 1080/2 - 150,
                        y: 1920/2 - 150,
                        scale: 1.0
                    });
                    closeAllDrawers();
                };
            }
        }

        // --- UI RENDER ---
        const filterListEl = document.getElementById('filterList');
        FILTERS.forEach(f => {
            const div = document.createElement('div');
            div.className = `filter-item ${f.id==='normal'?'selected':''}`;
            div.onclick = () => setFilter(f.id);
            div.innerHTML = `<div style="width:100%;height:100%;background:#333;filter:${f.filter}"></div><div class="filter-name">${f.name}</div>`;
            filterListEl.appendChild(div);
        });

        // --- SYNC ---
        function syncUI() {
            document.getElementById('inpName').value = state.name;
            document.getElementById('inpPrice').value = state.price;
            document.getElementById('inpUnit').value = state.unit;
            document.getElementById('logoScaleInput').value = state.logoScale;
            updateClasses();
        }

        function updateClasses() {
            ['Inter','Playfair Display','Oswald'].forEach(f => {
                const el = document.getElementById(`font-${f.split(' ')[0]}`);
                el.className = state.fontFamily.includes(f.split(' ')[0]) ? 'btn-select active' : 'btn-select inactive';
            });
            document.getElementById('fmt-horizontal').className = state.logoFormat === 'horizontal' ? 'btn-select active' : 'btn-select inactive';
            document.getElementById('fmt-square').className = state.logoFormat === 'square' ? 'btn-select active' : 'btn-select inactive';
        }
        syncUI();

        // --- HANDLERS ---
        const handleUpload = (file, key) => {
            if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => {
                    state[key] = img;
                    if(key==='bgImg'){ state.bgX=0; state.bgY=0; state.bgScale=1; }
                    if(key==='logoImg'){ state.logoX=null; state.logoY=null; }
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(file);
        };

        document.getElementById('startInput').addEventListener('change', e=>{ handleUpload(e.target.files[0],'bgImg'); welcomeScreen.classList.add('hidden'); toggleDrawer('bg'); });
        document.getElementById('bgInputDrawer').addEventListener('change', e=>handleUpload(e.target.files[0],'bgImg'));
        document.getElementById('logoInput').addEventListener('change', e=>handleUpload(e.target.files[0],'logoImg'));

        document.getElementById('inpName').addEventListener('input', e=>{state.name=e.target.value;});
        document.getElementById('inpPrice').addEventListener('input', e=>{state.price=e.target.value;});
        document.getElementById('inpUnit').addEventListener('input', e=>{state.unit=e.target.value;});

        window.setFont = f => {state.fontFamily=f; updateClasses();}
        window.setFilter = id => {
            state.currentFilterId=id; 
            document.querySelectorAll('.filter-item').forEach(e=>e.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        window.toggleInvert = () => { state.isDarkMode=!state.isDarkMode; updateClasses(); }
        window.setLogoFormat = f => { state.logoFormat=f; updateClasses(); }
        window.adjustLogoScale = v => { state.logoScale=parseFloat(v); }

        window.togglePreview = () => {
            document.body.classList.toggle('preview-active');
            if(document.body.classList.contains('preview-active')) closeAllDrawers();
        }

        let currentDrawer = null;
        window.toggleDrawer = (id) => {
            document.querySelectorAll('.drawer-panel').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('drawer-overlay').classList.remove('open');
            if(id && currentDrawer !== id) {
                document.getElementById(`drawer-${id}`).classList.add('open');
                document.getElementById(`btn-${id}`).classList.add('active');
                document.getElementById('drawer-overlay').classList.add('open');
                currentDrawer = id;
            } else { currentDrawer = null; }
        };
        window.closeAllDrawers = () => toggleDrawer(null);

        // --- SISTEMA DE GESTOS MULTITOUCH ---
        let dragTarget = null; // 'bg', 'logo', 'box', 'sticker-N'
        let pointers = {};
        let initialDist = 0;
        let initialScale = 1;
        let startPoints = {}; 
        let initialPos = { x:0, y:0 };

        const cContainer = document.getElementById('canvas-container');

        const getCanvasCoords = (clientX, clientY) => {
            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width;
            const sy = canvas.height / r.height;
            return { x: (clientX - r.left) * sx, y: (clientY - r.top) * sy };
        };

        const hitTest = (x, y) => {
            // Check Stickers (Top down)
            for(let i=state.stickers.length-1; i>=0; i--) {
                const s = state.stickers[i];
                let w = 300, h = 300;
                if(s.type === 'gif') {
                    const c = s.obj.get_canvas();
                    if(c) { w=c.width; h=c.height; }
                } else {
                    w = s.obj.width; h = s.obj.height;
                }
                w *= s.scale; h *= s.scale;
                
                if(x >= s.x && x <= s.x + w && y >= s.y && y <= s.y + h) return `sticker-${i}`;
            }

            if(state.logoImg) {
                let lw=state.logoFormat==='horizontal'?400:300, lh=state.logoFormat==='horizontal'?200:300;
                lw*=state.logoScale; lh*=state.logoScale;
                let lx = state.logoX!==null ? state.logoX : (1080-lw)/2; 
                let ly = state.logoY!==null ? state.logoY : 100;
                if(x>=lx && x<=lx+lw && y>=ly && y<=ly+lh) return 'logo';
            }
            let bw = state.boxW * state.boxScale;
            let bh = state.boxH * state.boxScale;
            let bx = state.boxManualX !== null ? state.boxManualX : (1080 - bw)/2;
            let by = state.boxManualY !== null ? state.boxManualY : 1920 - bh - 120;
            if(x>=bx && x<=bx+bw && y>=by && y<=by+bh) return 'box';
            return 'bg';
        };

        const handlePointerDown = (e) => {
            if(document.body.classList.contains('preview-active')) return;
            if(e.target.closest('.drawer-panel') || e.target.closest('.floating-menu') || e.target.id === 'exit-preview-btn') return;
            
            e.preventDefault();
            pointers[e.pointerId] = e;
            const pts = Object.values(pointers);
            
            if(pts.length === 1) {
                const p = getCanvasCoords(e.clientX, e.clientY);
                dragTarget = hitTest(p.x, p.y);
                startPoints[e.pointerId] = { cx: e.clientX, cy: e.clientY }; 
                
                if(dragTarget.startsWith('sticker-')) {
                    const idx = parseInt(dragTarget.split('-')[1]);
                    const s = state.stickers[idx];
                    initialPos = { x: s.x, y: s.y };
                }
                else if(dragTarget === 'logo') {
                    let lw=state.logoFormat==='horizontal'?400:300; 
                    lw*=state.logoScale; 
                    initialPos = { x: state.logoX!==null?state.logoX : (1080-lw)/2, y: state.logoY!==null?state.logoY : 100 };
                } 
                else if(dragTarget === 'box') {
                    let bw = state.boxW * state.boxScale;
                    let bh = state.boxH * state.boxScale;
                    initialPos = { x: state.boxManualX!==null?state.boxManualX : (1080-bw)/2, y: state.boxManualY!==null?state.boxManualY : 1920-bh-120 };
                }
                else if(dragTarget === 'bg') {
                    initialPos = { x: state.bgX, y: state.bgY };
                }
            } 
            else if (pts.length === 2) {
                const p1 = pts[0]; const p2 = pts[1];
                initialDist = Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
                if(dragTarget === 'bg') initialScale = state.bgScale;
                if(dragTarget === 'logo') initialScale = state.logoScale;
                if(dragTarget === 'box') initialScale = state.boxScale;
                if(dragTarget && dragTarget.startsWith('sticker-')) {
                    const idx = parseInt(dragTarget.split('-')[1]);
                    initialScale = state.stickers[idx].scale;
                }
            }
        };

        const handlePointerMove = (e) => {
            if(!dragTarget) return;
            e.preventDefault();
            pointers[e.pointerId] = e;
            const pts = Object.values(pointers);

            if(pts.length === 1) {
                const p = pts[0];
                const start = startPoints[p.pointerId];
                if(!start) return;
                const ratio = 1080 / window.innerWidth;
                const dx = (p.clientX - start.cx) * ratio;
                const dy = (p.clientY - start.cy) * ratio;

                if(dragTarget.startsWith('sticker-')) {
                    const idx = parseInt(dragTarget.split('-')[1]);
                    state.stickers[idx].x = initialPos.x + dx;
                    state.stickers[idx].y = initialPos.y + dy;
                }
                else if(dragTarget === 'logo') {
                    state.logoX = initialPos.x + dx;
                    state.logoY = initialPos.y + dy;
                }
                else if(dragTarget === 'box') {
                    state.boxManualX = initialPos.x + dx;
                    state.boxManualY = initialPos.y + dy;
                }
                else if(dragTarget === 'bg') {
                    state.bgX = initialPos.x + dx;
                    state.bgY = initialPos.y + dy;
                }
            }
            else if(pts.length === 2) {
                const p1 = pts[0]; const p2 = pts[1];
                const dist = Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
                const scaleFactor = dist / initialDist;

                if(dragTarget === 'bg') state.bgScale = Math.max(0.1, initialScale * scaleFactor);
                if(dragTarget === 'logo') {
                    state.logoScale = Math.max(0.2, initialScale * scaleFactor);
                    document.getElementById('logoScaleInput').value = state.logoScale;
                }
                if(dragTarget === 'box') state.boxScale = Math.max(0.5, initialScale * scaleFactor);
                if(dragTarget.startsWith('sticker-')) {
                    const idx = parseInt(dragTarget.split('-')[1]);
                    state.stickers[idx].scale = Math.max(0.2, initialScale * scaleFactor);
                }
            }
        };

        const handlePointerUp = (e) => {
            delete pointers[e.pointerId];
            delete startPoints[e.pointerId];
            if(Object.keys(pointers).length === 0) dragTarget = null;
            else if(Object.keys(pointers).length === 1) {
                const remaining = Object.values(pointers)[0];
                handlePointerDown(remaining);
            }
        };

        cContainer.addEventListener('pointerdown', handlePointerDown);
        cContainer.addEventListener('pointermove', handlePointerMove);
        cContainer.addEventListener('pointerup', handlePointerUp);
        cContainer.addEventListener('pointercancel', handlePointerUp);
        cContainer.addEventListener('pointerout', handlePointerUp);


        // --- ANIMAÇÃO LOOP (Necessário para GIFs) ---
        function animate() {
            draw();
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);

        function draw() {
            ctx.clearRect(0,0,1080,1920); ctx.fillStyle='#000'; ctx.fillRect(0,0,1080,1920);
            
            // 1. BG (Sem animação de motion, apenas estático escalável)
            if(state.bgImg) {
                const i=state.bgImg; const f=FILTERS.find(x=>x.id===state.currentFilterId);
                const r=i.width/i.height, cr=1080/1920;
                let dw,dh; 
                if(r > cr) { dh=1920; dw=i.width*(1920/i.height); }
                else { dw=1080; dh=i.height*(1080/i.width); }
                
                ctx.save(); ctx.filter=f.filter;
                ctx.translate(540,960); ctx.scale(state.bgScale, state.bgScale); ctx.translate(-540,-960);
                ctx.translate(state.bgX,state.bgY);
                ctx.drawImage(i, (1080-dw)/2, (1920-dh)/2, dw, dh);
                ctx.restore();
                
                if(f.overlay==='vignette_strong'){
                    const g=ctx.createRadialGradient(540,960,100,540,960,1300);
                    g.addColorStop(0,'transparent'); g.addColorStop(0.4, 'rgba(0,0,0,0.2)'); g.addColorStop(1,'rgba(0,0,0,0.95)');
                    ctx.fillStyle=g; ctx.fillRect(0,0,1080,1920);
                }
            }

            // 2. GLASS BOX
            let finalBoxW = state.boxW * state.boxScale;
            let finalBoxH = state.boxH * state.boxScale;
            let bx = state.boxManualX !== null ? state.boxManualX : (1080 - finalBoxW)/2;
            let by = state.boxManualY !== null ? state.boxManualY : 1920 - finalBoxH - 120;
            
            const dm=state.isDarkMode;
            ctx.save(); 
            ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=40; ctx.shadowOffsetY=15; ctx.shadowOffsetX=5;
            ctx.fillStyle=dm?"rgba(0,0,0,0.85)":"rgba(255,255,255,0.85)";
            ctx.beginPath(); ctx.roundRect(bx,by,finalBoxW,finalBoxH,30); ctx.fill();
            ctx.strokeStyle=dm?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.4)"; ctx.lineWidth=1.5; ctx.stroke(); 
            ctx.restore();

            // 3. TEXTO
            const titleS = state.titleSize * state.boxScale;
            const priceS = state.priceSize * state.boxScale;
            const gap = 5 * state.boxScale;

            const contentH = titleS + gap + priceS;
            const startY = by + (finalBoxH - contentH)/2 + titleS;
            const sx = bx + (60 * state.boxScale);

            ctx.fillStyle=dm?"#fff":"#1e293b"; ctx.textAlign="left";
            let tw='600'; if(state.fontFamily==='Oswald') tw='700';
            ctx.font=`${tw} ${titleS}px '${state.fontFamily}'`; ctx.fillText(state.name,sx,startY);
            
            const py = startY + gap + priceS;
            let pw='800'; if(state.fontFamily==='Playfair Display') pw='700';
            const cs=priceS*0.4; // Tamanho moeda
            const centsSize = priceS * 0.5; // Tamanho centavos

            // R$
            ctx.font=`${pw} ${cs}px '${state.fontFamily}'`; 
            ctx.fillText("R$",sx,py);
            
            // Separar Preço
            let fullPrice = state.price;
            let mainPrice = fullPrice; 
            let cents = "";
            if(fullPrice.includes(',')) { let p = fullPrice.split(','); mainPrice = p[0]; cents = "," + p[1]; } 
            else if(fullPrice.includes('.')) { let p = fullPrice.split('.'); mainPrice = p[0]; cents = "." + p[1]; }

            const cw=ctx.measureText("R$").width;
            const px = sx + cw + (10*state.boxScale);

            // Inteiro
            ctx.font=`${pw} ${priceS}px '${state.fontFamily}'`; 
            ctx.fillText(mainPrice, px, py);
            
            // Centavos
            const mainW = ctx.measureText(mainPrice).width;
            if(cents) {
                ctx.font=`${pw} ${centsSize}px '${state.fontFamily}'`;
                ctx.fillText(cents, px + mainW, py);
            }

            // Unidade
            if(state.unit){
                const centsW = ctx.measureText(cents).width;
                ctx.font=`400 ${cs*0.7}px '${state.fontFamily}'`; ctx.fillStyle=dm?"#999":"#555";
                ctx.fillText(`/${state.unit}`, px + mainW + centsW + (10*state.boxScale), py);
            }

            // 4. LOGO
            if(state.logoImg) {
                let lw=state.logoFormat==='horizontal'?400:300, lh=state.logoFormat==='horizontal'?200:300;
                lw*=state.logoScale; lh*=state.logoScale;
                let lx = state.logoX!==null ? state.logoX : (1080-lw)/2;
                let ly = state.logoY!==null ? state.logoY : 100;

                const lr=state.logoImg.width/state.logoImg.height, tr=lw/lh;
                let fw,fh; if(lr>tr){fw=lw;fh=lw/lr;}else{fh=lh;fw=lh*lr;}
                ctx.save(); 
                ctx.shadowColor="rgba(0,0,0,0.4)"; ctx.shadowBlur=25; ctx.shadowOffsetY=10; ctx.shadowOffsetX=5;
                ctx.drawImage(state.logoImg, lx+(lw-fw)/2, ly+(lh-fh)/2, fw, fh); 
                ctx.restore();
            }

            // 5. STICKERS (Desenhados por último)
            state.stickers.forEach(s => {
                let w, h, imgDraw;
                
                if (s.type === 'gif') {
                    const canvasGif = s.obj.get_canvas(); // LibGif Canvas
                    if(!canvasGif) return;
                    imgDraw = canvasGif;
                    w = canvasGif.width;
                    h = canvasGif.height;
                } else {
                    imgDraw = s.obj;
                    w = s.obj.width;
                    h = s.obj.height;
                }

                // Ajuste de escala do sticker (se muito grande inicialmente, reduzir)
                // Vamos usar um tamanho base de 300px se não definido
                if(!s.baseScaleSet) {
                    const maxDim = Math.max(w, h);
                    if(maxDim > 400) {
                        const ratio = 400 / maxDim;
                        w *= ratio; h *= ratio;
                        // Ajusta escala interna para refletir isso no futuro
                        // Na verdade, melhor desenhar com w/h ajustados pelo scale state
                    }
                    s.baseW = w; s.baseH = h; s.baseScaleSet = true;
                }

                const drawW = s.baseW * s.scale;
                const drawH = s.baseH * s.scale;

                ctx.save();
                ctx.shadowColor="rgba(0,0,0,0.2)"; ctx.shadowBlur=15; ctx.shadowOffsetY=5;
                ctx.drawImage(imgDraw, s.x, s.y, drawW, drawH);
                ctx.restore();
            });
        }
        
        window.downloadStory = () => {
            const l=document.createElement('a'); l.download=`story_${Date.now()}.jpg`;
            draw(); 
            // QUALIDADE REDUZIDA (0.85)
            l.href=canvas.toDataURL('image/jpeg',0.85); l.click();
        }

        async function downloadVideo() {
            const btn = document.getElementById('btn-video-dl');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            btn.style.pointerEvents = 'none';
            
            const stream = canvas.captureStream(30);
            // BITRATE REDUZIDO (2.5 Mbps)
            const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 2500000 });
            const chunks = [];
            
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `story_video_${Date.now()}.webm`; a.click();
                URL.revokeObjectURL(url);
                btn.innerHTML = originalIcon; btn.style.pointerEvents = 'auto'; lucide.createIcons();
            };
            
            mediaRecorder.start();
            setTimeout(() => { mediaRecorder.stop(); }, 5000); // 5 Segundos de gravação
        }
    </script>
</body>
</html>
