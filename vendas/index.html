<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V2.3 - Expedi√ß√£o & Etiquetas (Clean)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Estilo Geral (Desktop Compacto) --- */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1400px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .compact-input { padding: 0.3rem; font-size: 0.9rem; }
        
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Utilit√°rios Extras */
        .card-collapsed { max-height: 50px; overflow: hidden; }
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .rotate-180 { transform: rotate(180deg); }
        .bg-pattern { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }

        /* --- Drag and Drop Visual --- */
        .draggable-card { cursor: grab; }
        .draggable-card:active { cursor: grabbing; }
        .dragging { 
            opacity: 0.5; 
            border: 2px dashed #4f46e5 !important; /* Indigo border */
            background-color: #eef2ff !important;
        }

        /* --- Estilo de Impress√£o (Etiqueta 73mm x 150mm) --- */
        @media print {
            @page { 
                size: 73mm 150mm; /* Tamanho exato da etiqueta */
                margin: 0; 
            }
            body * { visibility: hidden; }
            #areaImpressao, #areaImpressao * { visibility: visible; }
            #areaImpressao {
                position: absolute;
                left: 0;
                top: 0;
                width: 71mm; /* Ligeira margem de seguran√ßa */
                /* height: 148mm; Removido altura fixa para fluir se necess√°rio, mas o page-break controla */
                background: white;
                color: black;
                font-family: 'Arial Black', 'Arial', sans-serif;
                display: block !important;
                overflow: visible;
            }
            
            /* Classes de Etiqueta */
            .label-container {
                width: 100%;
                height: 148mm; /* For√ßa altura da etiqueta */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                padding: 2mm;
                border: 1px dashed #ccc; /* Guia de corte visual, opcional */
                page-break-after: always; /* OBRIGAT√ìRIO: Pula para pr√≥xima etiqueta */
                box-sizing: border-box;
            }

            .label-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 5px; }
            .label-date { font-size: 12px; font-weight: normal; }
            
            .label-client-name { font-size: 24px; font-weight: 900; line-height: 1; text-transform: uppercase; margin-bottom: 2px; }
            .label-client-phone { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
            .label-client-address { font-size: 11px; line-height: 1.1; margin-bottom: 5px; text-transform: uppercase; }
            
            /* C√≥digo Cliente Unificado */
            .label-client-code-box { 
                background: black; 
                color: white; 
                padding: 4px; 
                font-size: 16px; 
                font-weight: bold; 
                text-align: center; 
                border-radius: 4px;
                margin: 5px 0;
            }
            
            .label-rota { font-size: 40px; font-weight: 900; text-align: center; border: 3px solid black; padding: 5px; margin: 5px 0; text-transform: uppercase; }
            
            .label-order-code { font-size: 22px; text-align: center; margin: 5px 0; font-family: 'Courier New', monospace; font-weight: 900; letter-spacing: 2px;}
            
            .label-basket { font-size: 20px; font-weight: bold; text-transform: uppercase; border-top: 2px solid black; padding-top: 5px; text-align: center; }
            
            .label-footer { text-align: center; font-size: 10px; margin-top: auto; }
            .volume-counter { font-size: 18px; font-weight: 900; text-align: right; margin-top: 5px; }

            .no-print { display: none !important; }
        }
        #areaImpressao { display: none; }
    </style>
</head>
<body class="text-gray-800 bg-pattern">

    <div class="app-container p-4 no-print">
        
        <!-- Cabe√ßalho -->
        <header class="bg-white shadow-sm rounded-lg p-3 mb-3 flex justify-between items-center border border-gray-200">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 text-white p-2 rounded">
                    <i class="fa-solid fa-tags"></i>
                </div>
                <h1 class="font-bold text-lg text-gray-700">M√≥dulo 2: Expedi√ß√£o & Etiquetas</h1>
            </div>
            
            <!-- Links -->
            <nav class="flex gap-2">
                <button onclick="window.location.href='https://donaantonia.com.br/cadastro'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded text-sm font-medium transition">
                    1. Cadastro
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/vendas'" class="bg-indigo-600 text-white px-4 py-1 rounded text-sm font-medium shadow-sm">
                    2. Vendas
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/crm'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded text-sm font-medium transition">
                    3. CRM
                </button>
            </nav>

            <div class="flex gap-2">
                <div class="flex items-center gap-2 bg-gray-50 px-2 rounded border border-gray-200">
                    <span class="text-xs font-bold text-gray-500">FILTRAR DATA:</span>
                    <input type="date" id="filtroData" class="bg-transparent text-sm border-none focus:ring-0 py-1" onchange="renderizarListaPedidos()">
                </div>
                <button onclick="exportarPedidosJson()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 shadow-sm" title="Exportar na Ordem da Tela">
                    <i class="fa-solid fa-file-export mr-1"></i> JSON
                </button>
            </div>
        </header>

        <!-- Layout Principal -->
        <div class="flex flex-1 gap-4 overflow-hidden">
            
            <!-- COLUNA ESQUERDA: Criador de Pedidos -->
            <div class="w-5/12 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h2 class="font-bold text-indigo-800 text-sm uppercase"><i class="fa-solid fa-plus-circle mr-2"></i>Novo Pedido</h2>
                    <button onclick="limparPedidoAtual()" class="text-xs text-red-500 hover:underline">Limpar Tela</button>
                </div>

                <div class="p-4 overflow-y-auto flex-1 custom-scroll">
                    
                    <!-- 1. Sele√ß√£o de Cliente -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-1">1. Selecionar Cliente</label>
                        <input type="text" id="inputBuscaCliente" onkeyup="filtrarClientes()" placeholder="üîé Digite nome ou bairro..." class="w-full border border-indigo-200 bg-indigo-50 rounded px-2 py-1.5 mb-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 placeholder-gray-400">
                        <div class="flex gap-2">
                            <select id="selCliente" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-indigo-500 bg-white">
                                <option value="">Carregando clientes...</option>
                            </select>
                            <button onclick="carregarClientes()" class="bg-gray-200 px-3 rounded hover:bg-gray-300" title="Atualizar lista"><i class="fa-solid fa-sync text-xs"></i></button>
                        </div>
                    </div>
                    
                    <hr class="border-dashed border-gray-200 my-3">

                    <!-- 2. Adicionar Itens (Cestas) -->
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-2">2. Adicionar Produto ao Pedido</label>
                        
                        <!-- Tabs de Modo de Entrada -->
                        <div class="flex border-b border-gray-300 mb-3 text-xs">
                            <button class="flex-1 py-1 font-bold text-indigo-700 border-b-2 border-indigo-600" id="tabPadrao" onclick="alternarTab('padrao')">Cesta Padr√£o</button>
                            <button class="flex-1 py-1 font-bold text-gray-500 hover:text-indigo-600" id="tabImportar" onclick="alternarTab('importar')">Importar (Colar)</button>
                        </div>

                        <!-- MODO PADR√ÉO -->
                        <div id="areaModoPadrao">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="selTipoCesta" onchange="atualizarOpcoesPreco()" class="col-span-1 border border-gray-300 rounded compact-input">
                                    <option value="economica">Cesta Econ√¥mica</option>
                                    <option value="mini">Cesta Mini</option>
                                    <option value="pequena">Cesta Pequena</option>
                                    <option value="media">Cesta M√©dia</option>
                                    <option value="grande">Cesta Grande</option>
                                </select>
                                <select id="selMarcaPreco" class="col-span-1 border border-gray-300 rounded compact-input">
                                    <!-- Preenchido via JS -->
                                </select>
                            </div>

                            <!-- Modo: Normal vs Alterada -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center text-sm cursor-pointer">
                                        <input type="radio" name="modoCesta" value="normal" checked onchange="toggleModoCesta()" class="mr-1 text-indigo-600"> Normal
                                    </label>
                                    <label class="flex items-center text-sm cursor-pointer">
                                        <input type="radio" name="modoCesta" value="alterada" onchange="toggleModoCesta()" class="mr-1 text-indigo-600"> Alterada
                                    </label>
                                </div>
                                
                                <div id="divCodigoCesta" class="hidden">
                                    <input type="number" id="inputCodigoCesta" placeholder="C√≥d. Identifica√ß√£o" class="border border-yellow-400 bg-yellow-50 rounded px-2 py-1 text-xs w-32 focus:ring-2 focus:ring-yellow-400 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- MODO IMPORTAR -->
                        <div id="areaModoImportar" class="hidden mb-3">
                            <label class="block text-[10px] text-gray-500 mb-1">Cole a lista abaixo (Formato: C√ìDIGO - QUANTIDADE)</label>
                            <textarea id="txtImportar" rows="4" class="w-full border border-gray-300 rounded text-xs p-2 font-mono bg-white" placeholder="001 - 3&#10;030 - 1&#10;043 - 2"></textarea>
                            <button onclick="processarImportacao()" class="mt-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs px-2 py-1 rounded border border-gray-300 w-full font-bold">
                                <i class="fa-solid fa-bolt mr-1"></i> Carregar Lista Edit√°vel
                            </button>
                        </div>

                        <!-- √Årea de Itens (Aparece se Alterada ou Importada) -->
                        <div id="areaItensCesta" class="hidden bg-white border border-gray-300 rounded p-2 mb-2 max-h-40 overflow-y-auto text-xs">
                            <!-- Lista de inputs gerada via JS -->
                        </div>

                        <button onclick="adicionarItemAoCarrinho()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-sm font-bold shadow-sm">
                            <i class="fa-solid fa-cart-plus mr-1"></i> Adicionar Cesta
                        </button>
                    </div>

                    <!-- 3. Carrinho -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-1">Itens no Pedido</label>
                        <div class="border border-gray-200 rounded bg-white min-h-[80px]">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-gray-100 text-gray-500">
                                    <tr>
                                        <th class="p-2">Item</th>
                                        <th class="p-2 text-right">Valor</th>
                                        <th class="p-2 text-center">X</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaCarrinho"></tbody>
                            </table>
                            <div id="carrinhoVazio" class="text-center text-gray-400 py-4 text-xs italic">Nenhuma cesta adicionada.</div>
                        </div>
                        <div class="text-right mt-1 font-bold text-indigo-700 text-sm">
                            Subtotal: R$ <span id="lblSubtotal">0,00</span>
                        </div>
                    </div>

                    <hr class="border-gray-300 my-3">

                    <!-- 4. Fechamento -->
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Pagamento</label>
                            <select id="pagMetodo" class="w-full border border-gray-300 rounded compact-input">
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">Pix</option>
                                <option value="cartao">Cart√£o</option>
                                <option value="fiado">Fiado/Cr√©dito</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Status Pagto</label>
                            <select id="pagStatus" class="w-full border border-gray-300 rounded compact-input bg-yellow-50 text-yellow-800 font-medium">
                                <option value="pendente">A Receber</option>
                                <option value="pago">Pago</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Desconto Manual</label>
                            <select id="desconto" onchange="calcularTotalFinal()" class="w-full border border-gray-300 rounded compact-input">
                                <option value="0">Sem desconto</option>
                                <option value="5">- R$ 5,00</option>
                                <option value="10">- R$ 10,00</option>
                                <option value="15">- R$ 15,00</option>
                                <option value="20">- R$ 20,00</option>
                                <option value="25">- R$ 25,00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Brinde</label>
                            <select id="brinde" class="w-full border border-gray-300 rounded compact-input text-green-700 font-medium">
                                <option value="Nenhum">Nenhum</option>
                                <option value="Amaciante">Amaciante</option>
                                <option value="Cafe">Caf√©</option>
                                <option value="Sabao Po">Sab√£o em P√≥</option>
                                <option value="Ovo">Ovo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Rota</label>
                            <select id="rota" class="w-full border border-gray-300 rounded compact-input font-bold">
                                <option value="Coxip√≥">Coxip√≥</option>
                                <option value="VG">V√°rzea Grande</option>
                                <option value="Cuiab√°">Cuiab√°</option>
                                <option value="CPA">CPA</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Observa√ß√£o</label>
                            <input type="text" id="obs" class="w-full border border-gray-300 rounded compact-input" placeholder="Ex: Entregar ap√≥s as 14h...">
                        </div>
                    </div>

                    <div class="bg-gray-100 p-2 rounded text-right mb-3 border border-gray-200">
                        <span class="text-xs text-gray-500 mr-2">TOTAL FINAL:</span>
                        <span class="text-xl font-bold text-gray-800">R$ <span id="lblTotalFinal">0,00</span></span>
                    </div>

                    <button onclick="finalizarPedido()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg transition text-lg flex justify-center items-center">
                        <i class="fa-solid fa-check-circle mr-2"></i> Finalizar Pedido
                    </button>

                </div>
            </div>

            <!-- COLUNA DIREITA: Lista de Pedidos -->
            <div class="w-7/12 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold text-gray-700 text-sm uppercase"><i class="fa-solid fa-list-check mr-2"></i>Organiza√ß√£o de Rota</h2>
                        <div id="resumoRotas" class="text-xs flex gap-2"></div>
                    </div>
                    
                    <!-- Filtros de Rota -->
                    <div class="flex gap-2 items-center">
                        <div class="flex bg-gray-100 rounded p-1 gap-1">
                            <button onclick="filtrarRota('todos')" id="btnRotaTodos" class="btn-rota bg-white shadow text-gray-800 text-xs px-2 py-1 rounded font-medium">Todos</button>
                            <button onclick="filtrarRota('Coxip√≥')" id="btnRotaCoxipo" class="btn-rota text-gray-500 hover:bg-white text-xs px-2 py-1 rounded">Coxip√≥</button>
                            <button onclick="filtrarRota('VG')" id="btnRotaVG" class="btn-rota text-gray-500 hover:bg-white text-xs px-2 py-1 rounded">VG</button>
                            <button onclick="filtrarRota('Cuiab√°')" id="btnRotaCuiaba" class="btn-rota text-gray-500 hover:bg-white text-xs px-2 py-1 rounded">Cuiab√°</button>
                            <button onclick="filtrarRota('CPA')" id="btnRotaCPA" class="btn-rota text-gray-500 hover:bg-white text-xs px-2 py-1 rounded">CPA</button>
                        </div>
                        <button onclick="enviarListaRotaWhatsapp()" class="ml-auto bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 font-bold shadow-sm">
                            <i class="fa-brands fa-whatsapp"></i> Rota no Zap
                        </button>
                    </div>
                </div>

                <!-- LISTA DE PEDIDOS COM DRAG AND DROP -->
                <div class="flex-1 overflow-auto bg-gray-100 p-2 custom-scroll">
                    <div id="listaPedidos" class="space-y-2 pb-10">
                        <!-- Cards de Pedidos Compactos -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √ÅREA DE IMPRESS√ÉO -->
    <div id="areaImpressao"></div>

    <script>
        // --- DADOS E CONFIGURA√á√ïES ---
        const ENTREGADORES = {
            'osvaldo': { nome: 'Osvaldo', num: '556598150975' }, 
            'andre': { nome: 'Andr√©', num: '5565993367403' },
            'claudio': { nome: 'Claudio', num: '5565996884599' },
            'Jose': { nome: 'Jose', num: '5565981756150' }
        };

        // --- CAT√ÅLOGO DE PRODUTOS UNIFICADO (MASTER DATA) ---
        const CATALOGO_PRODUTOS = {
            // === ALIMENTOS ===
            '001': { nome: 'Arroz de 5kg', ean: '7891234560010' },
            '002': { nome: 'A√ß√∫car Cristal de 2kg', ean: '7891234560027' },
            '003': { nome: '√ìleo de Soja de 900ml', ean: '7891234560034' },
            '004': { nome: 'Feij√£o 1kg', ean: '7891234560041' },
            '005': { nome: 'Caf√© 250g', ean: '7891234560058' },
            '005b': { nome: 'Caf√© 500g', ean: '7891234560553' }, 
            '006': { nome: 'Espaguete de 400g/500g', ean: '7891234560065' },
            '007': { nome: 'Trigo de 1kg', ean: '7891234560072' },
            '008': { nome: 'Farinha de Mandioca 1kg', ean: '7891234560089' },
            '009': { nome: 'Sal de 1kg', ean: '7891234560096' },
            '010': { nome: 'Molho Tomate Sach√™', ean: '7891234560102' },
            '011': { nome: 'Milho Lata/Sach√™', ean: '7891234560119' },
            '012': { nome: 'Bolacha Recheada', ean: '7891234560126' },
            '013': { nome: 'Miojo', ean: '7891234560133' },
            '014': { nome: 'Suco em P√≥', ean: '7891234560140' },
            '015': { nome: '12 Ovos', ean: '7891234560157' },
            '016': { nome: 'Mistura para Bolo 400g', ean: '7891234560164' },
            '017': { nome: 'Tempero Pronto', ean: '7891234560171' },
            
            // === LIMPEZA E HIGIENE ===
            '030': { nome: 'Sab√£o Barra (pct)', ean: '7891234560300' },
            '031': { nome: 'Creme Dental 70g', ean: '7891234560317' },
            '032': { nome: 'Papel Higi√™nico (4un)', ean: '7891234560324' },
            '033': { nome: 'Amaciante 2 Litros', ean: '7891234560331' },
            '034': { nome: 'Desinfetante 2 Litros', ean: '7891234560348' },
            '035': { nome: 'Sab√£o em P√≥ 800g', ean: '7891234560355' },
            '036': { nome: 'Detergente 500ml', ean: '7891234560362' },
            '037': { nome: 'Qboa 1 Litro', ean: '7891234560379' },
            '038': { nome: 'Sabonete 90g', ean: '7891234560386' },
            '039': { nome: 'Esponja de A√ßo', ean: '7891234560393' },
            '040': { nome: 'Esponja de Lou√ßa', ean: '7891234560409' }
        };

        const DADOS_CESTAS = {
            'economica': {
                titulo: 'Cesta Econ√¥mica',
                // Formato: [QTD, CODIGO]
                itensCod: [
                    [1, '001'], [1, '002'], [1, '003'], [1, '004'], [1, '005'], 
                    [1, '006'], [1, '007'], [1, '008'], [1, '009'], [1, '010'], 
                    [1, '011'], [1, '012'], [1, '013'], [1, '014']
                ]
            },
            'mini': {
                titulo: 'Cesta Mini',
                itensCod: [
                    [1, '001'], [1, '002'], [2, '003'], [2, '004'], [1, '005'],
                    [1, '006'], [1, '009'], [1, '010'], [1, '011'], [1, '012'],
                    [1, '013'], [2, '014'],
                    // Limpeza
                    [1, '030'], [1, '031'], [1, '032'], [1, '033'], [1, '034'],
                    [1, '035'], [1, '036'], [1, '037'], [2, '038'], [1, '039'], [1, '040']
                ]
            },
            'pequena': {
                titulo: 'Cesta Pequena',
                itensCod: [
                    [2, '001'], [1, '002'], [2, '003'], [2, '004'], [1, '005'],
                    [1, '015'], [1, '016'], [1, '006'], [1, '007'], [1, '009'],
                    [1, '010'], [1, '011'], [1, '017'], [2, '012'], [2, '013'], [2, '014'],
                    // Limpeza
                    [1, '030'], [1, '031'], [1, '032'], [1, '033'], [1, '034'],
                    [1, '035'], [2, '036'], [1, '037'], [2, '038'], [1, '039'], [1, '040']
                ]
            },
            'media': {
                titulo: 'Cesta M√©dia',
                itensCod: [
                    [3, '001'], [2, '002'], [3, '003'], [3, '004'], [1, '005b'],
                    [1, '015'], [1, '016'], [2, '006'], [1, '007'], [1, '009'],
                    [2, '010'], [1, '011'], [1, '017'], [2, '012'], [2, '013'], [3, '014'],
                    // Limpeza
                    [1, '030'], [2, '031'], [2, '032'], [1, '033'], [1, '034'],
                    [1, '035'], [2, '036'], [1, '037'], [3, '038'], [1, '039'], [1, '040']
                ]
            },
            'grande': {
                titulo: 'Cesta Grande',
                itensCod: [
                    [4, '001'], [3, '002'], [4, '003'], [4, '004'], [1, '005b'],
                    [3, '006'], [1, '015'], [1, '016'], [1, '007'], [1, '009'],
                    [2, '010'], [1, '011'], [1, '017'], [2, '012'], [2, '013'], [4, '014'],
                    // Limpeza
                    [1, '030'], [2, '031'], [2, '032'], [1, '033'], [1, '034'],
                    [1, '035'], [2, '036'], [1, '037'], [4, '038'], [1, '039'], [1, '040']
                ]
            }
        };

        const PRECOS = {
            'economica': { 'padrao': 85 },
            'mini': { 'alvino': 165, 'koblenz': 170 },
            'pequena': { 'alvino': 215, 'koblenz': 220 },
            'media': { 'alvino': 320, 'koblenz': 325 },
            'grande': { 'alvino': 380, 'koblenz': 390 }
        };

        // --- ESTADO GLOBAL ---
        let carrinho = []; 
        let pedidos = []; 
        let listaClientesCache = []; 

        let filtroRotaAtual = 'todos'; 
        let dragSrcEl = null; 
        
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            carregarClientes();
            carregarPedidosLocais();
            atualizarOpcoesPreco();
            
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        };

        // --- FUN√á√ïES DE NAVEGA√á√ÉO / DADOS ---
        function carregarClientes() {
            const clientesRaw = localStorage.getItem(KEY_CLIENTES);
            if (clientesRaw) {
                listaClientesCache = JSON.parse(clientesRaw);
                listaClientesCache.sort((a, b) => a.nome.localeCompare(b.nome));
            } else {
                listaClientesCache = [];
            }
            renderizarOpcoesClientes(listaClientesCache);
        }

        function renderizarOpcoesClientes(lista) {
            const select = document.getElementById('selCliente');
            const valorAtual = select.value; 
            select.innerHTML = '<option value="">-- Selecione o Cliente --</option>';

            if (lista.length === 0) {
                if (listaClientesCache.length === 0) {
                    select.innerHTML = '<option value="">Nenhum cliente cadastrado</option>';
                } else {
                    select.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
                }
                return;
            }

            lista.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                const label = `${c.nome} ${c.apelido ? '('+c.apelido+')' : ''} - ${c.bairro || 'S/ Bairro'}`;
                option.innerText = label;
                option.dataset.json = JSON.stringify(c); 
                select.appendChild(option);
            });

            if (valorAtual) select.value = valorAtual;
        }

        function filtrarClientes() {
            const termo = document.getElementById('inputBuscaCliente').value.toLowerCase();
            const filtrados = listaClientesCache.filter(c => {
                const nome = c.nome.toLowerCase();
                const apelido = (c.apelido || '').toLowerCase();
                const bairro = (c.bairro || '').toLowerCase();
                return nome.includes(termo) || apelido.includes(termo) || bairro.includes(termo);
            });
            renderizarOpcoesClientes(filtrados);
        }

        // --- L√ìGICA DE INTERFACE DE TABS ---
        function alternarTab(tab) {
            const btnPadrao = document.getElementById('tabPadrao');
            const btnImportar = document.getElementById('tabImportar');
            const areaPadrao = document.getElementById('areaModoPadrao');
            const areaImportar = document.getElementById('areaModoImportar');
            const areaItens = document.getElementById('areaItensCesta');

            if(tab === 'padrao') {
                btnPadrao.className = "flex-1 py-1 font-bold text-indigo-700 border-b-2 border-indigo-600";
                btnImportar.className = "flex-1 py-1 font-bold text-gray-500 hover:text-indigo-600";
                areaPadrao.classList.remove('hidden');
                areaImportar.classList.add('hidden');
                
                // Reset para modo normal
                document.querySelector('input[name="modoCesta"][value="normal"]').checked = true;
                toggleModoCesta();
            } else {
                btnImportar.className = "flex-1 py-1 font-bold text-indigo-700 border-b-2 border-indigo-600";
                btnPadrao.className = "flex-1 py-1 font-bold text-gray-500 hover:text-indigo-600";
                areaImportar.classList.remove('hidden');
                areaPadrao.classList.add('hidden');
                
                // Prepara para exibir lista editavel
                areaItens.classList.remove('hidden');
                areaItens.innerHTML = '<div class="text-center text-gray-400 p-2">Cole os c√≥digos e clique em carregar.</div>';
                
                // For√ßa visualmente modo "Alterada"
                document.querySelector('input[name="modoCesta"][value="alterada"]').checked = true;
                // Exibe campo c√≥digo
                document.getElementById('divCodigoCesta').classList.remove('hidden');
            }
        }

        function processarImportacao() {
            const texto = document.getElementById('txtImportar').value;
            if(!texto.trim()) return alert("Cole a lista primeiro!");

            const linhas = texto.split('\n');
            const listaParaRenderizar = [];

            linhas.forEach(linha => {
                if(!linha.trim()) return;
                // Tenta dividir por "-" ou espa√ßo
                let parts = linha.includes('-') ? linha.split('-') : linha.split(' ');
                
                // Limpeza b√°sica
                parts = parts.map(p => p.trim()).filter(p => p !== "");
                
                if(parts.length >= 2) {
                    const codigo = parts[0];
                    const qtd = parseInt(parts[1]);
                    
                    if(CATALOGO_PRODUTOS[codigo]) {
                        // Adiciona no formato que o gerador de lista entende: [qtd, codigo]
                        listaParaRenderizar.push([qtd, codigo]);
                    }
                }
            });

            if(listaParaRenderizar.length === 0) return alert("Nenhum c√≥digo v√°lido encontrado (Formato: 001 - 3)");

            renderizarListaEditavelGenerica(listaParaRenderizar);
        }

        // --- L√ìGICA DE PRODUTOS/PRE√áOS ---
        function atualizarOpcoesPreco() {
            const tipo = document.getElementById('selTipoCesta').value;
            const selectMarca = document.getElementById('selMarcaPreco');
            selectMarca.innerHTML = '';

            const opcoes = PRECOS[tipo];
            
            if (tipo === 'economica') {
                const opt = new Option(`Padr√£o - R$ ${opcoes.padrao},00`, opcoes.padrao);
                selectMarca.add(opt);
            } else {
                const opt1 = new Option(`Arroz Tio Alvino - R$ ${opcoes.alvino},00`, opcoes.alvino);
                opt1.setAttribute('data-marca', 'Tio Alvino');
                selectMarca.add(opt1);

                const opt2 = new Option(`Arroz Koblenz - R$ ${opcoes.koblenz},00`, opcoes.koblenz);
                opt2.setAttribute('data-marca', 'Koblenz');
                selectMarca.add(opt2);
            }
            // Se estiver no modo alterada, atualiza a lista
            if(document.querySelector('input[name="modoCesta"]:checked').value === 'alterada') {
                const listaOriginal = DADOS_CESTAS[tipo].itensCod;
                renderizarListaEditavelGenerica(listaOriginal);
            }
        }

        function toggleModoCesta() {
            const modo = document.querySelector('input[name="modoCesta"]:checked').value;
            const area = document.getElementById('areaItensCesta');
            const divCodigo = document.getElementById('divCodigoCesta');
            const inputCodigo = document.getElementById('inputCodigoCesta');
            
            if (modo === 'alterada') {
                const tipo = document.getElementById('selTipoCesta').value;
                const listaOriginal = DADOS_CESTAS[tipo].itensCod;
                renderizarListaEditavelGenerica(listaOriginal);

                area.classList.remove('hidden');
                divCodigo.classList.remove('hidden');
                inputCodigo.focus();
            } else {
                area.classList.add('hidden');
                divCodigo.classList.add('hidden');
                inputCodigo.value = ''; 
            }
        }

        function renderizarListaEditavelGenerica(listaItensCod) {
            const area = document.getElementById('areaItensCesta');
            area.innerHTML = '';

            // 1. Gera Itens da Lista
            listaItensCod.forEach((item) => {
                const qtd = item[0];
                const cod = item[1];
                // Busca no Objeto de Produtos
                const produto = CATALOGO_PRODUTOS[cod];
                const nome = produto ? produto.nome : 'Item Desconhecido';

                const row = document.createElement('div');
                row.className = "flex items-center gap-2 mb-1";
                row.innerHTML = `
                    <input type="number" min="0" value="${qtd}" class="w-12 border border-gray-300 rounded text-center px-1 item-qtd text-gray-700 font-bold">
                    <div class="flex-1 flex items-center gap-1">
                        <span class="text-[10px] bg-gray-200 text-gray-600 px-1 rounded font-mono">${cod}</span>
                        <input type="text" value="${nome}" class="flex-1 border border-gray-300 rounded px-1 item-desc text-xs" readonly>
                    </div>
                `;
                area.appendChild(row);
            });

            // 2. Cria Datalist para autocomplete (Apenas 1x √© suficiente, mas vamos recriar para garantir update)
            // Para performance, verificamos se j√° existe
            let dataList = document.getElementById('listProdutosCatalogo');
            if(!dataList) {
                dataList = document.createElement('datalist');
                dataList.id = 'listProdutosCatalogo';
                // Popula com cat√°logo
                Object.keys(CATALOGO_PRODUTOS).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = `${key} - ${CATALOGO_PRODUTOS[key].nome}`;
                    dataList.appendChild(opt);
                });
                document.body.appendChild(dataList); // Anexa ao body para ser acess√≠vel globalmente
            }

            // --- Divisor para √°rea de extras ---
            const divDivisor = document.createElement('div');
            divDivisor.id = "divisorExtras";
            divDivisor.className = "border-t border-dashed border-gray-300 my-2 pt-1";
            area.appendChild(divDivisor);

            // --- √Årea de Input Manual (BUSCA POR C√ìDIGO) ---
            const labelManual = document.createElement('div');
            labelManual.className = "text-[10px] font-bold text-blue-600 mb-1";
            labelManual.innerText = "Adicionar Produto Extra (Buscar no Cat√°logo):";
            area.appendChild(labelManual);

            const rowManual = document.createElement('div');
            rowManual.className = "flex items-center gap-2 mb-1";
            
            // Input modificado com DATALIST e Placeholder de C√ìDIGO
            rowManual.innerHTML = `
                <input type="number" id="qtdExtraInput" min="1" value="1" class="w-12 border border-blue-300 bg-blue-50 rounded text-center px-1 font-bold text-blue-800">
                <input type="text" id="codExtraInput" list="listProdutosCatalogo" placeholder="C√≥d. Produto (ex: 001)..." class="flex-1 border border-blue-300 bg-blue-50 rounded px-1 text-blue-800 placeholder-blue-300 text-xs">
                <button onclick="adicionarExtraVisualmente()" class="bg-blue-600 text-white w-7 h-7 rounded hover:bg-blue-700 flex items-center justify-center shadow-sm" title="Adicionar Item"><i class="fa-solid fa-plus text-xs"></i></button>
            `;
            area.appendChild(rowManual);
        }

        function adicionarExtraVisualmente() {
            const qtdInput = document.getElementById('qtdExtraInput');
            const codInput = document.getElementById('codExtraInput');
            const area = document.getElementById('areaItensCesta');
            const divisor = document.getElementById('divisorExtras');

            const qtd = parseInt(qtdInput.value);
            let rawValue = codInput.value.trim();

            if(!rawValue) {
                alert('Digite o c√≥digo do produto.');
                codInput.focus();
                return;
            }
            if(qtd <= 0) return alert('Quantidade deve ser maior que 0.');

            // Parser Inteligente: Aceita "001" ou "001 - Arroz" (vindo do datalist)
            let codigo = rawValue.split(' - ')[0].trim();

            // Valida√ß√£o no Master Data (Cat√°logo)
            const produto = CATALOGO_PRODUTOS[codigo];
            if(!produto) {
                alert(`Produto com c√≥digo "${codigo}" n√£o encontrado no cat√°logo!\nVerifique se o c√≥digo est√° correto.`);
                codInput.value = '';
                codInput.focus();
                return;
            }

            const row = document.createElement('div');
            row.className = "flex items-center gap-2 mb-1 row-extra animate-pulse"; 
            setTimeout(() => row.classList.remove('animate-pulse'), 500);

            // Renderiza usando os dados reais do cat√°logo (Nome correto)
            row.innerHTML = `
                <input type="number" min="0" value="${qtd}" class="w-12 border border-blue-200 rounded text-center px-1 item-qtd text-blue-800 font-bold bg-blue-50">
                <div class="flex-1 flex gap-1 items-center">
                     <span class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded font-mono">${codigo}</span>
                     <input type="text" value="${produto.nome}" class="flex-1 border border-blue-200 rounded px-1 item-desc text-blue-800 bg-blue-50 text-xs" readonly>
                     <button onclick="this.closest('.row-extra').remove()" class="text-red-400 hover:text-red-600 px-1" title="Remover"><i class="fa-solid fa-trash-can text-xs"></i></button>
                </div>
            `;
            area.insertBefore(row, divisor);

            qtdInput.value = 1;
            codInput.value = '';
            codInput.focus();
        }

        // --- CARRINHO ---
        function adicionarItemAoCarrinho() {
            const tipoKey = document.getElementById('selTipoCesta').value;
            const precoVal = parseFloat(document.getElementById('selMarcaPreco').value);
            const selMarca = document.getElementById('selMarcaPreco');
            const marcaNome = selMarca.options[selMarca.selectedIndex].getAttribute('data-marca') || 'Padr√£o';
            
            // Verifica qual modo est√° ativo (radio ou pela Tab de Importar que for√ßa o visual alterada)
            const isImportTab = !document.getElementById('areaModoImportar').classList.contains('hidden');
            const isRadioAlterada = document.querySelector('input[name="modoCesta"][value="alterada"]').checked;
            
            let modo = (isImportTab || isRadioAlterada) ? 'alterada' : 'normal';
            let itensFinais = [];
            let identificacao = null; 
            let nomeCestaDisplay = isImportTab ? 'Cesta Personalizada (Importada)' : DADOS_CESTAS[tipoKey].titulo;

            if (modo === 'normal') {
                // Modo Normal: Gera a string formatada a partir dos c√≥digos
                const listaCod = DADOS_CESTAS[tipoKey].itensCod;
                listaCod.forEach(item => {
                   const produto = CATALOGO_PRODUTOS[item[1]];
                   if(produto) {
                       // Guardamos o objeto completo (nome, ean, c√≥digo, qtd)
                       // Para exibi√ß√£o na tela e impress√£o
                       itensFinais.push({
                           cod: item[1],
                           qtd: item[0],
                           nome: produto.nome,
                           ean: produto.ean
                       });
                   }
                });
            } else {
                // Modo Alterada/Importada
                const codInput = document.getElementById('inputCodigoCesta').value;
                if(!codInput) {
                    alert('Por favor, informe o C√ìDIGO de identifica√ß√£o (N√∫mero do Pedido/Cesta).');
                    document.getElementById('inputCodigoCesta').focus();
                    return;
                }
                identificacao = codInput;

                const container = document.getElementById('areaItensCesta');
                
                Array.from(container.children).forEach(child => {
                    if (child.classList.contains('flex')) {
                        const qInput = child.querySelector('.item-qtd');
                        const dInput = child.querySelector('.item-desc');
                        
                        // Tenta pegar o c√≥digo se existir no span
                        const spanCod = child.querySelector('span.font-mono');
                        const codigo = spanCod ? spanCod.innerText : 'EXT';

                        const q = qInput ? qInput.value : 0;
                        const d = dInput ? dInput.value : '';
                        
                        // Busca o EAN se existir no cat√°logo
                        let ean = '';
                        if(CATALOGO_PRODUTOS[codigo]) ean = CATALOGO_PRODUTOS[codigo].ean;

                        if (q > 0 && d) {
                            itensFinais.push({
                                cod: codigo,
                                qtd: q,
                                nome: d, // Nome pode ter sido editado (raro, mas possivel se for extra)
                                ean: ean
                            });
                        }
                    }
                });
            }

            const itemCarrinho = {
                id: Date.now(),
                tipo: nomeCestaDisplay,
                marca: marcaNome,
                preco: precoVal,
                modo: modo,
                identificacao: identificacao, 
                conteudo: itensFinais // Agora √© um array de objetos, n√£o de strings
            };

            carrinho.push(itemCarrinho);
            renderizarCarrinho();

            // Limpa ap√≥s adicionar se for importa√ß√£o
            if(isImportTab) {
                document.getElementById('txtImportar').value = '';
                document.getElementById('areaItensCesta').innerHTML = '';
                document.getElementById('inputCodigoCesta').value = '';
            }
        }

        function removerDoCarrinho(id) {
            carrinho = carrinho.filter(i => i.id !== id);
            renderizarCarrinho();
        }

        function renderizarCarrinho() {
            const tbody = document.getElementById('tabelaCarrinho');
            const divVazio = document.getElementById('carrinhoVazio');
            tbody.innerHTML = '';
            
            let subtotal = 0;

            if (carrinho.length === 0) {
                divVazio.style.display = 'block';
            } else {
                divVazio.style.display = 'none';
                carrinho.forEach(item => {
                    subtotal += item.preco;
                    const tr = document.createElement('tr');
                    tr.className = "border-t border-gray-100";
                    
                    let labelModo = '';
                    if(item.modo === 'alterada') {
                        labelModo = `<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1">COD: ${item.identificacao}</span>`;
                    }
                    
                    tr.innerHTML = `
                        <td class="p-2">
                            <div class="font-bold text-xs">${item.tipo} ${labelModo}</div>
                            <div class="text-[10px] text-gray-500">${item.marca}</div>
                        </td>
                        <td class="p-2 text-right font-mono">R$ ${item.preco},00</td>
                        <td class="p-2 text-center">
                            <button onclick="removerDoCarrinho(${item.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('lblSubtotal').innerText = subtotal.toFixed(2).replace('.', ',');
            calcularTotalFinal(subtotal);
        }

        function calcularTotalFinal(subtotalOverride) {
            let sub = subtotalOverride;
            if (sub === undefined) {
                 const txt = document.getElementById('lblSubtotal').innerText.replace(',', '.');
                 sub = parseFloat(txt);
            }
            
            let desc = parseFloat(document.getElementById('desconto').value) || 0;
            const final = Math.max(0, sub - desc);
            document.getElementById('lblTotalFinal').innerText = final.toFixed(2).replace('.', ',');
        }

        // --- FINALIZA√á√ÉO ---
        function finalizarPedido() {
            const selCliente = document.getElementById('selCliente');
            if (!selCliente.value) return alert('Selecione um cliente!');
            if (carrinho.length === 0) return alert('Adicione pelo menos uma cesta!');

            const clienteDados = JSON.parse(selCliente.options[selCliente.selectedIndex].dataset.json);
            
            const subtotalText = document.getElementById('lblSubtotal').innerText.replace(',', '.');
            const totalText = document.getElementById('lblTotalFinal').innerText.replace(',', '.');
            const desc = parseFloat(document.getElementById('desconto').value);

            // GERA√á√ÉO DE C√ìDIGO DI√ÅRIO (DDMMSQ - SEM SEPARADOR)
            const now = new Date();
            const dia = String(now.getDate()).padStart(2, '0');
            const mes = String(now.getMonth() + 1).padStart(2, '0');
            const ano = now.getFullYear();
            
            // Filtra pedidos de hoje para achar a sequ√™ncia
            const dataHojeStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const countHoje = pedidos.filter(p => p.data.startsWith(dataHojeStr)).length + 1;
            const seq = String(countHoje).padStart(2, '0');
            
            // Formato: DDMMSQ (Ex: 020101)
            const codigoVisual = `${dia}${mes}${seq}`;

            const novoPedido = {
                id: Date.now().toString(), // ID √önico do Sistema (Timestamp)
                codigoVisual: codigoVisual, // C√≥digo para Etiqueta (DDMMSQ)
                data: new Date().toISOString(),
                ordem: Date.now(), 
                cliente: clienteDados, 
                rota: document.getElementById('rota').value,
                pagamento: {
                    metodo: document.getElementById('pagMetodo').value,
                    status: document.getElementById('pagStatus').value
                },
                financeiro: {
                    subtotal: parseFloat(subtotalText),
                    desconto: desc,
                    total: parseFloat(totalText)
                },
                brinde: document.getElementById('brinde').value,
                obs: document.getElementById('obs').value,
                itens: carrinho
            };

            pedidos.push(novoPedido);
            salvarPedidosLocais();
            
            alert(`Pedido salvo com sucesso!\nC√≥digo Gerado: ${codigoVisual}`);
            limparPedidoAtual();
            
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        }

        function salvarPedidosLocais() {
            localStorage.setItem(KEY_PEDIDOS, JSON.stringify(pedidos));
        }

        function carregarPedidosLocais() {
            const dados = localStorage.getItem(KEY_PEDIDOS);
            if (dados) pedidos = JSON.parse(dados);
        }

        function limparPedidoAtual() {
            carrinho = [];
            renderizarCarrinho();
            
            document.getElementById('selCliente').value = "";
            document.getElementById('inputBuscaCliente').value = ""; 
            carregarClientes(); 
            
            document.getElementById('obs').value = "";
            document.getElementById('pagStatus').value = "pendente";
            document.getElementById('desconto').value = "0";
            document.getElementById('brinde').value = "Nenhum";
            
            // Reseta tabs
            alternarTab('padrao');
            
            calcularTotalFinal(0);
        }

        // --- FUN√á√ÉO AUXILIAR: GERAR C√ìDIGO CLIENTE VISUAL ---
        function gerarCodigoClienteVisual(cliente, rotaPedido) {
            // 1. Cidade (CBA ou VG)
            let cid = 'CBA';
            const cidadeRaw = (cliente.cidade || '').toLowerCase();
            if (cidadeRaw.includes('varzea') || cidadeRaw.includes('v√°rzea') || cidadeRaw.includes('vg')) {
                cid = 'VG';
            }

            // 2. Rota (Remove espa√ßos e caracteres especiais se desejar, ou mant√©m como est√° se for simples)
            // O prompt diz "A ROTA" - vamos assumir o nome da rota do pedido limpo
            const rotaLimpa = rotaPedido.replace(/[^a-zA-Z0-9]/g, '');

            // 3. Telefone (4 √∫ltimos d√≠gitos)
            const telRaw = cliente.telefone || '';
            const telNumeros = telRaw.replace(/\D/g, '');
            const telFinal = telNumeros.length >= 4 ? telNumeros.slice(-4) : '0000';

            // Formato: CIDADE + ROTA + FINAL_TEL (Tudo junto)
            return `${cid}${rotaLimpa}${telFinal}`;
        }

        // --- VISUALIZA√á√ÉO E FILTROS ---
        
        function filtrarRota(rota) {
            filtroRotaAtual = rota;
            document.querySelectorAll('.btn-rota').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btn.classList.add('text-gray-500', 'hover:bg-white');
            });
            
            const idBtn = rota === 'Coxip√≥' ? 'btnRotaCoxipo' : 
                          rota === 'VG' ? 'btnRotaVG' : 
                          rota === 'Cuiab√°' ? 'btnRotaCuiaba' : 
                          rota === 'CPA' ? 'btnRotaCPA' : 'btnRotaTodos';
                          
            const btnAtivo = document.getElementById(idBtn);
            if(btnAtivo) {
                btnAtivo.classList.remove('text-gray-500', 'hover:bg-white');
                btnAtivo.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
            }

            renderizarListaPedidos();
        }

        function toggleDetalhes(id) {
            const div = document.getElementById(`detalhes_${id}`);
            const icon = document.getElementById(`icon_expand_${id}`);
            
            if(div.classList.contains('hidden')) {
                div.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                div.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        function getPedidosVisiveis() {
            const filtroData = document.getElementById('filtroData').value;
            let lista = pedidos.filter(p => p.data.startsWith(filtroData));
            if (filtroRotaAtual !== 'todos') lista = lista.filter(p => p.rota === filtroRotaAtual);
            lista.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
            return lista;
        }

        function moverPedido(id, direcao) {
            const listaAtual = getPedidosVisiveis();
            listaAtual.forEach((p, index) => { p.ordem = index * 10; });
            const indexAtual = listaAtual.findIndex(p => p.id === id);
            if (indexAtual === -1) return;
            const indexAlvo = indexAtual + direcao;

            if (indexAlvo >= 0 && indexAlvo < listaAtual.length) {
                const ordemTemp = listaAtual[indexAtual].ordem;
                listaAtual[indexAtual].ordem = listaAtual[indexAlvo].ordem;
                listaAtual[indexAlvo].ordem = ordemTemp;
                salvarPedidosLocais();
                renderizarListaPedidos();
            }
        }

        // --- DRAG AND DROP ---
        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDragEnter(e) { this.classList.add('border-indigo-500', 'bg-indigo-50'); }
        function handleDragLeave(e) { this.classList.remove('border-indigo-500', 'bg-indigo-50'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation(); 
            document.querySelectorAll('.draggable-card').forEach(col => col.classList.remove('dragging', 'border-indigo-500', 'bg-indigo-50'));
            const idOrigem = dragSrcEl.dataset.id;
            const idDestino = this.dataset.id;
            if (dragSrcEl !== this) {
                const listaAtual = getPedidosVisiveis();
                listaAtual.forEach((p, index) => { p.ordem = index * 10; });
                const idxOrigem = listaAtual.findIndex(p => p.id === idOrigem);
                const idxDestino = listaAtual.findIndex(p => p.id === idDestino);
                if (idxOrigem > -1 && idxDestino > -1) {
                    const [itemMovido] = listaAtual.splice(idxOrigem, 1);
                    listaAtual.splice(idxDestino, 0, itemMovido);
                    listaAtual.forEach((p, index) => { p.ordem = index * 10; });
                    salvarPedidosLocais();
                    renderizarListaPedidos();
                }
            }
            return false;
        }
        function handleDragEnd(e) { document.querySelectorAll('.draggable-card').forEach(col => col.classList.remove('dragging', 'border-indigo-500', 'bg-indigo-50')); }

        // --- RENDERIZA√á√ÉO ---
        function renderizarListaPedidos() {
            const container = document.getElementById('listaPedidos');
            const pedidosFiltrados = getPedidosVisiveis();

            // Resumo Rotas
            const resumo = {};
            pedidosFiltrados.forEach(p => { resumo[p.rota] = (resumo[p.rota] || 0) + 1; });
            const divResumo = document.getElementById('resumoRotas');
            divResumo.innerHTML = Object.entries(resumo).map(([rota, qtd]) => 
                `<span class="bg-blue-100 text-blue-800 px-1.5 rounded">${rota}: ${qtd}</span>`
            ).join('');
            
            container.innerHTML = '';
            if (pedidosFiltrados.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10">Nenhum pedido encontrado.</div>';
                return;
            }

            pedidosFiltrados.forEach((p, index) => {
                const card = document.createElement('div');
                const isPago = p.pagamento.status === 'pago';
                const borderClass = isPago ? 'border-green-500' : 'border-yellow-400';
                
                // Gera o C√≥digo do Cliente para exibi√ß√£o no card
                const codClienteVisual = gerarCodigoClienteVisual(p.cliente, p.rota);

                card.setAttribute('draggable', 'true');
                card.dataset.id = p.id;
                card.className = "draggable-card bg-white border-l-4 " + borderClass + " shadow-sm rounded-r mb-2 transition-all-300 flex";
                
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);

                const itemsSummary = p.itens.map(i => {
                    const alertIcon = i.modo === 'alterada' ? '<span class="text-red-500 font-bold ml-1">!</span>' : '';
                    return `${i.tipo}${alertIcon}`;
                }).join(', ');
                
                const opcoesEntregadores = Object.keys(ENTREGADORES).map(k => 
                    `<option value="${k}">${ENTREGADORES[k].nome}</option>`
                ).join('');

                const detalhesItens = p.itens.map(i => {
                    const resumo = i.conteudo.map(item => `${item.qtd}x ${item.nome}`).join(', ');
                    const isAlt = i.modo === 'alterada';
                    return `
                        <div class="flex justify-between border-b border-gray-100 py-0.5 last:border-0 text-[10px]">
                            <span class="truncate pr-2" title="${resumo}">${i.tipo} <small class="text-gray-500">(${i.marca})</small></span>
                            ${isAlt ? `<span class="bg-red-100 text-red-800 px-1 rounded border border-red-200">COD: ${i.identificacao}</span>` : ''}
                        </div>
                    `;
                }).join('');

                const localizacao = `${p.cliente.endereco || ''}, ${p.cliente.bairro || ''}`;
                const linkMap = p.cliente.maps ? p.cliente.maps : '';
                const linkFoto = p.cliente.foto ? p.cliente.foto : ''; 
                
                const btnMapHTML = linkMap ? 
                    `<button onclick="event.stopPropagation(); window.open('${linkMap}', '_blank')" class="ml-2 text-orange-500 hover:text-orange-600 transition" title="Abrir Mapa"><i class="fa-solid fa-map-location-dot"></i></button>` : 
                    `<button onclick="event.stopPropagation();" class="ml-2 text-gray-300 cursor-not-allowed" title="Sem Mapa"><i class="fa-solid fa-map-location-dot"></i></button>`;

                const btnFotoHTML = linkFoto ? 
                    `<button onclick="event.stopPropagation(); window.open('${linkFoto}', '_blank')" class="ml-1 text-purple-500 hover:text-purple-600 transition" title="Ver Foto"><i class="fa-solid fa-image"></i></button>` : 
                    `<button onclick="event.stopPropagation();" class="ml-1 text-gray-300 cursor-not-allowed" title="Sem Foto"><i class="fa-solid fa-image"></i></button>`;
                
                const botoesOrdem = pedidosFiltrados.length > 1 ? `
                    <div class="flex flex-col gap-1 mr-2 justify-center pl-1">
                        <button onclick="moverPedido('${p.id}', -1)" class="bg-gray-100 hover:bg-gray-200 text-gray-600 w-6 h-6 rounded flex items-center justify-center border border-gray-300 ${index === 0 ? 'opacity-30 cursor-not-allowed' : ''}" title="Subir">
                            <i class="fa-solid fa-caret-up"></i>
                        </button>
                        <div class="text-[8px] text-gray-400 text-center"><i class="fa-solid fa-grip-lines"></i></div>
                        <button onclick="moverPedido('${p.id}', 1)" class="bg-gray-100 hover:bg-gray-200 text-gray-600 w-6 h-6 rounded flex items-center justify-center border border-gray-300 ${index === pedidosFiltrados.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" title="Descer">
                            <i class="fa-solid fa-caret-down"></i>
                        </button>
                    </div>
                ` : '<div class="pl-2"></div>';

                // --- BOT√ÉO DE ETIQUETA ADICIONADO AQUI ---
                card.innerHTML = `
                    ${botoesOrdem}
                    <div class="flex-1">
                        <div class="flex items-center gap-2 p-2 cursor-pointer hover:bg-gray-50 transition" onclick="toggleDetalhes('${p.id}')">
                            <div class="min-w-[50px] text-center flex flex-col gap-1">
                                <span class="bg-indigo-600 text-white text-[10px] font-bold px-1 rounded shadow-sm">${index + 1}¬∫</span>
                                <span class="text-[9px] font-black uppercase bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200 block">${p.rota.substring(0,3).toUpperCase()}</span>
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <div class="font-bold text-gray-800 text-sm truncate leading-tight flex items-center gap-1">
                                    ${p.cliente.nome}
                                    <span class="text-[9px] bg-black text-white px-1 rounded ml-1 font-mono">${codClienteVisual}</span>
                                </div>
                                <div class="text-[10px] text-gray-500 truncate flex items-center">
                                    <span class="bg-gray-100 text-gray-600 px-1 rounded mr-1 font-mono font-bold">#${p.codigoVisual || '---'}</span>
                                    <i class="fa-solid fa-location-dot text-[9px] text-gray-400 mr-1"></i> ${localizacao}
                                    ${btnMapHTML} ${btnFotoHTML}
                                </div>
                            </div>
                            <div class="hidden sm:block w-1/3 px-2">
                                 <div class="text-[10px] text-gray-600 truncate bg-gray-50 border border-gray-100 rounded px-1 py-0.5">
                                    <i class="fa-solid fa-basket-shopping text-gray-400 mr-1"></i> ${itemsSummary}
                                 </div>
                            </div>
                            <div class="text-right flex flex-col items-end min-w-[70px]">
                                <span class="font-bold text-indigo-700 text-sm">R$ ${p.financeiro.total.toFixed(0)}</span>
                                <i id="icon_expand_${p.id}" class="fa-solid fa-chevron-down text-gray-400 text-xs transition-all-300"></i>
                            </div>
                        </div>

                        <div id="detalhes_${p.id}" class="hidden bg-gray-50 border-t border-gray-200 text-[11px] text-gray-700">
                            <div class="p-1.5">
                                <div class="bg-white p-1 rounded border border-gray-200 mb-1">${detalhesItens}</div>
                                <div class="grid grid-cols-4 gap-1 items-stretch">
                                    <div class="col-span-1 bg-white p-1 rounded border border-gray-200 flex flex-col justify-center">
                                        <div class="text-[9px] font-bold text-gray-400 uppercase leading-none mb-0.5">Obs</div>
                                        <div class="leading-tight truncate" title="${p.obs || ''}">${p.obs || '-'}</div>
                                    </div>
                                    <div class="col-span-1 bg-white p-1 rounded border border-gray-200 flex flex-col justify-center text-center">
                                        ${p.brinde !== 'Nenhum' ? `<div class="text-green-700 font-bold text-[10px] leading-none mb-0.5">üéÅ ${p.brinde}</div>` : ''}
                                        <div class="leading-tight font-medium">${p.pagamento.metodo.toUpperCase()}</div>
                                    </div>
                                    <div class="col-span-2 bg-white p-1 rounded border border-gray-200 flex items-center justify-between gap-1">
                                        <div class="flex items-center gap-1 flex-1">
                                            <select id="selEntregador_${p.id}" class="w-full text-[10px] border border-gray-300 rounded py-0.5 pl-1 bg-gray-50 focus:ring-0 h-6">
                                                ${opcoesEntregadores}
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button onclick="enviarPedidoZap('${p.id}')" class="bg-green-100 text-green-700 w-6 h-6 rounded flex items-center justify-center hover:bg-green-200" title="Zap"><i class="fa-brands fa-whatsapp"></i></button>
                                            
                                            <!-- Bot√£o de Impress√£o ETIQUETA -->
                                            <button onclick="imprimirEtiquetaPedido('${p.id}')" class="bg-gray-800 text-white w-6 h-6 rounded flex items-center justify-center hover:bg-gray-600 shadow-sm" title="Imprimir Etiquetas"><i class="fa-solid fa-tag"></i></button>
                                            
                                            <button onclick="excluirPedido('${p.id}')" class="bg-red-50 text-red-500 w-6 h-6 rounded flex items-center justify-center hover:bg-red-100" title="Del"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- EXPORTAR / WHATSAPP / IMPRESS√ÉO ---
        function excluirPedido(id) {
            if(confirm('Confirmar exclus√£o deste pedido?')) {
                pedidos = pedidos.filter(p => p.id !== id);
                salvarPedidosLocais();
                renderizarListaPedidos();
            }
        }

        function enviarPedidoZap(id) {
            const p = pedidos.find(item => item.id === id);
            const keyEntregador = document.getElementById(`selEntregador_${id}`).value;
            const entregador = ENTREGADORES[keyEntregador];
            if(!p || !entregador) return;

            // Gera c√≥digo para o zap tamb√©m
            const codCliente = gerarCodigoClienteVisual(p.cliente, p.rota);

            let msg = `*PEDIDO #${p.id.slice(-4)}*\n`;
            msg += `*C√≥d Pedido:* ${p.codigoVisual || 'N/A'}\n`;
            msg += `*C√≥d Cliente:* ${codCliente}\n`;
            msg += `*Cliente:* ${p.cliente.nome}\n`;
            if(p.cliente.apelido) msg += `*Apelido:* ${p.cliente.apelido}\n`;
            msg += `*Telefone:* ${p.cliente.telefone}\n`;
            msg += `*Cidade:* ${p.cliente.cidade || 'N√£o informada'}\n`;
            msg += `*Bairro:* ${p.cliente.bairro || ''}\n`;
            msg += `*Endere√ßo:* ${p.cliente.endereco}\n`;
            if(p.cliente.desc_casa) msg += `*Frente Casa:* ${p.cliente.desc_casa}\n`;
            msg += `*Link Maps:* ${p.cliente.maps || 'Sem link'}\n`;
            msg += `*Obs:* ${p.obs || '-'}\n\n`;
            msg += `*ITENS DO PEDIDO:* \n`;
            p.itens.forEach(i => {
                i.conteudo.forEach(item => {
                    msg += `- ${item.qtd}x ${item.nome}\n`;
                });
            });
            if(p.brinde !== 'Nenhum') msg += `\nüéÅ *Brinde:* ${p.brinde}\n`;
            msg += `\n*Pagamento:* ${p.pagamento.metodo.toUpperCase()}\n`;
            msg += `*Total:* R$ ${p.financeiro.total.toFixed(2)}`;

            const link = `https://wa.me/${entregador.num}?text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
        }

        function enviarListaRotaWhatsapp() {
            const filtroData = document.getElementById('filtroData').value;
            let lista = pedidos.filter(p => p.data.startsWith(filtroData));
            if (filtroRotaAtual !== 'todos') lista = lista.filter(p => p.rota === filtroRotaAtual);

            if (lista.length === 0) return alert('Nenhum pedido listado para enviar.');

            const resumoPorRota = {};
            lista.forEach(p => {
                const rota = p.rota;
                if (!resumoPorRota[rota]) resumoPorRota[rota] = {};
                p.itens.forEach(item => {
                    item.conteudo.forEach(subItem => {
                         // Agrupa por "C√≥digo + Nome"
                         const key = `[${subItem.cod}] ${subItem.nome}`;
                         if(!resumoPorRota[rota][key]) resumoPorRota[rota][key] = 0;
                         resumoPorRota[rota][key] += subItem.qtd;
                    });
                });
            });

            const dataFormatada = filtroData.split('-').reverse().join('/');
            let msg = `*RESUMO DE CARGA - ${dataFormatada}*\n`;
            Object.keys(resumoPorRota).sort().forEach(r => {
                msg += `\n*Rota: ${r}*\n`;
                Object.keys(resumoPorRota[r]).sort().forEach(itemKey => {
                    msg += `${resumoPorRota[r][itemKey]}x ${itemKey}\n`;
                });
                msg += `-----\n`;
            });

            const link = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
        }

        function exportarPedidosJson() {
            const filtroData = document.getElementById('filtroData').value;
            let lista = pedidos.filter(p => p.data.startsWith(filtroData));
            if (filtroRotaAtual !== 'todos') lista = lista.filter(p => p.rota === filtroRotaAtual);
            lista.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
            const dataStr = JSON.stringify(lista, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rota_pedidos_${filtroData}.json`;
            a.click();
        }

        // --- IMPRESS√ÉO DE ETIQUETAS (73mm x 150mm) ---
        function imprimirEtiquetaPedido(id) {
            const p = pedidos.find(item => item.id === id);
            if (!p) return;

            const area = document.getElementById('areaImpressao');
            const dataObj = new Date(p.data);
            const dataF = dataObj.toLocaleDateString('pt-BR');
            const horaF = dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            const primeiroNome = p.cliente.nome.split(' ')[0].toUpperCase();
            
            // GERA√á√ÉO DO C√ìDIGO DO CLIENTE (Fun√ß√£o Auxiliar)
            const idCliente = gerarCodigoClienteVisual(p.cliente, p.rota);
            
            const rota = p.rota.toUpperCase();
            const codVisual = p.codigoVisual || 'SEM COD';
            
            // Novos Dados
            const telefone = p.cliente.telefone || 'Sem Tel';
            const enderecoFull = `${p.cliente.endereco}, ${p.cliente.bairro || ''} - ${p.cliente.cidade || ''}`;

            let todasEtiquetasHtml = '';

            // Itera sobre cada ITEM do pedido (cada Cesta √© um item)
            p.itens.forEach(item => {
                const tipoLower = item.tipo.toLowerCase();
                let qtdEtiquetas = 1;

                // L√≥gica de Volumetria baseada no nome
                if (tipoLower.includes('mini') || tipoLower.includes('pequena')) {
                    qtdEtiquetas = 2;
                } else if (tipoLower.includes('grande') || tipoLower.includes('m√©dia') || tipoLower.includes('media')) {
                    qtdEtiquetas = 3;
                } else {
                    // Economica ou Personalizada padr√£o
                    qtdEtiquetas = 1; 
                }

                // Define o nome da Cesta para exibir
                let nomeCestaDisplay = item.tipo.toUpperCase();
                if(item.modo === 'alterada' && item.identificacao) {
                    nomeCestaDisplay = `COD: ${item.identificacao}`;
                }

                // Renderiza N etiquetas para este item
                for (let i = 1; i <= qtdEtiquetas; i++) {
                    
                    // SEM LISTA DE PRODUTOS
                    let conteudoCentral = `<div style="text-align:center; font-size:12px; margin-top:5px;">*** ${nomeCestaDisplay} ***</div>`;

                    todasEtiquetasHtml += `
                        <div class="label-container">
                            <div>
                                <div class="label-header">
                                    <span class="label-date">${dataF} ${horaF}</span>
                                </div>
                                
                                <div class="label-client-name">${primeiroNome}</div>
                                <div class="label-client-phone">${telefone}</div>
                                <div class="label-client-address">${enderecoFull}</div>
                                
                                <div class="label-client-code-box">${idCliente}</div>
                                
                                <div class="label-rota">${rota}</div>
                                
                                <div class="label-order-code">PED: ${codVisual}</div>
                            </div>

                            <div>
                                <div class="label-basket">${nomeCestaDisplay}</div>
                                ${conteudoCentral}
                            </div>

                            <div class="label-footer">
                                <div class="volume-counter">VOL: ${i}/${qtdEtiquetas}</div>
                                <div style="border-top: 1px solid black; padding-top:2px; margin-top:2px;">
                                    SISTEMA DONA ANTONIA
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            area.innerHTML = todasEtiquetasHtml;
            
            // Pequeno delay para garantir renderiza√ß√£o antes do print
            setTimeout(() => {
                window.print();
            }, 300);
        }
    </script>
</body>
</html>
