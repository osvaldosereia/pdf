<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V2.7 - Dashboard Log√≠stico (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Estilo Geral --- */
        body { background-color: #e5e7eb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1920px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        
        /* Inputs Super Compactos */
        .compact-input { padding: 0.2rem 0.4rem; font-size: 0.75rem; height: 28px; }
        .compact-label { font-size: 0.65rem; font-weight: 700; color: #4b5563; text-transform: uppercase; margin-bottom: 2px; }
        
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Utilit√°rios Extras */
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .bg-pattern { background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; }

        /* --- Drag and Drop Visual --- */
        .draggable-card { cursor: grab; user-select: none; }
        .draggable-card:active { cursor: grabbing; }
        .dragging { 
            opacity: 0.5; 
            border: 2px dashed #4f46e5 !important;
            background-color: #eef2ff !important;
        }

        /* --- Estilo de Impress√£o (Etiqueta 73mm x 150mm) --- */
        @media print {
            @page { size: 73mm 150mm; margin: 0; }
            body * { visibility: hidden; }
            #areaImpressao, #areaImpressao * { visibility: visible; }
            #areaImpressao {
                position: absolute; left: 0; top: 0; width: 71mm;
                background: white; color: black; font-family: 'Arial Black', 'Arial', sans-serif;
                display: block !important; overflow: visible;
            }
            .label-container {
                width: 100%; height: 148mm; display: flex; flex-direction: column;
                justify-content: space-between; padding: 2mm;
                border: 1px dashed #ccc; page-break-after: always; box-sizing: border-box;
            }
            .label-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 5px; }
            .label-date { font-size: 12px; font-weight: normal; }
            .label-client-name { font-size: 24px; font-weight: 900; line-height: 1; text-transform: uppercase; margin-bottom: 2px; }
            .label-client-phone { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
            .label-client-address { font-size: 11px; line-height: 1.1; margin-bottom: 5px; text-transform: uppercase; }
            .label-client-code-box { background: black; color: white; padding: 4px; font-size: 16px; font-weight: bold; text-align: center; border-radius: 4px; margin: 5px 0; }
            .label-rota { font-size: 40px; font-weight: 900; text-align: center; border: 3px solid black; padding: 5px; margin: 5px 0; text-transform: uppercase; }
            .label-order-code { font-size: 22px; text-align: center; margin: 5px 0; font-family: 'Courier New', monospace; font-weight: 900; letter-spacing: 2px;}
            .label-basket { font-size: 20px; font-weight: bold; text-transform: uppercase; border-top: 2px solid black; padding-top: 5px; text-align: center; }
            .label-footer { text-align: center; font-size: 10px; margin-top: auto; }
            .volume-counter { font-size: 18px; font-weight: 900; text-align: right; margin-top: 5px; }
            .no-print { display: none !important; }
        }
        #areaImpressao { display: none; }
    </style>
</head>
<body class="text-gray-800 bg-pattern text-sm">

    <div class="app-container p-2 no-print">
        
        <!-- Cabe√ßalho Compacto -->
        <header class="bg-white shadow-sm rounded p-2 mb-2 flex justify-between items-center border border-gray-300 h-12">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-1.5 rounded">
                    <i class="fa-solid fa-truck-fast text-sm"></i>
                </div>
                <h1 class="font-bold text-base text-gray-700">M√≥dulo 2: Expedi√ß√£o</h1>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="window.location.href='https://donaantonia.com.br/cadastro'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-bold transition">1. Cadastro</button>
                <button onclick="window.location.href='https://donaantonia.com.br/vendas'" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm">2. Vendas</button>
                <button onclick="window.location.href='https://donaantonia.com.br/crm'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-bold transition">3. CRM</button>
            </nav>

            <div class="flex gap-2 items-center">
                <span class="text-[10px] font-bold text-gray-500">DATA:</span>
                <input type="date" id="filtroData" class="bg-white border border-gray-300 rounded text-xs px-2 py-1 focus:ring-0" onchange="renderizarListaPedidos()">
                <button onclick="exportarPedidosJson()" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 shadow-sm" title="Backup">
                    <i class="fa-solid fa-download"></i>
                </button>
            </div>
        </header>

        <!-- Layout Principal: 3 Colunas -->
        <div class="flex flex-1 gap-2 overflow-hidden">
            
            <!-- COLUNA 1: Criador de Pedidos (Super Compacto - 25%) -->
            <div class="w-3/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col overflow-hidden">
                <div class="p-2 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h2 class="font-bold text-indigo-800 text-xs uppercase"><i class="fa-solid fa-plus mr-1"></i>Novo</h2>
                    <button onclick="limparPedidoAtual()" class="text-[10px] text-red-500 hover:underline">Limpar</button>
                </div>

                <div class="p-2 overflow-y-auto flex-1 custom-scroll">
                    
                    <!-- Cliente -->
                    <div class="mb-2">
                        <label class="compact-label">Cliente</label>
                        <input type="text" id="inputBuscaCliente" onkeyup="filtrarClientes()" placeholder="üîé Buscar..." class="w-full border border-indigo-200 bg-indigo-50 rounded compact-input mb-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        <div class="flex gap-1">
                            <select id="selCliente" class="w-full border border-gray-300 rounded compact-input focus:outline-none focus:border-indigo-500 bg-white">
                                <option value="">...</option>
                            </select>
                            <button onclick="carregarClientes()" class="bg-gray-200 px-2 rounded hover:bg-gray-300"><i class="fa-solid fa-sync text-[10px]"></i></button>
                        </div>
                    </div>
                    
                    <hr class="border-dashed border-gray-200 my-2">

                    <!-- Produtos -->
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 mb-2">
                        <div class="flex border-b border-gray-300 mb-2 text-[10px]">
                            <button class="flex-1 py-0.5 font-bold text-indigo-700 border-b-2 border-indigo-600" id="tabPadrao" onclick="alternarTab('padrao')">Padr√£o</button>
                            <button class="flex-1 py-0.5 font-bold text-gray-500 hover:text-indigo-600" id="tabImportar" onclick="alternarTab('importar')">Colar</button>
                        </div>

                        <!-- MODO PADR√ÉO -->
                        <div id="areaModoPadrao">
                            <div class="mb-1">
                                <label class="compact-label">Cesta</label>
                                <select id="selTipoCesta" onchange="atualizarOpcoesPreco()" class="w-full border border-gray-300 rounded compact-input mb-1">
                                    <option value="economica">Econ√¥mica</option>
                                    <option value="mini">Mini</option>
                                    <option value="pequena">Pequena</option>
                                    <option value="media">M√©dia</option>
                                    <option value="grande">Grande</option>
                                </select>
                                <!-- Seletor de Marca/Pre√ßo -->
                                <select id="selMarcaPreco" onchange="recarregarListaSeAlterada()" class="w-full border border-gray-300 rounded compact-input hidden">
                                    <!-- Preenchido via JS -->
                                </select>
                            </div>

                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <label class="flex items-center text-[10px] cursor-pointer">
                                        <input type="radio" name="modoCesta" value="normal" checked onchange="toggleModoCesta()" class="mr-1 text-indigo-600"> Normal
                                    </label>
                                    <label class="flex items-center text-[10px] cursor-pointer">
                                        <input type="radio" name="modoCesta" value="alterada" onchange="toggleModoCesta()" class="mr-1 text-indigo-600"> Alt
                                    </label>
                                </div>
                                <div id="divCodigoCesta" class="hidden">
                                    <input type="number" id="inputCodigoCesta" placeholder="C√≥d." class="border border-yellow-400 bg-yellow-50 rounded px-1 py-0.5 text-[10px] w-16 text-center">
                                </div>
                            </div>
                        </div>

                        <!-- MODO IMPORTAR -->
                        <div id="areaModoImportar" class="hidden mb-2">
                            <textarea id="txtImportar" rows="3" class="w-full border border-gray-300 rounded text-[10px] p-1 font-mono bg-white" placeholder="001 - 3"></textarea>
                            <button onclick="processarImportacao()" class="mt-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-[10px] px-2 py-0.5 rounded border border-gray-300 w-full font-bold">
                                Carregar
                            </button>
                        </div>

                        <!-- √Årea de Itens -->
                        <div id="areaItensCesta" class="hidden bg-white border border-gray-300 rounded p-1 mb-2 max-h-32 overflow-y-auto text-[10px]"></div>

                        <button onclick="adicionarItemAoCarrinho()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-1 rounded text-xs font-bold shadow-sm">
                            <i class="fa-solid fa-plus mr-1"></i> Add
                        </button>
                    </div>

                    <!-- Carrinho -->
                    <div class="mb-2 border border-gray-200 rounded bg-white min-h-[40px]">
                        <table class="w-full text-left text-[10px]">
                            <tbody id="tabelaCarrinho"></tbody>
                        </table>
                        <div id="carrinhoVazio" class="text-center text-gray-400 py-2 text-[10px] italic">Vazio</div>
                    </div>
                    <div class="text-right mb-2 font-bold text-indigo-700 text-xs">
                        Sub: R$ <span id="lblSubtotal">0,00</span>
                    </div>

                    <hr class="border-gray-300 mb-2">

                    <!-- Fechamento Grid -->
                    <div class="grid grid-cols-2 gap-1 mb-2">
                        <div>
                            <label class="compact-label">Pagto</label>
                            <select id="pagMetodo" class="w-full border border-gray-300 rounded compact-input">
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">Pix</option>
                                <option value="cartao">Cart√£o</option>
                                <option value="fiado">Fiado</option>
                            </select>
                        </div>
                        <div>
                            <label class="compact-label">Status</label>
                            <select id="pagStatus" class="w-full border border-gray-300 rounded compact-input bg-yellow-50 text-yellow-800">
                                <option value="pendente">Aberto</option>
                                <option value="pago">Pago</option>
                            </select>
                        </div>
                        <div>
                            <label class="compact-label">Desc.</label>
                            <select id="desconto" onchange="calcularTotalFinal()" class="w-full border border-gray-300 rounded compact-input">
                                <option value="0">0</option>
                                <option value="5">-5</option>
                                <option value="10">-10</option>
                                <option value="15">-15</option>
                                <option value="20">-20</option>
                            </select>
                        </div>
                        <div>
                            <label class="compact-label">Brinde</label>
                            <select id="brinde" class="w-full border border-gray-300 rounded compact-input text-green-700">
                                <option value="Nenhum">-</option>
                                <option value="Amaciante">Amaciante</option>
                                <option value="Cafe">Caf√©</option>
                                <option value="Sabao Po">Sab√£o P√≥</option>
                                <option value="Ovo">Ovo</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="compact-label">Rota</label>
                            <select id="rota" class="w-full border border-gray-300 rounded compact-input font-bold">
                                <option value="Coxip√≥">Coxip√≥</option>
                                <option value="VG">VG</option>
                                <option value="Cuiab√°">Cuiab√°</option>
                                <option value="CPA">CPA</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <input type="text" id="obs" class="w-full border border-gray-300 rounded compact-input" placeholder="Obs...">
                        </div>
                    </div>

                    <div class="bg-gray-800 text-white p-1.5 rounded text-center mb-2">
                        <span class="text-xs text-gray-400 mr-1">TOTAL:</span>
                        <span class="text-lg font-bold">R$ <span id="lblTotalFinal">0,00</span></span>
                    </div>

                    <button onclick="finalizarPedido()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow text-sm">
                        <i class="fa-solid fa-check mr-1"></i> SALVAR
                    </button>

                </div>
            </div>

            <!-- COLUNA 2: Lista de Pedidos (35% - Otimizada) -->
            <div class="w-5/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col">
                <div class="p-2 border-b border-gray-200 bg-gray-50 rounded-t">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="font-bold text-gray-700 text-xs uppercase"><i class="fa-solid fa-list mr-1"></i>Rota</h2>
                        <div id="resumoRotas" class="text-[9px] flex gap-1"></div>
                    </div>
                    
                    <div class="flex gap-1 items-center">
                        <button onclick="filtrarRota('todos')" id="btnRotaTodos" class="flex-1 btn-rota bg-white shadow text-gray-800 text-[10px] py-1 rounded font-bold border border-gray-200">Todos</button>
                        <button onclick="filtrarRota('Coxip√≥')" id="btnRotaCoxipo" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent">Coxip√≥</button>
                        <button onclick="filtrarRota('VG')" id="btnRotaVG" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent">VG</button>
                        <button onclick="filtrarRota('Cuiab√°')" id="btnRotaCuiaba" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent">CBA</button>
                        <button onclick="filtrarRota('CPA')" id="btnRotaCPA" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent">CPA</button>
                    </div>
                </div>

                <div class="flex-1 overflow-auto bg-gray-100 p-2 custom-scroll">
                    <div id="listaPedidos" class="space-y-2 pb-10">
                        <!-- Cards Renderizados Aqui -->
                    </div>
                </div>
            </div>

            <!-- COLUNA 3: Nova √Årea (40% - Placeholder) -->
            <div class="w-4/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col items-center justify-center text-gray-300">
                <i class="fa-solid fa-map-location-dot text-4xl mb-2"></i>
                <span class="text-xs font-bold uppercase">√Årea de Mapa / Expedi√ß√£o</span>
                <span class="text-[9px]">(Reservado para futura atualiza√ß√£o)</span>
            </div>

        </div>
    </div>

    <!-- √ÅREA DE IMPRESS√ÉO -->
    <div id="areaImpressao"></div>

    <script>
        // --- DADOS E CONFIGURA√á√ïES ---
        const ENTREGADORES = {
            'osvaldo': { nome: 'Osvaldo', num: '556598150975' }, 
            'andre': { nome: 'Andr√©', num: '5565993367403' },
            'claudio': { nome: 'Claudio', num: '5565996884599' },
            'Jose': { nome: 'Jose', num: '5565981756150' }
        };

        // --- CAT√ÅLOGO DE PRODUTOS ---
        const CATALOGO_PRODUTOS = {
            '001': { nome: 'Arroz de 5kg', ean: '7891234560010' },
            '002': { nome: 'A√ß√∫car Cristal de 2kg', ean: '7891234560027' },
            '003': { nome: '√ìleo de Soja de 900ml', ean: '7891234560034' },
            '004': { nome: 'Feij√£o 1kg', ean: '7891234560041' },
            '005': { nome: 'Caf√© 250g', ean: '7891234560058' },
            '005b': { nome: 'Caf√© 500g', ean: '7891234560553' }, 
            '006': { nome: 'Espaguete de 400g/500g', ean: '7891234560065' },
            '007': { nome: 'Trigo de 1kg', ean: '7891234560072' },
            '008': { nome: 'Farinha de Mandioca 1kg', ean: '7891234560089' },
            '009': { nome: 'Sal de 1kg', ean: '7891234560096' },
            '010': { nome: 'Molho Tomate Sach√™', ean: '7891234560102' },
            '011': { nome: 'Milho Lata/Sach√™', ean: '7891234560119' },
            '012': { nome: 'Bolacha Recheada', ean: '7891234560126' },
            '013': { nome: 'Miojo', ean: '7891234560133' },
            '014': { nome: 'Suco em P√≥', ean: '7891234560140' },
            '015': { nome: '12 Ovos', ean: '7891234560157' },
            '016': { nome: 'Mistura para Bolo 400g', ean: '7891234560164' },
            '017': { nome: 'Tempero Pronto', ean: '7891234560171' },
            '030': { nome: 'Sab√£o Barra (pct)', ean: '7891234560300' },
            '031': { nome: 'Creme Dental 70g', ean: '7891234560317' },
            '032': { nome: 'Papel Higi√™nico (4un)', ean: '7891234560324' },
            '033': { nome: 'Amaciante 2 Litros', ean: '7891234560331' },
            '034': { nome: 'Desinfetante 2 Litros', ean: '7891234560348' },
            '035': { nome: 'Sab√£o em P√≥ 800g', ean: '7891234560355' },
            '036': { nome: 'Detergente 500ml', ean: '7891234560362' },
            '037': { nome: 'Qboa 1 Litro', ean: '7891234560379' },
            '038': { nome: 'Sabonete 90g', ean: '7891234560386' },
            '039': { nome: 'Esponja de A√ßo', ean: '7891234560393' },
            '040': { nome: 'Esponja de Lou√ßa', ean: '7891234560409' }
        };

        const DADOS_CESTAS = {
            'economica': { titulo: 'Econ√¥mica', itensCod: [[1,'001'],[1,'002'],[1,'003'],[1,'004'],[1,'005'],[1,'006'],[1,'007'],[1,'008'],[1,'009'],[1,'010'],[1,'011'],[1,'012'],[1,'013'],[1,'014']] },
            'mini': { titulo: 'Mini', itensCod: [[1,'001'],[1,'002'],[2,'003'],[2,'004'],[1,'005'],[1,'006'],[1,'009'],[1,'010'],[1,'011'],[1,'012'],[1,'013'],[2,'014'],[1,'030'],[1,'031'],[1,'032'],[1,'033'],[1,'034'],[1,'035'],[1,'036'],[1,'037'],[2,'038'],[1,'039'],[1,'040']] },
            'pequena': { titulo: 'Pequena', itensCod: [[2,'001'],[1,'002'],[2,'003'],[2,'004'],[1,'005'],[1,'015'],[1,'016'],[1,'006'],[1,'007'],[1,'009'],[1,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[2,'014'],[1,'030'],[1,'031'],[1,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[2,'038'],[1,'039'],[1,'040']] },
            'media': { titulo: 'M√©dia', itensCod: [[3,'001'],[2,'002'],[3,'003'],[3,'004'],[1,'005b'],[1,'015'],[1,'016'],[2,'006'],[1,'007'],[1,'009'],[2,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[3,'014'],[1,'030'],[2,'031'],[2,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[3,'038'],[1,'039'],[1,'040']] },
            'grande': { titulo: 'Grande', itensCod: [[4,'001'],[3,'002'],[4,'003'],[4,'004'],[1,'005b'],[3,'006'],[1,'015'],[1,'016'],[1,'007'],[1,'009'],[2,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[4,'014'],[1,'030'],[2,'031'],[2,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[4,'038'],[1,'039'],[1,'040']] }
        };

        const PRECOS = {
            'economica': { 'padrao': 85 },
            'mini': { 'alvino': 165, 'koblenz': 170 },
            'pequena': { 'alvino': 215, 'koblenz': 220 },
            'media': { 'alvino': 320, 'koblenz': 325 },
            'grande': { 'alvino': 380, 'koblenz': 390 }
        };

        // --- ESTADO GLOBAL ---
        let carrinho = []; 
        let pedidos = []; 
        let listaClientesCache = []; 
        let filtroRotaAtual = 'todos'; 
        let dragSrcEl = null; 
        
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            carregarClientes();
            carregarPedidosLocais();
            atualizarOpcoesPreco(); // Corrigido aqui
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        };

        // --- FUN√á√ïES DE DADOS ---
        function carregarClientes() {
            const clientesRaw = localStorage.getItem(KEY_CLIENTES);
            if (clientesRaw) {
                listaClientesCache = JSON.parse(clientesRaw);
                listaClientesCache.sort((a, b) => a.nome.localeCompare(b.nome));
            } else listaClientesCache = [];
            renderizarOpcoesClientes(listaClientesCache);
        }

        function renderizarOpcoesClientes(lista) {
            const select = document.getElementById('selCliente');
            const valorAtual = select.value; 
            select.innerHTML = '<option value="">...</option>';
            lista.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.innerText = `${c.nome.substring(0,20)}...`;
                option.dataset.json = JSON.stringify(c); 
                select.appendChild(option);
            });
            if (valorAtual) select.value = valorAtual;
        }

        function filtrarClientes() {
            const termo = document.getElementById('inputBuscaCliente').value.toLowerCase();
            const filtrados = listaClientesCache.filter(c => {
                const nome = c.nome.toLowerCase();
                return nome.includes(termo);
            });
            renderizarOpcoesClientes(filtrados);
        }

        // --- INTERFACE DE TABS E PRODUTOS ---
        function alternarTab(tab) {
            const btnPadrao = document.getElementById('tabPadrao');
            const btnImportar = document.getElementById('tabImportar');
            const areaPadrao = document.getElementById('areaModoPadrao');
            const areaImportar = document.getElementById('areaModoImportar');
            const areaItens = document.getElementById('areaItensCesta');

            if(tab === 'padrao') {
                btnPadrao.className = "flex-1 py-0.5 font-bold text-indigo-700 border-b-2 border-indigo-600";
                btnImportar.className = "flex-1 py-0.5 font-bold text-gray-500 hover:text-indigo-600";
                areaPadrao.classList.remove('hidden');
                areaImportar.classList.add('hidden');
                document.querySelector('input[name="modoCesta"][value="normal"]').checked = true;
                toggleModoCesta();
            } else {
                btnImportar.className = "flex-1 py-0.5 font-bold text-indigo-700 border-b-2 border-indigo-600";
                btnPadrao.className = "flex-1 py-0.5 font-bold text-gray-500 hover:text-indigo-600";
                areaImportar.classList.remove('hidden');
                areaPadrao.classList.add('hidden');
                areaItens.classList.remove('hidden');
                areaItens.innerHTML = '<div class="text-center text-gray-400 p-2">Cole os c√≥digos...</div>';
                document.querySelector('input[name="modoCesta"][value="alterada"]').checked = true;
                document.getElementById('divCodigoCesta').classList.remove('hidden');
            }
        }

        function processarImportacao() {
            const texto = document.getElementById('txtImportar').value;
            if(!texto.trim()) return alert("Cole a lista!");
            const linhas = texto.split('\n');
            const listaParaRenderizar = [];
            linhas.forEach(linha => {
                if(!linha.trim()) return;
                let parts = linha.includes('-') ? linha.split('-') : linha.split(' ');
                parts = parts.map(p => p.trim()).filter(p => p !== "");
                if(parts.length >= 2) {
                    const codigo = parts[0];
                    const qtd = parseInt(parts[1]);
                    if(CATALOGO_PRODUTOS[codigo]) listaParaRenderizar.push([qtd, codigo]);
                }
            });
            if(listaParaRenderizar.length === 0) return alert("Nenhum c√≥digo v√°lido.");
            renderizarListaEditavelGenerica(listaParaRenderizar);
        }

        // Fun√ß√£o corrigida e renomeada
        function atualizarOpcoesPreco() {
            const tipo = document.getElementById('selTipoCesta').value;
            const selectMarca = document.getElementById('selMarcaPreco');
            selectMarca.innerHTML = '';
            const opcoes = PRECOS[tipo];
            
            // Popula op√ß√µes
            if (tipo === 'economica') {
                const opt = new Option(`Padr√£o - R$ ${opcoes.padrao}`, opcoes.padrao);
                selectMarca.add(opt);
            } else {
                const opt1 = new Option(`Alvino - R$ ${opcoes.alvino}`, opcoes.alvino);
                opt1.setAttribute('data-marca', 'Alvino');
                selectMarca.add(opt1);
                const opt2 = new Option(`Koblenz - R$ ${opcoes.koblenz}`, opcoes.koblenz);
                opt2.setAttribute('data-marca', 'Koblenz');
                selectMarca.add(opt2);
            }

            // AUTO-HIDE LOGIC
            if (selectMarca.options.length <= 1) {
                selectMarca.classList.add('hidden');
            } else {
                selectMarca.classList.remove('hidden');
            }

            // Atualiza a lista se estiver no modo Alterada
            if(document.querySelector('input[name="modoCesta"]:checked').value === 'alterada') {
                const listaOriginal = DADOS_CESTAS[tipo].itensCod;
                renderizarListaEditavelGenerica(listaOriginal);
            }
        }

        function recarregarListaSeAlterada() {
            if(document.querySelector('input[name="modoCesta"]:checked').value === 'alterada') {
                const tipo = document.getElementById('selTipoCesta').value;
                const listaOriginal = DADOS_CESTAS[tipo].itensCod;
                renderizarListaEditavelGenerica(listaOriginal);
            }
        }

        function toggleModoCesta() {
            const modo = document.querySelector('input[name="modoCesta"]:checked').value;
            const area = document.getElementById('areaItensCesta');
            const divCodigo = document.getElementById('divCodigoCesta');
            
            if (modo === 'alterada') {
                const tipo = document.getElementById('selTipoCesta').value;
                renderizarListaEditavelGenerica(DADOS_CESTAS[tipo].itensCod);
                area.classList.remove('hidden');
                divCodigo.classList.remove('hidden');
            } else {
                area.classList.add('hidden');
                divCodigo.classList.add('hidden');
            }
        }

        function renderizarListaEditavelGenerica(listaItensCod) {
            const area = document.getElementById('areaItensCesta');
            area.innerHTML = '';
            
            // Verifica se h√° marca selecionada para o Arroz
            const selMarca = document.getElementById('selMarcaPreco');
            let marcaExtra = "";
            if (selMarca && !selMarca.classList.contains('hidden') && selMarca.selectedIndex >= 0) {
                 const opt = selMarca.options[selMarca.selectedIndex];
                 const nomeMarca = opt.getAttribute('data-marca');
                 if(nomeMarca && nomeMarca !== 'Pad') marcaExtra = ` (${nomeMarca})`;
            }

            listaItensCod.forEach((item) => {
                const qtd = item[0];
                const cod = item[1];
                const produto = CATALOGO_PRODUTOS[cod];
                let nome = produto ? produto.nome.substring(0,25) : 'Desc';
                
                // Adiciona marca ao Arroz (001)
                if(cod === '001' && marcaExtra) {
                    nome += marcaExtra;
                }

                const row = document.createElement('div');
                row.className = "flex items-center gap-1 mb-1";
                row.innerHTML = `
                    <input type="number" min="0" value="${qtd}" class="w-8 border border-gray-300 rounded text-center px-0.5 item-qtd font-bold">
                    <span class="text-[9px] bg-gray-200 px-1 rounded font-mono">${cod}</span>
                    <input type="text" value="${nome}" class="flex-1 border border-gray-300 rounded px-1 item-desc bg-gray-50" readonly>
                `;
                area.appendChild(row);
            });
        }

        function adicionarItemAoCarrinho() {
            const tipoKey = document.getElementById('selTipoCesta').value;
            const precoVal = parseFloat(document.getElementById('selMarcaPreco').value) || 0;
            const selMarca = document.getElementById('selMarcaPreco');
            const marcaNome = selMarca.options[selMarca.selectedIndex] 
                              ? (selMarca.options[selMarca.selectedIndex].getAttribute('data-marca') || 'Pad') 
                              : 'Pad';
            
            const isImportTab = !document.getElementById('areaModoImportar').classList.contains('hidden');
            const isRadioAlterada = document.querySelector('input[name="modoCesta"][value="alterada"]').checked;
            
            let modo = (isImportTab || isRadioAlterada) ? 'alterada' : 'normal';
            let itensFinais = [];
            let identificacao = null; 
            let nomeCestaDisplay = isImportTab ? 'Importada' : DADOS_CESTAS[tipoKey].titulo;

            // L√≥gica de Montagem da Lista de Itens
            if (modo === 'normal') {
                const listaCod = DADOS_CESTAS[tipoKey].itensCod;
                listaCod.forEach(item => {
                   const produto = CATALOGO_PRODUTOS[item[1]];
                   if(produto) itensFinais.push({ cod: item[1], qtd: item[0], nome: produto.nome, ean: produto.ean });
                });
            } else {
                const codInput = document.getElementById('inputCodigoCesta').value;
                if(!codInput) return alert('Por favor, informe o C√ìDIGO de identifica√ß√£o para cesta alterada/importada.');
                identificacao = codInput;
                const container = document.getElementById('areaItensCesta');
                
                // Raspa os dados visuais se for alterada
                Array.from(container.children).forEach(child => {
                    const qInput = child.querySelector('.item-qtd');
                    const spanCod = child.querySelector('span.font-mono');
                    
                    if(qInput && spanCod) {
                        const codigo = spanCod.innerText;
                        const q = parseInt(qInput.value) || 0;
                        if (q > 0) {
                            let ean = CATALOGO_PRODUTOS[codigo] ? CATALOGO_PRODUTOS[codigo].ean : '';
                            
                            // Tenta pegar o nome exibido (que j√° tem a marca se for arroz)
                            const descInput = child.querySelector('.item-desc');
                            let nome = descInput ? descInput.value : (CATALOGO_PRODUTOS[codigo] ? CATALOGO_PRODUTOS[codigo].nome : 'Extra');
                            
                            itensFinais.push({ cod: codigo, qtd: q, nome: nome, ean: ean });
                        }
                    }
                });
            }

            if(itensFinais.length === 0) {
                return alert("Erro: N√£o foi poss√≠vel identificar os itens da cesta. Verifique se o cadastro est√° correto.");
            }

            carrinho.push({
                id: Date.now(),
                tipo: nomeCestaDisplay,
                marca: marcaNome,
                preco: precoVal,
                modo: modo,
                identificacao: identificacao, 
                conteudo: itensFinais
            });
            renderizarCarrinho();
        }

        function removerDoCarrinho(id) {
            carrinho = carrinho.filter(i => i.id !== id);
            renderizarCarrinho();
        }

        function renderizarCarrinho() {
            const tbody = document.getElementById('tabelaCarrinho');
            const divVazio = document.getElementById('carrinhoVazio');
            tbody.innerHTML = '';
            let subtotal = 0;

            if (carrinho.length === 0) {
                divVazio.style.display = 'block';
            } else {
                divVazio.style.display = 'none';
                carrinho.forEach(item => {
                    subtotal += item.preco;
                    const tr = document.createElement('tr');
                    tr.className = "border-t border-gray-100";
                    let label = item.modo === 'alterada' ? `<span class="bg-yellow-200 px-1 rounded ml-1 text-[9px]">COD:${item.identificacao}</span>` : '';
                    tr.innerHTML = `
                        <td class="p-1">
                            <div class="font-bold">${item.tipo} ${label}</div>
                            <div class="text-[9px] text-gray-500">${item.marca}</div>
                        </td>
                        <td class="p-1 text-right">R$ ${item.preco}</td>
                        <td class="p-1 text-center"><button onclick="removerDoCarrinho(${item.id})" class="text-red-500 font-bold">X</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('lblSubtotal').innerText = subtotal.toFixed(2).replace('.', ',');
            calcularTotalFinal(subtotal);
        }

        function calcularTotalFinal(subtotalOverride) {
            let sub = subtotalOverride !== undefined ? subtotalOverride : parseFloat(document.getElementById('lblSubtotal').innerText.replace(',', '.'));
            let desc = parseFloat(document.getElementById('desconto').value) || 0;
            document.getElementById('lblTotalFinal').innerText = Math.max(0, sub - desc).toFixed(2).replace('.', ',');
        }

        function finalizarPedido() {
            const selCliente = document.getElementById('selCliente');
            if (!selCliente.value || carrinho.length === 0) return alert('Preencha Cliente e Carrinho!');
            const clienteDados = JSON.parse(selCliente.options[selCliente.selectedIndex].dataset.json);
            
            const now = new Date();
            const dataHojeStr = now.toISOString().split('T')[0];
            const countHoje = pedidos.filter(p => p.data.startsWith(dataHojeStr)).length + 1;
            const codigoVisual = `${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(countHoje).padStart(2,'0')}`;

            pedidos.push({
                id: Date.now().toString(),
                codigoVisual: codigoVisual,
                data: new Date().toISOString(),
                ordem: Date.now(), 
                cliente: clienteDados, 
                rota: document.getElementById('rota').value,
                pagamento: { metodo: document.getElementById('pagMetodo').value, status: document.getElementById('pagStatus').value },
                financeiro: {
                    subtotal: parseFloat(document.getElementById('lblSubtotal').innerText.replace(',', '.')),
                    desconto: parseFloat(document.getElementById('desconto').value),
                    total: parseFloat(document.getElementById('lblTotalFinal').innerText.replace(',', '.'))
                },
                brinde: document.getElementById('brinde').value,
                obs: document.getElementById('obs').value,
                itens: carrinho
            });
            salvarPedidosLocais();
            alert(`Salvo: ${codigoVisual}`);
            limparPedidoAtual();
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        }

        function salvarPedidosLocais() { localStorage.setItem(KEY_PEDIDOS, JSON.stringify(pedidos)); }
        function carregarPedidosLocais() { 
            const dados = localStorage.getItem(KEY_PEDIDOS);
            if (dados) pedidos = JSON.parse(dados);
        }

        function limparPedidoAtual() {
            carrinho = [];
            renderizarCarrinho();
            document.getElementById('selCliente').value = "";
            document.getElementById('inputBuscaCliente').value = ""; 
            document.getElementById('obs').value = "";
            document.getElementById('pagStatus').value = "pendente";
            document.getElementById('desconto').value = "0";
            alternarTab('padrao');
            calcularTotalFinal(0);
        }

        function gerarCodigoClienteVisual(cliente, rotaPedido) {
            let cid = (cliente.cidade || '').toLowerCase().includes('vg') ? 'VG' : 'CBA';
            const rotaLimpa = rotaPedido.replace(/[^a-zA-Z0-9]/g, '');
            const telFinal = (cliente.telefone || '').replace(/\D/g, '').slice(-4).padStart(4,'0');
            return `${cid}${rotaLimpa}${telFinal}`;
        }

        function filtrarRota(rota) {
            filtroRotaAtual = rota;
            document.querySelectorAll('.btn-rota').forEach(btn => {
                btn.className = 'flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent';
            });
            const btnAtivo = document.getElementById('btnRota' + (rota === 'todos' ? 'Todos' : rota.replace(/\s+/g, '')));
            if(btnAtivo) btnAtivo.className = 'flex-1 btn-rota bg-white shadow text-gray-800 text-[10px] py-1 rounded font-bold border border-gray-200';
            renderizarListaPedidos();
        }

        function getPedidosVisiveis() {
            const filtroData = document.getElementById('filtroData').value;
            let lista = pedidos.filter(p => p.data.startsWith(filtroData));
            if (filtroRotaAtual !== 'todos') lista = lista.filter(p => p.rota === filtroRotaAtual);
            lista.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
            return lista;
        }

        function moverPedido(id, direcao) {
            const listaAtual = getPedidosVisiveis();
            listaAtual.forEach((p, index) => p.ordem = index * 10);
            const indexAtual = listaAtual.findIndex(p => p.id === id);
            if (indexAtual === -1) return;
            const indexAlvo = indexAtual + direcao;
            if (indexAlvo >= 0 && indexAlvo < listaAtual.length) {
                const ordemTemp = listaAtual[indexAtual].ordem;
                listaAtual[indexAtual].ordem = listaAtual[indexAlvo].ordem;
                listaAtual[indexAlvo].ordem = ordemTemp;
                salvarPedidosLocais();
                renderizarListaPedidos();
            }
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDragEnter(e) { this.classList.add('border-indigo-500', 'bg-indigo-50'); }
        function handleDragLeave(e) { this.classList.remove('border-indigo-500', 'bg-indigo-50'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation(); 
            document.querySelectorAll('.draggable-card').forEach(col => col.classList.remove('dragging', 'border-indigo-500', 'bg-indigo-50'));
            const idOrigem = dragSrcEl.dataset.id;
            const idDestino = this.dataset.id;
            if (dragSrcEl !== this) {
                const listaAtual = getPedidosVisiveis();
                listaAtual.forEach((p, index) => p.ordem = index * 10);
                const idxOrigem = listaAtual.findIndex(p => p.id === idOrigem);
                const idxDestino = listaAtual.findIndex(p => p.id === idDestino);
                if (idxOrigem > -1 && idxDestino > -1) {
                    const [itemMovido] = listaAtual.splice(idxOrigem, 1);
                    listaAtual.splice(idxDestino, 0, itemMovido);
                    listaAtual.forEach((p, index) => p.ordem = index * 10);
                    salvarPedidosLocais();
                    renderizarListaPedidos();
                }
            }
            return false;
        }
        function handleDragEnd(e) { document.querySelectorAll('.draggable-card').forEach(col => col.classList.remove('dragging', 'border-indigo-500', 'bg-indigo-50')); }

        function renderizarListaPedidos() {
            const container = document.getElementById('listaPedidos');
            const pedidosFiltrados = getPedidosVisiveis();
            const resumo = {};
            pedidosFiltrados.forEach(p => { resumo[p.rota] = (resumo[p.rota] || 0) + 1; });
            document.getElementById('resumoRotas').innerHTML = Object.entries(resumo).map(([rota, qtd]) => `<span class="bg-blue-100 text-blue-800 px-1 rounded">${rota.substring(0,3)}:${qtd}</span>`).join('');
            
            container.innerHTML = '';
            if (pedidosFiltrados.length === 0) return container.innerHTML = '<div class="text-center text-gray-400 mt-10 text-xs">Vazio</div>';

            pedidosFiltrados.forEach((p, index) => {
                const card = document.createElement('div');
                const isPago = p.pagamento.status === 'pago';
                const borderClass = isPago ? 'border-green-500' : 'border-yellow-400';
                const codClienteVisual = gerarCodigoClienteVisual(p.cliente, p.rota);
                const nomeCurto = p.cliente.nome.substring(0, 10).toUpperCase();

                card.setAttribute('draggable', 'true');
                card.dataset.id = p.id;
                card.className = "draggable-card bg-white border-l-4 " + borderClass + " shadow-sm rounded-r mb-2 flex flex-col p-1.5";
                
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);

                const opcoesEntregadores = Object.keys(ENTREGADORES).map(k => `<option value="${k}">${ENTREGADORES[k].nome}</option>`).join('');
                
                // --- LINHA 1: Cabe√ßalho ---
                const headerHtml = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-1">
                            <span class="bg-gray-800 text-white text-[10px] font-mono px-1 rounded font-bold">${p.codigoVisual || '--'}</span>
                            <span class="font-bold text-gray-800 text-xs" title="${p.cliente.nome}">${nomeCurto}</span>
                            <span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded font-mono">${codClienteVisual}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            ${p.cliente.maps ? '<i class="fa-solid fa-map-location-dot text-orange-500 text-[10px]"></i>' : ''}
                            <span class="font-bold text-indigo-700 text-xs">R$${p.financeiro.total.toFixed(0)}</span>
                        </div>
                    </div>
                `;

                // --- LINHA 2: Resumo Itens ---
                const resumoItens = p.itens.map(i => {
                    const tipo = i.tipo.replace('Cesta ', '');
                    const labelAlt = i.modo === 'alterada' ? `<span class="bg-red-100 text-red-800 px-0.5 rounded text-[8px] font-bold">ALT</span>` : '';
                    return `<div class="flex justify-between text-[10px] leading-tight text-gray-600"><span>${tipo} (${i.marca.substring(0,3)})</span> ${labelAlt}</div>`;
                }).join('');

                const itensHtml = `<div class="bg-gray-50 border border-gray-100 rounded p-1 mb-1">${resumoItens}</div>`;

                // --- LINHA 3: A√ß√µes (REMOVIDO ZAP) ---
                const acoesHtml = `
                    <div class="flex items-center justify-between gap-1 mt-auto">
                        <div class="flex items-center gap-1">
                            <button onclick="moverPedido('${p.id}', -1)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-caret-up"></i></button>
                            <button onclick="moverPedido('${p.id}', 1)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-caret-down"></i></button>
                        </div>
                        <div class="flex-1 px-1">
                            <select id="selEntregador_${p.id}" class="w-full text-[9px] border border-gray-300 rounded py-0 bg-white h-5">
                                <option value="">Entregador...</option>
                                ${opcoesEntregadores}
                            </select>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="imprimirEtiquetaPedido('${p.id}')" class="bg-gray-800 text-white w-5 h-5 rounded flex items-center justify-center hover:bg-gray-600" title="Etiqueta"><i class="fa-solid fa-tag text-[10px]"></i></button>
                            <button onclick="excluirPedido('${p.id}')" class="text-red-300 hover:text-red-500 w-4"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                `;

                card.innerHTML = headerHtml + itensHtml + acoesHtml;
                container.appendChild(card);
            });
        }

        // Fun√ß√µes de A√ß√£o (Mantidas iguais, mas compactadas)
        function excluirPedido(id) { if(confirm('Del?')) { pedidos = pedidos.filter(p => p.id !== id); salvarPedidosLocais(); renderizarListaPedidos(); } }
        
        function exportarPedidosJson() {
            const filtroData = document.getElementById('filtroData').value;
            let lista = pedidos.filter(p => p.data.startsWith(filtroData));
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(lista)], {type: "application/json"}));
            a.download = `backup_${filtroData}.json`;
            a.click();
        }

        function imprimirEtiquetaPedido(id) {
            const p = pedidos.find(item => item.id === id);
            if (!p) return;
            const area = document.getElementById('areaImpressao');
            const codCli = gerarCodigoClienteVisual(p.cliente, p.rota);
            let html = '';
            p.itens.forEach(item => {
                let qtd = (item.tipo.match(/mini|pequena/i)) ? 2 : (item.tipo.match(/grande|media|m√©dia/i) ? 3 : 1);
                let nomeCesta = item.modo === 'alterada' ? `COD: ${item.identificacao}` : item.tipo.toUpperCase();
                for (let i = 1; i <= qtd; i++) {
                    html += `
                        <div class="label-container">
                            <div>
                                <div class="label-header"><span class="label-date">${new Date(p.data).toLocaleDateString('pt-BR')}</span></div>
                                <div class="label-client-name">${p.cliente.nome.split(' ')[0].toUpperCase()}</div>
                                <div class="label-client-phone">${p.cliente.telefone||''}</div>
                                <div class="label-client-address">${p.cliente.endereco}, ${p.cliente.bairro}</div>
                                <div class="label-client-code-box">${codCli}</div>
                                <div class="label-rota">${p.rota.toUpperCase()}</div>
                                <div class="label-order-code">PED: ${p.codigoVisual}</div>
                            </div>
                            <div><div class="label-basket">${nomeCesta}</div></div>
                            <div class="label-footer"><div class="volume-counter">VOL: ${i}/${qtd}</div><div style="border-top:1px solid black;margin-top:2px;">SISTEMA DONA ANTONIA</div></div>
                        </div>`;
                }
            });
            area.innerHTML = html;
            setTimeout(() => window.print(), 300);
        }
    </script>
</body>
</html>
