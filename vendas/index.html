<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V3.7 - Logística & Sales Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Estilo Geral --- */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1920px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        
        .compact-input { padding: 0.2rem 0.4rem; font-size: 0.75rem; height: 28px; }
        .compact-label { font-size: 0.65rem; font-weight: 700; color: #4b5563; text-transform: uppercase; margin-bottom: 2px; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .bg-pattern { background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; }
        
        /* Destaque do Card Selecionado */
        .selected-card { 
            border-left-color: #4f46e5 !important; 
            background-color: #eef2ff !important; 
            border-width: 2px !important; 
            border-color: #4f46e5 !important; 
        }

        .draggable-card { cursor: grab; user-select: none; }
        .draggable-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; border: 2px dashed #4f46e5 !important; background-color: #eef2ff !important; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: white; border-left: 4px solid; padding: 15px 20px; margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.3s ease-out forwards; transform: translateX(100%);
        }
        @keyframes slideIn { to { transform: translateX(0); } }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }
        .toast-warning { border-color: #f59e0b; }

        /* --- IMPRESSÃO GERAL --- */
        @media print {
            body * { visibility: hidden; }
            #areaImpressao, #areaImpressao * { visibility: visible; }
            #areaImpressao {
                position: absolute; left: 0; top: 0; 
                background: white; color: black; font-family: 'Arial', sans-serif;
                display: block !important; overflow: hidden;
            }

            /* Cabeçalho Textual (Logo) */
            .print-header-brand {
                display: flex; align-items: flex-start; justify-content: space-between;
                border-bottom: 2px solid black; padding-bottom: 3px; margin-bottom: 5px; width: 100%;
            }
            .brand-text { font-weight: 900; font-size: 11px; line-height: 1.1; text-transform: uppercase; }
            .brand-info { text-align: right; }
            .brand-whatsapp { font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: flex-end; gap: 2px; }
            .brand-site { font-size: 8px; font-weight: bold; margin-top: 1px; text-transform: uppercase;}
            
            /* --- ETIQUETA QUADRADA (76x76mm) --- */
            .label-page {
                width: 76mm; height: 76mm;
                page-break-after: always; break-after: page;
                padding: 5mm; 
                box-sizing: border-box;
                display: flex; flex-direction: column; justify-content: space-between;
                border: 1px dashed #eee; 
            }
            
            .label-date { font-size: 16px; font-weight: 900; text-align: center; border-bottom: 2px solid black; margin-bottom: 3px; }
            .label-client-name { font-size: 18px; font-weight: 900; line-height: 1; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
            .label-client-phone { font-size: 16px; font-weight: 900; margin-bottom: 2px; }
            .label-client-address { font-size: 11px; line-height: 1.1; font-weight: normal; text-transform: uppercase; margin-bottom: 4px; }
            
            .info-row { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 4px; }
            .box-code { border: 2px solid black; font-weight: 900; padding: 2px 4px; font-size: 14px; text-transform: uppercase; border-radius: 4px; flex: 1; text-align: center; }

            .label-basket-info { font-size: 12px; font-weight: 900; text-transform: uppercase; border-top: 2px solid black; padding-top: 2px; }
            .label-brinde { font-size: 11px; font-weight: bold; margin-top: 1px; }
            
            .label-footer { text-align: right; font-size: 16px; font-weight: 900; }

            /* --- MONTAGEM / LISTA --- */
            .montagem-page { width: 76mm; padding: 2mm; box-sizing: border-box; page-break-after: always; }
            .montagem-item { border-bottom: 1px dashed #000; padding: 5px 0; display: flex; align-items: center; justify-content: space-between; }
            .montagem-prod { font-size: 12px; font-weight: bold; flex: 1; padding-right: 5px; text-transform: uppercase; }
            .montagem-meta { font-size: 22px; font-family: 'Courier New', monospace; font-weight: 900; text-align: right; white-space: nowrap; }

            /* --- CUPOM --- */
            .cupom-page { width: 76mm; padding: 5mm; box-sizing: border-box; text-align: center; page-break-after: always; }
            .cupom-box { border: 3px dashed black; padding: 5px; margin: 10px 0; border-radius: 8px; }
            .cupom-price-val { font-size: 32px; font-weight: 900; }

            .no-print { display: none !important; }
        }
        #areaImpressao { display: none; }
        
        @page { size: 76mm 76mm; margin: 0; } 
    </style>
</head>
<body class="text-gray-800 bg-pattern text-sm">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="app-container p-2 no-print">
        
        <!-- Header -->
        <header class="bg-white shadow-sm rounded p-2 mb-2 flex justify-between items-center border border-gray-300 h-14">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded shadow-md"><i class="fa-solid fa-truck-fast text-lg"></i></div>
                <div>
                    <h1 class="font-bold text-lg text-gray-700 leading-none">Módulo 2: Expedição</h1>
                    <span class="text-[10px] text-gray-400 font-bold tracking-wider">V3.7 STABLE | ARCHITECT.SALES</span>
                </div>
            </div>
            
            <div class="flex gap-2 items-center bg-gray-50 p-1.5 rounded border border-gray-200">
                <div class="flex flex-col items-end mr-2">
                    <span class="text-[9px] font-bold text-gray-400 uppercase">Filtro de Visualização</span>
                    <input type="date" id="filtroData" class="bg-white border border-gray-300 rounded text-xs px-2 py-0.5 focus:ring-0 w-32" onchange="renderizarListaPedidos()">
                </div>
                
                <div class="h-8 w-px bg-gray-300 mx-1"></div>

                <!-- Novos Botões de Ação -->
                <button onclick="exportarBackupGeral()" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center gap-2 transition-colors" title="Salva últimos 90 dias">
                    <i class="fa-solid fa-database"></i> BKP (90d)
                </button>
                <button onclick="exportarDoDia()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center gap-2 transition-colors" title="Baixar apenas hoje">
                    <i class="fa-solid fa-download"></i> Hoje
                </button>
            </div>
        </header>

        <!-- Layout 3 Colunas -->
        <div class="flex flex-1 gap-2 overflow-hidden">
            
            <!-- 1. Novo Pedido -->
            <div class="w-3/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col overflow-hidden">
                <div class="p-2 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h2 class="font-bold text-indigo-800 text-xs uppercase"><i class="fa-solid fa-plus mr-1"></i>Novo Pedido</h2>
                    <button onclick="limparPedidoAtual()" class="text-[10px] text-red-500 hover:text-red-700 font-bold uppercase transition-colors">Limpar</button>
                </div>
                <div class="p-2 overflow-y-auto flex-1 custom-scroll">
                    <!-- Cliente -->
                    <div class="mb-2">
                        <label class="compact-label">Cliente</label>
                        <input type="text" id="inputBuscaCliente" onkeyup="filtrarClientes()" placeholder="Digite para buscar..." class="w-full border border-indigo-200 bg-indigo-50 rounded compact-input mb-1 focus:border-indigo-500 focus:outline-none">
                        <div class="flex gap-1">
                            <select id="selCliente" class="w-full border border-gray-300 rounded compact-input focus:border-indigo-500"><option value="">Selecione...</option></select>
                            <button onclick="carregarClientes()" class="bg-gray-200 px-2 rounded hover:bg-gray-300 transition-colors"><i class="fa-solid fa-sync text-[10px]"></i></button>
                        </div>
                    </div>
                    <hr class="border-dashed border-gray-200 my-2">
                    
                    <!-- Produto/Cesta -->
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 mb-2">
                        <div class="flex border-b border-gray-300 mb-2 text-[10px]">
                            <button class="flex-1 py-0.5 font-bold text-indigo-700 border-b-2 border-indigo-600 transition-colors" id="tabPadrao" onclick="alternarTab('padrao')">Padrão</button>
                            <button class="flex-1 py-0.5 font-bold text-gray-500 hover:text-indigo-600 transition-colors" id="tabImportar" onclick="alternarTab('importar')">Colar (Import)</button>
                        </div>
                        
                        <div id="areaModoPadrao">
                            <div class="mb-1">
                                <label class="compact-label">Tamanho da Cesta</label>
                                <select id="selTipoCesta" onchange="atualizarOpcoesPreco()" class="w-full border border-gray-300 rounded compact-input mb-1 focus:border-indigo-500">
                                    <option value="economica">Econômica</option>
                                    <option value="mini">Mini</option>
                                    <option value="pequena">Pequena</option>
                                    <option value="media">Média</option>
                                    <option value="grande">Grande</option>
                                </select>
                                <select id="selMarcaPreco" onchange="recarregarListaSeAlterada()" class="w-full border border-gray-300 rounded compact-input hidden focus:border-indigo-500"></select>
                            </div>
                            
                            <div class="flex items-center justify-between mb-1 bg-white p-1 rounded border border-gray-200">
                                <div class="flex items-center gap-2">
                                    <label class="flex items-center text-[10px] cursor-pointer"><input type="radio" name="modoCesta" value="normal" checked onchange="toggleModoCesta()" class="mr-1 accent-indigo-600">Normal</label>
                                    <label class="flex items-center text-[10px] cursor-pointer"><input type="radio" name="modoCesta" value="alterada" onchange="toggleModoCesta()" class="mr-1 accent-red-500">Alterada</label>
                                </div>
                                <div id="divCodigoCesta" class="hidden">
                                    <input type="number" id="inputCodigoCesta" placeholder="Cód. da Alteração" class="border border-red-300 bg-red-50 rounded px-1 py-0.5 text-[10px] w-24 text-center font-bold text-red-700 placeholder-red-300 focus:outline-none focus:border-red-500">
                                </div>
                            </div>
                        </div>

                        <div id="areaModoImportar" class="hidden mb-2">
                            <textarea id="txtImportar" rows="3" class="w-full border border-gray-300 rounded text-[10px] p-1 font-mono focus:border-indigo-500" placeholder="Cole aqui: 001 - 3, 002 - 1..."></textarea>
                            <button onclick="processarImportacao()" class="mt-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-[10px] px-2 py-0.5 rounded border border-gray-300 w-full font-bold transition-colors">Processar Texto</button>
                        </div>
                        <div id="areaItensCesta" class="hidden bg-white border border-gray-300 rounded p-1 mb-2 max-h-32 overflow-y-auto text-[10px]"></div>
                        <button onclick="adicionarItemAoCarrinho()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded text-xs font-bold shadow-sm transition-all-300 transform active:scale-95"><i class="fa-solid fa-cart-plus mr-1"></i> ADICIONAR AO CARRINHO</button>
                    </div>

                    <!-- Carrinho -->
                    <div class="mb-2 border border-gray-200 rounded bg-white min-h-[60px] relative">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-50 text-gray-500 border-b border-gray-200">
                                <tr>
                                    <th class="p-1 font-normal">Item</th>
                                    <th class="p-1 font-normal text-right">Valor</th>
                                    <th class="p-1 font-normal text-center">#</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaCarrinho"></tbody>
                        </table>
                        <div id="carrinhoVazio" class="absolute inset-0 flex items-center justify-center text-gray-300 text-xs pointer-events-none">
                            <i class="fa-solid fa-basket-shopping mr-1"></i> Carrinho Vazio
                        </div>
                    </div>
                    <div class="text-right mb-2 font-bold text-indigo-700 text-xs bg-indigo-50 p-1 rounded">Subtotal: R$ <span id="lblSubtotal">0,00</span></div>
                    
                    <hr class="border-gray-300 mb-2">
                    
                    <!-- Fechamento -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="compact-label">Pagamento</label><select id="pagMetodo" class="w-full border border-gray-300 rounded compact-input"><option value="dinheiro">Dinheiro</option><option value="pix">Pix</option><option value="cartao">Cartão</option><option value="fiado">Fiado</option></select></div>
                        <div><label class="compact-label">Status</label><select id="pagStatus" class="w-full border border-gray-300 rounded compact-input bg-yellow-50 text-yellow-800 font-bold"><option value="pendente">Aberto (Pendente)</option><option value="pago">Pago (Confirmado)</option></select></div>
                        <div><label class="compact-label">Desconto (R$)</label><select id="desconto" onchange="calcularTotalFinal()" class="w-full border border-gray-300 rounded compact-input"><option value="0">0,00</option><option value="5">-5,00</option><option value="10">-10,00</option><option value="15">-15,00</option><option value="20">-20,00</option></select></div>
                        <div><label class="compact-label">Brinde</label><select id="brinde" class="w-full border border-gray-300 rounded compact-input text-green-700 font-bold"><option value="Nenhum">-</option><option value="Amaciante">Amaciante</option><option value="Cafe">Café</option><option value="Sabao Po">Sabão Pó</option><option value="Ovo">Ovo</option></select></div>
                        <div class="col-span-2"><label class="compact-label">Rota de Entrega</label><select id="rota" class="w-full border border-gray-300 rounded compact-input font-bold text-indigo-900"><option value="Coxipó">Coxipó</option><option value="VG">Várzea Grande (VG)</option><option value="Cuiabá">Cuiabá (Centro/Norte)</option><option value="CPA">CPA</option></select></div>
                        <div class="col-span-2"><input type="text" id="obs" class="w-full border border-gray-300 rounded compact-input" placeholder="Observações do pedido..."></div>
                    </div>
                    
                    <div class="bg-gray-800 text-white p-2 rounded text-center mb-2 shadow-inner">
                        <span class="text-xs text-gray-400 mr-1 uppercase font-bold">Total Final:</span><div class="text-2xl font-black text-green-400">R$ <span id="lblTotalFinal">0,00</span></div>
                    </div>
                    <button onclick="finalizarPedido()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-md text-sm transition-all-300 transform active:scale-95 flex justify-center items-center gap-2"><i class="fa-solid fa-check-circle"></i> SALVAR PEDIDO</button>
                </div>
            </div>

            <!-- 2. Lista Rota -->
            <div class="w-5/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col">
                <div class="p-2 border-b border-gray-200 bg-gray-50 rounded-t">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="font-bold text-gray-700 text-xs uppercase"><i class="fa-solid fa-list-check mr-1"></i>Gerenciamento de Rotas</h2>
                        <div id="resumoRotas" class="text-[9px] flex gap-1"></div>
                    </div>
                    <div class="flex gap-1 items-center bg-gray-200 p-1 rounded">
                        <button onclick="filtrarRota('todos')" id="btnRotaTodos" class="flex-1 btn-rota bg-white shadow text-gray-800 text-[10px] py-1 rounded font-bold border border-gray-200 transition-all">Todos</button>
                        <button onclick="filtrarRota('Coxipó')" id="btnRotaCoxipo" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent transition-all">Coxipó</button>
                        <button onclick="filtrarRota('VG')" id="btnRotaVG" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent transition-all">VG</button>
                        <button onclick="filtrarRota('Cuiabá')" id="btnRotaCuiaba" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent transition-all">CBA</button>
                        <button onclick="filtrarRota('CPA')" id="btnRotaCPA" class="flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent transition-all">CPA</button>
                        <div class="w-px h-4 bg-gray-300 mx-1"></div>
                        <button onclick="imprimirRelatorioConferencia()" class="bg-purple-600 text-white w-6 h-6 rounded flex items-center justify-center shadow-sm hover:bg-purple-500 transition-colors" title="Imprimir Relatório de Conferência"><i class="fa-solid fa-clipboard-list text-[10px]"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto bg-gray-100 p-2 custom-scroll">
                    <div id="listaPedidos" class="space-y-2 pb-10"></div>
                </div>
            </div>

            <!-- 3. Detalhes (Centro de Comando) -->
            <div class="w-4/12 bg-white rounded shadow-sm border border-gray-300 flex flex-col overflow-hidden">
                <div class="p-2 bg-gray-50 border-b border-gray-200 flex justify-between items-center h-10">
                    <h2 class="font-bold text-gray-700 text-xs uppercase"><i class="fa-solid fa-eye mr-1"></i>Detalhes & Impressão</h2>
                </div>
                <div id="painelDetalhes" class="flex-1 overflow-y-auto p-4 flex flex-col items-center justify-center text-gray-400">
                    <i class="fa-solid fa-hand-pointer text-4xl mb-2 text-gray-300"></i>
                    <span class="text-xs">Selecione um pedido na lista para ver ações</span>
                </div>
            </div>

        </div>
    </div>

    <div id="areaImpressao"></div>

    <script>
        // --- DADOS ---
        const CATALOGO_PRODUTOS = {
            '001': { nome: 'Arroz Tio Alvino 5kg', ean: '7891234560010' },
            '001b': { nome: 'Arroz Koblenz 5kg', ean: '7891234560011' }, 
            '002': { nome: 'Açúcar Cristal 2kg', ean: '7891234560027' },
            '003': { nome: 'Óleo de Soja 900ml', ean: '7891234560034' },
            '004': { nome: 'Feijão 1kg', ean: '7891234560041' },
            '005': { nome: 'Café 250g', ean: '7891234560058' },
            '005b': { nome: 'Café 500g', ean: '7891234560553' }, 
            '006': { nome: 'Espaguete 400g', ean: '7891234560065' },
            '007': { nome: 'Trigo 1kg', ean: '7891234560072' },
            '008': { nome: 'Farinha Mandioca 1kg', ean: '7891234560089' },
            '009': { nome: 'Sal 1kg', ean: '7891234560096' },
            '010': { nome: 'Molho Tomate Sachê', ean: '7891234560102' },
            '011': { nome: 'Milho Lata/Sachê', ean: '7891234560119' },
            '012': { nome: 'Bolacha Recheada', ean: '7891234560126' },
            '013': { nome: 'Miojo', ean: '7891234560133' },
            '014': { nome: 'Suco em Pó', ean: '7891234560140' },
            '015': { nome: '12 Ovos', ean: '7891234560157' },
            '016': { nome: 'Mistura Bolo 400g', ean: '7891234560164' },
            '017': { nome: 'Tempero Pronto', ean: '7891234560171' },
            '030': { nome: 'Sabão Barra (pct)', ean: '7891234560300' },
            '031': { nome: 'Creme Dental 70g', ean: '7891234560317' },
            '032': { nome: 'Papel Higiênico (4un)', ean: '7891234560324' },
            '033': { nome: 'Amaciante 2 Litros', ean: '7891234560331' },
            '034': { nome: 'Desinfetante 2 Litros', ean: '7891234560348' },
            '035': { nome: 'Sabão em Pó 800g', ean: '7891234560355' },
            '036': { nome: 'Detergente 500ml', ean: '7891234560362' },
            '037': { nome: 'Qboa 1 Litro', ean: '7891234560379' },
            '038': { nome: 'Sabonete 90g', ean: '7891234560386' },
            '039': { nome: 'Esponja de Aço', ean: '7891234560393' },
            '040': { nome: 'Esponja de Louça', ean: '7891234560409' }
        };

        const DADOS_CESTAS = {
            'economica': { titulo: 'Econômica', itensCod: [[1,'001'],[1,'002'],[1,'003'],[1,'004'],[1,'005'],[1,'006'],[1,'007'],[1,'008'],[1,'009'],[1,'010'],[1,'011'],[1,'012'],[1,'013'],[1,'014']] },
            'mini': { titulo: 'Mini', itensCod: [[1,'001'],[1,'002'],[2,'003'],[2,'004'],[1,'005'],[1,'006'],[1,'009'],[1,'010'],[1,'011'],[1,'012'],[1,'013'],[2,'014'],[1,'030'],[1,'031'],[1,'032'],[1,'033'],[1,'034'],[1,'035'],[1,'036'],[1,'037'],[2,'038'],[1,'039'],[1,'040']] },
            'pequena': { titulo: 'Pequena', itensCod: [[2,'001'],[1,'002'],[2,'003'],[2,'004'],[1,'005'],[1,'015'],[1,'016'],[1,'006'],[1,'007'],[1,'009'],[1,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[2,'014'],[1,'030'],[1,'031'],[1,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[2,'038'],[1,'039'],[1,'040']] },
            'media': { titulo: 'Média', itensCod: [[3,'001'],[2,'002'],[3,'003'],[3,'004'],[1,'005b'],[1,'015'],[1,'016'],[2,'006'],[1,'007'],[1,'009'],[2,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[3,'014'],[1,'030'],[2,'031'],[2,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[3,'038'],[1,'039'],[1,'040']] },
            'grande': { titulo: 'Grande', itensCod: [[4,'001'],[3,'002'],[4,'003'],[4,'004'],[1,'005b'],[3,'006'],[1,'015'],[1,'016'],[1,'007'],[1,'009'],[2,'010'],[1,'011'],[1,'017'],[2,'012'],[2,'013'],[4,'014'],[1,'030'],[2,'031'],[2,'032'],[1,'033'],[1,'034'],[1,'035'],[2,'036'],[1,'037'],[4,'038'],[1,'039'],[1,'040']] }
        };

        const PRECOS = {
            'economica': { 'padrao': 85 },
            'mini': { 'alvino': 165, 'koblenz': 170 },
            'pequena': { 'alvino': 215, 'koblenz': 220 },
            'media': { 'alvino': 320, 'koblenz': 325 },
            'grande': { 'alvino': 380, 'koblenz': 390 }
        };

        const VALORES_DESCONTO = { 'economica': 5, 'mini': 10, 'pequena': 15, 'media': 20, 'grande': 25 };
        let carrinho = [], pedidos = [], listaClientesCache = [], filtroRotaAtual = 'todos', dragSrcEl = null, pedidoSelecionadoId = null;
        const KEY_CLIENTES = 'sistema_empresarial_clientes', KEY_PEDIDOS = 'sistema_empresarial_vendas';

        // --- SISTEMA DE NOTIFICAÇÃO (TOAST) ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icon = type === 'success' ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : 
                         (type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : 
                         '<i class="fa-solid fa-info-circle text-blue-500"></i>');
            toast.innerHTML = `${icon} <span class="font-bold text-sm">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        window.onload = () => {
            carregarClientes(); 
            carregarPedidosLocais(); 
            atualizarOpcoesPreco(); 
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        };

        function carregarClientes() { const d = localStorage.getItem(KEY_CLIENTES); listaClientesCache = d ? JSON.parse(d).sort((a,b)=>a.nome.localeCompare(b.nome)) : []; renderizarOpcoesClientes(listaClientesCache); }
        function renderizarOpcoesClientes(l) { const s = document.getElementById('selCliente'); const v = s.value; s.innerHTML = '<option value="">Selecione...</option>'; l.forEach(c => s.add(new Option(c.nome.substring(0,25), c.id))); if(v) s.value = v; }
        function filtrarClientes() { const t = document.getElementById('inputBuscaCliente').value.toLowerCase(); renderizarOpcoesClientes(listaClientesCache.filter(c => c.nome.toLowerCase().includes(t))); }
        
        // --- CORREÇÃO DO SALVAMENTO (ERRO CRÍTICO TRATADO) ---
        function salvarPedidosLocais() { 
            try {
                localStorage.setItem(KEY_PEDIDOS, JSON.stringify(pedidos)); 
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    showToast('ERRO CRÍTICO: Memória Cheia! Faça o BKP imediatamente e limpe dados antigos.', 'error');
                    alert("Atenção: Seu navegador não consegue mais salvar dados novos porque o limite foi atingido. Baixe o backup e limpe o histórico.");
                } else {
                    showToast('Erro ao salvar no disco local.', 'error');
                }
            }
        }
        
        function carregarPedidosLocais() { 
            const d = localStorage.getItem(KEY_PEDIDOS); 
            if(d) {
                try {
                    pedidos = JSON.parse(d);
                    // Garante que é array
                    if (!Array.isArray(pedidos)) pedidos = [];
                } catch(e) {
                    pedidos = [];
                }
            } else {
                pedidos = [];
            }
        }

        function alternarTab(tab) {
            document.getElementById('areaModoPadrao').className = tab === 'padrao' ? '' : 'hidden';
            document.getElementById('areaModoImportar').className = tab === 'importar' ? '' : 'hidden';
            document.getElementById('areaItensCesta').innerHTML = '';
            document.getElementById('areaItensCesta').classList.add('hidden');
            
            const styleActive = "flex-1 py-0.5 font-bold text-indigo-700 border-b-2 border-indigo-600 transition-colors";
            const styleInactive = "flex-1 py-0.5 font-bold text-gray-500 hover:text-indigo-600 transition-colors";
            document.getElementById('tabPadrao').className = tab === 'padrao' ? styleActive : styleInactive;
            document.getElementById('tabImportar').className = tab === 'importar' ? styleActive : styleInactive;

            if(tab === 'padrao') {
                document.querySelector('input[name="modoCesta"][value="normal"]').checked = true;
                toggleModoCesta();
            } else {
                document.querySelector('input[name="modoCesta"][value="alterada"]').checked = true;
                document.getElementById('divCodigoCesta').classList.remove('hidden');
                document.getElementById('areaItensCesta').classList.remove('hidden');
                document.getElementById('areaItensCesta').innerHTML = '<div class="text-center text-gray-400 p-2">Cole os códigos...</div>';
            }
        }

        function atualizarOpcoesPreco() {
            const tipo = document.getElementById('selTipoCesta').value;
            const selectMarca = document.getElementById('selMarcaPreco');
            selectMarca.innerHTML = '';
            
            const opcoes = PRECOS[tipo];
            
            if (tipo === 'economica') {
                selectMarca.add(new Option(`Padrão - R$ ${opcoes.padrao},00`, opcoes.padrao));
            } else {
                const opt1 = new Option(`Alvino - R$ ${opcoes.alvino},00`, opcoes.alvino);
                opt1.setAttribute('data-marca', 'Alvino');
                selectMarca.add(opt1);
                
                const opt2 = new Option(`Koblenz - R$ ${opcoes.koblenz},00`, opcoes.koblenz);
                opt2.setAttribute('data-marca', 'Koblenz');
                selectMarca.add(opt2);
            }
            
            if (selectMarca.options.length <= 1) {
                selectMarca.classList.add('hidden');
                selectMarca.selectedIndex = 0; 
            } else {
                selectMarca.classList.remove('hidden');
            }

            if(document.querySelector('input[name="modoCesta"]:checked').value === 'alterada') {
                recarregarListaSeAlterada();
            }
        }

        function recarregarListaSeAlterada() {
            if(document.querySelector('input[name="modoCesta"]:checked').value === 'alterada') {
                const tipo = document.getElementById('selTipoCesta').value;
                renderizarListaEditavelGenerica(DADOS_CESTAS[tipo].itensCod);
            }
        }

        function toggleModoCesta() {
            const modo = document.querySelector('input[name="modoCesta"]:checked').value;
            const area = document.getElementById('areaItensCesta');
            const divCodigo = document.getElementById('divCodigoCesta');
            
            if (modo === 'alterada') {
                const tipo = document.getElementById('selTipoCesta').value;
                renderizarListaEditavelGenerica(DADOS_CESTAS[tipo].itensCod);
                area.classList.remove('hidden');
                divCodigo.classList.remove('hidden');
            } else {
                area.classList.add('hidden');
                divCodigo.classList.add('hidden');
            }
        }

        function renderizarListaEditavelGenerica(listaItensCod) {
            const area = document.getElementById('areaItensCesta');
            area.innerHTML = '';
            
            const selMarca = document.getElementById('selMarcaPreco');
            let isKoblenz = false;
            if (selMarca && !selMarca.classList.contains('hidden') && selMarca.selectedIndex >= 0) {
                 const opt = selMarca.options[selMarca.selectedIndex];
                 if(opt.getAttribute('data-marca') === 'Koblenz') isKoblenz = true;
            }

            listaItensCod.forEach((item) => {
                const qtd = item[0];
                let cod = item[1];
                if (cod === '001' && isKoblenz) cod = '001b'; 
                
                const produto = CATALOGO_PRODUTOS[cod];
                const nome = produto ? produto.nome.substring(0,30) : 'Desc';
                
                const row = document.createElement('div');
                row.className = "flex items-center gap-1 mb-1";
                row.innerHTML = `
                    <input type="number" min="0" value="${qtd}" class="w-8 border border-gray-300 rounded text-center px-0.5 item-qtd font-bold">
                    <span class="text-[9px] bg-gray-200 px-1 rounded font-mono">${cod}</span>
                    <input type="text" value="${nome}" class="flex-1 border border-gray-300 rounded px-1 item-desc bg-gray-50 text-[10px]" readonly>
                `;
                area.appendChild(row);
            });
        }

        function adicionarItemAoCarrinho() {
            const tipoKey = document.getElementById('selTipoCesta').value;
            const precoVal = parseFloat(document.getElementById('selMarcaPreco').value) || 0;
            const selMarca = document.getElementById('selMarcaPreco');
            
            let marcaNome = 'Padrão';
            if (selMarca && !selMarca.classList.contains('hidden') && selMarca.selectedIndex >= 0) {
                 const opt = selMarca.options[selMarca.selectedIndex];
                 marcaNome = opt.getAttribute('data-marca') || 'Padrão';
            }
            
            const isImportTab = !document.getElementById('areaModoImportar').classList.contains('hidden');
            const isRadioAlterada = document.querySelector('input[name="modoCesta"][value="alterada"]').checked;
            
            let modo = (isImportTab || isRadioAlterada) ? 'alterada' : 'normal';
            let itensFinais = [];
            let identificacao = null; 
            let nomeCestaDisplay = isImportTab ? 'Importada' : DADOS_CESTAS[tipoKey].titulo;
            let isKoblenz = (marcaNome === 'Koblenz');

            if (modo === 'normal') {
                const listaCod = DADOS_CESTAS[tipoKey].itensCod;
                listaCod.forEach(item => {
                   let cod = item[1];
                   if(cod === '001' && isKoblenz) cod = '001b';
                   const produto = CATALOGO_PRODUTOS[cod];
                   if(produto) itensFinais.push({ cod: cod, qtd: item[0], nome: produto.nome, ean: produto.ean });
                });
            } else {
                const codInput = document.getElementById('inputCodigoCesta').value;
                if(!codInput) return showToast('Informe o CÓDIGO da alteração (número).', 'error');
                identificacao = codInput;
                const container = document.getElementById('areaItensCesta');
                Array.from(container.children).forEach(child => {
                    const qInput = child.querySelector('.item-qtd');
                    const spanCod = child.querySelector('span.font-mono');
                    if(qInput && spanCod) {
                        const codigo = spanCod.innerText;
                        const q = parseInt(qInput.value) || 0;
                        if (q > 0) {
                            let ean = CATALOGO_PRODUTOS[codigo] ? CATALOGO_PRODUTOS[codigo].ean : '';
                            let nome = CATALOGO_PRODUTOS[codigo] ? CATALOGO_PRODUTOS[codigo].nome : 'Extra';
                            itensFinais.push({ cod: codigo, qtd: q, nome: nome, ean: ean });
                        }
                    }
                });
            }

            if(itensFinais.length === 0) return showToast("Erro: Nenhum item identificado.", 'error');

            carrinho.push({ id: Date.now(), tipo: nomeCestaDisplay, marca: marcaNome, preco: precoVal, modo: modo, identificacao: identificacao, conteudo: itensFinais });
            renderizarCarrinho();
            showToast('Item adicionado!', 'success');
        }

        function removerDoCarrinho(id) { carrinho = carrinho.filter(i => i.id !== id); renderizarCarrinho(); }
        
        function renderizarCarrinho() {
            const tbody = document.getElementById('tabelaCarrinho'); tbody.innerHTML = '';
            let subtotal = 0;
            const vazioMsg = document.getElementById('carrinhoVazio');
            
            if(carrinho.length === 0) {
                vazioMsg.classList.remove('hidden');
            } else {
                vazioMsg.classList.add('hidden');
                carrinho.forEach(item => {
                    subtotal += item.preco;
                    const tr = document.createElement('tr'); tr.className = "border-t border-gray-100 hover:bg-gray-50";
                    let label = item.modo === 'alterada' ? `<span class="bg-yellow-200 text-yellow-800 px-1 rounded ml-1 text-[9px] font-bold">COD:${item.identificacao}</span>` : '';
                    tr.innerHTML = `<td class="p-1"><div class="font-bold text-indigo-900">${item.tipo} ${label}</div><div class="text-[9px] text-gray-500">${item.marca}</div></td><td class="p-1 text-right font-mono">R$ ${item.preco}</td><td class="p-1 text-center"><button onclick="removerDoCarrinho(${item.id})" class="text-red-400 hover:text-red-600 font-bold px-2 py-1"><i class="fa-solid fa-times"></i></button></td>`;
                    tbody.appendChild(tr);
                });
            }
            
            document.getElementById('lblSubtotal').innerText = subtotal.toFixed(2).replace('.', ',');
            calcularTotalFinal(subtotal);
        }

        function calcularTotalFinal(subtotalOverride) {
            let sub = subtotalOverride !== undefined ? subtotalOverride : parseFloat(document.getElementById('lblSubtotal').innerText.replace(',', '.'));
            let desc = parseFloat(document.getElementById('desconto').value) || 0;
            document.getElementById('lblTotalFinal').innerText = Math.max(0, sub - desc).toFixed(2).replace('.', ',');
        }

        function limparPedidoAtual() {
            carrinho = []; renderizarCarrinho();
            document.getElementById('selCliente').value = "";
            document.getElementById('inputBuscaCliente').value = ""; 
            document.getElementById('obs').value = "";
            document.getElementById('pagStatus').value = "pendente";
            document.getElementById('desconto').value = "0";
            alternarTab('padrao'); calcularTotalFinal(0);
        }

        function finalizarPedido() {
            const selCliente = document.getElementById('selCliente');
            if (!selCliente.value) return showToast('Selecione um Cliente!', 'error');
            if (carrinho.length === 0) return showToast('Carrinho vazio!', 'error');
            
            const clienteDados = JSON.parse(selCliente.options[selCliente.selectedIndex].dataset.json || "{}");
            // Fallback se o dataset estiver vazio (busca no cache)
            const clienteFull = listaClientesCache.find(c => c.id == selCliente.value);

            const now = new Date();
            const dataHojeStr = now.toISOString().split('T')[0];
            const countHoje = pedidos.filter(p => p.data.startsWith(dataHojeStr)).length + 1;
            const codigoVisual = `${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(countHoje).padStart(2,'0')}`;
            
            pedidos.push({
                id: Date.now().toString(), 
                codigoVisual: codigoVisual, 
                data: new Date().toISOString(), 
                ordem: Date.now(), 
                cliente: clienteFull || clienteDados, 
                rota: document.getElementById('rota').value,
                pagamento: { metodo: document.getElementById('pagMetodo').value, status: document.getElementById('pagStatus').value },
                financeiro: { subtotal: parseFloat(document.getElementById('lblSubtotal').innerText.replace(',', '.')), desconto: parseFloat(document.getElementById('desconto').value), total: parseFloat(document.getElementById('lblTotalFinal').innerText.replace(',', '.')) },
                brinde: document.getElementById('brinde').value, 
                obs: document.getElementById('obs').value, 
                itens: carrinho
            });
            
            salvarPedidosLocais();
            showToast(`PEDIDO ${codigoVisual} SALVO COM SUCESSO!`, 'success');
            
            limparPedidoAtual();
            document.getElementById('filtroData').valueAsDate = new Date();
            renderizarListaPedidos();
        }

        function filtrarRota(rota) {
            filtroRotaAtual = rota;
            document.querySelectorAll('.btn-rota').forEach(btn => btn.className = 'flex-1 btn-rota text-gray-500 hover:bg-white text-[10px] py-1 rounded border border-transparent transition-all');
            const btnAtivo = document.getElementById('btnRota' + (rota === 'todos' ? 'Todos' : rota.replace(/\s+/g, '')));
            if(btnAtivo) btnAtivo.className = 'flex-1 btn-rota bg-white shadow text-gray-800 text-[10px] py-1 rounded font-bold border border-gray-200 transition-all';
            renderizarListaPedidos();
        }

        function getPedidosVisiveis() {
            const f = document.getElementById('filtroData').value;
            let l = pedidos.filter(p => p.data.startsWith(f));
            if (filtroRotaAtual !== 'todos') l = l.filter(p => p.rota === filtroRotaAtual);
            return l.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
        }

        function moverPedido(id, direcao) {
            const l = getPedidosVisiveis();
            l.forEach((p, i) => p.ordem = i * 10);
            const idx = l.findIndex(p => p.id === id);
            if (idx === -1) return;
            const alvo = idx + direcao;
            if (alvo >= 0 && alvo < l.length) {
                const temp = l[idx].ordem; l[idx].ordem = l[alvo].ordem; l[alvo].ordem = temp;
                salvarPedidosLocais(); renderizarListaPedidos();
            }
        }

        function excluirPedido(id) { 
            if(confirm('Tem certeza que deseja EXCLUIR este pedido permanentemente?')) { 
                pedidos = pedidos.filter(p => p.id !== id); 
                salvarPedidosLocais(); 
                if(pedidoSelecionadoId===id) pedidoSelecionadoId=null; 
                renderizarListaPedidos(); 
                renderizarDetalhesPedido(pedidoSelecionadoId);
                showToast('Pedido excluído.', 'warning');
            } 
        }

        // --- BACKUP E EXPORTAÇÃO (ATUALIZADO) ---
        function downloadJSON(dados, nomeArquivo) {
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(new Blob([JSON.stringify(dados)], {type: "application/json"})); 
            a.download = nomeArquivo; 
            a.click();
        }

        // 1. Backup Geral (90 dias)
        function exportarBackupGeral() {
            const hoje = new Date();
            const limite90 = new Date();
            limite90.setDate(hoje.getDate() - 90);

            // Filtra pedidos onde a data é maior ou igual a 90 dias atrás
            const backup = pedidos.filter(p => new Date(p.data) >= limite90);
            
            const dataStr = hoje.toISOString().split('T')[0];
            downloadJSON(backup, `BKP_90DIAS_${dataStr}.json`);
            showToast(`Backup de ${backup.length} pedidos (90 dias) gerado!`, 'success');
        }

        // 2. Exportar Somente Hoje (Para fechamento)
        function exportarDoDia() {
            const dataHoje = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const doDia = pedidos.filter(p => p.data.startsWith(dataHoje));
            
            if (doDia.length === 0) return showToast('Nenhum pedido hoje para baixar.', 'warning');
            
            downloadJSON(doDia, `FECHAMENTO_${dataHoje}.json`);
            showToast(`Arquivo do dia (${doDia.length} pedidos) baixado!`, 'success');
        }

        // --- RENDERIZAÇÃO ---
        function renderizarListaPedidos() {
            const c = document.getElementById('listaPedidos'); const l = getPedidosVisiveis();
            const resumo = {}; l.forEach(p => { resumo[p.rota] = (resumo[p.rota] || 0) + 1; });
            document.getElementById('resumoRotas').innerHTML = Object.entries(resumo).map(([r, q]) => `<span class="bg-blue-100 text-blue-800 px-1 rounded border border-blue-200">${r.substring(0,3)}:${q}</span>`).join('');
            
            c.innerHTML = ''; 
            if (l.length === 0) return c.innerHTML = '<div class="text-center text-gray-400 mt-10 text-xs flex flex-col items-center"><i class="fa-solid fa-box-open text-2xl mb-2 opacity-50"></i>Nenhum pedido encontrado</div>';
            
            l.forEach((p, index) => {
                const card = document.createElement('div');
                const isSelected = p.id === pedidoSelecionadoId;
                const nomeF = p.cliente.nome.split(' ').slice(0, 2).join(' ').toUpperCase();
                card.dataset.id = p.id; card.setAttribute('draggable', 'true');
                card.className = `draggable-card bg-white border border-gray-200 shadow-sm rounded mb-1 p-2 flex gap-2 items-center cursor-pointer transition-all ${isSelected ? 'selected-card ring-2 ring-indigo-500' : 'hover:bg-gray-50'}`;
                card.onclick = () => { pedidoSelecionadoId = p.id; renderizarListaPedidos(); renderizarDetalhesPedido(p.id); };
                
                // Drag and drop events
                card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', p.id); e.target.classList.add('dragging'); dragSrcEl = e.target; });
                card.addEventListener('dragover', (e) => e.preventDefault());
                card.addEventListener('drop', (e) => { e.preventDefault(); if(dragSrcEl !== e.target) {
                     const l2 = getPedidosVisiveis(); l2.forEach((x,i)=>x.ordem=i*10); 
                     const i1 = l2.findIndex(x=>x.id===dragSrcEl.dataset.id); const i2 = l2.findIndex(x=>x.id===p.id);
                     if(i1>-1 && i2>-1) { const [m] = l2.splice(i1,1); l2.splice(i2,0,m); l2.forEach((x,i)=>x.ordem=i*10); salvarPedidosLocais(); renderizarListaPedidos(); }
                }});
                card.addEventListener('dragend', (e) => document.querySelectorAll('.draggable-card').forEach(x=>x.classList.remove('dragging')));

                let info = p.itens.map(i => `${i.tipo.replace('Cesta ','')} ${i.modo==='alterada'?'<i class="fa-solid fa-triangle-exclamation text-red-500 text-[10px]" title="Alterada"></i>':''}`).join(', ');

                card.innerHTML = `
                    <div class="flex flex-col gap-1 items-center justify-center border-r border-gray-200 pr-2">
                        <button onclick="event.stopPropagation(); moverPedido('${p.id}', -1)" class="text-gray-300 hover:text-indigo-600"><i class="fa-solid fa-caret-up"></i></button>
                        <button onclick="event.stopPropagation(); moverPedido('${p.id}', 1)" class="text-gray-300 hover:text-indigo-600"><i class="fa-solid fa-caret-down"></i></button>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1 mb-1">
                            <div class="text-xs font-black text-gray-800 truncate">
                                <span class="bg-gray-800 text-white px-1.5 py-0.5 rounded font-mono mr-1 text-[10px]">${p.codigoVisual}</span> ${nomeF}
                            </div>
                            <div class="text-[9px] font-bold text-gray-400">${p.rota.substring(0,3).toUpperCase()}</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-[10px] text-gray-600 leading-tight truncate w-32">${info}</div>
                            <button onclick="event.stopPropagation(); excluirPedido('${p.id}')" class="text-gray-300 hover:text-red-600 ml-1 transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                c.appendChild(card);
            });
        }

        function renderizarDetalhesPedido(id) {
            const painel = document.getElementById('painelDetalhes');
            const p = pedidos.find(i => i.id === id);
            if(!p) return painel.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fa-solid fa-hand-pointer text-4xl mb-2 text-gray-300"></i><span class="text-xs">Selecione um pedido</span></div>';

            let htmlItens = '';
            p.itens.forEach(item => {
                let lista = item.conteudo.map(s => `<div class="flex justify-between border-b border-dashed border-gray-200 py-1 text-xs"><span class="flex-1"><b class="bg-gray-100 px-1 rounded mr-1 text-[10px]">${s.cod}</b> ${s.nome}</span><span class="font-bold w-12 text-right">${s.qtd}x</span></div>`).join('');
                htmlItens += `<div class="bg-white border border-gray-200 rounded mb-2 shadow-sm overflow-hidden"><div class="bg-gray-50 p-2 font-bold text-sm border-b border-gray-200 flex justify-between items-center"><span>${item.tipo} (${item.marca})</span>${item.modo==='alterada'?'<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-[10px] ml-2 font-bold uppercase border border-red-200">Alterada</span>':''}</div><div class="p-2 bg-white">${lista}</div></div>`;
            });

            painel.innerHTML = `
                <div class="w-full h-full flex flex-col">
                    <div class="p-4 bg-white border-b border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div><div class="text-xl font-black text-gray-800 leading-none">${p.cliente.nome}</div></div>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 font-bold">PEDIDO</div>
                                <div class="text-2xl font-black text-indigo-600 leading-none">${p.codigoVisual}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded font-bold uppercase">${p.rota}</span>
                            <span><i class="fa-solid fa-location-dot w-4 text-center"></i> ${p.cliente.endereco}, ${p.cliente.bairro}</span>
                        </div>
                        ${p.obs ? `<div class="mt-2 text-xs bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-200 flex gap-2"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> <div><b>OBSERVAÇÃO:</b> ${p.obs}</div></div>` : ''}
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-50 custom-scroll border-b border-gray-200">${htmlItens}</div>
                    <div class="p-4 bg-white grid grid-cols-2 gap-2">
                        <button onclick="imprimirEtiquetaPedido('${p.id}')" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded shadow flex items-center justify-center gap-2 transition-all"><i class="fa-solid fa-tag"></i> ETIQUETA</button>
                        <button onclick="imprimirMontagem('${p.id}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow flex items-center justify-center gap-2 transition-all"><i class="fa-solid fa-boxes-packing"></i> MONTAGEM</button>
                        <button onclick="imprimirCupomDesconto('${p.id}')" class="col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-2 text-xs uppercase transition-all"><i class="fa-solid fa-ticket"></i> CUPOM PROMOCIONAL</button>
                    </div>
                </div>`;
        }

        // --- IMPRESSÃO (Mantida e Estilizada) ---
        function getHeaderImpressao() {
            return `<div class="print-header-brand"><div class="brand-text"><div>SUPER CESTAS</div><div>DONA ANTONIA</div></div><div class="brand-info"><div class="brand-whatsapp"><i class="fa-brands fa-whatsapp"></i> 65 99815-0975</div><div class="brand-site">www.DONAANTONIA.com.br</div></div></div>`;
        }

        function imprimirEtiquetaPedido(id) {
            const p = pedidos.find(i => i.id === id); if(!p) return;
            const area = document.getElementById('areaImpressao');
            const nomeCli = p.cliente.nome.split(' ').slice(0, 2).join(' ').toUpperCase();
            const dataF = new Date(p.data).toLocaleDateString('pt-BR');
            const brinde = (p.brinde && p.brinde !== 'Nenhum') ? `BRINDE: ${p.brinde.toUpperCase()}` : 'SEM BRINDE';
            const header = getHeaderImpressao();
            let html = '';

            p.itens.forEach(item => {
                let qtd = (item.tipo.match(/mini|pequena/i)) ? 2 : (item.tipo.match(/grande|media|média/i) ? 3 : 1);
                let nomeCesta = `CESTA ${item.tipo.toUpperCase()} (${item.marca})`;
                if(item.modo === 'alterada') nomeCesta += ` - ALTERADA (COD: ${item.identificacao})`;
                
                for (let i = 1; i <= qtd; i++) {
                    html += `
                        <div class="label-page"><div class="label-content">
                            ${header}
                            <div>
                                <div class="label-date">${dataF}</div>
                                <div class="label-client-name">${nomeCli}</div>
                                <div class="label-client-phone">${p.cliente.telefone||''}</div>
                                <div class="label-client-address">${p.cliente.endereco}, ${p.cliente.bairro}</div>
                                <div class="info-row">
                                    <div class="box-code">ROTA: ${p.rota.toUpperCase()}</div>
                                    <div class="box-code">PED: ${p.codigoVisual}</div>
                                </div>
                            </div>
                            <div><div class="label-basket-info">${nomeCesta}</div><div class="label-brinde">${brinde}</div></div>
                            <div class="label-footer"><div class="volume-counter">VOL: ${i}/${qtd}</div></div>
                        </div></div>`;
                }
            });
            area.innerHTML = html; setTimeout(() => window.print(), 300);
        }

        function imprimirMontagem(id) {
            const p = pedidos.find(i => i.id === id); if(!p) return;
            const area = document.getElementById('areaImpressao');
            const dataF = new Date(p.data).toLocaleDateString('pt-BR');
            const horaF = new Date(p.data).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            
            let htmlConteudo = '';
            p.itens.forEach(item => {
                let titulo = item.tipo.toUpperCase();
                let lista = '';
                if (item.modo === 'alterada') {
                    titulo += ` (COD: ${item.identificacao})`;
                    lista = item.conteudo.map(s => `<div class="montagem-item"><div class="montagem-prod">${s.nome.toUpperCase()}</div><div class="montagem-meta">${s.cod} | <b>${s.qtd}x</b></div></div>`).join('');
                } else {
                    lista = '<div style="text-align:center; padding:10px;">(ITENS PADRÃO)</div>';
                }
                htmlConteudo += `<div style="margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;"><div class="montagem-header">${titulo}</div>${lista}</div>`;
            });

            area.innerHTML = `
                <div class="montagem-page">
                    ${getHeaderImpressao()}
                    <div style="text-align:center; font-size:16px; font-weight:900; margin-bottom:10px;">MONTAGEM <br>${dataF} ${horaF}</div>
                    <div style="font-size:24px; font-weight:900; margin-bottom:5px;">${p.cliente.nome.split(' ')[0]} | #${p.codigoVisual}</div>
                    <div style="border-bottom: 4px solid black; margin-bottom:10px;"></div>
                    <div>${htmlConteudo}</div>
                    ${p.obs ? `<div style="font-size:16px; font-weight:bold; border: 2px solid black; padding: 5px; margin-top: 10px;">OBS: ${p.obs.toUpperCase()}</div>` : ''}
                </div>`;
            setTimeout(() => window.print(), 300);
        }

        function imprimirCupomDesconto(id) {
            const p = pedidos.find(i => i.id === id); if(!p) return;
            const area = document.getElementById('areaImpressao');
            
            let melhorCesta = p.itens[0];
            let maiorDesconto = 0;
            p.itens.forEach(item => {
                const t = item.tipo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                let d = 5;
                if(t.includes('grande')) d = 25; else if(t.includes('media')) d = 20; else if(t.includes('pequena')) d = 15; else if(t.includes('mini')) d = 10;
                if(d > maiorDesconto) { maiorDesconto = d; melhorCesta = item; }
            });

            const validade = new Date(); validade.setDate(validade.getDate() + 30);
            const valorFinal = melhorCesta.preco - maiorDesconto;

            area.innerHTML = `
                <div class="cupom-page"><div class="cupom-container">
                    ${getHeaderImpressao()}
                    <div class="cupom-title">PRESENTE PARA VOCÊ!</div>
                    <div style="font-size:14px;">Olá <b>${p.cliente.nome.split(' ')[0]}</b>, obrigado!</div>
                    <div style="font-size:12px; margin-top:5px;">Compre a <b>${melhorCesta.tipo.toUpperCase()}</b> até <b>${validade.toLocaleDateString('pt-BR')}</b> e:</div>
                    <div class="cupom-box">
                        <div class="cupom-price-label">PAGUE APENAS</div>
                        <div class="cupom-price-value">R$ ${valorFinal.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div style="font-size:11px;">(Preço normal: R$ ${melhorCesta.preco.toFixed(2)})</div>
                    <div class="cupom-footer">Válido apenas para a cesta acima.</div>
                </div></div>`;
            setTimeout(() => window.print(), 300);
        }

        function imprimirRelatorioConferencia() {
            const d = document.getElementById('filtroData').value;
            let l = pedidos.filter(p => p.data.startsWith(d));
            if (l.length === 0) return showToast('Nenhum pedido nesta data para relatório.', 'warning');
            l.sort((a, b) => a.rota.localeCompare(b.rota) || a.cliente.nome.localeCompare(b.cliente.nome));
            
            const rotas = {}; l.forEach(p => { if (!rotas[p.rota]) rotas[p.rota] = []; rotas[p.rota].push(p); });

            let html = getHeaderImpressao();
            html += `<div style="text-align:center; font-weight:900; font-size:16px; margin:10px 0; border-bottom:2px solid black;">RELATÓRIO DE CONFERÊNCIA - ${new Date(d+'T00:00:00').toLocaleDateString('pt-BR')}</div>`;

            for (const [r, itens] of Object.entries(rotas)) {
                html += `<div style="font-size:14px; font-weight:900; background:#eee; padding:5px; margin-top:10px; border-top: 1px solid #000; text-transform:uppercase;">ROTA: ${r} (${itens.length})</div>`;
                html += `<table style="width:100%; border-collapse:collapse; font-size:11px; font-family:'Arial', sans-serif;"><tr style="border-bottom:1px solid #000;"><th style="text-align:left;">PED</th><th style="text-align:left;">CLIENTE</th><th style="text-align:left;">CESTA</th></tr>`;
                itens.forEach(p => {
                    let info = p.itens.map(i => `${i.tipo} ${i.marca!=='Pad'?'('+i.marca+')':''} ${i.modo==='alterada'?'[ALT]':''}`).join(', ');
                    html += `<tr style="border-bottom:1px dashed #ccc;"><td style="font-weight:bold;">${p.codigoVisual}</td><td>${p.cliente.nome.substring(0,20)}</td><td>${info}</td></tr>`;
                });
                html += `</table>`;
            }
            document.getElementById('areaImpressao').innerHTML = html;
            setTimeout(() => window.print(), 300);
        }
    </script>
</body>
</html>
